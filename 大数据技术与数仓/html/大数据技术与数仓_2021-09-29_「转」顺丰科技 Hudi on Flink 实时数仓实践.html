<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 0 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic{color:#8e8e8e;background:#f7f7f7;border-radius:5px;padding:10px 8px;}.topic a{padding-right:5px;}.topic p{margin-bottom:5px;}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head><script>
var data={"mp":"大数据技术与数仓","title":"顺丰科技 Hudi on Flink 实时数仓实践","time":"2021-09-29 08:30:00","timeStamp":"1632875400"};
</script>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="http://mp.weixin.qq.com/s?__biz=MzU2ODQ3NjYyMA==&mid=2247487448&idx=2&sn=5384de259f057a577f2fa7a0306b5883&chksm=fc8c197bcbfb906d9fae819b810c0b94803ee1f0a0b2346e78c14f328feebacce233c85f5f6d#rd" target="_blank">顺丰科技 Hudi on Flink 实时数仓实践</a></h1><div id="meta_content" class="rich_media_meta_list"><span class="rich_media_meta rich_media_meta_text">刘杰@顺丰&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">大数据技术与数仓&nbsp;&nbsp;</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-09-29 08:30:00</em></div><content><div class="reprint"><p>转自公众号：Flink 中文社区<br><a href="http://mp.weixin.qq.com/s?__biz=MzU3Mzg4OTMyNQ==&mid=2247493959&idx=1&sn=90532a9dc5023baf30249789c8e6ce68" target="_blank" title="阅读原文">http://mp.weixin.qq.com/s?__biz=MzU3Mzg4OTMyNQ==&mid=2247493959&idx=1&sn=90532a9dc5023baf30249789c8e6ce68</a></p></div><section style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;" data-mpa-powered-by="yiban.io"><span style="outline: 0px;max-width: 100%;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;box-sizing: border-box !important;overflow-wrap: break-word !important;">▼ 关注「</span><span style="outline: 0px;max-width: 100%;font-size: 15px;letter-spacing: 0.5px;font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;color: rgb(217, 78, 106);box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">大数据技术与数仓</span></strong></span><span style="outline: 0px;max-width: 100%;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;box-sizing: border-box !important;overflow-wrap: break-word !important;">」，获取更多技术干货&nbsp;<span style="outline: 0px;max-width: 100%;text-align: left;">▼</span></span></section><section class="mp_profile_iframe_wrp"><mpprofile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzU2ODQ3NjYyMA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/PL10rfzHicsiaWUJ7uBrlIibLdUDlmsXrhE9b6ZXmFWGZFqzSQE7LFkL1XmLkmgAWibVYG7tpGyEjls5B0LWc8lkjg/0?wx_fmt=png" data-nickname="大数据技术与数仓" data-alias="bigdata_dw" data-signature="专注分享数据仓库与大数据技术(Flink/Hadoop/Spark/Hive)相关内容。关注我可以免费领取大数据书籍与视频。我的博客:https://jiamaoxiang.top/" data-from="0"></mpprofile></section><section style="outline: 0px;max-width: 100%;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="outline: 0px;max-width: 100%;letter-spacing: 0.544px;line-height: 27.2px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section donone="shifuMouseDownCard(&#39;shifu_c_008&#39;)" label="Copyright Reserved by PLAYHUDONG." style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section donone="shifuMouseDownCard(&#39;shifu_c_008&#39;)" label="Copyright Reserved by PLAYHUDONG." style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section donone="shifuMouseDownCard(&#39;shifu_c_008&#39;)" label="Copyright Reserved by PLAYHUDONG." style="margin-right: 0em;margin-left: 0em;padding: 0.5em 1em;outline: 0px;max-width: 100%;border-style: none;background-color: rgb(245, 245, 245);box-sizing: border-box !important;overflow-wrap: break-word !important;"><p style="outline: 0px;max-width: 100%;min-height: 1em;font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(89, 89, 89);letter-spacing: 0.5px;font-size: 15px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="outline: 0px;max-width: 100%;font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;box-sizing: border-box !important;overflow-wrap: break-word !important;">摘要：</strong><span style="outline: 0px;max-width: 100%;text-align: left;">本文作者刘杰，介绍了顺丰科技数仓的架构，趟过的一些问题、使用 Hudi 来优化整个 job 状态的实践细节，以及未来的一些规划。主要内容为：</span></span></p><p style="outline: 0px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 14px;font-family: &quot;PingFang SC&quot;;color: rgb(18, 20, 22);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"  /></p><ol class="list-paddingleft-2" style="outline: 0px;max-width: 100%;overflow-wrap: break-word !important;"><li style="outline: 0px;max-width: 100%;font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;text-align: left;box-sizing: border-box !important;overflow-wrap: break-word !important;">数仓架构<br  /></span></section></li><li style="outline: 0px;max-width: 100%;font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;text-align: left;box-sizing: border-box !important;overflow-wrap: break-word !important;">Hudi 代码躺过的坑<br  /></span></section></li><li style="outline: 0px;max-width: 100%;font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;text-align: left;box-sizing: border-box !important;overflow-wrap: break-word !important;">状态优化<br  /></span></section></li><li style="outline: 0px;max-width: 100%;font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;box-sizing: border-box !important;overflow-wrap: break-word !important;">未来规划</span></section></li></ol><section style="outline: 0px;max-width: 100%;text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"  /></section><section style="outline: 0px;max-width: 100%;font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;letter-spacing: 0.5px;font-size: 15px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(89, 89, 89);"><strong style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">Tips：</strong><span style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">点</span></span><span style="outline: 0px;max-width: 100%;"><span style="outline: 0px;max-width: 100%;color: rgb(89, 89, 89);box-sizing: border-box !important;overflow-wrap: break-word !important;">击</span><span style="outline: 0px;max-width: 100%;color: rgb(255, 79, 121);box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">「阅读原</strong></span><span style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(255, 79, 121);"><strong style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">文」</strong></span><span style="outline: 0px;max-width: 100%;color: rgb(89, 89, 89);">即可查看更多技术文章</span></span></span></span></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section><section style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;letter-spacing: 0.544px;text-align: center;font-size: 15px;font-family: 微软雅黑, sans-serif;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br  /></section></section></section><p style="outline: 0px;max-width: 100%;min-height: 1em;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><br  /></p><p style="outline: 0px;max-width: 100%;min-height: 1em;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="letter-spacing: 0.5px;"><span style="color: rgb(89, 89, 89);font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 15px;text-align: left;">顺丰科技早在 2019 年引入 Hudi ,当时是基于 Spark 批处理，2020 年对数据的实时性要求更高公司对架构进行了升级，在社区 Hudi on Flink 的半成品上持续优化实现 </span><span style="font-size: 15px;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;text-align: left;color: rgb(89, 89, 89);">Binlog 数据 CDC 入湖。在 Hudi 社区飞速发展的同时公司今年对数仓也提出了新的要求，最终采用 Flink + Hudi 的方式来宽表的实时化。过程中遇到了很多问题主要有两点：<br  /></span></span></p><p style="text-align: left;line-height: 1.75em;"><br  /></p><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li style="font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;"><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;">Hudi Master 代码当时存在一些漏洞；</span></p><p style="text-align: left;line-height: 1.75em;"><br  /></p></li><li style="font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;"><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;">宽表涉及到多个 Join，Top One 等操作使得状态很大。</span></p></li></ol><p style="text-align: left;line-height: 1.75em;"><br  /></p><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;">庆幸的是社区的修复速度很给力加上 Hudi 强大 upsert 能力使这两个问题得到以有效的解决。</span></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><section style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box;caret-color: rgb(0, 0, 0);color: rgb(0, 0, 0);font-size: 16px;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="margin-top: 10px;margin-bottom: 10px;outline: 0px;max-width: 100%;box-sizing: border-box;text-align: center;overflow-wrap: break-word !important;"><section style="padding: 3px;outline: 0px;max-width: 100%;box-sizing: border-box;display: inline-block;border-bottom: 5px solid rgb(71, 193, 168);font-size: 18px;overflow-wrap: break-word !important;"><p cid="n68" mdtype="heading" style="outline: 0px;max-width: 100%;box-sizing: border-box;min-height: 1em;overflow-wrap: break-word !important;"><strong style="outline: 0px;max-width: 100%;box-sizing: border-box;overflow-wrap: break-word !important;">一、数仓架构</strong></p></section></section></section></section></section></section><section style="outline: 0px;max-width: 100%;min-height: 1em;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><br  /></span></section><section style="outline: 0px;max-width: 100%;min-height: 1em;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);">感兴趣的同学可以参考之前顺丰分享的《Hudi on Flink 在顺丰的实践应用》</span><br  /></section><section style="outline: 0px;max-width: 100%;min-height: 1em;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><br  /></span></section><section style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;font-size: 15px;letter-spacing: 0.5px;font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;color: rgb(217, 78, 106);box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;color: rgb(217, 78, 106);outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">▼ 文章点击&nbsp;▼</span></strong></span></section><section style="text-align: center;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;outline: 0px;max-width: 100%;text-align: left;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br  /></span></section><section style="text-align: center;line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3Mzg4OTMyNQ==&amp;mid=2247490142&amp;idx=1&amp;sn=0dec80f8194a45a73b162162e5359627&amp;chksm=fd3b941cca4c1d0af068abb2333647e90f7d02ad17da671c9f88a0066e40d3adc9fb853257fc&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2">Hudi on Flink 在顺丰的实践应用</a><br  /></span></section><section style="text-align: left;line-height: 1.75em;"><br  /></section><section style="white-space: normal;outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box;caret-color: rgb(0, 0, 0);color: rgb(0, 0, 0);font-size: 16px;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="margin-top: 10px;margin-bottom: 10px;outline: 0px;max-width: 100%;box-sizing: border-box;text-align: center;overflow-wrap: break-word !important;"><section style="padding: 3px;outline: 0px;max-width: 100%;box-sizing: border-box;display: inline-block;border-bottom: 5px solid rgb(71, 193, 168);font-size: 18px;overflow-wrap: break-word !important;"><p cid="n68" mdtype="heading" style="outline: 0px;max-width: 100%;box-sizing: border-box;min-height: 1em;overflow-wrap: break-word !important;"><strong style="outline: 0px;max-width: 100%;box-sizing: border-box;overflow-wrap: break-word !important;">二、Hudi 代码趟过的坑</strong></p></section></section></section></section></section></section><section style="white-space: normal;outline: 0px;max-width: 100%;min-height: 1em;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><br  /></span></section><section style="white-space: normal;outline: 0px;max-width: 100%;min-height: 1em;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">在去年我们是基于 Hudi &nbsp;0.6 左右进行的 Hudi on Flink 的实践，代码较老。为了拥抱社区我们使用最新 master 代码进行实践，在大数据量写入场景中，发现了一个比较隐秘的丢数问题，这个问题花了将近两周的时间才定位到。</span></section><h4 cid="n115" mdtype="heading" style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><strong style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: left;white-space: normal;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(0, 122, 170);box-sizing: border-box !important;overflow-wrap: break-word !important;"><br  /></span></strong></span></h4><h4 cid="n115" mdtype="heading" style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><strong style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: left;white-space: normal;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(0, 122, 170);box-sizing: border-box !important;overflow-wrap: break-word !important;">1.&nbsp;Hudi StreamWriteFunction 算子核心流程梳理</span></strong></span></h4><section style="text-align: left;line-height: 1.75em;"><br  /></section><p cid="n88" mdtype="paragraph"><img data-ratio="0.42168674698795183" src="https://mmbiz.qpic.cn/mmbiz_png/8AsYBicEePu64ia5x6UjO8jCiajGm90hHRicpue5wqGiaNYiaE0WJZ6iaiblyeBHb6ccdeE0joBt45iaYvNkwLdm0yYX45g/640?wx_fmt=png" data-type="png" data-w="1079" style="box-sizing: border-box;border-width: 0px 4px 0px 2px;border-right-style: solid;border-left-style: solid;border-right-color: transparent;border-left-color: transparent;vertical-align: middle;image-orientation: from-image;cursor: default;transform: translateZ(0px);display: block;margin: auto;"  /></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><p style="text-align: left;line-height: 1.75em;"><span style="box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;"><code style="box-sizing: border-box;font-family: var(--monospace);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);background-color: rgb(243, 244, 244);border-radius: 3px;padding-right: 2px;padding-left: 2px;font-size: 0.9em;">StreamWriteFunction</code></span><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">算子收数据的时候会先把数据按照 fileld 分组缓存好，数据的持续流会使得缓存数据越来越大，当达到一定阈值时便会执行 flush。阈值由 2 个核心参数控制<span md-inline="plain" style="color: rgb(89, 89, 89);box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;">：</span></span><span style="box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;"><code style="box-sizing: border-box;font-family: var(--monospace);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);background-color: rgb(243, 244, 244);border-radius: 3px;padding-right: 2px;padding-left: 2px;font-size: 0.9em;">write.batch.size 默认 64M</code> ，<code style="box-sizing: border-box;font-family: var(--monospace);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);background-color: rgb(243, 244, 244);border-radius: 3px;padding-right: 2px;padding-left: 2px;font-size: 0.9em;">write.task.max.size 默认 1G</code> 。</span><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">当单个分组数据达到 64M 或者总缓存数据达到 800M ~ 1G 就会触发 flush 。</span></p><p style="text-align: left;line-height: 1.75em;"><br  /></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">flush 会调用 client 的 api 去创建一个 WriteHandle，然后把 WriteHandle 放入 Map 进行缓存，一个 handle 可以理解为对应一个文件的 cow。</span></p><p style="text-align: left;line-height: 1.75em;"><br  /></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">如果一个 fileld 在同一 checkpoint 期间被多次写入，则后一次是基于前一次的 cow, 它的 handle 是一个<span md-inline="code" spellcheck="false" style="color: rgb(89, 89, 89);box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;"><code style="box-sizing: border-box;font-family: var(--monospace);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);background-color: rgb(243, 244, 244);border-radius: 3px;padding-right: 2px;padding-left: 2px;font-size: 0.9em;">FlinkMergeAndReplaceHandle</code>，</span>判断一个 fileld 是否之前被写入过就是根据上面 Map 缓存得来的。</span></p><p style="text-align: left;line-height: 1.75em;"><br  /></p><p style="text-align: left;line-height: 1.75em;"><span style="box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;"><code style="box-sizing: border-box;font-family: var(--monospace);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);background-color: rgb(243, 244, 244);border-radius: 3px;padding-right: 2px;padding-left: 2px;font-size: 0.9em;">StreamWriteFunction</code></span><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">执行 snapshotState 时会把内存的所有分组数据一次进行 flush, 之后对 client 的 handle 进行清空。</span></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><h4 cid="n119" mdtype="heading" style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><strong style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: left;white-space: normal;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(0, 122, 170);box-sizing: border-box !important;overflow-wrap: break-word !important;">2. 场景还原</span></strong></span></h4><p><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><strong style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: left;white-space: normal;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(0, 122, 170);box-sizing: border-box !important;overflow-wrap: break-word !important;"><br  /></span></strong></span></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">Hudi 本身是具备 upsert 能力的，所以我们开始认为 Hudi Sink 在 At Least Once 模式下是没问题的，并且 At Least Once 模式下 Flink 算子不需要等待 Barrier 对齐，能够处理先到的数据使得处理速度更快，于是我们在 Copy On Write 场景中对 Flink CheckpointingMode 设置了 AT_LEAST_ONCE。</span></p><p style="text-align: left;line-height: 1.75em;"><br  /></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">writeFunction 的上游是文件&nbsp;<span md-inline="code" spellcheck="false" style="color: rgb(89, 89, 89);box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;"><code style="box-sizing: border-box;font-family: var(--monospace);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);background-color: rgb(243, 244, 244);border-radius: 3px;padding-right: 2px;padding-left: 2px;font-size: 0.9em;">BucketAssignFunction</code> </span>fileld 分配算子，假如有一批 insert 数据 A、B、C、D 属于同一个分区并且分配到同一个<span md-inline="code" spellcheck="false" style="color: rgb(89, 89, 89);box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;"><code style="box-sizing: border-box;font-family: var(--monospace);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);background-color: rgb(243, 244, 244);border-radius: 3px;padding-right: 2px;padding-left: 2px;font-size: 0.9em;">BucketAssignFunction</code> </span>的 subtask ,但是 A、B 和 C、D 是相邻两个不同的 checkpoint。</span></p><p style="text-align: left;line-height: 1.75em;"><br  /></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">当 A 进入<span md-inline="code" spellcheck="false" style="color: rgb(89, 89, 89);box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;"><code style="box-sizing: border-box;font-family: var(--monospace);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);background-color: rgb(243, 244, 244);border-radius: 3px;padding-right: 2px;padding-left: 2px;font-size: 0.9em;">BucketAssignFunction</code> </span>时如果发现没有新的小文件可以使用，就会创建一个新的 fileld f0，当 B 流入时也会给他分配到 f0 上。同时因为是 AT_LEAST_ONCE 模式，C、D 数据都有可能被处理到也被分配到了 f0 上。也就是说 在 AT_LEAST_ONCE 模式下由于 C、D 数据被提前处理，导致 A、B、C、D 4 条属于两个 checkpoint 的 insert 数据被分配到了同一个 fileld。</span></p><p style="text-align: left;line-height: 1.75em;"><br  /></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">writeFunction 有可能当接收到 A、B、C 后这个算子的 barrier 就对齐了，会把 A、B、C 进行 flush，而 D 将被遗留到下一个 checkpoint 才处理。A、B、C 是 insert 数据所以就会直接创建一个文件写入，D 属于下一个 checkpoint ，A、B、C 写入时创建的 handle 已被清理了，等到下一个 checkpoint 执行 flush。因为 D 也是 insert 数据所以也会直接创建一个文件写数据，但是 A、B、C、D 的 fileld 是一样的，导致最终 D 创建的文件覆盖了 A、B、C 写入的文件最终导致 A、B、C 数据丢失。</span></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><p cid="n86" mdtype="paragraph"><img data-ratio="0.2993262752646776" src="https://mmbiz.qpic.cn/mmbiz_png/8AsYBicEePu64ia5x6UjO8jCiajGm90hHRicicNicFZad3anMV2HaV33tiarapNHB4SsF1hCg8rkdjnaSkJxYLJgwdDQw/640?wx_fmt=png" data-type="png" data-w="1039" style="box-sizing: border-box;border-width: 0px 4px 0px 2px;border-right-style: solid;border-left-style: solid;border-right-color: transparent;border-left-color: transparent;vertical-align: middle;image-orientation: from-image;cursor: default;transform: translateZ(0px);display: block;margin: auto;"  /></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><h4 cid="n139" mdtype="heading" style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><strong style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: left;white-space: normal;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(0, 122, 170);box-sizing: border-box !important;overflow-wrap: break-word !important;">3. 问题定位</span></strong></span></h4><section style="text-align: left;line-height: 1.75em;"><br  /></section><section style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);">这个问题之所以难定位是因为具有一定随机性，每次丢失的数据都不太一样，而且小数据量不易出现。最终通过开启 Flink 的 Queryable State 进行查询, 查找丢失数据的定位到 fileld, 发现 ABCD state &nbsp;的 instant 都是 I，然后解析对应 fileld 的所有版本进行跟踪还原。</span></section><section style="text-align: left;line-height: 1.75em;"><br  /></section><section style="white-space: normal;outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box;caret-color: rgb(0, 0, 0);color: rgb(0, 0, 0);font-size: 16px;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="margin-top: 10px;margin-bottom: 10px;outline: 0px;max-width: 100%;box-sizing: border-box;text-align: center;overflow-wrap: break-word !important;"><section style="padding: 3px;outline: 0px;max-width: 100%;box-sizing: border-box;display: inline-block;border-bottom: 5px solid rgb(71, 193, 168);font-size: 18px;overflow-wrap: break-word !important;"><p cid="n68" mdtype="heading" style="outline: 0px;max-width: 100%;box-sizing: border-box;min-height: 1em;overflow-wrap: break-word !important;"><strong style="outline: 0px;max-width: 100%;box-sizing: border-box;overflow-wrap: break-word !important;">三、状态优化</strong></p></section></section></section></section></section></section><section style="white-space: normal;outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><br  /></section><section style="white-space: normal;outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;text-align: left;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">我们对线上最大的离线宽边进行了实时化的，宽表字段较多，涉及到多个表对主表的 left join 还包括一些 Top One 的计算，这些算子都会占用 state. &nbsp;而我们的数据周期较长需要保存 180 天数据。估算下来状态大小将会达到上百 T，这无疑会对状态的持久化带来很大的压力。但是这些操作放入 Hudi 来做就显得轻而易举。</span></section><section style="text-align: left;line-height: 1.75em;"><br  /></section><h4 cid="n141" mdtype="heading" style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><strong style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: left;white-space: normal;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(0, 122, 170);box-sizing: border-box !important;overflow-wrap: break-word !important;">1. Top One 下沉 Hudi</span></strong></span></h4><p><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><strong style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: left;white-space: normal;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(0, 122, 170);box-sizing: border-box !important;overflow-wrap: break-word !important;"><br  /></span></strong></span></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">在 Hudi 中有一个<span md-inline="code" spellcheck="false" style="font-size: 15px;color: rgb(89, 89, 89);box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;"><code style="box-sizing: border-box;font-family: var(--monospace);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);background-color: rgb(243, 244, 244);border-radius: 3px;padding-right: 2px;padding-left: 2px;font-size: 0.9em;">write.precombine.field</code> </span>配置项用来指定使用某个字段对 flush 的数据去重，当出现多条数据需要去重时就会按照整个字段进行比较，保留最大的那条记录，这其实和 Top One 很像。</span></p><p style="text-align: left;line-height: 1.75em;"><br  /></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">我们在 SQL 上将 Top One 的排序逻辑组合成了一个字段设置为 Hudi 的 <span md-inline="code" spellcheck="false" style="font-size: 15px;color: rgb(89, 89, 89);box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;"><code style="box-sizing: border-box;font-family: var(--monospace);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);background-color: rgb(243, 244, 244);border-radius: 3px;padding-right: 2px;padding-left: 2px;font-size: 0.9em;">write.precombine.field</code>，</span></span><span style="letter-spacing: 0.5px;"><span style="color: rgb(89, 89, 89);font-size: 15px;">同时把这个字段写入 state，同一 key 的数据多次进来时都会和 state 的<span md-inline="plain" style="color: rgb(89, 89, 89);box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;">&nbsp;</span></span><span style="box-sizing: border-box;caret-color: rgb(51, 51, 51);font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, &quot;Segoe UI Emoji&quot;, sans-serif;orphans: 4;text-align: start;white-space: pre-wrap;text-size-adjust: auto;color: rgb(89, 89, 89);font-size: 15px;"><code style="box-sizing: border-box;font-family: var(--monospace);border-width: 1px;border-style: solid;border-color: rgb(231, 234, 237);background-color: rgb(243, 244, 244);border-radius: 3px;padding-right: 2px;padding-left: 2px;font-size: 0.9em;">write.precombine.field</code> </span><span style="color: rgb(89, 89, 89);font-size: 15px;">进行比较更新。</span></span></p><p style="text-align: left;line-height: 1.75em;"><br  /></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">Flink Top One 的 state 默认是保存整记录的所有字段，但是我们只保存了一个字段，大大节省了 state 的大小。</span></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><h4 cid="n142" mdtype="heading" style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><strong style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: left;white-space: normal;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(0, 122, 170);box-sizing: border-box !important;overflow-wrap: break-word !important;">2. 多表 Left Join 下沉 Hudi</span></strong></span></h4><p><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><strong style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: left;white-space: normal;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(0, 122, 170);box-sizing: border-box !important;overflow-wrap: break-word !important;"><br  /></span></strong></span></p><h4 cid="n31" mdtype="heading" style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="color: rgb(89, 89, 89);letter-spacing: 0.5px;"><strong><span style="font-size: 15px;"><span style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">■&nbsp;</span>2.1 Flink SQL join</span></strong></span></h4><h5 cid="n49" mdtype="heading" style="text-align: left;line-height: 1.75em;"><br  /></h5><section style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);">我们把这个场景简化成如下一个案例，假如有宽表 t_p 由三张表组成</span></section><pre spellcheck="false" cid="n51" mdtype="fences" style="text-align: left;"><section style="line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><br  /></span></section><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul><pre class="code-snippet__js" data-lang="sql"><code><span class="code-snippet_outer"><span class="code-snippet__keyword">insert</span> <span class="code-snippet__keyword">into</span> t_p </span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">select</span> </span></code><code><span class="code-snippet_outer">    t0.id,t0.name,</span></code><code><span class="code-snippet_outer">    t1.age,           </span></code><code><span class="code-snippet_outer">    t2.sex </span></code><code><span class="code-snippet_outer"><span class="code-snippet__keyword">from</span> t0 </span></code><code><span class="code-snippet_outer">    <span class="code-snippet__keyword">left</span> <span class="code-snippet__keyword">join</span> t1 <span class="code-snippet__keyword">on</span> t0.id = t1.id </span></code><code><span class="code-snippet_outer">    left join t2 on t0.id = t2.id</span></code></pre></section><section style="line-height: 1.75em;"><br  /></section></pre><section style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);">在 Flink SQL join 算子内部会维护一个左表和右表的 state，这都是每个 table 的全字段，且多一次 join 就会多出一个 state. 最终导致 state 大小膨胀，如果 join 算子上游是一个 append 流，state 大小膨胀的效果更明显。</span></section><section style="text-align: left;line-height: 1.75em;"><br  /></section><h4 cid="n31" mdtype="heading" style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="color: rgb(89, 89, 89);letter-spacing: 0.5px;"><strong><span style="font-size: 15px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">■&nbsp;2.2 把 Join 改写成 Union All</span></strong></span></h4><h5 cid="n147" mdtype="heading" style="text-align: left;line-height: 1.75em;"><br  /></h5><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);">对于上面案例每次 left join 只是补充了几个字段，我们想到用 union all 的方式进行 SQL 改写，union all 需要补齐所有字段，缺的字段用 null 补。我们认为 null 补充的</span><span style="letter-spacing: 0.5px;color: rgb(89, 89, 89);font-size: 15px;">字段不是有效字段。改成从 union all 之后要求 Hudi 具备局部更新的能力才能达到 join 的效果。</span></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);letter-spacing: 0.5px;font-size: 15px;"><br  /></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li style="text-align: left;letter-spacing: 0.5px;font-size: 15px;"><p style="line-height: 1.75em;"><span style="color: rgb(89, 89, 89);letter-spacing: 0.5px;font-size: 15px;">当收到的数据是来自 t0 的时候就只更新 id 和 name 字段；</span></p></li></ul><p style="text-align: left;line-height: 1.75em;"><br  /></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li style="text-align: left;letter-spacing: 0.5px;font-size: 15px;"><p style="line-height: 1.75em;"><span style="color: rgb(89, 89, 89);letter-spacing: 0.5px;font-size: 15px;">同理 ，数据是来自 t1 的时候就只更新 age 字段；</span></p></li></ul><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);letter-spacing: 0.5px;font-size: 15px;"><br  /></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li style="text-align: left;letter-spacing: 0.5px;font-size: 15px;"><p style="line-height: 1.75em;"><span style="color: rgb(89, 89, 89);letter-spacing: 0.5px;font-size: 15px;">t2 只更新 sex 字段。</span></p></li></ul><section style="text-align: left;line-height: 1.75em;"><br  /></section><section style="text-align: left;line-height: 1.75em;"><span style="letter-spacing: 0.5px;font-size: 15px;color: rgb(89, 89, 89);">不幸的是 Hudi 的默认实现是全字段覆盖，也就是说当收到 t0 的数据时会把 age sex 覆盖成 null, 收到 t1 数据时会把 name sex 覆盖成 null。这显然是不可接受的。这就要求我们对 Hudi sink 进行改造。</span></section><section style="text-align: left;line-height: 1.75em;"><br  /></section><h4 cid="n31" mdtype="heading" style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="font-size: 15px;letter-spacing: 0.5px;color: rgb(89, 89, 89);"><strong><span style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">■&nbsp;2.3 Hudi &nbsp;Union All 实现</span></strong></span></h4><h5 cid="n148" mdtype="heading" style="text-align: left;line-height: 1.75em;"><br  /></h5><section style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">Hudi 在 cow 模式每条记录的更新写入都是对旧数据进行 copy 覆盖写入，似乎只要知道这条记录来自哪个表，哪几个字段是有效的字段就选择性的对 copy 出来的字段进行覆盖即可。但是在分区变更的场景中就不是那么好使了。在分区变更的场景中，数据从一个分区变到另一个分区的逻辑是把旧分区数据删掉，往新分区新增数据。这可能会把一些之前局部更新的字段信息丢失掉。细聊下来 Hudi on Flink 涉及到由几个核心算子组成 pipeline。</span></section><section style="text-align: left;line-height: 1.75em;"><br  /></section><p cid="n57" mdtype="paragraph"><img data-ratio="0.12054120541205413" src="https://mmbiz.qpic.cn/mmbiz_png/8AsYBicEePu64ia5x6UjO8jCiajGm90hHRicpjVt4rU2Iwjic3leGjdjWNePkvsvmkwGb2EiaA2AoU8vibDI71BBB7Yyw/640?wx_fmt=png" data-type="png" data-w="813" style="box-sizing: border-box;border-width: 0px 4px 0px 2px;border-right-style: solid;border-left-style: solid;border-right-color: transparent;border-left-color: transparent;vertical-align: middle;image-orientation: from-image;cursor: default;transform: translateZ(0px);display: block;margin: auto;"  /></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><ul class="list-paddingleft-2" style="list-style-type: disc;"><li style="font-size: 15px;text-align: left;letter-spacing: 0.5px;"><section style="line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;"><strong><span style="color: rgb(89, 89, 89);">RowDataToHoodieFunction：</span></strong><span style="color: rgb(89, 89, 89);">这是对收入的数据进行转化成一个 HudiRecord，收到数据是包含全字段的，我们在转化 HudiRecord 的时候只选择了有效字段进行转化。</span></span></section></li></ul><section style="text-align: left;line-height: 1.75em;"><br  /></section><ul class="list-paddingleft-2" style="list-style-type: disc;"><li style="font-size: 15px;text-align: left;letter-spacing: 0.5px;"><section style="line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;"><strong><span style="color: rgb(89, 89, 89);">BoostrapFunction：</span></strong><span style="color: rgb(89, 89, 89);">在任务恢复的时候会读取文件加载索引数据，当任务恢复后次算子不做数据转化处理。</span></span></section></li></ul><section style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;"><br  /></span></section><ul class="list-paddingleft-2" style="list-style-type: disc;"><li style="font-size: 15px;text-align: left;letter-spacing: 0.5px;"><section style="line-height: 1.75em;"><span style="font-size: 15px;letter-spacing: 0.5px;"><strong><span style="color: rgb(89, 89, 89);">BucketAssignFunction：</span></strong><span style="color: rgb(89, 89, 89);">这个算子用来对记录分配 location，loaction 包含两部分信息。一是分区目录，另一个是 fileld。fileld 用来标识记录将写入哪个文件，一旦记录被确定写入哪个文件，就会发记录按照 fileld 分组发送到 StreamWriteFunction，StreamWriteFunction 再按文件进行批量写入。</span></span></section></li></ul><section style="text-align: left;line-height: 1.75em;"><br  /></section><section style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">原生的 BucketAssignFunction 的算子逻辑如下图，当收到一条记录时会先从 state 里面进行查找是否之前有写过这条记录，如果有就会找对应的 location。如果分区没有发生变更，就把当前这条记录也分配给这个location，如果在 state 中没有找到 location 就会新创建一个 location，把这个新的location 分配给当前记录，并更新到 state。</span></section><section style="text-align: left;line-height: 1.75em;"><br  /></section><section style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">总之这个 state 存储的 location 就是告诉当前记录应该从哪个文件进行更新或者写入。遇到分区变更的场景会复杂一点。假如一条记录从 2020 分区变更成了 2021，就会创建一条删除的记录，它的 loaction 是 state 中的 location。这条记录让下游进行实际的删除操作，然后再创建一个新的 location (分区是 2021) 发送到下游进行 insert。</span></section><section style="text-align: left;line-height: 1.75em;"><br  /></section><p cid="n100" mdtype="paragraph"><img data-ratio="0.5756929637526652" src="https://mmbiz.qpic.cn/mmbiz_png/8AsYBicEePu64ia5x6UjO8jCiajGm90hHRicoV0icO3SEt0iaoicyWCxD2tvTEh24fItJ1vSTXTQr1vqW3LvLn5HLIXfg/640?wx_fmt=png" data-type="png" data-w="938" style="box-sizing: border-box;border-width: 0px 4px 0px 2px;border-right-style: solid;border-left-style: solid;border-right-color: transparent;border-left-color: transparent;vertical-align: middle;image-orientation: from-image;cursor: default;transform: translateZ(0px);display: block;margin: auto;"  /></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><p style="text-align: left;line-height: 1.75em;"><span style="letter-spacing: 0.5px;font-size: 15px;color: rgb(89, 89, 89);">为了在 Hudi 中实现 top one，我们对 state 信息进行了扩展，用来做 Top One 时间字段。</span></p><p style="text-align: left;line-height: 1.75em;"><span style="letter-spacing: 0.5px;font-size: 15px;color: rgb(89, 89, 89);"><br  /></span></p><section style="text-align: left;line-height: 1.75em;"><span style="letter-spacing: 0.5px;font-size: 15px;color: rgb(89, 89, 89);">对于 StreamWriteFunction 在 Insert 场景中，假如收到了如下 3 条数据 {id:1,name:zs}，{id:1,age:20}，{id:1,sex:man}，在执行 flush 时会创建一个全字段的空记录 {id:null,name:null,age:null,sex:null}，然后依次和 3 条记录进行合并。注意，这个合并过程只会选择有效字段的合并。如下图：</span></section><section style="text-align: left;line-height: 1.75em;"><br  /></section><p cid="n104" mdtype="paragraph"><img data-ratio="0.690846286701209" src="https://mmbiz.qpic.cn/mmbiz_png/8AsYBicEePu64ia5x6UjO8jCiajGm90hHRicoIriaTtuEmrNP8CBnXPQ8lKFb0E9WceYSLgszKnmBLlhcHDMP9Qt2Pw/640?wx_fmt=png" data-type="png" data-w="579" style="box-sizing: border-box;border-width: 0px 4px 0px 2px;border-right-style: solid;border-left-style: solid;border-right-color: transparent;border-left-color: transparent;vertical-align: middle;image-orientation: from-image;cursor: default;transform: translateZ(0px);display: block;margin: auto;"  /></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;">在 Update 场景中的更新逻辑类似 insert 场景，假如老数据是 {id:1,name:zs,age:20,sex:man} ，新收到了{id:1,name:ls}，{id:1,age:30} 这 2 条数据，就会先从文件中把老的数据读出来，然后依次和新收到的数据进行合并，合并步骤同 insert。如下图：</span></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><p cid="n107" mdtype="paragraph"><img data-ratio="0.576214405360134" src="https://mmbiz.qpic.cn/mmbiz_png/8AsYBicEePu64ia5x6UjO8jCiajGm90hHRicoaugAqOJpuFB9M4feXcbBbSeDdk9JBprNokLWkiaHLa0mlSj7JZhGeg/640?wx_fmt=png" data-type="png" data-w="597" style="box-sizing: border-box;border-width: 0px 4px 0px 2px;border-right-style: solid;border-left-style: solid;border-right-color: transparent;border-left-color: transparent;vertical-align: middle;image-orientation: from-image;cursor: default;transform: translateZ(0px);display: block;margin: auto;"  /></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;">这样通过 union all 的方式达到了 left join 的效果，大大节省了 state 的大小。</span></p><section style="text-align: left;line-height: 1.75em;"><br  /></section><section style="white-space: normal;outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section style="outline: 0px;max-width: 100%;box-sizing: border-box;caret-color: rgb(0, 0, 0);color: rgb(0, 0, 0);font-size: 16px;overflow-wrap: break-word !important;"><section powered-by="xiumi.us" style="margin-top: 10px;margin-bottom: 10px;outline: 0px;max-width: 100%;box-sizing: border-box;text-align: center;overflow-wrap: break-word !important;"><section style="padding: 3px;outline: 0px;max-width: 100%;box-sizing: border-box;display: inline-block;border-bottom: 5px solid rgb(71, 193, 168);font-size: 18px;overflow-wrap: break-word !important;"><p cid="n68" mdtype="heading" style="outline: 0px;max-width: 100%;box-sizing: border-box;min-height: 1em;overflow-wrap: break-word !important;"><strong style="outline: 0px;max-width: 100%;box-sizing: border-box;overflow-wrap: break-word !important;">四、未来规划</strong></p></section></section></section></section></section></section><section style="white-space: normal;outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;text-align: left;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;"><br  /></span></section><p style="white-space: normal;outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="font-size: 15px;color: rgb(89, 89, 89);text-align: left;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.5px;">parquet 元数据信息收集，parquet 文件可以从 footer 里面得到每个行列的最大最小等信息，我们计划在写入文件的后把这些信息收集起来，并且基于上一次的 commit &nbsp;的元数据信息进行合并，生成一个包含所有文件的元数据文件，这样可以在读取数据时进行谓词下推进行文件的过滤。<br  /></span></p><p style="text-align: left;line-height: 1.75em;"><br  /></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;">公司致力于打造基于 Hudi 作为底层存储，Flink 作为流批一体化的 SQL 计算引擎，Flink 的批处理 Hudi 这块还涉足不深，未来可能会计划用 Flink 对 Hudi 实现 clustering 等功能，在 Flink 引擎上完善 Hudi 的批处理功能。</span></p><p style="text-align: left;line-height: 1.75em;"><span style="color: rgb(89, 89, 89);font-size: 15px;letter-spacing: 0.5px;"><br  /></span></p><hr style="border-style: solid;border-width: 1px 0 0;border-color: rgba(0,0,0,0.1);-webkit-transform-origin: 0 0;-webkit-transform: scale(1, 0.5);transform-origin: 0 0;transform: scale(1, 0.5);"  /><p style="text-align: left;line-height: 1.75em;"><br  /></p><section style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;letter-spacing: 0.5px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="outline: 0px;max-width: 100%;color: rgb(217, 78, 106);font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;font-size: 15px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">热点推荐</span></strong></span></section><section style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU2ODQ3NjYyMA==&amp;mid=2247486981&amp;idx=2&amp;sn=f4a1eb7e7d649407d9cf34c26342090b&amp;chksm=fc8c18a6cbfb91b00b414501f4f0128e32627ea02242b250cc4c77e288d435d89d162f4f0915&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">数据库、数据仓库、大数据平台、数据中台、数据湖对比分析</a></section><section style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"  /></section><hr style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);border-style: solid;border-right-width: 0px;border-bottom-width: 0px;border-left-width: 0px;border-color: rgba(0, 0, 0, 0.1);transform-origin: 0px 0px;transform: scale(1, 0.5);box-sizing: border-box !important;overflow-wrap: break-word !important;"  /><p style="outline: 0px;max-width: 100%;min-height: 1em;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"  /></p><section style="outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;color: rgb(89, 89, 89);font-size: 15px;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.5px;box-sizing: border-box !important;overflow-wrap: break-word !important;">更多 Flink 相关技术问题，可扫码加入交流群～</span></section><p style="text-align: center;"><img class="rich_pages wxw-img" data-ratio="0.5555555555555556" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/PL10rfzHicsgYic9icrPjCqicQZOqicicQRjOr9ka3KSCgElNV1HLd89YxT5NMTUmMwhGyE7KFVo2I11Rta7icUMP2muA/640?wx_fmt=png" data-type="png" data-w="900" style=""  /></p><p style="outline: 0px;max-width: 100%;min-height: 1em;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;line-height: 1.75em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;font-size: 15px;color: rgb(89, 89, 89);letter-spacing: 0.5px;box-sizing: border-box !important;overflow-wrap: break-word !important;">&nbsp;<img class="__bg_gif" data-ratio="1" data-type="gif" data-w="400" src="https://mmbiz.qpic.cn/mmbiz_gif/Z6bicxIx5naLWBBEcl44aIic1Mthe1nZiaramW5s4e8WwyCYYbTzu6uPBpgI6sxNXNymEnOYKpJpcrItUia7lS64mA/640?wx_fmt=gif" style="outline: 0px;color: rgb(62, 62, 62);font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.54px;display: inline-block;vertical-align: middle;box-sizing: border-box !important;overflow-wrap: break-word !important;visibility: visible !important;width: 36px !important;"  />&nbsp;&nbsp;</span><span style="outline: 0px;max-width: 100%;color: rgb(217, 78, 106);font-family: &quot;Microsoft YaHei&quot;, &quot;Segoe UI&quot;, system-ui, Roboto, &quot;Droid Sans&quot;, &quot;Helvetica Neue&quot;, sans-serif, Tahoma, &quot;Segoe UI SymbolMyanmar Text&quot;, 微软雅黑;font-size: 12px;white-space: pre-wrap;letter-spacing: 0.5px;box-sizing: border-box !important;overflow-wrap: break-word !important;">戳我，查看更多技术文章！</span><br  /></p><div class="msg_source_url"><a href="https://t.1yb.co/dkIa" target="_blank">阅读原文</a></div></content><div class="msg_source_url"><a href="https://t.1yb.co/dkIa" target="_blank">阅读原文</a></div>
</div>
</body>
</html>