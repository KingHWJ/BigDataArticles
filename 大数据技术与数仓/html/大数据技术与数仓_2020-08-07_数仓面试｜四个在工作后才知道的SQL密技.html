<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 0 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic{color:#8e8e8e;background:#f7f7f7;border-radius:5px;padding:10px 8px;}.topic a{padding-right:5px;}.topic p{margin-bottom:5px;}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head><script>
var data={"mp":"大数据技术与数仓","title":"数仓面试|四个在工作后才知道的SQL密技","time":"2020-08-07 08:30:00","timeStamp":"1596760200"};
</script>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="http://mp.weixin.qq.com/s?__biz=MzU2ODQ3NjYyMA==&mid=2247484865&idx=1&sn=ffcb7f1f56aa8d5df61386778491677a&chksm=fc8c1362cbfb9a7480c5c5a1cfa07d3d586cca75c15e4ab95eb1bf750972d87c34875a7b8eb2#rd" target="_blank">数仓面试|四个在工作后才知道的SQL密技</a></h1><div id="meta_content" class="rich_media_meta_list"><span id="copyright_logo" class="wx_tap_link js_wx_tap_highlight rich_media_meta icon_appmsg_tag appmsg_title_tag weui-wa-hotarea">原创&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_text">西贝&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">大数据技术与数仓&nbsp;&nbsp;</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2020-08-07 08:30:00</em></div><content><div class="topic"><p>收录于话题</p><p><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU2ODQ3NjYyMA==&action=getalbum&album_id=1344435576086560769#wechat_redirect" title="数仓" target="_blank">#数仓</a></p></div><section style="display:none;" data-tools="新媒体管家" data-label="powered by xmt.cn" data-mpa-powered-by="yiban.io"><br  /></section><p><br  /></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;line-height: 1.6;word-break: break-word;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 15px;letter-spacing: 0.05em;color: rgb(89, 89, 89);"><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">SQL是大数据从业者的必备技能，大部分的大数据技术框架也都提供了SQL的解决方案。可以说SQL是一种经久不衰、历久弥新的编程语言。尤其是在数仓领域，使用SQL更是家常便饭。本文会分享四个在面试和工作中常用的几个使用技巧，具体包括：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">日期与期间的使用</section></li><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">临时表与Common Table Expression (WITH)</section></li><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">Aggregation 与CASE WHEN的结合使用</section></li><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">Window Function的其他用途</section></li></ul><blockquote data-tool="mdnice编辑器" style="font-size: 0.9em;overflow: auto;padding: 10px 10px 10px 20px;margin: 10px 5px;border-left-color: rgb(53, 179, 120);border-right: 0px solid rgb(53, 179, 120);color: rgb(97, 97, 97);quotes: none;background: rgb(251, 249, 253);"><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;">数仓？不就是写写SQL吗…</p></blockquote><h2 data-tool="mdnice编辑器" style="line-height: 32px;color: rgb(53, 179, 120);display: inline-block;border-bottom: 0px solid rgb(53, 179, 120);border-top-color: rgb(53, 179, 120);border-right-color: rgb(53, 179, 120);border-left-color: rgb(53, 179, 120);font-size: 23px;margin-top: 1em;margin-bottom: 0rem;padding-top: 0.5em;padding-bottom: 0.5em;font-weight: bold;"><span style="display: none;"></span></h2></section><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="1" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/PL10rfzHicsh4hj0fj4Y2sT2icWRS8x3Sfdo0v8x7wsJ48o1gbeZjicu3hBicNkwLPzyic9eW8ASvQd9IlG60d17bPw/640?wx_fmt=jpeg" data-type="jpeg" data-w="200" style=""  /></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;line-height: 1.6;word-break: break-word;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 15px;letter-spacing: 0.05em;color: rgb(89, 89, 89);"><h2 data-tool="mdnice编辑器" style="line-height: 32px;color: rgb(53, 179, 120);display: inline-block;border-bottom: 0px solid rgb(53, 179, 120);border-top-color: rgb(53, 179, 120);border-right-color: rgb(53, 179, 120);border-left-color: rgb(53, 179, 120);font-size: 23px;margin-top: 1em;margin-bottom: 0rem;padding-top: 0.5em;padding-bottom: 0.5em;font-weight: bold;">第一：日期与期间的使用</h2><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">日期与时间段的筛选在工作中是经常被用到的，因为在拉取报表、仪表板和各种分析时，周、月、季度、年度的表现往往是分析需要考量的重点。</p><h3 data-tool="mdnice编辑器" style="font-size: 20px;margin-top: 1.2em;margin-bottom: 1em;font-weight: bold;color: rgb(53, 179, 120);"><span style="display: none;"></span>时间区段的提取：Extract<span style="display: none;"></span></h3><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">语法</section></li></ul><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;field可以是day、hour、minute,&nbsp;month,&nbsp;quarter等等</span><br  /><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;source可以是date、timestamp类型</span><br  />extract(field&nbsp;FROM&nbsp;source)<br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">使用</section></li></ul><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">extract</span>(<span style="font-weight: bold;line-height: 26px;">year</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;<span style="color: #d14;line-height: 26px;">'2020-08-05&nbsp;09:30:08'</span>);&nbsp;&nbsp;&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;结果为&nbsp;2020</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">extract</span>(<span style="font-weight: bold;line-height: 26px;">quarter</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;<span style="color: #d14;line-height: 26px;">'2020-08-05&nbsp;09:30:08'</span>);&nbsp;&nbsp;&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;结果为&nbsp;3</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">extract</span>(<span style="font-weight: bold;line-height: 26px;">month</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;<span style="color: #d14;line-height: 26px;">'2020-08-05&nbsp;09:30:08'</span>);&nbsp;&nbsp;&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;结果为&nbsp;8</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">extract</span>(<span style="font-weight: bold;line-height: 26px;">week</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;<span style="color: #d14;line-height: 26px;">'2020-08-05&nbsp;09:30:08'</span>);&nbsp;&nbsp;&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;结果为&nbsp;31,一年中的第几周</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">extract</span>(<span style="font-weight: bold;line-height: 26px;">day</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;<span style="color: #d14;line-height: 26px;">'2020-08-05&nbsp;09:30:08'</span>);&nbsp;&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;结果为&nbsp;5</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">extract</span>(<span style="font-weight: bold;line-height: 26px;">hour</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;<span style="color: #d14;line-height: 26px;">'2020-08-05&nbsp;09:30:08'</span>);&nbsp;&nbsp;&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;结果为&nbsp;9</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">extract</span>(<span style="font-weight: bold;line-height: 26px;">minute</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;<span style="color: #d14;line-height: 26px;">'2020-08-05&nbsp;09:30:08'</span>);&nbsp;&nbsp;&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;结果为&nbsp;30</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">extract</span>(<span style="font-weight: bold;line-height: 26px;">second</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;<span style="color: #d14;line-height: 26px;">'2020-08-05&nbsp;09:30:08'</span>);&nbsp;&nbsp;&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;结果为&nbsp;8</span><br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">上面可供提取的字段，不同的数据库存在些许的差异。以Hive为例，支持<code style="font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(53, 179, 120);">day, dayofweek, hour, minute, month, quarter, second, week 和 year</code>。其中周、月、年使用最为广泛，因为无论是公司内部产品，还是商用的产品所提供的数据后台统计，周报和月报(比如近7天、近30天)最注重表现的周期。</p><blockquote data-tool="mdnice编辑器" style="font-size: 0.9em;overflow: auto;padding: 10px 10px 10px 20px;margin: 10px 5px;border-left-color: rgb(53, 179, 120);border-right: 0px solid rgb(53, 179, 120);color: rgb(97, 97, 97);quotes: none;background: rgb(251, 249, 253);"><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;">注意：</p><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;">impala支持：YEAR, QUARTER, MONTH, DAY, HOUR, MINUTE, SECOND, MILLISECOND, EPOCH</p><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;">Hive支持：day, dayofweek, hour, minute, month, quarter, second, week 和 year</p><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;">Hive是从<strong style="color: rgb(53, 179, 120);">Hive2.2.0</strong>版本开始引入该函数</p></blockquote><h3 data-tool="mdnice编辑器" style="font-size: 20px;margin-top: 1.2em;margin-bottom: 1em;font-weight: bold;color: rgb(53, 179, 120);"><span style="display: none;"></span>周的提取<span style="display: none;"></span></h3><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">语法</section></li></ul><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">在按照周的区间进行统计时，需要识别出周一的日期与周日的日期，这个时候经常会用到下面的函数：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">next_day(STRING&nbsp;start_date,&nbsp;STRING&nbsp;day_of_week)<br  /><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;返回当前日期对应的下一个周几对应的日期</span><br  /><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;2020-08-05为周三</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;next_day(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>,<span style="color: #d14;line-height: 26px;">'MO'</span>)&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;下一个周一对应的日期：2020-08-10</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;next_day(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>,<span style="color: #d14;line-height: 26px;">'TU'</span>)&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;下一个周二对应的日期：2020-08-11</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;next_day(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>,<span style="color: #d14;line-height: 26px;">'WE'</span>)&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;下一个周三对应的日期：2020-08-12</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;next_day(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>,<span style="color: #d14;line-height: 26px;">'TH'</span>)&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;下一个周四对应的日期：2020-08-06，即为本周四</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;next_day(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>,<span style="color: #d14;line-height: 26px;">'FR'</span>)&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;下一个周五对应的日期：2020-08-07，即为本周五</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;next_day(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>,<span style="color: #d14;line-height: 26px;">'SA'</span>)&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;下一个周六对应的日期：2020-08-08，即为本周六</span><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;next_day(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>,<span style="color: #d14;line-height: 26px;">'SU'</span>)&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;下一个周日对应的日期：2020-08-09，即为本周日</span><br  /><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;星期一到星期日的英文（Monday，Tuesday、Wednesday、Thursday、Friday、Saturday、Sunday）</span><br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">使用</section></li></ul><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">那么该如何获取当前日期所在周的周一对应的日期呢？只需要先获取当前日期的下周一对应的日期，然后减去7天，即可获得：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">date_add</span>(next_day(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>,<span style="color: #d14;line-height: 26px;">'MO'</span>),<span style="color: #008080;line-height: 26px;">-7</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">同理，获取当前日期所在周的周日对应的日期，只需要先获取当前日期的下周一对应的日期，然后减去1天，即可获得：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">select</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">date_add</span>(next_day(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>,<span style="color: #d14;line-height: 26px;">'MO'</span>),<span style="color: #008080;line-height: 26px;">-1</span>)&nbsp;<br  /><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;2020-08-09</span><br  /></code></pre><h3 data-tool="mdnice编辑器" style="font-size: 20px;margin-top: 1.2em;margin-bottom: 1em;font-weight: bold;color: rgb(53, 179, 120);"><span style="display: none;"></span>月的提取<span style="display: none;"></span></h3><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">语法</section></li></ul><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">至于怎么将月份从单一日期提取出来呢，LAST_DAY这个函数可以将每个月中的日期变成该月的最后一天(28号，29号，30号或31号)，如下：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">last_day(STRING&nbsp;date)<br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">使用</section></li></ul><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">last_day</span>(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>);&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;2020-08-31</span><br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">除了上面的方式，也可以使用date_format函数，比如：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">date_format</span>(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>,<span style="color: #d14;line-height: 26px;">'yyyy-MM'</span>);<br  /><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;2020-08</span><br  /></code></pre><h3 data-tool="mdnice编辑器" style="font-size: 20px;margin-top: 1.2em;margin-bottom: 1em;font-weight: bold;color: rgb(53, 179, 120);"><span style="display: none;"></span>日期的范围<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">月的Window：使用add_months加上trunc()的应用</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;返回加减月份之后对应的日期</span><br  /><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;2020-07-05</span><br  /><span style="font-weight: bold;line-height: 26px;">select</span>&nbsp;add_months(<span style="color: #d14;line-height: 26px;">'2020-08-05'</span>,&nbsp;<span style="color: #008080;line-height: 26px;">-1</span>)<br  /><br  /><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;返回当前日期的月初日期</span><br  /><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;2020-08-01</span><br  /><span style="font-weight: bold;line-height: 26px;">select</span>&nbsp;trunc(<span style="color: #d14;line-height: 26px;">"2020-08-05"</span>,<span style="color: #d14;line-height: 26px;">'MM'</span>)<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">由上面范例可见，单纯使用add_months，减N个月的用法，可以刚好取到整数月的数据，但如果加上trunc()函数，则会从前N个月的一号开始取值。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;选取2020-07-05到2020-08-05所有数据</span><br  />BETWEEN&nbsp;add_months('2020-08-05',&nbsp;-1)&nbsp;AND&nbsp;'2020-08-05'&nbsp;<br  /><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;选取2020-07-01到2020-08-05之间所有数据</span><br  />BETWEEN&nbsp;add_months(trunc("2020-08-05",'MM'),-1)&nbsp;AND&nbsp;'2020-08-05'&nbsp;<br  /></code></pre><h2 data-tool="mdnice编辑器" style="line-height: 32px;color: rgb(53, 179, 120);display: inline-block;border-bottom: 0px solid rgb(53, 179, 120);border-top-color: rgb(53, 179, 120);border-right-color: rgb(53, 179, 120);border-left-color: rgb(53, 179, 120);font-size: 23px;margin-top: 1em;margin-bottom: 0rem;padding-top: 0.5em;padding-bottom: 0.5em;font-weight: bold;"><span style="display: none;"></span>第二：临时表与Common Table Expression (WITH)</h2><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">这两种方法是日常工作中经常被使用到，对于一些比较复杂的计算任务，为了避免过多的JOIN，通常会先把一些需要提取的部分数据使用临时表或是CTE的形式在主要查询区块前进行提取。</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;"><strong style="color: rgb(53, 179, 120);">临时表的作法：</strong></p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">CREATE&nbsp;TEMPORARY&nbsp;TABLE&nbsp;table_1&nbsp;AS&nbsp;&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;columns<br  />&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;table&nbsp;A;<br  />CREATE&nbsp;TEMPORARY&nbsp;table_2&nbsp;AS&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;SELECT<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;columns<br  />&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;table&nbsp;B;<br  /><br  />SELECT<br  />&nbsp;&nbsp;&nbsp;&nbsp;table_1.columns,<br  />&nbsp;&nbsp;&nbsp;&nbsp;table_2.columns,&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;c.columns&nbsp;<br  />FROM&nbsp;table&nbsp;C&nbsp;JOIN&nbsp;table_1<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JOIN&nbsp;table_2;<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;"><strong style="color: rgb(53, 179, 120);">CTE的作法：</strong></p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;注意Hive、Impala支持这种语法，低版本的MySQL不支持(高版本支持)<br  />WITH&nbsp;employee_by_title_count&nbsp;AS&nbsp;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;SELECT<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.name&nbsp;as&nbsp;job_title<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;COUNT(e.id)&nbsp;as&nbsp;amount_of_employees<br  />&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;employees&nbsp;e<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JOIN&nbsp;job_titles&nbsp;t&nbsp;on&nbsp;e.job_title_id&nbsp;=&nbsp;t.id<br  />&nbsp;&nbsp;&nbsp;&nbsp;GROUP&nbsp;BY&nbsp;1<br  />),<br  />salaries_by_title&nbsp;AS&nbsp;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;as&nbsp;job_title<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;salary<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;job_titles<br  />)<br  />SELECT&nbsp;*<br  />FROM&nbsp;employee_by_title_count&nbsp;e<br  />&nbsp;&nbsp;&nbsp;&nbsp;JOIN&nbsp;salaries_by_title&nbsp;s&nbsp;ON&nbsp;s.job_title&nbsp;=&nbsp;e.job_title<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">可以看到TEMP TABLE和CTE WITH的用法其实非常类似，目的都是为了让你的Query更加一目了然且优雅简洁。很多人习惯将所有的Query写在单一的区块里面，用过多的JOIN或SUBQUERY，导致最后逻辑丢失且自己也搞不清楚写到哪里，适时的使用TEMP TABLE和CTE作为辅助，绝对是很加分的。</p><h2 data-tool="mdnice编辑器" style="line-height: 32px;color: rgb(53, 179, 120);display: inline-block;border-bottom: 0px solid rgb(53, 179, 120);border-top-color: rgb(53, 179, 120);border-right-color: rgb(53, 179, 120);border-left-color: rgb(53, 179, 120);font-size: 23px;margin-top: 1em;margin-bottom: 0rem;padding-top: 0.5em;padding-bottom: 0.5em;font-weight: bold;"><span style="display: none;"></span>第三：Aggregation 与CASE WHEN的结合使用</h2><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">将Aggregation function (SUM/COUNT/COUNT DISTINCT/MIN/MAX) 结合CASE WHEN是最强大且最有趣的使用方式。这样的使用创造出一种类似EXCEL中SUMIF/COUNTIF的效果，可以用这个方式做出很多高效的分析。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">Table Name: order</section></li><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">Column: register_date, order_date, user_id, country, order_sales, order_id</section></li></ul><h3 data-tool="mdnice编辑器" style="font-size: 20px;margin-top: 1.2em;margin-bottom: 1em;font-weight: bold;color: rgb(53, 179, 120);"><span style="display: none;"></span>数据准备<span style="display: none;"></span></h3><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">CREATE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>(<br  />&nbsp;&nbsp;&nbsp;&nbsp;register_date&nbsp;<span style="font-weight: bold;line-height: 26px;">string</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;order_date&nbsp;<span style="font-weight: bold;line-height: 26px;">string</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;user_id&nbsp;<span style="font-weight: bold;line-height: 26px;">string</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;country&nbsp;<span style="font-weight: bold;line-height: 26px;">string</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;order_sales&nbsp;<span style="color: #0086b3;line-height: 26px;">decimal</span>(<span style="color: #008080;line-height: 26px;">10</span>,<span style="color: #008080;line-height: 26px;">2</span>),<br  />&nbsp;&nbsp;&nbsp;&nbsp;order_id&nbsp;<span style="font-weight: bold;line-height: 26px;">string</span>);<br  /><br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-07"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-09"</span>,<span style="color: #d14;line-height: 26px;">"001"</span>,<span style="color: #d14;line-height: 26px;">'c0'</span>,<span style="color: #008080;line-height: 26px;">210</span>,<span style="color: #d14;line-height: 26px;">"o1"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-08"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-09"</span>,<span style="color: #d14;line-height: 26px;">"002"</span>,<span style="color: #d14;line-height: 26px;">'c1'</span>,<span style="color: #008080;line-height: 26px;">220</span>,<span style="color: #d14;line-height: 26px;">"o2"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-07"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-10"</span>,<span style="color: #d14;line-height: 26px;">"003"</span>,<span style="color: #d14;line-height: 26px;">'c2'</span>,<span style="color: #008080;line-height: 26px;">230</span>,<span style="color: #d14;line-height: 26px;">"o3"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-09"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-10"</span>,<span style="color: #d14;line-height: 26px;">"004"</span>,<span style="color: #d14;line-height: 26px;">'c3'</span>,<span style="color: #008080;line-height: 26px;">200</span>,<span style="color: #d14;line-height: 26px;">"o4"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-07"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-20"</span>,<span style="color: #d14;line-height: 26px;">"005"</span>,<span style="color: #d14;line-height: 26px;">'c4'</span>,<span style="color: #008080;line-height: 26px;">300</span>,<span style="color: #d14;line-height: 26px;">"o5"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-10"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-23"</span>,<span style="color: #d14;line-height: 26px;">"006"</span>,<span style="color: #d14;line-height: 26px;">'c5'</span>,<span style="color: #008080;line-height: 26px;">400</span>,<span style="color: #d14;line-height: 26px;">"o6"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-07"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-19"</span>,<span style="color: #d14;line-height: 26px;">"007"</span>,<span style="color: #d14;line-height: 26px;">'c6'</span>,<span style="color: #008080;line-height: 26px;">600</span>,<span style="color: #d14;line-height: 26px;">"o7"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-12"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-18"</span>,<span style="color: #d14;line-height: 26px;">"008"</span>,<span style="color: #d14;line-height: 26px;">'c7'</span>,<span style="color: #008080;line-height: 26px;">700</span>,<span style="color: #d14;line-height: 26px;">"o8"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-07"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-09"</span>,<span style="color: #d14;line-height: 26px;">"009"</span>,<span style="color: #d14;line-height: 26px;">'c8'</span>,<span style="color: #008080;line-height: 26px;">100</span>,<span style="color: #d14;line-height: 26px;">"o9"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-15"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-18"</span>,<span style="color: #d14;line-height: 26px;">"0010"</span>,<span style="color: #d14;line-height: 26px;">'c9'</span>,<span style="color: #008080;line-height: 26px;">200</span>,<span style="color: #d14;line-height: 26px;">"o10"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-15"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-19"</span>,<span style="color: #d14;line-height: 26px;">"0011"</span>,<span style="color: #d14;line-height: 26px;">'c10'</span>,<span style="color: #008080;line-height: 26px;">250</span>,<span style="color: #d14;line-height: 26px;">"o11"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-12"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-29"</span>,<span style="color: #d14;line-height: 26px;">"0012"</span>,<span style="color: #d14;line-height: 26px;">'c11'</span>,<span style="color: #008080;line-height: 26px;">270</span>,<span style="color: #d14;line-height: 26px;">"o12"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-16"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-19"</span>,<span style="color: #d14;line-height: 26px;">"0013"</span>,<span style="color: #d14;line-height: 26px;">'c12'</span>,<span style="color: #008080;line-height: 26px;">230</span>,<span style="color: #d14;line-height: 26px;">"o13"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-17"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-20"</span>,<span style="color: #d14;line-height: 26px;">"0014"</span>,<span style="color: #d14;line-height: 26px;">'c13'</span>,<span style="color: #008080;line-height: 26px;">290</span>,<span style="color: #d14;line-height: 26px;">"o14"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"2020-06-20"</span>,<span style="color: #d14;line-height: 26px;">"2020-06-29"</span>,<span style="color: #d14;line-height: 26px;">"0015"</span>,<span style="color: #d14;line-height: 26px;">'c14'</span>,<span style="color: #008080;line-height: 26px;">203</span>,<span style="color: #d14;line-height: 26px;">"o15"</span>);<br  /></code></pre><h3 data-tool="mdnice编辑器" style="font-size: 20px;margin-top: 1.2em;margin-bottom: 1em;font-weight: bold;color: rgb(53, 179, 120);"><span style="display: none;"></span>CASE WHEN 时间，进行留存率/使用率的分析<span style="display: none;"></span></h3><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;允许多列去重</span><br  /><span style="font-weight: bold;line-height: 26px;">set</span>&nbsp;hive.groupby.skewindata&nbsp;=&nbsp;<span style="color: #008080;line-height: 26px;">false</span><br  /><span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;允许使用位置编号分组或排序</span><br  /><span style="font-weight: bold;line-height: 26px;">set</span>&nbsp;hive.groupby.orderby.position.alias&nbsp;=&nbsp;<span style="color: #008080;line-height: 26px;">true</span><br  /><br  /><span style="font-weight: bold;line-height: 26px;">SELECT</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">date_add</span>(Next_day(register_date,&nbsp;<span style="color: #d14;line-height: 26px;">'MO'</span>),<span style="color: #008080;line-height: 26px;">-1</span>)&nbsp;<span style="font-weight: bold;line-height: 26px;">AS</span>&nbsp;week_end,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">COUNT</span>(<span style="font-weight: bold;line-height: 26px;">DISTINCT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">CASE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">WHEN</span>&nbsp;order_date&nbsp;<span style="font-weight: bold;line-height: 26px;">BETWEEN</span>&nbsp;register_date&nbsp;<span style="font-weight: bold;line-height: 26px;">AND</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">date_add</span>(register_date,<span style="color: #008080;line-height: 26px;">6</span>)&nbsp;<span style="font-weight: bold;line-height: 26px;">THEN</span>&nbsp;user_id&nbsp;<span style="font-weight: bold;line-height: 26px;">END</span>)&nbsp;<span style="font-weight: bold;line-height: 26px;">AS</span>&nbsp;first_week_order,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">COUNT</span>(<span style="font-weight: bold;line-height: 26px;">DISTINCT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">CASE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">WHEN</span>&nbsp;order_date&nbsp;<span style="font-weight: bold;line-height: 26px;">BETWEEN</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">date_add</span>(register_date&nbsp;,<span style="color: #008080;line-height: 26px;">7</span>)&nbsp;<span style="font-weight: bold;line-height: 26px;">AND</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">date_add</span>(register_date,<span style="color: #008080;line-height: 26px;">13</span>)&nbsp;<span style="font-weight: bold;line-height: 26px;">THEN</span>&nbsp;user_id&nbsp;<span style="font-weight: bold;line-height: 26px;">END</span>)&nbsp;<span style="font-weight: bold;line-height: 26px;">AS</span>&nbsp;sencod_week_order,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">COUNT</span>(<span style="font-weight: bold;line-height: 26px;">DISTINCT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">CASE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">WHEN</span>&nbsp;order_date&nbsp;<span style="font-weight: bold;line-height: 26px;">BETWEEN</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">date_add</span>(register_date&nbsp;,<span style="color: #008080;line-height: 26px;">14</span>)&nbsp;<span style="font-weight: bold;line-height: 26px;">AND</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">date_add</span>(register_date,<span style="color: #008080;line-height: 26px;">20</span>)&nbsp;<span style="font-weight: bold;line-height: 26px;">THEN</span>&nbsp;user_id&nbsp;<span style="font-weight: bold;line-height: 26px;">END</span>)&nbsp;<span style="font-weight: bold;line-height: 26px;">as</span>&nbsp;third_week_order<br  /><span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">order</span><br  /><span style="font-weight: bold;line-height: 26px;">GROUP</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">BY</span>&nbsp;<span style="color: #008080;line-height: 26px;">1</span><br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">上面的示例可以得知到用户在注册之后，有没有创建订单的行为。比如注册后的第一周，第二周，第三周分别有多少下单用户，这样可以分析出用户的使用情况和留存情况。</p><blockquote data-tool="mdnice编辑器" style="font-size: 0.9em;overflow: auto;padding: 10px 10px 10px 20px;margin: 10px 5px;border-left-color: rgb(53, 179, 120);border-right: 0px solid rgb(53, 179, 120);color: rgb(97, 97, 97);quotes: none;background: rgb(251, 249, 253);"><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;">注意：上面的使用方式，需要配置两个参数：</p><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;"><strong style="color: rgb(53, 179, 120);">hive.groupby.skewindata = false</strong>：允许多列去重，否则报错：</p><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;"><code style="font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(53, 179, 120);">SemanticException [Error 10022]: DISTINCT on different columns not supported with skew in data</code></p><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;"><strong style="color: rgb(53, 179, 120);">hive.groupby.orderby.position.alias = true</strong>：允许使用位置编号分组或排序,否则报错：</p><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;"><code style="font-size: 14px;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(53, 179, 120);">SemanticException [Error 10025]: line 79:13 Expression not in GROUP BY key ''MO''</code></p></blockquote><h3 data-tool="mdnice编辑器" style="font-size: 20px;margin-top: 1.2em;margin-bottom: 1em;font-weight: bold;color: rgb(53, 179, 120);"><span style="display: none;"></span>CASE WHEN 时间，进行每个用户消费金额的分析<span style="display: none;"></span></h3><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">SELECT<br  />&nbsp;&nbsp;&nbsp;&nbsp;user_id,<br  />&nbsp;&nbsp;&nbsp;&nbsp;SUM&nbsp;(CASE&nbsp;WHEN&nbsp;order_date&nbsp;BETWEEN&nbsp;register_date&nbsp;AND&nbsp;date_add(register_date,6)&nbsp;THEN&nbsp;order_sales&nbsp;END)&nbsp;AS&nbsp;first_week_amount,<br  />&nbsp;&nbsp;&nbsp;&nbsp;SUM&nbsp;(CASE&nbsp;WHEN&nbsp;order_date&nbsp;BETWEEN&nbsp;date_add(register_date&nbsp;,7)&nbsp;AND&nbsp;date_add(register_date,13)&nbsp;THEN&nbsp;order_sales&nbsp;END)&nbsp;AS&nbsp;second_week_amount<br  />&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;order<br  />GROUP&nbsp;BY&nbsp;1<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">通过筛选出注册与消费的日期，并且进行消费金额统计，每个用户在每段时间段(注册后第一周、第二周…以此类推)的消费金额，可以观察用户是否有持续维持消费习惯或是消费金额变低等分析。</p><h3 data-tool="mdnice编辑器" style="font-size: 20px;margin-top: 1.2em;margin-bottom: 1em;font-weight: bold;color: rgb(53, 179, 120);"><span style="display: none;"></span>CASE WHEN数量，消费金额超过某一定额的数量分析<span style="display: none;"></span></h3><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">SELECT<br  />&nbsp;&nbsp;&nbsp;&nbsp;user_id,<br  />&nbsp;&nbsp;&nbsp;&nbsp;COUNT(DISTINCT&nbsp;CASE&nbsp;WHEN&nbsp;order_sales&nbsp;&gt;=&nbsp;100&nbsp;THEN&nbsp;order_id&nbsp;END)&nbsp;AS&nbsp;count_of_order_greateer_than_100<br  />FROM&nbsp;order<br  />GROUP&nbsp;BY&nbsp;1<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">上面的示例就是类似countif的用法，针对每个用户，统计其订单金额大于某个值的订单数量，分析去筛选出高价值的顾客。</p><h3 data-tool="mdnice编辑器" style="font-size: 20px;margin-top: 1.2em;margin-bottom: 1em;font-weight: bold;color: rgb(53, 179, 120);"><span style="display: none;"></span>CASE WHEN数量，加上时间的用法<span style="display: none;"></span></h3><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">SELECT<br  />&nbsp;&nbsp;&nbsp;&nbsp;user_id,<br  />&nbsp;&nbsp;&nbsp;&nbsp;MIN(CASE&nbsp;WHEN&nbsp;order_sales&nbsp;&gt;&nbsp;100&nbsp;THEN&nbsp;order_date&nbsp;END)&nbsp;AS&nbsp;first_order_date_over1000,<br  />&nbsp;&nbsp;&nbsp;&nbsp;MAX(CASE&nbsp;WHEN&nbsp;order_sales&nbsp;&gt;&nbsp;100&nbsp;THEN&nbsp;order_date&nbsp;END)&nbsp;AS&nbsp;recent_order_date_over100<br  />FROM&nbsp;order<br  />GROUP&nbsp;BY&nbsp;1<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">CASE WHEN加上MIN/MAX时间，可以得出该用户在其整个使用过程中，首次购买超过一定金额的订单日期，以及最近一次购买超过一定金额的订单日期。</p><h2 data-tool="mdnice编辑器" style="line-height: 32px;color: rgb(53, 179, 120);display: inline-block;border-bottom: 0px solid rgb(53, 179, 120);border-top-color: rgb(53, 179, 120);border-right-color: rgb(53, 179, 120);border-left-color: rgb(53, 179, 120);font-size: 23px;margin-top: 1em;margin-bottom: 0rem;padding-top: 0.5em;padding-bottom: 0.5em;font-weight: bold;"><span style="display: none;"></span>第四：Window Function的其他用途</h2><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">Window Function既是工作中经常使用的函数，也是面试时经常被问到的问题。常见的使用场景是分组取topN。本文介绍的另外一个用法，使用开窗函数进行用户访问session分析。</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">session是指在指定的时间段内用户在网站上发生的一系列互动。例如，一次session可以包含多个网页浏览、事件、社交互动和电子商务交易。session就相当于一个容器，其中包含了用户在网站上执行的操作。</p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.32545454545454544" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/PL10rfzHicsh4hj0fj4Y2sT2icWRS8x3Sfp8rfZID4EZNRFiakibTgmz0F3PpfXDH9cpr9KM5KDiaV06VMbPfhpvl1g/640?wx_fmt=png" data-type="png" data-w="550" style=""  /></p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">session具有一个过期时间，比如30分钟，即不活动状态超过 30 分钟，该session就会过时。</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">假设张三访问了网站，从他到达网站的那一刻开始，就开始计时。如果过了 30 分钟，而张三仍然没有进行任何形式的互动，则视为本次session结束。但是，只要张三与某个元素进行了互动（例如发生了某个事件、社交互动或打开了新网页），就会在该次互动的时间基础上再增加 30 分钟，从而重置过期时间。</p><p style="text-align: center;"><img class="rich_pages js_insertlocalimg" data-ratio="0.4" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/PL10rfzHicsh4hj0fj4Y2sT2icWRS8x3SfmLBoMpCCfGUUzgQ0ISv90rjRica4JEHSQnDoXDzeD3ZPOM3icnzDTaWQ/640?wx_fmt=png" data-type="png" data-w="550" style=""  /></p><h3 data-tool="mdnice编辑器" style="font-size: 20px;margin-top: 1.2em;margin-bottom: 1em;font-weight: bold;color: rgb(53, 179, 120);"><span style="display: none;"></span>数据准备<span style="display: none;"></span></h3><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">Table Name: user_visit_action</section></li><li><section style="line-height: 26px;color: rgb(1, 1, 1);margin-top: 10px;margin-bottom: 10px;">Columns: user_id, session_id , page_url, action_time</section></li></ul><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">CREATE</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;user_visit_action(&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;user_id&nbsp;<span style="font-weight: bold;line-height: 26px;">string</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;session_id&nbsp;<span style="font-weight: bold;line-height: 26px;">string</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;page_url&nbsp;<span style="font-weight: bold;line-height: 26px;">string</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;action_time&nbsp;<span style="font-weight: bold;line-height: 26px;">string</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;user_visit_action&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"001"</span>,<span style="color: #d14;line-height: 26px;">"ss001"</span>,<span style="color: #d14;line-height: 26px;">"http://a.com"</span>,<span style="color: #d14;line-height: 26px;">"2020-08-06&nbsp;13:34:11.478"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;user_visit_action&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"001"</span>,<span style="color: #d14;line-height: 26px;">"ss001"</span>,<span style="color: #d14;line-height: 26px;">"http://b.com"</span>,<span style="color: #d14;line-height: 26px;">"2020-08-06&nbsp;13:35:11.478"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;user_visit_action&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"001"</span>,<span style="color: #d14;line-height: 26px;">"ss001"</span>,<span style="color: #d14;line-height: 26px;">"http://c.com"</span>,<span style="color: #d14;line-height: 26px;">"2020-08-06&nbsp;13:36:11.478"</span>);<br  /><br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;user_visit_action&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"001"</span>,<span style="color: #d14;line-height: 26px;">"ss002"</span>,<span style="color: #d14;line-height: 26px;">"http://a.com"</span>,<span style="color: #d14;line-height: 26px;">"2020-08-06&nbsp;14:30:11.478"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;user_visit_action&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"001"</span>,<span style="color: #d14;line-height: 26px;">"ss002"</span>,<span style="color: #d14;line-height: 26px;">"http://b.com"</span>,<span style="color: #d14;line-height: 26px;">"2020-08-06&nbsp;14:31:11.478"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;user_visit_action&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"001"</span>,<span style="color: #d14;line-height: 26px;">"ss002"</span>,<span style="color: #d14;line-height: 26px;">"http://e.com"</span>,<span style="color: #d14;line-height: 26px;">"2020-08-06&nbsp;14:33:11.478"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;user_visit_action&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"001"</span>,<span style="color: #d14;line-height: 26px;">"ss002"</span>,<span style="color: #d14;line-height: 26px;">"http://f.com"</span>,<span style="color: #d14;line-height: 26px;">"2020-08-06&nbsp;14:35:11.478"</span>);<br  /><br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;user_visit_action&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"002"</span>,<span style="color: #d14;line-height: 26px;">"ss003"</span>,<span style="color: #d14;line-height: 26px;">"http://u.com"</span>,<span style="color: #d14;line-height: 26px;">"2020-08-06&nbsp;18:34:11.478"</span>);<br  /><span style="font-weight: bold;line-height: 26px;">INSERT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">INTO</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">TABLE</span>&nbsp;user_visit_action&nbsp;<span style="font-weight: bold;line-height: 26px;">VALUES</span>(<span style="color: #d14;line-height: 26px;">"002"</span>,<span style="color: #d14;line-height: 26px;">"ss003"</span>,<span style="color: #d14;line-height: 26px;">"http://k.com"</span>,<span style="color: #d14;line-height: 26px;">"2020-08-06&nbsp;18:38:11.478"</span>);<br  /><br  /></code></pre><h3 data-tool="mdnice编辑器" style="font-size: 20px;margin-top: 1.2em;margin-bottom: 1em;font-weight: bold;color: rgb(53, 179, 120);"><span style="display: none;"></span>用户访问session分析<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">范例的资料表如上，有使用者、访次和页面的连结和时间。以下则使用partition by来表达每个使用者在不同访次之间的浏览行为。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">SELECT</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;user_id,<br  />&nbsp;&nbsp;&nbsp;&nbsp;session_id,<br  />&nbsp;&nbsp;&nbsp;&nbsp;page_url,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">DENSE_RANK</span>()&nbsp;<span style="font-weight: bold;line-height: 26px;">OVER</span>&nbsp;(<span style="font-weight: bold;line-height: 26px;">PARTITION</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">BY</span>&nbsp;user_id,&nbsp;session_id&nbsp;<span style="font-weight: bold;line-height: 26px;">ORDER</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">BY</span>&nbsp;action_time&nbsp;<span style="font-weight: bold;line-height: 26px;">ASC</span>)&nbsp;<span style="font-weight: bold;line-height: 26px;">AS</span>&nbsp;page_order,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">MIN</span>(action_time)&nbsp;<span style="font-weight: bold;line-height: 26px;">OVER</span>&nbsp;(<span style="font-weight: bold;line-height: 26px;">PARTITION</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">BY</span>&nbsp;user_id,&nbsp;session_id)&nbsp;<span style="font-weight: bold;line-height: 26px;">AS</span>&nbsp;session_start_time,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">MAX</span>(action_time)&nbsp;<span style="font-weight: bold;line-height: 26px;">OVER</span>&nbsp;(<span style="font-weight: bold;line-height: 26px;">PARTITION</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">BY</span>&nbsp;user_id,&nbsp;session_id)&nbsp;<span style="font-weight: bold;line-height: 26px;">AS</span>&nbsp;session_finisht_time<br  /><span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;user_visit_action<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">上面的查询会返回针对每个用户、每次的到访，浏览页面行为的先后次序，以及该session开始与结束的时间，以此为基础就可以将这个结果存入TEMP TABLE或是CTE ，进行更进一步的分析。</p><span style="color: rgb(53, 179, 120);font-size: 23px;font-weight: bold;letter-spacing: 0.05em;">小结</span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;line-height: 1.6;word-break: break-word;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 15px;letter-spacing: 0.05em;color: rgb(89, 89, 89);"><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;margin: 1em 4px;">本文主要分享了四个在工作和面试中经常遇到的SQL使用技巧。当然，这些都与具体的分析业务息息相关。最后，不管你是SQL boy &nbsp;or &nbsp;SQL girl，只要是掌握一些技巧，相信都能够Happy SQL querying 😊。</p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;line-height: 1.6;word-break: break-word;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 15px;letter-spacing: 0.05em;color: rgb(89, 89, 89);"><blockquote data-tool="mdnice编辑器" style="font-size: 0.9em;overflow: auto;padding: 10px 10px 10px 20px;margin: 10px 5px;border-left-color: rgb(53, 179, 120);border-right: 0px solid rgb(53, 179, 120);color: rgb(97, 97, 97);quotes: none;background: rgb(251, 249, 253);"><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;">记得分享、点赞、在看</p></blockquote></section></section><div class="msg_source_url"><a href="https://mp.weixin.qq.com/s/RykdGWsESRNhq9r7q2f-CA#rd" target="_blank">阅读原文</a></div></content><div class="msg_source_url"><a href="https://mp.weixin.qq.com/s/RykdGWsESRNhq9r7q2f-CA#rd" target="_blank">阅读原文</a></div>
</div>
</body>
</html>