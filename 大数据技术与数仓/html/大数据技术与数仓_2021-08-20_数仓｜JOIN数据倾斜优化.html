<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 0 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic{color:#8e8e8e;background:#f7f7f7;border-radius:5px;padding:10px 8px;}.topic a{padding-right:5px;}.topic p{margin-bottom:5px;}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head><script>
var data={"mp":"大数据技术与数仓","title":"数仓|JOIN数据倾斜优化","time":"2021-08-20 08:30:00","timeStamp":"1629419400"};
</script>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="http://mp.weixin.qq.com/s?__biz=MzU2ODQ3NjYyMA==&mid=2247487146&idx=1&sn=12c616ee7e03757302b474fcc1c4e0ba&chksm=fc8c1809cbfb911f31e493ac0e14e3919c97fd4815298d604ccdfaeb7a3ab42d90ab6919b211#rd" target="_blank">数仓|JOIN数据倾斜优化</a></h1><div id="meta_content" class="rich_media_meta_list"><span id="copyright_logo" class="wx_tap_link js_wx_tap_highlight rich_media_meta icon_appmsg_tag appmsg_title_tag weui-wa-hotarea">原创&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_text">西贝&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">大数据技术与数仓&nbsp;&nbsp;</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-08-20 08:30:00</em></div><content><div class="topic"><p>收录于话题</p><p><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU2ODQ3NjYyMA==&action=getalbum&album_id=1502493234856574979#wechat_redirect" title="SQL" target="_blank">#SQL</a><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU2ODQ3NjYyMA==&action=getalbum&album_id=1344435576086560769#wechat_redirect" title="数仓" target="_blank">#数仓</a><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU2ODQ3NjYyMA==&action=getalbum&album_id=1502493234823020547#wechat_redirect" title="Hive" target="_blank">#Hive</a><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU2ODQ3NjYyMA==&action=getalbum&album_id=1516633651147554819#wechat_redirect" title="OLAP" target="_blank">#OLAP</a></p></div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px;color: black;padding-right: 10px;padding-left: 10px;line-height: 1.6;letter-spacing: 0px;word-break: break-word;overflow-wrap: break-word;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;"><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;border-bottom: 2px solid rgb(239, 112, 96);font-size: 1.3em;"><span style="display: none;"></span><span style="display: inline-block;background: rgb(239, 112, 96);color: rgb(255, 255, 255);padding: 3px 10px 1px;border-top-right-radius: 3px;border-top-left-radius: 3px;margin-right: 3px;">背景</span><span style="display: inline-block;vertical-align: bottom;border-bottom: 36px solid #efebe9;border-right: 20px solid transparent;"> </span></h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">当数据量比较大且分布不均匀时，对数据进行JOIN操作很容易造成数据倾斜，因为在JOIN的执行阶段会将JOIN KEY相同的数据分发到同一个task任务上处理，如果某个key上的数据量比较多，会导致该task执行的时间比其他的task执行时间长。具体表现为：大部分的task任务都已经执行完成，但只有少数的几个task一直处于运行当中。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">数据量不大的情况下，一般不会出现数据倾斜的问题。但当数据量巨大时，数据倾斜的现象就会非常普遍。比如电商网站在大促时期，某些店铺的PV远远大于普通店铺的PV，某些热门商品的PV也远远大于一些长尾商品的PV，这个时候如果进行维表的JOIN，很容易导致数据倾斜。</p><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;border-bottom: 2px solid rgb(239, 112, 96);font-size: 1.3em;"><span style="display: none;"></span><span style="display: inline-block;background: rgb(239, 112, 96);color: rgb(255, 255, 255);padding: 3px 10px 1px;border-top-right-radius: 3px;border-top-left-radius: 3px;margin-right: 3px;">JOIN数据倾斜的场景</span><span style="display: inline-block;vertical-align: bottom;border-bottom: 36px solid #efebe9;border-right: 20px solid transparent;"> </span></h2><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>维表JOIN<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">当JOIN的维表数据量较小时(可以通过参数配置不超过多大)，可以使用map端join，避免分发引起数据倾斜。</p><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>空值<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">当JOIN的两个表数据量都很大，且数据倾斜是有空key造成的，可以将空key处理成随机值，避免分发到同一个task。</p><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>热点KEY<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">当JOIN的两个表的数据量都很大，且是有热点key导致的数据倾斜(某个key对应的数据量非常大)，可以将热点key与非热点key分别处理，再合并数据即可。</p><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;border-bottom: 2px solid rgb(239, 112, 96);font-size: 1.3em;"><span style="display: none;"></span><span style="display: inline-block;background: rgb(239, 112, 96);color: rgb(255, 255, 255);padding: 3px 10px 1px;border-top-right-radius: 3px;border-top-left-radius: 3px;margin-right: 3px;">方案</span><span style="display: inline-block;vertical-align: bottom;border-bottom: 36px solid #efebe9;border-right: 20px solid transparent;"> </span></h2><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>map端JOIN<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">Join倾斜时，如果某路输入比较小，可以采用Mapjoin避免倾斜。Mapjoin的原理是将Join操作提前到Map端执行，这样可以避免因为分发Key不均匀导致数据倾斜。但是Mapjoin的使用有限制，必须是Join中的从表比较小才可用。所谓从表，即Left Outer Join中的右表，或者Right Outer Join中的左表。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">map端join适用于当一张表很小(可以存在内存中)的情况，即可以将小表加载至内存。Hive从0.7开始支持自动转为map端join，具体配置如下：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">SET&nbsp;hive.auto.convert.join=<span style="color: #008080;line-height: 26px;">true</span>;&nbsp;--&nbsp;&nbsp;hivev0.11.0之后默认<span style="color: #008080;line-height: 26px;">true</span><br  />SET&nbsp;hive.mapjoin.smalltable.filesize=600000000;&nbsp;--&nbsp;默认&nbsp;25m<br  />SET&nbsp;hive.auto.convert.join.noconditionaltask=<span style="color: #008080;line-height: 26px;">true</span>;&nbsp;--&nbsp;默认<span style="color: #008080;line-height: 26px;">true</span>，所以不需要指定map&nbsp;join&nbsp;hint<br  />SET&nbsp;hive.auto.convert.join.noconditionaltask.size=10000000;&nbsp;--&nbsp;控制加载到内存的表的大小<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">也可以使用 map join hint的方式进行手动指定：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">/*+&nbsp;MAPJOIN(c)&nbsp;*/</span>&nbsp;*&nbsp;<span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;orders&nbsp;o&nbsp;<span style="font-weight: bold;line-height: 26px;">JOIN</span>&nbsp;cities&nbsp;c&nbsp;<span style="font-weight: bold;line-height: 26px;">ON</span>&nbsp;(o.city_id&nbsp;=&nbsp;c.id);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">一旦开启map端join配置，Hive会自动检查小表是否大于<code style="font-size: 14px;overflow-wrap: break-word;padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(239, 112, 96);">hive.mapjoin.smalltable.filesize</code>配置的大小，如果大于则转为普通的join，如果小于则转为map端join。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">关于map端join的原理，如下图所示：</p><p style="text-align: center;"><img class="rich_pages wxw-img js_insertlocalimg" data-ratio="0.664179104477612" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/PL10rfzHicsjXfrKcia6mLWSV8UunXb9aVUb9qfsrtTkAuWicEod9ht6WSvZ9B6zxf3ibzNN9FE4YAMwc6eMwN8G5g/640?wx_fmt=png" data-type="png" data-w="804" style=""></p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><figcaption style="margin-top: 5px;text-align: center;color: #888;font-size: 14px;"><br  /></figcaption></figure><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">首先，Task A(客户端本地执行的task)负责读取小表a，并将其转成一个HashTable的数据结构，写入到本地文件，之后将其加载至分布式缓存。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">然后，Task B任务会启动map任务读取大表b，在Map阶段，根据每条记录与分布式缓存中的a表对应的hashtable关联，并输出结果</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">注意：map端join没有reduce任务，所以map直接输出结果，即有多少个map任务就会产生多少个结果文件。</p><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>空值数据倾斜<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果是因为空值导致数据倾斜，且JOIN的两张表数据量都很大，此时无法使用Mapjoin，可以将空值处理成随机值。因为空值是无法关联上，只是分发到了一处，因此给予随机值即不会影响关联也能避免聚集。当然我们也可以提前对空值进行过滤。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;&nbsp;...<br  /><span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;&nbsp;*<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;tbl1<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">WHERE</span>&nbsp;&nbsp;&nbsp;ds&nbsp;=&nbsp;<span style="color: #d14;line-height: 26px;">'${cur_date}'</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;a<br  /><span style="font-weight: bold;line-height: 26px;">LEFT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">OUTER</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">JOIN</span>&nbsp;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;&nbsp;*<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;tbl1<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">WHERE</span>&nbsp;&nbsp;&nbsp;ds&nbsp;=&nbsp;<span style="color: #d14;line-height: 26px;">'${cur_date}'</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;b<br  /><span style="font-weight: bold;line-height: 26px;">ON</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">coalesce</span>(a.id,<span style="font-weight: bold;line-height: 26px;">rand</span>()&nbsp;*&nbsp;<span style="color: #008080;line-height: 26px;">9999</span>)&nbsp;=&nbsp;b.id&nbsp;<span style="color: #998;font-style: italic;line-height: 26px;">--&nbsp;通过coalesce对空值进行随机分发，避免聚集</span><br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>热点Key数据倾斜<span style="display: none;"></span></h3><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>案例介绍<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">假设有下面两张表，一张事实表，一张维表：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">事实表：<strong style="color: black;">fact_tbl</strong></section></li><ul style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">数据量：100MB</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">其中一个字段名是：<strong style="color: black;">code_id</strong></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">99MB的数据对应的code_id为100</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">只有1MB的数据对应的code_id是均匀分布的</section></li></ul><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">维表：<strong style="color: black;">dim_tbl</strong></section></li><ul style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">数据比较大，不能进行Map端join</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">code_id可以唯一约束一条记录</section></li></ul></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果将上面两个表进行join：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;&nbsp;*<br  /><span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;fact_tbl&nbsp;f<br  /><span style="font-weight: bold;line-height: 26px;">LEFT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">JOIN</span>&nbsp;dim_tbl&nbsp;d<br  /><span style="font-weight: bold;line-height: 26px;">ON</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.code_id&nbsp;=&nbsp;d.code_id<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">我们会注意到99%的reduce任务会快速运行结束，但是会有一个reduce任务运行的时间特变长(因为code_id=100对应的了99MB的数据)，这也就是上面提到的数据倾斜。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>方案1：分开查询<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">以上面的例子，可以分开进行查询，如下：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">查询1:排出热点key数据</section></li></ul><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;&nbsp;*<br  /><span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;fact_tbl&nbsp;f<br  /><span style="font-weight: bold;line-height: 26px;">LEFT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">JOIN</span>&nbsp;dim_tbl&nbsp;d<br  /><span style="font-weight: bold;line-height: 26px;">ON</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.code_id&nbsp;=&nbsp;d.code_id<br  /><span style="font-weight: bold;line-height: 26px;">WHERE</span>&nbsp;&nbsp;&nbsp;f.code_id&nbsp;&lt;&gt;&nbsp;<span style="color: #008080;line-height: 26px;">100</span><br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">查询2：单独计算热点key</section></li></ul><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="font-weight: bold;line-height: 26px;">SELECT</span>&nbsp;&nbsp;*<br  /><span style="font-weight: bold;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;fact_tbl&nbsp;f<br  /><span style="font-weight: bold;line-height: 26px;">LEFT</span>&nbsp;<span style="font-weight: bold;line-height: 26px;">JOIN</span>&nbsp;dim_tbl&nbsp;d<br  /><span style="font-weight: bold;line-height: 26px;">ON</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.code_id&nbsp;=&nbsp;d.code_id<br  /><span style="font-weight: bold;line-height: 26px;">WHERE</span>&nbsp;&nbsp;&nbsp;f.code_id&nbsp;=&nbsp;<span style="color: #008080;line-height: 26px;">250</span><br  /><span style="font-weight: bold;line-height: 26px;">AND</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d.code_id&nbsp;=&nbsp;<span style="color: #008080;line-height: 26px;">250</span><br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">缺点</section></li><ul style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">需要写两次SQL</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">如果原始的查询SQL非常复杂，分开写两次会非常麻烦</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">如果需要修改SQL，需要同时修改两个地方</section></li></ul></ul><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>方案2：Skew Join<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">SkewJoin Hint可以通过自动或手动方式获取两张表的热点key，分别计算热点数据和非热点数据的Join结果并合并，加快Join的执行速度。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">我们可以通过配置Skew Join 优化，如下：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="color: #0086b3;line-height: 26px;">set</span>&nbsp;hive.optimize.skewjoin=<span style="color: #008080;line-height: 26px;">true</span>;<br  /><span style="color: #0086b3;line-height: 26px;">set</span>&nbsp;hive.skewjoin.key=500000;<br  /><span style="color: #0086b3;line-height: 26px;">set</span>&nbsp;hive.skewjoin.mapjoin.map.tasks=10000;<br  /><span style="color: #0086b3;line-height: 26px;">set</span>&nbsp;hive.skewjoin.mapjoin.min.split=33554432;<br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">hive.optimize.skewjoin</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">是否开启skew join优化，当开启参数时，在进行查询的时候会识别数据倾斜的key，首先将这些key存储在HDFS的临时文件上，在接下来的map-reduce过程中，再去处理这些数据倾斜的key（启动map端join专门计算这个特殊值）</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">hive.skewjoin.key</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">告诉hive这个join的skew key是什么，即如何判断哪个key是数据倾斜的key。根据该参数的配置值，比如默认100000，那么就认为超过100000条记录的值就是数据倾斜的key。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">Skew Join的具体过程如下图所示：</p><p style="text-align: center;"><img class="rich_pages wxw-img js_insertlocalimg" data-ratio="0.545" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/PL10rfzHicsjXfrKcia6mLWSV8UunXb9aVz4dgwxh4NkzIDUjicHicZMKpUVJkicH9FgrZzqRYclUFicFadhbhPzLJAg/640?wx_fmt=jpeg" data-type="jpeg" data-w="600" style=""></p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><figcaption style="margin-top: 5px;text-align: center;color: #888;font-size: 14px;"><span style="color: black;font-size: 16px;letter-spacing: 0px;text-align: left;">大致的步骤为：</span><span style="color: black;font-size: 16px;letter-spacing: 0px;text-align: left;">现将引起数据倾斜的key分别写入到HDFS的临时文件中，如上图的</span><strong style="color: black;font-size: 16px;letter-spacing: 0px;text-align: left;">HDFS File a-K1</strong><span style="color: black;font-size: 16px;letter-spacing: 0px;text-align: left;">与</span><strong style="color: black;font-size: 16px;letter-spacing: 0px;text-align: left;">HDFS File b-K1</strong><span style="color: black;font-size: 16px;letter-spacing: 0px;text-align: left;">，对倾斜key的数据执行map端join；</span><span style="color: black;font-size: 16px;letter-spacing: 0px;text-align: left;">对其他分部均匀的key正常执行join任务，最后将两份join的数据进行合并。</span><br  /></figcaption><figcaption style="margin-top: 5px;text-align: center;color: #888;font-size: 14px;"><span style="color: black;font-size: 16px;letter-spacing: 0px;text-align: left;"><br  /></span></figcaption><figcaption style="margin-top: 5px;text-align: center;color: #888;font-size: 14px;"><span style="color: black;font-size: 16px;letter-spacing: 0px;text-align: left;">扫描下方二维码，加微信，进大数据技术交流群<br  /></span></figcaption><p style="text-align: center;"><img class="rich_pages wxw-img" data-ratio="0.5555555555555556" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/PL10rfzHicsgYic9icrPjCqicQZOqicicQRjOr9ka3KSCgElNV1HLd89YxT5NMTUmMwhGyE7KFVo2I11Rta7icUMP2muA/640?wx_fmt=png" data-type="png" data-w="900" style=""></p><figcaption style="margin-top: 5px;text-align: center;color: #888;font-size: 14px;"><span style="color: black;font-size: 16px;letter-spacing: 0px;text-align: left;"></span><br  /></figcaption><section class="mp_profile_iframe_wrp"><mpprofile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzU2ODQ3NjYyMA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/PL10rfzHicsiaWUJ7uBrlIibLdUDlmsXrhE9b6ZXmFWGZFqzSQE7LFkL1XmLkmgAWibVYG7tpGyEjls5B0LWc8lkjg/0?wx_fmt=png" data-nickname="大数据技术与数仓" data-alias="bigdata_dw" data-signature="专注分享数据仓库与大数据技术(Flink/Hadoop/Spark/Hive)相关内容。关注我可以免费领取大数据书籍与视频。我的博客:https://jiamaoxiang.top/" data-from="0"></mpprofile></section><figcaption style="margin-top: 5px;text-align: center;color: #888;font-size: 14px;"><br  /></figcaption></figure></section><div class="msg_source_url"><a href="http://mp.weixin.qq.com/mp/homepage?__biz=MzU2ODQ3NjYyMA==&hid=5&sn=512054e59f6ed54bd7e5f451785e82c9&scene=18#wechat_redirect" target="_blank">阅读原文</a></div></content><div class="msg_source_url"><a href="http://mp.weixin.qq.com/mp/homepage?__biz=MzU2ODQ3NjYyMA==&hid=5&sn=512054e59f6ed54bd7e5f451785e82c9&scene=18#wechat_redirect" target="_blank">阅读原文</a></div>
</div>
</body>
</html>