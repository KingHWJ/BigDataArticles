<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 0 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic{color:#8e8e8e;background:#f7f7f7;border-radius:5px;padding:10px 8px;}.topic a{padding-right:5px;}.topic p{margin-bottom:5px;}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head><script>
var data={"mp":"大数据技术与数仓","title":"数仓|长周期去重指标的计算优化","time":"2021-08-13 08:31:44","timeStamp":"1628814704"};
</script>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="http://mp.weixin.qq.com/s?__biz=MzU2ODQ3NjYyMA==&mid=2247487094&idx=1&sn=01bdc4b133dba718081c1269ba6fdcce&chksm=fc8c18d5cbfb91c3698afc30c1f6a155b84a3676d507e31e1dd0507cbe6112928368ad819bff#rd" target="_blank">数仓|长周期去重指标的计算优化</a></h1><div id="meta_content" class="rich_media_meta_list"><span id="copyright_logo" class="wx_tap_link js_wx_tap_highlight rich_media_meta icon_appmsg_tag appmsg_title_tag weui-wa-hotarea">原创&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_text">西贝&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">大数据技术与数仓&nbsp;&nbsp;</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-08-13 08:31:44</em></div><content><div class="topic"><p>收录于话题</p><p><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU2ODQ3NjYyMA==&action=getalbum&album_id=1502493234823020547#wechat_redirect" title="Hive" target="_blank">#Hive</a><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU2ODQ3NjYyMA==&action=getalbum&album_id=1415165154173779969#wechat_redirect" title="大数据技术" target="_blank">#大数据技术</a><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU2ODQ3NjYyMA==&action=getalbum&album_id=1516633651147554819#wechat_redirect" title="OLAP" target="_blank">#OLAP</a><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU2ODQ3NjYyMA==&action=getalbum&album_id=1502493234856574979#wechat_redirect" title="SQL" target="_blank">#SQL</a><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU2ODQ3NjYyMA==&action=getalbum&album_id=1344435576086560769#wechat_redirect" title="数仓" target="_blank">#数仓</a></p></div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px;color: black;padding-right: 10px;padding-left: 10px;line-height: 1.6;letter-spacing: 0px;word-break: break-word;overflow-wrap: break-word;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;"><section class="mp_profile_iframe_wrp"><mpprofile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzU2ODQ3NjYyMA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/PL10rfzHicsiaWUJ7uBrlIibLdUDlmsXrhE9b6ZXmFWGZFqzSQE7LFkL1XmLkmgAWibVYG7tpGyEjls5B0LWc8lkjg/0?wx_fmt=png" data-nickname="大数据技术与数仓" data-alias="bigdata_dw" data-signature="专注分享数据仓库与大数据技术(Flink/Hadoop/Spark/Hive)相关内容。关注我可以免费领取大数据书籍与视频。我的博客:https://jiamaoxiang.top/" data-from="0"></mpprofile></section><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;border-bottom: 2px solid rgb(239, 112, 96);font-size: 1.3em;"><span style="display: inline-block;background: rgb(239, 112, 96);color: rgb(255, 255, 255);padding: 3px 10px 1px;border-top-right-radius: 3px;border-top-left-radius: 3px;margin-right: 3px;">背景</span></h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在电商数据仓库和商业分析场景中，经常需要计算最近N天的UV、成交用户数等类似的指标，这些指标都有两个共同的特点</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">去重</strong>，在时间窗口范围内，一个用户多次访问或者购买，只统计一次</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">时间窗口</strong>，这些指标需要根据一段时间内的累积数据进行计算</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">通常情况下，这些指标的计算逻辑并不复杂，可以从日志明细表中查询数据进行计算。例如，运行如下SQL语句计算商品最近30天的访客数。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;background: #282c34;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="color: #c678dd;line-height: 26px;">SELECT</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sku_code&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">--商品id&nbsp;</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,<span style="color: #c678dd;line-height: 26px;">COUNT</span>(<span style="color: #c678dd;line-height: 26px;">DISTINCT</span>&nbsp;user_id)&nbsp;<span style="color: #c678dd;line-height: 26px;">AS</span>&nbsp;ipv_uv_30d<br  /><span style="color: #c678dd;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;dwd_log_vst_di&nbsp;&nbsp;&nbsp;<span style="color: #5c6370;font-style: italic;line-height: 26px;">--用户访问商品日志明细表</span><br  /><span style="color: #c678dd;line-height: 26px;">WHERE</span>&nbsp;&nbsp;&nbsp;ds&lt;=&nbsp;<span style="color: #98c379;line-height: 26px;">'${cur_date}'</span><br  /><span style="color: #c678dd;line-height: 26px;">AND</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ds&gt;=&nbsp;to_char(<span style="color: #c678dd;line-height: 26px;">dateadd</span>(<span style="color: #c678dd;line-height: 26px;">to_date</span>(<span style="color: #98c379;line-height: 26px;">'${cur_date}'</span>,<span style="color: #98c379;line-height: 26px;">'yyyymmdd'</span>),<span style="color: #d19a66;line-height: 26px;">-29</span>,<span style="color: #98c379;line-height: 26px;">'dd'</span>),<span style="color: #98c379;line-height: 26px;">'yyyymmdd'</span>)<br  /><span style="color: #c678dd;line-height: 26px;">GROUP</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">BY</span>&nbsp;item_id<br  />;<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">上面的计算方式是最常见的，也是最简单的。如果数据量不是很大，这样计算也是可以的。但是当面对海量数据时，这种方式会显得非常不友好。比如每天的日志量很大时，上面代码就会出现一个严重的问题，即<strong>需要的Map个数太多</strong>，导致Map Task无法顺利执行。</p><blockquote data-tool="mdnice编辑器" style="border-top: none;border-right: none;border-bottom: none;font-size: 0.9em;overflow: auto;color: rgb(106, 115, 125);padding: 10px 10px 10px 20px;margin-bottom: 20px;margin-top: 20px;border-left-color: rgb(239, 112, 96);background: rgb(255, 249, 249);"><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;color: black;line-height: 26px;">尖叫提示：如果分区数据量很大，并且需要扫描的分区数有很多，比如60天、90天，这种情况需要优化代码，避免暴力扫描</p></blockquote><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;border-bottom: 2px solid rgb(239, 112, 96);font-size: 1.3em;"><span style="display: none;"></span><span style="display: inline-block;background: rgb(239, 112, 96);color: rgb(255, 255, 255);padding: 3px 10px 1px;border-top-right-radius: 3px;border-top-left-radius: 3px;margin-right: 3px;">优化方案一</span><span style="display: inline-block;vertical-align: bottom;border-bottom: 36px solid #efebe9;border-right: 20px solid transparent;"> </span></h2><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>方案描述<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如何计算长周期的指标，又不影响性能？</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">首先，我们可以看到性能瓶颈主要在<strong>需要扫描的分区天数</strong>和<strong>分区数据量</strong>上，归根结底是数据量的问题，如果把数据量给降低了，就可以解决这个问题了。</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">明确了瓶颈是数据量大，那么我们该如何降低数据量呢，值得注意的是明细表的数据是不能改变的，所以减少数据量最直接的办法是把每天的数据量都给减少，因此需要构建临时表，对1天的数据进行轻度汇总，这样就能去掉很多重复数据 ，减少数据量。</p></section></li></ul><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 20px;"><span style="display: none;"></span>实现方案<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">根据上面的方案描述，我们可以执行下面两个步骤：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">构建轻度汇总表，明确汇总的粒度，就上面的例子而言，我们可以创建一张商品+用户粒度的1d表</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">使用轻度汇总的表进行长周期去重指标的计算</p></section></li></ul><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>创建一张商品+用户粒度的1d表<span style="display: none;"></span></h4><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;background: #282c34;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="color: #5c6370;font-style: italic;line-height: 26px;">--一个用户访问多次，只保存一次</span><br  /><span style="color: #c678dd;line-height: 26px;">INSERT</span>&nbsp;OVERWRITE&nbsp;<span style="color: #c678dd;line-height: 26px;">TABLE</span>&nbsp;dwd_sku_user_1d&nbsp;(ds=<span style="color: #98c379;line-height: 26px;">'${cur_date}'</span>)<br  /><span style="color: #c678dd;line-height: 26px;">SELECT</span>&nbsp;&nbsp;sku_code<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,user_id<br  /><span style="color: #c678dd;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;dwd_log_vst_di<br  /><span style="color: #c678dd;line-height: 26px;">WHERE</span>&nbsp;&nbsp;&nbsp;ds&nbsp;=&nbsp;<span style="color: #98c379;line-height: 26px;">'{cur_date}'</span><br  /><span style="color: #c678dd;line-height: 26px;">GROUP</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">BY</span>&nbsp;sku_code<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,user_id<br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>使用上面轻度汇总表进行计算<span style="display: none;"></span></h4><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;background: #282c34;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="color: #c678dd;line-height: 26px;">SELECT</span>&nbsp;&nbsp;sku_code<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,<span style="color: #c678dd;line-height: 26px;">COUNT</span>(<span style="color: #c678dd;line-height: 26px;">DISTINCT</span>&nbsp;user_id)&nbsp;<span style="color: #c678dd;line-height: 26px;">AS</span>&nbsp;uv<br  /><span style="color: #c678dd;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;dwd_sku_user_1d<br  /><span style="color: #c678dd;line-height: 26px;">WHERE</span>&nbsp;&nbsp;&nbsp;ds&nbsp;&lt;=&nbsp;<span style="color: #98c379;line-height: 26px;">'${cur_date}'</span><br  /><span style="color: #c678dd;line-height: 26px;">AND</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ds&nbsp;&gt;=&nbsp;to_char(<span style="color: #c678dd;line-height: 26px;">dateadd</span>(<span style="color: #c678dd;line-height: 26px;">to_date</span>(<span style="color: #98c379;line-height: 26px;">'${cur_date}'</span>,<span style="color: #98c379;line-height: 26px;">'yyyymmdd'</span>),&nbsp;-&nbsp;<span style="color: #d19a66;line-height: 26px;">29</span>,<span style="color: #98c379;line-height: 26px;">'dd'</span>),<span style="color: #98c379;line-height: 26px;">'yyyymmdd'</span>)<br  /><span style="color: #c678dd;line-height: 26px;">GROUP</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">BY</span>&nbsp;sku_code<br  />;<br  /></code></pre><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;border-bottom: 2px solid rgb(239, 112, 96);font-size: 1.3em;"><span style="display: none;"></span><span style="display: inline-block;background: rgb(239, 112, 96);color: rgb(255, 255, 255);padding: 3px 10px 1px;border-top-right-radius: 3px;border-top-left-radius: 3px;margin-right: 3px;">优化方案二</span><span style="display: inline-block;vertical-align: bottom;border-bottom: 36px solid #efebe9;border-right: 20px solid transparent;"> </span></h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">上述方法对每天的访问日志明细数据进行单天去重，从而减少了数据量，提高了性能。缺点是每次计算多天数据的时候，都需要读取N个分区的数据。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">所以，我们是不是可以将需要读取的这N个分区的数据存在在一个分区下面，让一个分区的数据包含历史数据的信息，这样就可以不用扫描那么多的分区了。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">执行上面的思路，主要包括以下两个步骤：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">首先获取最近30天的访问数据(<strong style="color: black;">假设存储在表dwd_log_vst_nd中</strong>)，只需要要一次全量计算，后面通过增量计算</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">对最新分区的数据(<strong style="color: black;">包括近30的数据</strong>)进行去重</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">假设我们有了上面的<strong>商品+用户粒度</strong>的轻度汇总表，只需要扫描一次30天分区的数据放在表dwd_log_vst_nd的一个分区下面，以后计算则通过增量的方式进行计算即可，即将dwd_log_vst_nd前天分区数据与表的dwd_sku_user_1d最近一天分区数据进行合并，放在dwd_log_vst_nd表的最近一天分区下。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;background: #282c34;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="color: #c678dd;line-height: 26px;">INSERT</span>&nbsp;OVERWRITE&nbsp;<span style="color: #c678dd;line-height: 26px;">TABLE</span>&nbsp;dwd_log_vst_nd&nbsp;<span style="color: #c678dd;line-height: 26px;">PARTITION</span>(ds=<span style="color: #98c379;line-height: 26px;">'${cur_date}'</span>)<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">COALESCE</span>(&nbsp;n.sku_code,&nbsp;o.sku_code&nbsp;)&nbsp;<span style="color: #c678dd;line-height: 26px;">AS</span>&nbsp;sku_code,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">COALESCE</span>(&nbsp;n.user_id,&nbsp;o.user_id&nbsp;)&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">AS</span>&nbsp;user_id,<br  /><span style="color: #c678dd;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">SELECT</span>&nbsp;&nbsp;*<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;dwd_sku_user_1d<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">WHERE</span>&nbsp;&nbsp;&nbsp;ds&nbsp;=&nbsp;<span style="color: #98c379;line-height: 26px;">'${cur_date}'</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">AND</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sku_code&nbsp;<span style="color: #c678dd;line-height: 26px;">IS</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">NOT</span>&nbsp;<span style="color: #56b6c2;line-height: 26px;">NULL</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">AND</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user_id&nbsp;<span style="color: #c678dd;line-height: 26px;">IS</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">NOT</span>&nbsp;<span style="color: #56b6c2;line-height: 26px;">NULL</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;n<br  /><span style="color: #c678dd;line-height: 26px;">FULL</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">OUTER</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">JOIN</span>&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style="color: #5c6370;font-style: italic;line-height: 26px;">--&nbsp;全外连接进行数据merge</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">SELECT</span>&nbsp;&nbsp;*<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;dwd_log_vst_nd<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">WHERE</span>&nbsp;&nbsp;&nbsp;ds&nbsp;=&nbsp;to_char(<span style="color: #c678dd;line-height: 26px;">dateadd</span>(<span style="color: #c678dd;line-height: 26px;">to_date</span>(<span style="color: #98c379;line-height: 26px;">'${cur_date}'</span>,<span style="color: #98c379;line-height: 26px;">'yyyymmdd'</span>),&nbsp;-&nbsp;<span style="color: #d19a66;line-height: 26px;">1</span>,<span style="color: #98c379;line-height: 26px;">'dd'</span>),<span style="color: #98c379;line-height: 26px;">'yyyymmdd'</span>)<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">AND</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sku_code&nbsp;<span style="color: #c678dd;line-height: 26px;">IS</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">NOT</span>&nbsp;<span style="color: #56b6c2;line-height: 26px;">NULL</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">AND</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user_id&nbsp;<span style="color: #c678dd;line-height: 26px;">IS</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">NOT</span>&nbsp;<span style="color: #56b6c2;line-height: 26px;">NULL</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;o<br  /><span style="color: #c678dd;line-height: 26px;">ON</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o.sku_code&nbsp;=&nbsp;n.sku_code<br  /><span style="color: #c678dd;line-height: 26px;">AND</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o.user_id&nbsp;=&nbsp;n.user_id<br  />;<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">有了上面的dwd_log_vst_nd表计算进30天的商品访客数就会变得简单了，只需要扫描一个分区的数据进行去重即可：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;background: #282c34;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;"><span style="color: #c678dd;line-height: 26px;">SELECT</span>&nbsp;&nbsp;sku_code<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,<span style="color: #c678dd;line-height: 26px;">COUNT</span>(<span style="color: #c678dd;line-height: 26px;">DISTINCT</span>&nbsp;user_id)&nbsp;<span style="color: #c678dd;line-height: 26px;">AS</span>&nbsp;uv<br  /><span style="color: #c678dd;line-height: 26px;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;dwd_sku_user_nd<br  /><span style="color: #c678dd;line-height: 26px;">WHERE</span>&nbsp;&nbsp;&nbsp;ds&nbsp;=&nbsp;<span style="color: #98c379;line-height: 26px;">'${cur_date}'</span><br  /><span style="color: #c678dd;line-height: 26px;">GROUP</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">BY</span>&nbsp;sku_code<br  />;<br  /></code></pre><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;border-bottom: 2px solid rgb(239, 112, 96);font-size: 1.3em;"><span style="display: none;"></span><span style="display: inline-block;background: rgb(239, 112, 96);color: rgb(255, 255, 255);padding: 3px 10px 1px;border-top-right-radius: 3px;border-top-left-radius: 3px;margin-right: 3px;">总结</span><span style="display: inline-block;vertical-align: bottom;border-bottom: 36px solid #efebe9;border-right: 20px solid transparent;"> </span></h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">本文主要介绍了数仓开发过程中常见的长周期去重指标的计算优化方式，对于跨多天分区的去重指标计算，在数据量特别大的情况下会存在暴力扫描的问题，从而导致计算效率低。通常情况下，我们可以使用预去重的方式将原始分区的数据量降低，这样在大不部分的情况下可以缓解计算瓶颈的问题，但是仍然需要扫描大量的分区数据。本文给出的第二种方式，是基于增量去重的视角进行的，即将需要扫描的分区数据合并放置在一个分区下面，后面通过增量合并的方式来获取最新的全量数据，最终的指标计算只需要扫描一天的分区数据即可，这样计算性能会有较大的提升。</p><p><br  /></p><section data-tools="135编辑器" data-id="105183"><section style="margin: 10px auto;text-align: left;"><section style="margin-left: 21px;transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-ms-transform: rotate(0deg);-o-transform: rotate(0deg);"><section style="display:inline-block;"><section style="background-image: linear-gradient(rgba(254, 254, 254, 0) 0%, rgba(254, 254, 254, 0) 55%, rgb(255, 255, 255) 55%, rgb(255, 255, 255) 60%, rgba(254, 254, 254, 0) 60%, rgba(254, 254, 254, 0) 100%);background-position: initial;background-size: initial;background-repeat: initial;background-attachment: initial;background-origin: initial;background-clip: initial;padding-right: 5px;padding-left: 5px;"><section style="display: flex;justify-content: flex-start;align-items: center;"><section style="box-sizing: border-box;width: 50px;height: 50px;border-radius: 50%;background-color: rgb(254, 247, 178);overflow: hidden;"><br  /></section><section style="margin-left: -20px;"><section data-brushtype="text" style="font-size: 12px;letter-spacing: 1.5px;color: rgb(79, 228, 237);">NO.<span data-original-title="" title="">1</span></section><section data-brushtype="text" style="font-size: 14px;letter-spacing: 1.5px;color: rgb(79, 228, 237);"><strong>往期回顾</strong></section></section></section></section></section></section><section style="border-width: 1px;border-style: solid;border-color: rgb(79, 228, 237);padding-top: 6px;padding-left: 6px;box-shadow: rgba(220, 254, 255, 0.2) 6px 6px 0px 0px;margin-top: -29px;margin-right: 7px;box-sizing: border-box;"><section style="background-color: rgb(247, 253, 255);padding: 15px 25px 30px 23px;box-sizing: border-box;"><section style="display: flex;justify-content: flex-start;align-items: flex-start;margin-top: 10px;"><section style="box-sizing: border-box;width: 11px;height: 11px;border-width: 1px;border-style: solid;border-color: rgb(79, 228, 237);margin-top: 7px;margin-right: 15px;flex-shrink: 0;overflow: hidden;"><br  /></section><section data-autoskip="1" style="text-align: justify;line-height:1.75em;letter-spacing: 1.5px;font-size:14px;color:#3e4c51;background: transparent;"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU2ODQ3NjYyMA==&amp;mid=2247486761&amp;idx=1&amp;sn=3dd31da6759aa39f65679cdef22820cd&amp;chksm=fc8c1b8acbfb929c9998a490485d4cf51867fb2f54d7458a58071a0bf08b3e80f1eba2110f11&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">数仓|该如何理解数据仓库的建设</a><br  /></p></section></section><section style="display: flex;justify-content: flex-start;align-items: flex-start;margin-top: 10px;"><section style="box-sizing: border-box;width: 11px;height: 11px;border-width: 1px;border-style: solid;border-color: rgb(79, 228, 237);margin-top: 7px;margin-right: 15px;flex-shrink: 0;overflow: hidden;"><br  /></section><section data-autoskip="1" style="text-align: justify;line-height:1.75em;letter-spacing: 1.5px;font-size:14px;color:#3e4c51;background: transparent;"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU2ODQ3NjYyMA==&amp;mid=2247486569&amp;idx=2&amp;sn=bf09a2857ef12ca2bdec466729fbc511&amp;chksm=fc8c1acacbfb93dc2ea2a8addead6a2b9105b61f435ccd31e028296b0caf3430aac2444a936b&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">数仓规范|使SQL更易于阅读的几个小技巧</a><br  /></p></section></section><section style="display: flex;justify-content: flex-start;align-items: flex-start;margin-top: 10px;"><section style="box-sizing: border-box;width: 11px;height: 11px;border-width: 1px;border-style: solid;border-color: rgb(79, 228, 237);margin-top: 7px;margin-right: 15px;flex-shrink: 0;overflow: hidden;"><br  /></section><section data-autoskip="1" style="text-align: justify;line-height:1.75em;letter-spacing: 1.5px;font-size:14px;color:#3e4c51;background: transparent;"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU2ODQ3NjYyMA==&amp;mid=2247486547&amp;idx=2&amp;sn=d124aedbe197d0c564f73204f41f72fe&amp;chksm=fc8c1af0cbfb93e64834e4f4cb215a63cd226d8d730911890b3753ad105e990da27e6b0dc6ad&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">如何使用Hive进行OLAP分析</a><br  /></p></section></section><section style="display: flex;justify-content: flex-start;align-items: flex-start;margin-top: 10px;"><section style="box-sizing: border-box;width: 11px;height: 11px;border-width: 1px;border-style: solid;border-color: rgb(79, 228, 237);margin-top: 7px;margin-right: 15px;flex-shrink: 0;overflow: hidden;"><br  /></section><section data-autoskip="1" style="text-align: justify;line-height:1.75em;letter-spacing: 1.5px;font-size:14px;color:#3e4c51;background: transparent;"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU2ODQ3NjYyMA==&amp;mid=2247486511&amp;idx=1&amp;sn=5a959ce84ea93d41e51efc7b61e855f3&amp;chksm=fc8c1a8ccbfb939a193eea96a27f562bfdb6d8a10325d0783fbd73c3ffdbd87ffc7668f5d979&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">该如何设计数仓的汇总层(DWS)</a><br  /></p></section></section></section></section></section></section><section data-role="paragraph"><p style="text-align: center;"><img class="rich_pages wxw-img" data-ratio="0.5555555555555556" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/PL10rfzHicsgYic9icrPjCqicQZOqicicQRjOr9ka3KSCgElNV1HLd89YxT5NMTUmMwhGyE7KFVo2I11Rta7icUMP2muA/640?wx_fmt=png" data-type="png" data-w="900" style=""></p><p><br  /></p></section></section><div class="msg_source_url"><a href="http://mp.weixin.qq.com/mp/homepage?__biz=MzU2ODQ3NjYyMA==&hid=5&sn=512054e59f6ed54bd7e5f451785e82c9&scene=18#wechat_redirect" target="_blank">阅读原文</a></div></content><div class="msg_source_url"><a href="http://mp.weixin.qq.com/mp/homepage?__biz=MzU2ODQ3NjYyMA==&hid=5&sn=512054e59f6ed54bd7e5f451785e82c9&scene=18#wechat_redirect" target="_blank">阅读原文</a></div>
</div>
</body>
</html>