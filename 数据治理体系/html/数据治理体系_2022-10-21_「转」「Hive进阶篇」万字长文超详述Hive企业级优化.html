<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 0 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic{color:#8e8e8e;background:#f7f7f7;border-radius:5px;padding:10px 8px;}.topic a{padding-right:5px;}.topic p{margin-bottom:5px;}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head><script>
var data={"mp":"数据治理体系","title":"「Hive进阶篇」万字长文超详述Hive企业级优化","time":"2022-10-21 19:31:49","timeStamp":"1666351909"};
</script>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="http://mp.weixin.qq.com/s?__biz=MzA3NjIzNjMwOA==&mid=2247490827&idx=1&sn=1328b44aef354d38640be7781fe046bd&chksm=9f650e70a812876663334ca834106a7bda4d48d054839f6dcc0d62138fb9551ca3f6994360e5#rd" target="_blank">「Hive进阶篇」万字长文超详述Hive企业级优化</a></h1><div id="meta_content" class="rich_media_meta_list"><span class="rich_media_meta rich_media_meta_text">大数据小江 Akin&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">数据治理体系&nbsp;&nbsp;</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2022-10-21 19:31:49</em></div><content><div class="reprint"><p>转自公众号：大数据阶梯之路<br><a href="http://mp.weixin.qq.com/s?__biz=Mzg4MTYyMzI4Mw==&mid=2247484236&idx=1&sn=e5512f69a9927db92c5a94642664ea5b" target="_blank" title="阅读原文">http://mp.weixin.qq.com/s?__biz=Mzg4MTYyMzI4Mw==&mid=2247484236&idx=1&sn=e5512f69a9927db92c5a94642664ea5b</a></p></div><section data-role="outer" label="edit by 135editor" style="margin-bottom: 0px;" data-mpa-powered-by="yiban.io"><p><br  /></p><p><img class="rich_pages wxw-img" data-ratio="0.5507246376811594" data-w="828" style="box-sizing: border-box;vertical-align: inherit;width: 100%;max-width: 100% !important;height: auto !important;" src="https://mmbiz.qpic.cn/mmbiz_jpg/AxUordoh3AsqlesUzSAjTGvGxOicHbubGLlwibwykD29KIMuMohOTG7czdw1lGQO76D7pmztiaUdJMoqLtMdYcTGA/640?wx_fmt=jpeg"  />9</p><p style="text-align:right;"><span style="font-size: 13px;color: rgb(255, 0, 0);font-family: 楷体, 楷体_GB2312, SimKai;">文章字数：13271字</span></p><p style="text-align:right;"><span style="font-size: 13px;color: rgb(255, 0, 0);font-family: 楷体, 楷体_GB2312, SimKai;">预计阅读需：18分钟</span></p><section data-role="paragraph"><blockquote style="line-height: 22.4px;box-sizing: content-box;margin: 15px 0px;border-left: 4px solid rgb(221, 221, 221);padding: 0px 15px;color: rgb(119, 119, 119);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;font-family: PingFangSC-Regular, sans-serif;"><p style="line-height: 22.399999618530273px;box-sizing: content-box;margin: 0px;color: #333333;"><span style="caret-color: red;font-family: 楷体, 楷体_GB2312, SimKai;">大家好，肝了几个晚上，梳理总结了一份万字长文超详述hive企业级优化文章，也整理了一份</span><code data-backticks="1" style="caret-color: red;line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding-top: 4px;padding-right: 4px;padding-bottom: 2px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">hive优化总结思维导图</span></code><span style="caret-color: red;font-family: 楷体, 楷体_GB2312, SimKai;">和</span><code data-backticks="1" style="caret-color: red;line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding-top: 4px;padding-right: 4px;padding-bottom: 2px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">hive优化详细PDF文档</span></code><span style="caret-color: red;font-family: 楷体, 楷体_GB2312, SimKai;">，<strong style="line-height: 22.399999618530273px;box-sizing: content-box;">有需要可 点赞+在看 关注公众号《大数据阶梯之路》找小编获取文档保存本地吧，学习和复习都是绝佳，公众号不断分享技术相关文章</strong>。话不多说，下面就直接开讲吧！</span></p></blockquote><h3 style="line-height: 43.2px;box-sizing: content-box;font-size: 27px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong>一、问题背景</strong></span></h3><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">hive离线数仓开发，一个良好的数据任务，它的运行时长一般是在合理范围内的，当发现报表应用层的指标数据总是产出延迟，排查定位发现是有些任务执行了超10小时这样肯定是不合理的，此时就该想想如何优化数据任务链路，<strong style="line-height: 22.399999618530273px;box-sizing: content-box;">主要从以下几个角度来考虑问题解决</strong>：</span></p><section data-role="list"><ol style="list-style-type: decimal;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">从数据任务本身hive逻辑代码出发，即hive逻辑优化，偏理解业务角度</span></p></li><li><p><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">从集群的资源设置出发，即hive参数调优，偏理解技术角度</span></p></li><li><p><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">从全局数据链路的任务设置出发，观测是否任务执行调度设置不合理</span></p></li><li><p><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">从数仓的数据易用性和模型复用性的角度出发，针对某些中间逻辑过程可以复用的就落地中间模型表</span></p></li></ol></section><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="caret-color: red;line-height: 22.4px;box-sizing: content-box;">附上一份个人梳理总结的思维导图部分截图</strong><strong style="caret-color: red;line-height: 22.4px;box-sizing: content-box;"></strong></span></p><p style="text-align: center;margin-bottom: 0em;"><img class="rich_pages wxw-img js_insertlocalimg" data-ratio="0.5" data-s="300,640" data-type="png" data-w="1280" style="height: auto !important;" src="https://mmbiz.qpic.cn/mmbiz_png/AxUordoh3AsqlesUzSAjTGvGxOicHbubG53FBpJrMhqvGy0YviaPY6xaLibWjNxiaoAXGxMWCmQricsZbxfLlZJictDQ/640?wx_fmt=png"  /></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">下面就先分享下常见的hive优化策略吧~<strong>&nbsp;</strong></strong><strong style="line-height: 22.399999618530273px;box-sizing: content-box;"></strong><strong style="line-height: 22.399999618530273px;box-sizing: content-box;"></strong><strong style="line-height: 22.399999618530273px;box-sizing: content-box;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><strong>会附带案例实践帮助理解</strong></code></strong></span></p><blockquote style="line-height: 22.4px;box-sizing: content-box;margin: 15px 0px;border-left: 4px solid rgb(221, 221, 221);padding: 0px 15px;color: rgb(119, 119, 119);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;font-family: PingFangSC-Regular, sans-serif;"><p style="box-sizing: content-box;margin: 0px 0px 10px;color: #333333;line-height: 1.75em;"><span style="font-size: 16px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">hive优化文章大纲</strong></span></p><section data-role="list"><ol style="list-style-type: decimal;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">列裁剪和分区裁剪</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">提前数据收敛</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">谓词下推(PPD)</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">多路输出，减少表读取次数写多个结果表</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">合理选择排序</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">join优化</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">合理选择文件存储格式和压缩方式</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">解决小文件过多问题</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">distinct 和 group by</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">参数调优</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">解决数据倾斜问题</span></p></li></ol></section></blockquote><h3 style="box-sizing: content-box;font-size: 27px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong>二、hive优化</strong></span></h3><h4 style="box-sizing: content-box;font-size: 20px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><span style="font-size: 16px;font-family: 楷体, 楷体_GB2312, SimKai;">1. 列裁剪和分区裁剪</span></strong></span></h4><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">裁剪 顾名思义就是不需要的数据不要多查。</span></code><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">列裁剪，尽量减少直接</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">select * from table</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">这种操作，首先可读性不好，根本不知道具体用到哪几个列，其次列选择多了也会增大IO传输；<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />分区裁剪就是针对分区表切记要加上分区过滤条件，比如表以时间作为分区字段，要加上分区筛选。</span></p><h4 style="box-sizing: content-box;font-size: 20px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><span style="font-size: 16px;font-family: 楷体, 楷体_GB2312, SimKai;">2. 提前数据收敛</span></strong></span></h4><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">在子查询中，有些条件能先过滤的尽量放在子查询里先过滤，减少子查询输出的数据量。</span></p><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;原脚本</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span><br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.字段a,a.字段b,b.字段a,b.字段b<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;<br style="margin: 0px;padding: 0px;"  />(<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;字段a,字段b<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;table_a<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;dt&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">date_sub</span>(<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">current_date</span>,<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>)<br style="margin: 0px;padding: 0px;"  />)&nbsp;a&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">left</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">join</span>&nbsp;<br style="margin: 0px;padding: 0px;"  />(<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;字段a,字段b<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;table_b<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;dt&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">date_sub</span>(<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">current_date</span>,<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>)<br style="margin: 0px;padding: 0px;"  />)&nbsp;b&nbsp;<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">on</span>&nbsp;a.字段a&nbsp;=&nbsp;b.字段a<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;a.字段b&nbsp;&lt;&gt;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">''</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">and</span>&nbsp;b.字段b&nbsp;&lt;&gt;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'xxx'</span><br style="margin: 0px;padding: 0px;"  />;<br style="margin: 0px;padding: 0px;"  /><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;优化脚本&nbsp;（数据收敛）</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span><br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.字段a,a.字段b,b.字段a,b.字段b<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;<br style="margin: 0px;padding: 0px;"  />(<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;字段a,字段b<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;table_a<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;dt&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">date_sub</span>(<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">current_date</span>,<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>)<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">and</span>&nbsp;字段b&nbsp;&lt;&gt;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">''</span><br style="margin: 0px;padding: 0px;"  />)&nbsp;a&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">left</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">join</span>&nbsp;<br style="margin: 0px;padding: 0px;"  />(<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;字段a,字段b<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;table_b<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;dt&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">date_sub</span>(<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">current_date</span>,<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>)<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">and</span>&nbsp;字段b&nbsp;&lt;&gt;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'xxx'</span><br style="margin: 0px;padding: 0px;"  />)&nbsp;b&nbsp;<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">on</span>&nbsp;a.字段a&nbsp;=&nbsp;b.字段a<br style="margin: 0px;padding: 0px;"  />;</span></code></pre><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><br  /></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><strong style="font-family: 楷体, 楷体_GB2312, SimKai;font-size: 16px;">3. 谓词下推（Predicate Pushdown）</strong><br  /></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">谓词下推Predicate Pushdown是什么？简称PPD，指的是在不影响数据结果的情况下，将过滤表达式尽可能移动至靠近数据源的位置，以使真正执行时能直接跳过无关的数据</strong>，这样在map执行过滤条件，可以减少map端数据输出，起到了数据收敛的作用，<strong style="line-height: 22.399999618530273px;box-sizing: content-box;">降低了数据在集群上传输的量，节约了集群的资源，也提升了任务的性能</strong>。<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />hive默认是开启谓词下推该参数设置的，</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">hive.optimize.ppd=true</span></code><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">所谓下推，即谓词过滤在map端执行；所谓不下推，即谓词过滤在reduce端执行。</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />关于谓词下推的规则，主要分为join的on条件过滤下推和where条件过滤下推，我整理了一张图方便理解。</span></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><img class="rich_pages wxw-img" data-ratio="0.06388888888888888" data-w="1080" style="box-sizing: border-box;vertical-align: inherit;width: 100%;max-width: 100% !important;height: auto !important;" src="https://mmbiz.qpic.cn/mmbiz_png/AxUordoh3AsqlesUzSAjTGvGxOicHbubGZhBhpAQ44ibbnlibE91sdIrRfTLxqOEwVOKru8CHSszx7AWDfBdhNBwQ/640?wx_fmt=png"  /></span></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">核心判断逻辑：join的on条件过滤不能下推到保留行表中；where条件过滤不能下推到null补充表中。</strong><strong style="line-height: 22.399999618530273px;box-sizing: content-box;"></strong></span></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;"></strong><span style="white-space:pre-wrap;box-sizing: border-box;margin: 0px 0px -7px;padding: 0px;color: rgb(0, 0, 0);font-size: 16px;text-align: left;text-decoration-thickness: initial;display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/XYrRG5UShDc3a6nCEJux5ha2U4ZgQe4drYD4jILdI45wg3HsicrU893Qj6I9XFwV8W7boUJdpy1rxhN8h56bCITQp3jWDNq7w/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 558px;border-radius: 5px;font-family: 楷体, 楷体_GB2312, SimKai;"></span></span><code style="white-space:pre-wrap;margin: 0px;padding: 15px 16px 16px;text-align: left;text-decoration-thickness: initial;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;举例说明：以下脚本 on后面的a表条件过滤没有下推至map端运行而是在reduce端运行，where后面的b表条件过滤则有下推至map端运行</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span><br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.字段a,a.字段b,b.字段a,b.字段b<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;table_a&nbsp;a<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">left</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">join</span>&nbsp;table_b&nbsp;b<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">on</span>&nbsp;a.字段a&nbsp;&lt;&gt;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">''</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;a表条件过滤</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;a.字段b&nbsp;&lt;&gt;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'xxx'</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;a表条件过滤</span><br style="margin: 0px;padding: 0px;"  />;</span></code></p><blockquote style="line-height: 22.4px;box-sizing: content-box;margin: 15px 0px;border-left: 4px solid rgb(221, 221, 221);padding: 0px 15px;color: rgb(119, 119, 119);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;font-family: PingFangSC-Regular, sans-serif;"><p style="box-sizing: content-box;margin: 0px;color: #333333;line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">谓词下推注意事项：</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />如果在表达式中含有不确定函数，整个表达式的谓词将不会被下推。例如下面脚本，则整个条件过滤都是在reduce端执行：</span></p></blockquote><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;a.*<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;a&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">join</span>&nbsp;b&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">on</span>&nbsp;a.id&nbsp;=&nbsp;b.id<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;a.ds&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'2019-10-09'</span>&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">and</span>&nbsp;a.create_time&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">unix_timestamp</span>()<br style="margin: 0px;padding: 0px;"  />;</span></code></pre><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">因为上面</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">unix_timestamp()</span></code><span style="font-family: 楷体, 楷体_GB2312, SimKai;">是不确定函数，在编译的时候无法得知，所以，整个表达式不会被下推，即ds='2022-07-04'也不会被提前过滤。类似的不确定函数还有</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">rand()</span></code><span style="font-family: 楷体, 楷体_GB2312, SimKai;">函数等。</span></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">附上2篇关于谓词下推的详细案例分析讲解<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">!上链接，自行复制去访问哈</strong>：</span></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">①&nbsp; &nbsp;https://cloud.tencent.com/developer/article/1616687</span></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">②&nbsp; &nbsp;https://cloud.tencent.com/developer/article/1616689</span></p><h4 style="box-sizing: content-box;font-size: 20px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><span style="font-size: 16px;font-family: 楷体, 楷体_GB2312, SimKai;">4. 多路输出</span></strong></span></h4><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">当我们有</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">使用一次查询，多次插入</span></code><span style="font-family: 楷体, 楷体_GB2312, SimKai;">的场景时，则可以采用多路输出的写法，减少表的读取次数，起到性能优化的作用。</span></p><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;读取一次源表，同时写入多张目标表</span><br style="margin: 0px;padding: 0px;"  />from&nbsp;table_source<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">insert</span>&nbsp;overwrite&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">table</span>&nbsp;table_a<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;*<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;dt&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">date_sub</span>(<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">current_date</span>,<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>)<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">and</span>&nbsp;event_name&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'事件A'</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">insert</span>&nbsp;overwrite&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">table</span>&nbsp;table_b<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;*<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;dt&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">date_sub</span>(<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">current_date</span>,<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>)<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">and</span>&nbsp;event_name&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'事件B'</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">insert</span>&nbsp;oveewrite&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">table</span>&nbsp;table_c<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;*<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;dt&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">date_sub</span>(<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">current_date</span>,<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>)<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">and</span>&nbsp;event_name&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'事件C'</span><br style="margin: 0px;padding: 0px;"  />;</span></code></pre><blockquote style="line-height: 22.4px;box-sizing: content-box;margin: 15px 0px;border-left: 4px solid rgb(221, 221, 221);padding: 0px 15px;color: rgb(119, 119, 119);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;font-family: PingFangSC-Regular, sans-serif;"><p style="box-sizing: content-box;margin: 0px 0px 10px;color: #333333;line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">多路输出注意事项：</strong><strong style="line-height: 22.399999618530273px;box-sizing: content-box;"></strong></span></p><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">一般情况下，一个sql里面最多支持128路输出，超过了则会报错</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">在多插往同一张分区表的不同分区时，不允许在一个sql里面多路输出时既包含insert overwrite和insert into，要统一操作</span></p></li></ul></section></blockquote><h4 style="box-sizing: content-box;font-size: 20px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><span style="font-size: 16px;font-family: 楷体, 楷体_GB2312, SimKai;">5. 合理选择排序</span></strong></span></h4><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">order by</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">全局排序，只走一个reducer</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，当表数据量较大时容易计算不出来，性能不佳慎用，在严格模式下需要加limit</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">sort by</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />局部排序，即保证单个reduce内结果有序，但没有全局排序的能力。</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">distribute by</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">按照指定的字段把数据划分输出到不同的reducer中，是控制数据如何从map端输出到reduce端</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，hive会根据distribute by后面的字段和对应reducer的个数进行hash分发</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">cluster by</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />拥有distrubute by的能力，同时也拥有sort by的能力，</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">所以可以理解cluster by是 distrubute by+sort by</span></code></p></li></ul></section><blockquote style="line-height: 22.4px;box-sizing: content-box;margin: 15px 0px;border-left: 4px solid rgb(221, 221, 221);padding: 0px 15px;color: rgb(119, 119, 119);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;font-family: PingFangSC-Regular, sans-serif;"><p style="box-sizing: content-box;margin: 0px;color: #333333;line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">以下举个排序方式优化案例，<strong style="line-height: 22.399999618530273px;box-sizing: content-box;">取用户信息表(10亿数据量)中年龄排前100的用户信息</strong>：</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">以下案例实现也体现了一个大数据思想，分而治之，大job拆分小job。</span></code></p></blockquote><pre data-language="sql" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;margin: 2px 0px 8px;background-color: rgb(245, 247, 248);white-space: pre-wrap;overflow-wrap: break-word;caret-color: rgb(24, 24, 24);color: rgb(24, 24, 24);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;"><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;原脚本</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;*<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;tmp.user_info_table<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;dt&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'2022-07-04'</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">order</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">by</span>&nbsp;age&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;全局排序，只走一个reduce</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">limit</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">100</span><br style="margin: 0px;padding: 0px;"  />;<br style="margin: 0px;padding: 0px;"  /><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;优化脚本</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;mapred.reduce.tasks=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">50</span>;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;设置reduce个数为50</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;*<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;tmp.user_info_table<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;dt&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'2022-07-04'</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">distribute</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">by</span>&nbsp;(<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">case</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">when</span>&nbsp;age&lt;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">20</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">then</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">0</span><br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">when</span>&nbsp;age&nbsp;&gt;=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">20</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">and</span>&nbsp;age&nbsp;&lt;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">40</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">then</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span><br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">else</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">2</span><br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">end</span><br style="margin: 0px;padding: 0px;"  />)&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">-- distribute by主要是为了控制map端输出的数据在reduce端中是如何划分的，防止map端数据随机分配到reduce。这里字段做case when判断是因为用户年龄的零散值会导致分布不均匀，起太多reduce本身也耗时浪费资源</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">sort</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">by</span>&nbsp;age&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;起多个reduce排序，保证单个reduce结果有序</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">limit</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">100</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;取前100，因为是按照年龄局部排序过，所以前100个也一定是年龄最小的</span><br style="margin: 0px;padding: 0px;"  />;</span></code></pre></pre><blockquote style="line-height: 22.4px;box-sizing: content-box;margin: 15px 0px;border-left: 4px solid rgb(221, 221, 221);padding: 0px 15px;color: rgb(119, 119, 119);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;font-family: PingFangSC-Regular, sans-serif;"><p style="box-sizing: content-box;margin: 0px 0px 10px;color: #333333;line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="caret-color: red;line-height: 22.4px;box-sizing: content-box;">排序选择的小结：</strong><br  /></span></p><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">order by全局排序，但只有一个reducer执行，数据量大的话容易计算不过来，慎用</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">sort by局部排序，单个reducer内有序，把map端随机分发给reduce端执行，如果是要实现全局排序且走多个reducer的优化需求时，可以在外层嵌套一层，</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">例如：select * from (select * from 表名 sort by 字段名 limit N) order by 字段名 limit N</span></code><span style="font-family: 楷体, 楷体_GB2312, SimKai;">，这样就有2个Job，一个是内层的局部排序，一个是外层的归并全局排序</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">distribute by可以按照指定字段将数据进行hash分发到对应的reducer去执行</span></p></li><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">当分区字段和排序字段相同时可以使用cluster by来简化distribute by+sort by的写法</span></code><span style="font-family: 楷体, 楷体_GB2312, SimKai;">，但是cluster by排序只能是升序排序，不能指定排序规则是ASC或者DESC</span></p></li></ul></section></blockquote><h4 style="box-sizing: content-box;font-size: 20px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><span style="font-size: 16px;font-family: 楷体, 楷体_GB2312, SimKai;">6. join优化</span></strong></span></h4><blockquote style="line-height: 22.4px;box-sizing: content-box;margin: 15px 0px;border-left: 4px solid rgb(221, 221, 221);padding: 0px 15px;color: rgb(119, 119, 119);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;font-family: PingFangSC-Regular, sans-serif;"><p style="box-sizing: content-box;margin: 0px;color: #333333;line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">hive在redurce阶段完成的join就是common join，在map阶段完成的join就是map join。</strong></span></p></blockquote><section data-role="list"><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">提前收敛数据量，保证在join关联前无用数据不参与关联</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />这块可以跟前面的数据收敛模块&amp;谓词下推模块 搭配起来看，主要就是提前收敛数据量，不止在join场景，在其他复杂计算前同样适用。</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">left semi join左半关联</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">left semi join</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">一开始出现的使用场景其实是解决hive不支持in/exists子查询的高效实现，<strong style="line-height: 22.399999618530273px;box-sizing: content-box;">虽然left semi join含有left，但其实不是保留左表全部数据，效果类似于join吧，只是最终结果只取左表中的列，还有最终结果某些场景下会跟join结果不同。</strong></span></p></li></ul></section><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;a.*<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;<br style="margin: 0px;padding: 0px;"  />(<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">as</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">id</span>,<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'a'</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">as</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">name</span>&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">union</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">all</span>&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">2</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">as</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">id</span>,<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'b'</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">as</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">name</span>&nbsp;<br style="margin: 0px;padding: 0px;"  />)&nbsp;a&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">left</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">semi</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">join</span>&nbsp;<br style="margin: 0px;padding: 0px;"  />(&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">as</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">id</span>,<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'b'</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">as</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">name</span>&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">union</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">all</span>&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">as</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">id</span>,<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'c'</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">as</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">name</span>&nbsp;<br style="margin: 0px;padding: 0px;"  />)&nbsp;b&nbsp;<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">on</span>&nbsp;a.id&nbsp;=&nbsp;b.id<br style="margin: 0px;padding: 0px;"  />&nbsp;&nbsp;&nbsp;&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;你猜left semi join结果是？</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">id</span>&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">name</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>&nbsp;&nbsp;&nbsp;a<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;而如果上面的脚本是join呢，结果？</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">id</span>&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">name</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>&nbsp;&nbsp;&nbsp;a<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1</span>&nbsp;&nbsp;&nbsp;a</span></code></pre></section><blockquote style="line-height: 22.4px;box-sizing: content-box;margin: 15px 0px;border-left: 4px solid rgb(221, 221, 221);padding: 0px 15px;color: rgb(119, 119, 119);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;font-family: PingFangSC-Regular, sans-serif;"><p style="box-sizing: content-box;margin: 0px 0px 10px;color: #333333;line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">left semi join注意事项：</strong><strong style="line-height: 22.399999618530273px;box-sizing: content-box;"></strong></span></p><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">右表的条件过滤只能写在on后面，不能写在where后面</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">最终结果只能展示左表的列，右表的列不能展示</span></p></li><li><p style="line-height: 1.75em;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">left semi join与join的差异：主要在于右表有重复数据时，left semi join是遍历到右表一条数据后就跳过，只取一条，而join是一直遍历至右表最后一条数据，这也就是要注意实际数据场景是否有重复和是否要保留</span></p></li></ul></section></blockquote><section data-role="list"><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">大表join小表场景</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />大表join小表的话，</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">要把小表放在左边，大表放在右边</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，<strong style="line-height: 22.399999618530273px;box-sizing: content-box;">这是因为join操作发生在reduce阶段，在hive2.x版本以前，位于左边的表会被加载进内存中，所以如果是大表放左边被加载进内存的话就会有内存溢出的风险</strong>，不过在hive2.x版本后就已经优化好这块了，无需关注，底层帮我们优化好这个问题了。</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">启用mapjoin</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">mapjoin就是把join的表直接分发到map端的内存中，即在map端来执行join操作</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，就不用在reduce阶段进行join了，提高了执行效率。如果表比较小的话最好是启用mapjoin，hive默认是开启自动mapjoin的。</span></p></li></ul></section><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;hive.auto.convert.join&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(86, 182, 194);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">true</span>;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;大表小表的阈值设置（默认25M一下认为是小表）</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;hive.mapjoin.smalltable.filesize=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">26214400</span>;</span></code></pre></section><section data-role="list"><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">大表join大表场景</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />举例，假设a表是包括许多空值的数据，b表是不包含空值的数据</span></p></li></ul></section><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;不做优化时的原始hql</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;&nbsp;a.id&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;a&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">left</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">join</span>&nbsp;b<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">on</span>&nbsp;a.id&nbsp;=&nbsp;b.id</span></code></pre></section><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">1、空key过滤，过滤空key的数据</span></code></strong></span><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">关联的过程是相同key对应的数据都会发送到相同的reducer上，如果某些空key过多是会导致内存不够的，从而引发join超时，所以如果不需要这类空key数据的时候，可以先过滤掉这些异常数据。</span></p><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;做空key过滤优化时的hql，利用子查询先处理掉后再关联</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;a.id&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;(<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;*&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;a&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">where</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">id</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">is</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">not</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(86, 182, 194);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">null</span>)&nbsp;a<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">join</span>&nbsp;b<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">on</span>&nbsp;a.id&nbsp;=&nbsp;b.id</span></code></pre><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;">2、空key转换，转换key的数据进行关联时打散key</code></strong></span><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-family: 楷体, 楷体_GB2312, SimKai;">当然，有时候空值的数据又不一定是异常数据，还是需要保留的，但是空key过多都分配到一个reducer去了，这样执行起来就算不内存溢出也会发生数据倾斜情况，数据倾斜的话对集群资源的利用率来看的话是极其不利的，我们可以通过把空key虚拟成随机数，但要保证不是同一个空key，从而降低数据倾斜概率，虽然这样在对关联键做处理反而会总体增长执行时间，但却减轻了reducer负担。</span></p><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="box-sizing: border-box;margin: 0px 0px -7px;padding: 0px;display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/XYrRG5UShDc3a6nCEJux5ha2U4ZgQe4drYD4jILdI45wg3HsicrU893Qj6I9XFwV8W7boUJdpy1rxhN8h56bCITQp3jWDNq7w/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 558px;border-radius: 5px;font-family: 楷体, 楷体_GB2312, SimKai;"></span><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;做空key转换优化时的hql，利用case&nbsp;when判断加随机数</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;a.id&nbsp;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;a.left&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">join</span>&nbsp;b<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">on</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">case</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">when</span>&nbsp;a.id&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">is</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(86, 182, 194);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">null</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">then</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">concat</span>(<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'hive'</span>+<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">rand</span>())&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">else</span>&nbsp;a.id&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">end</span>&nbsp;=&nbsp;b.id</span></code></pre><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">避免笛卡尔积</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />尽量避免笛卡尔积，即避免join的时候不加on条件，或者无效的on条件，因为Hive只能使用1个reducer来完成笛卡尔积，不过这点hive会通过严格模式下来提醒，在严格模式下出现笛卡尔积时报错。</span></p></li></ul></section><h4 style="box-sizing: content-box;font-size: 20px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><span style="font-size: 16px;font-family: 楷体, 楷体_GB2312, SimKai;">7. 合理选择文件存储格式和压缩方式</span></strong></span></h4><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">关于这点，我专门写过一篇文章介绍hive常见的几种存储格式和压缩方式，具体可以去上次我写过的这篇文章看看<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">!上链接</strong>：</span><a href="https://mp.weixin.qq.com/s?__biz=Mzg4MTYyMzI4Mw==&amp;mid=2247483930&amp;idx=1&amp;sn=92d95128c107f4020d5d02f5f4fd871a&amp;scene=21#wechat_redirect" style="line-height: 22.4px;box-sizing: content-box;text-decoration: underline;color: rgb(82, 134, 188);font-family: 楷体, 楷体_GB2312, SimKai;" data-linktype="2"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">https://mp.weixin.qq.com/s/RndQKF5y9Mto7QfgiiAOvQ</span></a></p><h4 style="box-sizing: content-box;font-size: 20px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><span style="font-size: 16px;font-family: 楷体, 楷体_GB2312, SimKai;">8. 解决小文件过多问题</span></strong></span></h4><section data-role="list"><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">先来说一说什么是小文件，怎么发生的</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">顾名思义，小文件就是文件很小的文件，小文件的产生一定是发生在向hive表导入数据的时候</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，比如：</span></p></li></ul></section><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;第①种导入数据方式</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">insert</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">into</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">table</span>&nbsp;A&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">values</span>();&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;每执行一条语句hive表就产生一个文件，但这种导入数据方式生产环境少见；</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;第②种导入数据方式</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">load</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">data</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">local</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">path</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'本地文件/本地文件夹&nbsp;路径'</span>&nbsp;overwrite&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">into</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">table</span>&nbsp;A;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;导入文件/文件夹`，即有多少个文件hive表就会产生多少个文件</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;第③种导入数据方式</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">insert</span>&nbsp;overwrite&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">table</span>&nbsp;A&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;*&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;B;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;通过查询的方式导入数据是生产环境最常见的</span></span></code></pre></section><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">MR中&nbsp;</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">reduce 有多少个就输出多少个文件，文件数量 = reduce数量 * 分区数</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，如果说某些简单job没有reduce阶段只有map阶段，那</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">文件数量 = map数量 * 分区数</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">。<strong style="line-height: 22.399999618530273px;box-sizing: content-box;">从公式上看，reduce的个数和分区数最终决定了输出的文件的个数，所以可以调整reduce的个数以及分区 达到控制hive表的文件数量。</strong></span></p><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">小文件过多有什么影响</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">首先第一点从HDFS底层来看</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，小文件过多会给集群namenode带来负担，即namenode元数据大占用内存，影响HDFS的性能<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">第二点从hive来看</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，在进行查询时，每个小文件都会当成一个块，启动一个Map任务来完成，而一个Map任务启动和初始化的时间远远大于逻辑处理的时间，就会造成很大的资源浪费</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">如何解决小文件过多问题</strong></span></p></li></ul></section><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">1、使用hive自带的 concatenate 命令，来合并小文件</span></code></strong></span><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">不过要注意的是concatenate命令只支持hive表存储格式是orcfile或者rcfile，还有该方式不支持指定合并后的文件数量</span></p><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;对于非分区表</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">alter</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">table</span>&nbsp;test_table&nbsp;concatenate;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;对于分区表</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">alter</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">table</span>&nbsp;test_table&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">partition</span>(dt&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(152, 195, 121);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">'2022-07-16'</span>)&nbsp;concatenate;</span></code></pre><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;">2、调整参数减少Map数</code></strong></span></p><section data-role="list"><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">设置map输入合并小文件</strong></span></p></li></ul></section><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;102400000B=102400KB=100M</span><br style="margin: 0px;padding: 0px;"  /><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;每个Map最大输入大小(这个值决定了合并后文件的数量)</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;mapred.max.split.size=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">102400000</span>;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;一个节点上split的至少的大小(这个值决定了多个DataNode上的文件是否需要合并)</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;mapred.min.split.size.per.node=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">102400000</span>;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;一个交换机下split的至少的大小(这个值决定了多个交换机上的文件是否需要合并)</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;mapred.min.split.size.per.rack=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">102400000</span>;<br style="margin: 0px;padding: 0px;"  /><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;前3行设置是确定合并文件块的大小，&gt;128M的文件按128M切块，&gt;100M和&lt;128M的文件按100M切块，剩下的&lt;100M的小文件直接合并</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;map执行前合并小文件</span></span></code></pre></section><section data-role="list"><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">设置map输出和reduce输出合并小文件</strong></span></p></li></ul></section><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;设置map端输出进行合并，默认为true</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;hive.merge.mapfiles&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(86, 182, 194);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">true</span>;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;设置reduce端输出进行合并，默认为false</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;hive.merge.mapredfiles&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(86, 182, 194);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">true</span>;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;设置合并文件的大小</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;hive.merge.size.per.task&nbsp;=&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">256</span>*<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1000</span>*<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">1000</span>;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;当输出文件的平均大小小于该值时，启动一个独立的MapReduce任务进行文件merge</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;hive.merge.smallfiles.avgsize=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">16000000</span>;&nbsp;</span></code></pre></section><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;">3、调整参数减少Reduce数</code></strong></span></p><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">-- hive中的分区函数 distribute by 正好是控制MR中partition分区的，然后通过设置reduce的数量，结合分区函数让数据均衡的进入每个reduce即可。</span><br style="margin: 0px;padding: 0px;"  /><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;直接设置reduce个数</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;mapreduce.job.reduces=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">10</span>;<br style="margin: 0px;padding: 0px;"  /><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;执行以下语句，将数据均衡的分配到reduce中</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;mapreduce.job.reduces=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">10</span>;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">insert</span>&nbsp;overwrite&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">table</span>&nbsp;A&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">partition</span>(dt)<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">select</span>&nbsp;*&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">from</span>&nbsp;B<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">distribute</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">by</span>&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">rand</span>();<br style="margin: 0px;padding: 0px;"  />解释：如设置reduce数量为10，则使用 rand()，&nbsp;随机生成一个数x % 10，这样数据就会随机进入 reduce 中，防止出现有的文件过大或过小</span></code></pre><h4 style="box-sizing: content-box;font-size: 20px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><span style="font-size: 16px;font-family: 楷体, 楷体_GB2312, SimKai;">9. count(distinct ) 和 group by</span></strong></span></h4><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">在计算去重指标的时候，比如不同年龄段的用户数这个指标，一般都是采用</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">count(distinct user_id)</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">直接计算，当表数据量不大的话影响不大，<strong style="line-height: 22.399999618530273px;box-sizing: content-box;">但如果数据量大count distinct就很耗性能了，因为其只会用一个reduce task来执行，容易reduce端数据倾斜</strong>，通常优化就使用</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">里层group by age然后再外层count(user_id)</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">来替代。</span></p><blockquote style="line-height: 22.4px;box-sizing: content-box;margin: 15px 0px;border-left: 4px solid rgb(221, 221, 221);padding: 0px 15px;color: rgb(119, 119, 119);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;font-family: PingFangSC-Regular, sans-serif;"><p style="box-sizing: content-box;margin: 0px 0px 10px;color: #333333;line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">注意事项：</strong><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />关于使用</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">里层group by age然后再外层count(user_id)</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">来替代</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">count(distinct user_id)</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">直接去重计算是否一定就起到优化效果这也是看情况的，假设表数据量不是特别大，有些情况下</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">里层group by age然后再外层count(user_id)</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">未必就见得比</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">count(distinct user_id)</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">好。<strong style="line-height: 22.399999618530273px;box-sizing: content-box;">所以还是具体业务场景具体分析为好，优化从来不是考虑局部就好，要全局考虑。</strong></span></p><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">hive3.x版本里已经新增了对</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">count(distinct )</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">的优化，通过</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.optimize.countdistinct</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">配置，即使真的出现数据倾斜也可以自动优化，自动改变SQL执行的逻辑</span></p></li><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">里层group by age然后再外层count(user_id)</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">这种方式会生成2个job任务，会消耗更多的磁盘网络I/O资源</span></p></li></ul></section></blockquote><h4 style="box-sizing: content-box;font-size: 20px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><span style="font-size: 16px;font-family: 楷体, 楷体_GB2312, SimKai;">10. 参数调优</span></strong></span></h4><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.optimize.countdistinct=true</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">开启对count(distinct )的自动优化</span></p></li><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.auto.convert.join = true;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">开启自动mapjoin<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.mapjoin.smalltable.filesize=26214400;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">大表小表的阈值设置（默认25M一下认为是小表）</span></p></li><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.exec.parallel=true;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">打开任务并行执行<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.exec.parallel.thread.number=16;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">同一个sql允许最大并行度，默认值为8。默认情况下，Hive一次只会执行一个阶段。开启并行执行时会把一个sql语句中没有相互依赖的阶段并行去运行，这样可能使得整个job的执行时间缩短。提高集群资源利用率，不过这当然得是在系统资源比较空闲的时候才有优势，否则没资源，并行也起不来。</span></p></li><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.map.aggr=true;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">默认值是true，当选项设定为true时，开启map端部分聚合<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.groupby.skewindata = ture;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">默认值是false，当有数据倾斜的时候进行负载均衡，<strong style="line-height: 22.399999618530273px;box-sizing: content-box;">生成的查询计划有两个MapReduce任务</strong>，第一个MR Job中，Map的输出结果会随机分布到Reduce中，每个Reduce做部分聚合操作，并输出结果，这样处理的结果是相同的Group By Key有可能被分发到不同的Reduce中，从而达到负载均衡的目的；第二个MR Job再根据预处理的数据结果按照Group By Key分布到Reduce中（这个过程可以保证相同的Group By Key被分布到同一个Reduce中），最后完成最终的聚合操作</span></p></li><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.mapred.mode=strict;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">设置严格模式，默认值是nonstrict非严格模式。严格模式下会禁止以下3种类型不合理查询，即以下3种情况会报错</span></p></li><section data-role="list"><ul style="list-style-type: square;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">对于查询分区表，必须where加上分区限制条件</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">使用order by全局排序时，必须加上limit限制数据查询条数</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">限制了笛卡尔积查询</span></p></li></ul></section><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">设置map端执行前合并小文件</span></p></li><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.exec.compress.output=true;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">设置hive的查询结果输出是否进行压缩<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set mapreduce.output.fileoutputformat.compress=true;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">设置MapReduce Job的结果输出是否使用压缩</span></p></li><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.cbo.enable=false;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">关闭CBO优化，默认值true开启，可以自动优化HQL中多个JOIN的顺序，并选择合适的JOIN算法</span></p></li></ul></section><h4 style="box-sizing: content-box;font-size: 20px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><span style="font-size: 16px;font-family: 楷体, 楷体_GB2312, SimKai;">11. 解决数据倾斜问题</span></strong></span></h4><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">什么是数据倾斜<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">数据倾斜是大量的相同key被partition分配到同一个reduce里,造成了'一个人累死,其他人闲死'的情况</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，违背了并行计算的初衷，而且当其他节点计算好了还要等待这个忙碌节点的计算，效率就被拉低了</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">数据倾斜的明显表现<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">任务进度长时间维持在99%</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，查看任务监控页面，发现只有少量（1个或几个）reduce子任务未完成。因为其处理的数据量和其他reduce差异过大</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">数据倾斜的根本原因是什么？<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />key分布不均匀，redurce数据处理不均匀</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">如何尽量避免数据倾斜<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />如何将数据均匀的分配到各个reduce中，就是避免数据倾斜的根本所在。举例下2个典型案例，关于join操作发生的数据倾斜和解决方案：</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">就在文章上面的第六点join优化【大表join大表场景】</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，还有合理设置map数和reduce数的解决方案。</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">合理设置map数和reduce数</span></p></li></ul></section><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;">1、Map端优化</code></span></strong></span><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">通常情况下，Job会通过input目录产生一个或多个map任务，</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">map数主要取决与input的文件总个数，文件总大小，集群设置的文件块大小。</span></code><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">从hadoop2.7.3版本开始，HDFS的默认块大小block size是128M。每张hive表在hdfs上对应存储都是一个文件，关于执行task时，每一个128M的文件都是一个块block，每个块就用一个map任务来完成，若文件超过128M就分块，若小于128M则独立成块。<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">那么：①当小文件过多怎么办？</span></code><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">答案是map任务增多，map任务的启动和初始化时间远大于执行逻辑处理时间，从而集群造成资源浪费。<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">②是不是让每个文件都接近128M大小就毫无问题了呢？</span></code><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">答案是不可能，假设一个文件大小127M，但表只有一两个字段，文件大小是由几千万条记录撑大的，如果数据处理逻辑复杂则用一个map任务去执行也是很耗时的。<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">③是不是map数越多越好？</span></code><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">答案是这种说法是片面的，map数增多有利于提升并行度，但一个map在启动和初始化时间是远大于执行逻辑处理时间，越多的map启动初始化就造成很大的集群资源浪费。</span></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">减少map数量，降低资源浪费，如何做？</span></code><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">以下相当于是把小文件合并成大文件处理 （多合一）</span></p><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;102400000B=102400KB=100M</span><br style="margin: 0px;padding: 0px;"  /><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;每个Map最大输入大小(这个值决定了合并后文件的数量)</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;mapred.max.split.size=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">102400000</span>;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;一个节点上split的至少的大小(这个值决定了多个DataNode上的文件是否需要合并)</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;mapred.min.split.size.per.node=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">102400000</span>;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;一个交换机下split的至少的大小(这个值决定了多个交换机上的文件是否需要合并)</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;mapred.min.split.size.per.rack=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">102400000</span>;<br style="margin: 0px;padding: 0px;"  /><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;前3行设置是确定合并文件块的大小，&gt;128M的文件按128M切块，&gt;100M和&lt;128M的文件按100M切块，剩下的&lt;100M的小文件直接合并</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;map执行前合并小文件</span></span></code></pre><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">有时候对hive进行优化，在执行时间上可能没什么大的改观，但是在计算资源上就有很大改善。</span></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">增大map数量，分担每个map处理的数据量提升任务效率，如何做？</span></code><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-family: 楷体, 楷体_GB2312, SimKai;">以下相当于是把小文件合并成大文件处理 （一拆多）</span></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">根据mapreduce切片的公式：</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">computeSliteSize(Math.max(minSize,Math.min(maxSize,blocksize)))</span></code><span style="font-family: 楷体, 楷体_GB2312, SimKai;">，从公式可以看出调整maxSize最大值,让maxSize最大值低于blocksize就可以增加map的个数。</span></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">mapreduce.input.fileinputformat.split.minsize（切片最小值)</span></code><span style="font-family: 楷体, 楷体_GB2312, SimKai;">，默认值=1，参数调的比blockSize大，则可以让切片变得比blocksize还大，从而减少map数<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;">mapreduce.input.fileinputformat.split.maxsize(切片最大值)</span></code><span style="font-family: 楷体, 楷体_GB2312, SimKai;">，默认值=blocksize块大小，参数如果调到比blocksize小，则会让切片变小，从而增大map数</span></p><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;">2、Reduce端优化</code></strong></span><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-family: 楷体, 楷体_GB2312, SimKai;">reduce个数设置过大也会产生很多小文件对namenode有影响，且输出的小文件偶尔也会作为下一个任务的输入导致出现小文件过多问题，设置过小又会导致单个reduce处理的数据量过大导致OOM异常。<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  />不指定时则hive会默认根据计算公式<code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;">hive.exec.reducers.bytes.per.reducer</code>(每个reduce任务处理数据量，默认1G)和<code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;">hive.exec.reducers.max</code>(每个任务的最大reduce数，默认1009个)，来做<code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;">min(hive.exec.reducers.max值,总输入数据量/hive.exec.reducers.bytes.per.reducer值)</code>计算，得出结果确定reduce个数，所以可以通过调整参数1和参数2来调整reduce个数，不过最简便的还是通过下面的参数来直接控制reduce个数。</span></p><pre data-tool="mdnice编辑器" style="margin: 10px 0px;padding: 0px;color: #000000;font-size: 16px;text-align: left;text-decoration-thickness: initial;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="margin: 0px;padding: 15px 16px 16px;overflow-x: auto;color: rgb(171, 178, 191);display: -webkit-box;font-size: 12px;background: rgb(40, 44, 52);border-radius: 5px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;手动指定reduce个数</span><br style="margin: 0px;padding: 0px;"  /><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;mapred.reduce.tasks=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">50</span>;<br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(92, 99, 112);font-style: italic;line-height: 26px;font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">--&nbsp;设置每一个job中reduce个数</span><br style="margin: 0px;padding: 0px;"  /><span style="margin: 0px;padding: 0px;color: rgb(198, 120, 221);line-height: 26px;font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set</span>&nbsp;mapreduce.job.reduces=<span style="margin: 0px;padding: 0px;color: rgb(209, 154, 102);line-height: 26px;font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">50</span>;</span></span></code></pre><p style="box-sizing: content-box;margin: 10px 0px;color: rgb(51, 51, 51);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">那么：①reduce数是不是越多越好？</span></code><br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">答案是错误的，同map数一样，启动reduce和初始化同样耗时和占资源，而且过多的reduce会生成多个文件，同样会出现小文件问题。<br style="line-height: 22.399999618530273px;box-sizing: content-box;"  /></span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">②什么情况下当设置了参数指定reduce个数后还是只有单个reduce在跑？</span></code></p><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">本身输入数据量就小于1G</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">在做测数据量验证时没加group by分组汇总。比如</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">select count(1) from test_table where dt = 20201228;</span></code></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">用了order by排序</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">关联出现了笛卡尔积</span></p></li></ul></section><blockquote style="line-height: 22.4px;box-sizing: content-box;margin: 15px 0px;border-left: 4px solid rgb(221, 221, 221);padding: 0px 15px;color: rgb(119, 119, 119);font-size: 14px;font-weight: normal;text-size-adjust: auto;text-decoration: none;font-family: PingFangSC-Regular, sans-serif;"><p style="box-sizing: content-box;margin: 0px 0px 10px;color: #333333;line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;"><strong style="line-height: 22.399999618530273px;box-sizing: content-box;">合理设置map数和reduce数的小结：</strong></span></p><section data-role="list"><ul style="list-style-type: disc;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set hive.input.format = org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">&nbsp;//系统默认格式，设置在map执行前合并小文件，减少map数</span></p></li><li><p style="line-height: 1.75em;"><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">set mapreduce.input.fileinputformat.split.maxsize = 100;</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">&nbsp;//调整最大切片值，让maxSize值低于blocksize就可以增加map数</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">根据mapreduce切片的公式：</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">computeSliteSize(Math.max(minSize,Math.min(maxSize,blocksize)))</span></code><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">，<strong style="line-height: 22.399999618530273px;box-sizing: content-box;">从公式可以看出调整maxSize最大值,让maxSize最大值低于blocksize，从而使切片变小，就可以增加map的个数</strong></span></p></li></ul></section></blockquote><h3 style="box-sizing: content-box;font-size: 27px;color: rgb(51, 51, 51);text-size-adjust: auto;text-decoration: none;line-height: 1.75em;font-family: PingFangSC-Regular, sans-serif;"><span style="font-family: 楷体, 楷体_GB2312, SimKai;"><strong>三、总结</strong></span></h3><section data-role="list"><ol style="list-style-type: decimal;margin: 0px;padding: 0px 0px 0px 30px;" class="list-paddingleft-1"><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">日常hive开发中时刻养成提前数据收敛的习惯，避免无用数据参与到计算中</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">不要过度进行优化，有可能做的是无用功甚至产生负效应，在调优上投入的工作成本和回报不成正比</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">对于公共可复用的逻辑代码，可以抽取出来落地临时表或者中间表，提升复用性，</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">强调复用！</span></code></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">理解hiveQL底层执行的原理，优化起来才有章可循</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">理透需求是代码优化的前提，关注全局数据链路，一些常见的hive优化策略要懂</span></p></li><li><p style="line-height: 1.75em;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">做hive优化的时候，涉及到参数调优时要慎重，比如把内存都申请抢占满了，避免因为你自己的任务调优了但影响到整个集群其他任务的资源分配，</span><code data-backticks="1" style="line-height: 22.4px;box-sizing: content-box;border-width: 0px;border-style: initial;border-color: initial;border-radius: 0px;color: rgb(193, 120, 139);padding: 4px 4px 2px 0px;letter-spacing: -0.3px;"><span style="font-size: 14px;font-family: 楷体, 楷体_GB2312, SimKai;">全局优才是优！</span></code></p></li></ol></section><section data-role="outer" label="Powered by 135editor.com" data-darkmode-bgcolor-16540943044599="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16540943044599="#fff|rgb(255, 255, 255)" data-darkmode-color-16540943044599="rgb(163, 163, 163)" data-darkmode-original-color-16540943044599="#fff|rgb(0, 0, 0)|rgb(62, 62, 62)" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;background-color: rgb(255, 255, 255);text-decoration-thickness: initial;color: rgb(62, 62, 62);word-spacing: 2px;letter-spacing: 0.544px;widows: 1;caret-color: rgb(255, 0, 0);font-size: 16px;text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;font-family: 微软雅黑;"><section data-tools="135编辑器" data-id="89450" data-darkmode-bgcolor-16540943044599="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16540943044599="#fff|rgb(255, 255, 255)" data-darkmode-color-16540943044599="rgb(163, 163, 163)" data-darkmode-original-color-16540943044599="#fff|rgb(0, 0, 0)|rgb(62, 62, 62)" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section data-tools="135编辑器" data-id="89450" data-darkmode-bgcolor-16540943044599="rgb(25, 25, 25)" data-darkmode-original-bgcolor-16540943044599="#fff|rgb(255, 255, 255)" data-darkmode-color-16540943044599="rgb(163, 163, 163)" data-darkmode-original-color-16540943044599="#fff|rgb(0, 0, 0)|rgb(62, 62, 62)" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;" draggable="true"><section class="mp_profile_iframe_wrp"><mp-common-profile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzA3NjIzNjMwOA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/hXibVSNciaXhzia07WkYkDfaRxHUiaDaNc5x3xTNO1RlNBRhPnxpEzoemhsn7ofat4pVwVgOktaveEtu6IKzzLONQQ/0?wx_fmt=png" data-nickname="数据治理体系" data-alias="DGsystem" data-signature="持续完善数据治理实战体系，数据仓库、标签、数字体系，实现业务数字化，数字资产化，资产业务化，资产资本化；回归业务场景的数字化案例才最具参考价值，最容易理解和借鉴的。" data-from="0"></mp-common-profile>&nbsp; &nbsp; &nbsp;</section></section></section></section></section></section><div class="msg_source_url"><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA3NjIzNjMwOA==&action=getalbum&album_id=1908216570263158791#wechat_redirect" target="_blank">阅读原文</a></div></content><div class="msg_source_url"><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA3NjIzNjMwOA==&action=getalbum&album_id=1908216570263158791#wechat_redirect" target="_blank">阅读原文</a></div>
</div>
</body>
</html>