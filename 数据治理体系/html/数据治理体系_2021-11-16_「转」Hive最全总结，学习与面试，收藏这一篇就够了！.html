<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 0 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic{color:#8e8e8e;background:#f7f7f7;border-radius:5px;padding:10px 8px;}.topic a{padding-right:5px;}.topic p{margin-bottom:5px;}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head><script>
var data={"mp":"数据治理体系","title":"Hive最全总结，学习与面试，收藏这一篇就够了！","time":"2021-11-16 20:19:43","timeStamp":"1637065183"};
</script>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="http://mp.weixin.qq.com/s?__biz=MzA3NjIzNjMwOA==&mid=2247484925&idx=1&sn=9b771a3072444bfe9a2cbda08fa1e397&chksm=9f651686a8129f902ed65f39d3c4512e19764a9d4b783d11d28196331eeefbcbbaddc9807c4f#rd" target="_blank">Hive最全总结，学习与面试，收藏这一篇就够了！</a></h1><div id="meta_content" class="rich_media_meta_list"><span class="rich_media_meta rich_media_meta_text">左右&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">数据治理体系&nbsp;&nbsp;</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-11-16 20:19:43</em></div><content><div class="reprint"><p>转自公众号：大数据左右手<br><a href="http://mp.weixin.qq.com/s?__biz=MzI4MjU4MzkwOQ==&mid=2247485612&idx=1&sn=5012c4c816799793bcac3d1c7e58d937" target="_blank" title="阅读原文">http://mp.weixin.qq.com/s?__biz=MzI4MjU4MzkwOQ==&mid=2247485612&idx=1&sn=5012c4c816799793bcac3d1c7e58d937</a></p></div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px;padding-right: 10px;padding-left: 10px;word-break: break-word;overflow-wrap: break-word;text-align: left;line-height: 1.75;color: rgb(89, 89, 89);font-family: Optima-Regular, Optima, PingFangTC-Light, PingFangSC-light, PingFangTC-light;letter-spacing: 2px;background-image: linear-gradient(90deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%), linear-gradient(360deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%);background-size: 20px 20px;background-position: center center;"><h2 data-tool="mdnice编辑器" style="font-weight: bold;color: black;font-size: 22px;margin-top: 20px;margin-right: 10px;"><span style="display: none;"></span></h2><section style="outline: 0px;max-width: 100%;color: rgb(89, 89, 89);font-family: Optima-Regular, Optima, PingFangTC-Light, PingFangSC-light, PingFangTC-light;font-size: 16px;letter-spacing: 2px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="font-size: 14px;word-spacing: 2px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">点击上方关注【</span><strong style="font-size: 14px;word-spacing: 2px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">大数据左右手</strong><span style="font-size: 14px;word-spacing: 2px;outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">】</span></section><p style="margin-top: 5px;margin-bottom: 5px;padding: 8px 10px;color: rgb(89, 89, 89);font-family: Optima-Regular, Optima, PingFangTC-Light, PingFangSC-light, PingFangTC-light;letter-spacing: 2px;white-space: normal;outline: 0px;max-width: 100%;overflow-wrap: break-word;background-color: rgb(255, 255, 255);line-height: 26px;font-size: 14px;word-spacing: 2px;word-break: break-word;text-align: center;background-image: linear-gradient(90deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%), linear-gradient(360deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%);background-size: 20px 20px;background-position: center center;box-sizing: border-box !important;"><span style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">加</span><span style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">技术</span><span style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">吐槽</span><span style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">群，获取更多资料</span></p><h2 data-tool="mdnice编辑器" style="font-weight: bold;color: black;font-size: 22px;margin-top: 20px;margin-right: 10px;"><span style="font-size: 18px;display: inline-block;padding-left: 10px;border-left: 5px solid rgb(222, 198, 251);color: rgb(89, 89, 89);">前言</span><br  /></h2><p>从以下方面对Hive做了一些总结，希望对你学习工作或者面试有所用处，赶快收藏吧！<br  /></p><ol class=" list-paddingleft-2" style="list-style-type: decimal;"><li style="font-weight: bold;"><p><strong>Hive架构与原理<br  /></strong></p></li><li style="font-weight: bold;"><p><strong>内部表与外部表</strong></p></li><li style="font-weight: bold;"><p><strong>Hive分区与分桶</strong></p></li><li style="font-weight: bold;"><p><strong>函数（开发重点）</strong></p></li><li style="font-weight: bold;"><p><strong>Hive 优化</strong></p></li><li style="font-weight: bold;"><p><strong>Hive数据倾斜</strong><br  /></p></li></ol><h2 data-tool="mdnice编辑器" style="margin-top: 20px;margin-right: 10px;font-weight: bold;font-size: 22px;font-family: Optima-Regular, Optima, PingFangTC-Light, PingFangSC-light, PingFangTC-light;letter-spacing: 2px;text-align: left;white-space: normal;color: black;"><span style="padding-left: 10px;font-size: 18px;display: inline-block;border-left: 5px solid rgb(222, 198, 251);color: rgb(89, 89, 89);">Hive 架构与原理</span></h2><h2 data-tool="mdnice编辑器" style="margin-top: 20px;margin-right: 10px;font-weight: bold;font-size: 22px;font-family: Optima-Regular, Optima, PingFangTC-Light, PingFangSC-light, PingFangTC-light;letter-spacing: 2px;text-align: left;white-space: normal;color: black;">Hive架构</h2><p style="text-align: center;"><img class="rich_pages wxw-img" data-fileid="100001956" data-galleryid="" data-ratio="0.9137380191693291" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/2gY1hzDz7dQfHPEeErHzuiaBGC8KEZiadIneBdeVyParEyTANaiat9MxXA2ONfU0BuChq2EluF9zR3ibaAbyCl5LSA/640?wx_fmt=png" data-type="png" data-w="626" style="width: 455px;height: auto !important;"  /></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>1 用户接口：Client</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">CLI（command-line interface）、JDBC/ODBC(jdbc访问hive)</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>2 元数据：Metastore</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">元数据包括：表名、表所属的数据库（默认是default）、表的拥有者、列/分区字段、表的类型（是否是外部表）、表的数据所在目录等；默认存储在自带的derby数据库中，推荐使用MySQL存储Metastore</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>3 Hadoop</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">使用HDFS进行存储，使用MapReduce进行计算。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>4 驱动器：Driver</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（1）解析器（SQL Parser）：将SQL字符串转换成抽象语法树AST，这一步一般都用第三方工具库完成，比如antlr；对AST进行语法分析，比如表是否存在、字段是否存在、SQL语义是否有误。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（2）编译器（Physical Plan）：将AST编译生成逻辑执行计划。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（3）优化器（Query Optimizer）：对逻辑执行计划进行优化。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（4）执行器（Execution）：把逻辑执行计划转换成可以运行的物理计划。对于Hive来说，就是MR/Spark。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>Hive运行原理<span style="display: none;"></span></h4><p style="text-align: center;"><img class="rich_pages wxw-img" data-fileid="100001957" data-galleryid="" data-ratio="0.47844228094575797" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/2gY1hzDz7dQfHPEeErHzuiaBGC8KEZiadI57rHZxttibh2rODk5ic4CgmaibzhrLWLt33jPozOfV0VukMca29n4vz3w/640?wx_fmt=png" data-type="png" data-w="719" style="height: auto !important;"  /></p><p><span style="font-size: 14px;word-spacing: 2px;">Hive通过给用户提供的一系列交互接口，接收到用户的指令(SQL)，使用自己的Driver，结合元数据(MetaStore)，将这些指令翻译成MapReduce，提交到Hadoop中执行，最后，将执行返回的结果输出到用户交互接口。</span></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">其实，还可以这样理解：Hive要做的就是将SQL翻译成MapReduce程序代码。实际上，Hive内置了很多Operator，每个Operator完成一个特定的计算过程，Hive将这些Operator构造成一个有向无环图DAG，然后根据这些Operator之间是否存在shuffle将其封装到map或者reduce函数中，之后就可以提交给MapReduce执行了。</p><h2 data-tool="mdnice编辑器" style="font-weight: bold;color: black;font-size: 22px;margin-top: 20px;margin-right: 10px;"><span style="display: none;"></span><span style="font-size: 18px;display: inline-block;padding-left: 10px;border-left: 5px solid rgb(222, 198, 251);color: rgb(89, 89, 89);">内部表与外部表</span></h2><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>不同点<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（1） 外部表不会加载数据到Hive，减少数据传输、数据还能共享。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">共享的理解就是：当我们删除一个内部表时，Hive 也会删除这个表中数据。内部表不适合和其他工具共享数据。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（2）Hive创建内部表时，会将数据移动到数据仓库指向的路径。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">创建外部表时，仅记录数据所在的路径，不对数据的位置做任何改变，</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">在删除表的时候，内部表的元数据和数据会被一起删除，而外部表只删除元数据，不删除数据。这样外部表相对来说更加安全些，数据组织也更加灵活，方便共享源数据。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><span style="color: black;font-size: 18px;font-weight: bold;">场</span><span style="color: black;font-size: 18px;font-weight: bold;">景选择</span></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">在公司中绝大多数场景都是外部表。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">自己使用的临时表，才会创建内部表。</p><h2 data-tool="mdnice编辑器" style="font-weight: bold;color: black;font-size: 22px;margin-top: 20px;margin-right: 10px;"><span style="display: none;"></span><span style="font-size: 18px;display: inline-block;padding-left: 10px;border-left: 5px solid rgb(222, 198, 251);color: rgb(89, 89, 89);">Hive分区与分桶</span></h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI4MjU4MzkwOQ==&amp;mid=2247484600&amp;idx=1&amp;sn=53420bb2919e200e95fd320e37b7b487&amp;chksm=eb96f2b2dce17ba48b6857af63ba70a91a12f8b12d5a106a58c32b58367449b6f67de601ab9f&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">六千字总结:大数据框架(分区，分桶，分片),建议收藏</a><br  /></p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>Hive分区<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">是按照数据表的某列或者某些列分为多区，在hive存储上是hdfs文件，也就是文件夹形式。现在最常用的跑T+1数据，按当天时间分区的较多。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">把每天通过sqoop或者datax拉取的一天的数据存储一个区，也就是所谓的文件夹与文件。在查询时只要指定分区字段的值就可以直接从该分区查找即可。创建分区表的时候，要通过关键字 partitioned by （column name &nbsp;string）声明该表是分区表，并且是按照字段column name进行分区，column name值一致的所有记录存放在一个分区中，分区属性name的类型是string类型。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">当然，可以依据多个列进行分区，即对某个分区的数据按照某些列继续分区。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">向分区表导入数据的时候，要通过关键字partition（（column name="xxxx"）显示声明数据要导入到表的哪个分区</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>设置分区的影响<span style="display: none;"></span></h6><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;font-size: 15px;" class=" list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;">首先是hive本身对分区数有限制，不过可以修改限制的数量。</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;"><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.exec.dynamic.partition=<span style="color: #56b6c2;line-height: 26px;">true</span>;<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.exec.max.dynamic.partitions=1000;&nbsp;<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.exec.dynamic.partition.mode=nonstrict;&nbsp;<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.exec.parallel.thread.number=264;<br  /></code></pre><ol start="2" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;font-size: 15px;" class=" list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;">hdfs对单个目录下的目录数量或者文件数量也是有限制的，也是可以修改的。</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;">NN的内存肯定会限制，这是最重要的，如果分区数很大，会影响NN服务，进而影响一系列依赖于NN的服务。所以最好合理设置分区规则，对小文件也可以定期合并，减少NN的压力。</section></li></ol><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>Hive的分桶<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">在分区数量过于庞大以至于可能导致文件系统崩溃时，我们就需要使用分桶来解决问题</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">分桶是相对分区进行更细粒度的划分。分桶则是指定分桶表的某一列，让该列数据按照哈希取模的方式随机、均匀的分发到各个桶文件中。因为分桶操作需要根据某一列具体数据来进行哈希取模操作，故指定的分桶列必须基于表中的某一列（字段） 要使用关键字clustered by 指定分区依据的列名，还要指定分为多少桶：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">create&nbsp;table&nbsp;<span style="color: #e6c07b;line-height: 26px;">test</span>(id&nbsp;int,name&nbsp;string)&nbsp;cluster&nbsp;by&nbsp;(id)&nbsp;into&nbsp;5&nbsp;buckets&nbsp;.......<br  /><br  />insert&nbsp;into&nbsp;buck&nbsp;select&nbsp;id&nbsp;,name&nbsp;from&nbsp;p&nbsp;cluster&nbsp;by&nbsp;(id)<br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>Hive分区分桶区别<span style="display: none;"></span></h4><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;font-size: 15px;" class=" list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;word-spacing: 2px;">分区是表的部分列的集合，可以为频繁使用的数据建立分区，这样查找分区中的数据时就不需要扫描全表，这对于提高查找效率很有帮助。</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;word-spacing: 2px;">不同于分区对列直接进行拆分，桶往往使用列的哈希值对数据打散，并分发到各个不同的桶中从而完成数据的分桶过程。</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;word-spacing: 2px;">分区和分桶最大的区别就是分桶随机分割数据库，分区是非随机分割数据库。</p></section></li></ol><h2 data-tool="mdnice编辑器" style="font-weight: bold;color: black;font-size: 22px;margin-top: 20px;margin-right: 10px;"><span style="display: none;"></span><span style="font-size: 18px;display: inline-block;padding-left: 10px;border-left: 5px solid rgb(222, 198, 251);color: rgb(89, 89, 89);">函数</span></h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">本环节不再介绍简单的函数，比如：'if' ，'is not null' ,'=='等等这类的函数。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>内置函数<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（1） NVL</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">给值为NULL的数据赋值，它的格式是NVL( value，default_value)。它的功能是如果value为NULL，则NVL函数返回default_value的值，否则返回value的值，如果两个参数都为NULL ，则返回NULL</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">select nvl(column, 0) from xxx；<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（2）行转列</strong></p><section data-tool="mdnice编辑器" style="overflow-x: auto;"><table><thead><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><th style="border-top-width: 1px;border-color: rgb(204, 204, 204);text-align: left;background-color: rgb(240, 240, 240);font-size: 14px;min-width: 85px;">函数</th><th style="border-top-width: 1px;border-color: rgb(204, 204, 204);text-align: left;background-color: rgb(240, 240, 240);font-size: 14px;min-width: 85px;">描述</th></tr></thead><tbody style="border-width: 0px;border-style: initial;border-color: initial;"><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">CONCAT(string A/col, string B/col…)</td><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">返回输入字符串连接后的结果，支持任意个输入字符串</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">CONCAT_WS(separator, str1, str2,...)</td><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">第一个参数参数间的分隔符，如果分隔符是 NULL，返回值也将为 NULL。这个函数会跳过分隔符参数后的任何 NULL 和空字符串。分隔符将被加到被连接的字符串之间。</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">COLLECT_SET(col)</td><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">将某字段的值进行去重汇总，产生array类型字段</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">COLLECT_LIST(col)</td><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">函数只接受基本数据类型，它的主要作用是将某字段的值进行不去重汇总，产生array类型字段。</td></tr></tbody></table></section><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（3）列转行(一列转多行)</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>Split(str, separator)：</strong>&nbsp;将字符串按照后面的分隔符切割，转换成字符array。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>EXPLODE(col)：</strong>将hive一列中复杂的array或者map结构拆分成多行。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>LATERAL VIEW</strong></p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">用法：<br  /><br  />LATERAL&nbsp;VIEW&nbsp;udtf(expression)&nbsp;tableAlias&nbsp;AS&nbsp;columnAlias<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">解释：lateral view用于和split, explode等UDTF一起使用，它能够将一行数据拆成多行数据，在此基础上可以对拆分后的数据进行聚合。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">lateral view首先为原始表的每行调用UDTF，UDTF会把一行拆分成一或者多行，lateral view再把结果组合，产生一个支持别名表的虚拟表。</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>准备数据源测试<span style="display: none;"></span></h6><section data-tool="mdnice编辑器" style="overflow-x: auto;"><table><thead><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><th style="border-top-width: 1px;border-color: rgb(204, 204, 204);text-align: left;background-color: rgb(240, 240, 240);font-size: 14px;min-width: 85px;">movie</th><th style="border-top-width: 1px;border-color: rgb(204, 204, 204);text-align: left;background-color: rgb(240, 240, 240);font-size: 14px;min-width: 85px;">category</th></tr></thead><tbody style="border-width: 0px;border-style: initial;border-color: initial;"><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">《功勋》</td><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">记录,剧情</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">《战狼2》</td><td style="border-color: rgb(204, 204, 204);font-size: 14px;min-width: 85px;">战争,动作,灾难</td></tr></tbody></table></section><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>SQL<span style="display: none;"></span></h6><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">SELECT&nbsp;movie,category_name&nbsp;<br  />FROM&nbsp;movie_info&nbsp;<br  />lateral&nbsp;VIEW<br  />explode(split(category,<span style="color: #98c379;line-height: 26px;">","</span>))&nbsp;movie_info_tmp&nbsp;&nbsp;AS&nbsp;category_name&nbsp;;<br  /><br  /></code></pre><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>测试结果<span style="display: none;"></span></h6><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">《功勋》&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;记录<br  />《功勋》&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;剧情<br  />《战狼2》&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;战争<br  />《战狼2》&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;动作<br  />《战狼2》&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;灾难<br  /><br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>窗口函数<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（1）OVER()</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">定分析函数工作的数据窗口大小，这个数据窗口大小可能会随着行的变而变化。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（2）CURRENT ROW（当前行）</strong></p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>语法<span style="display: none;"></span></h6><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">n PRECEDING：往前n行数据<br  /><br  />n FOLLOWING：往后n行数据<br  /><br  />（3）UNBOUNDED（无边界）<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">UNBOUNDED PRECEDING 前无边界，表示从前面的起点</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">UNBOUNDED FOLLOWING后无边界，表示到后面的终点</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;"><br  /></code></pre><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>SQL案例：由起点到当前行的聚合<span style="display: none;"></span></h6><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">select&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;sum(money)&nbsp;over(partition&nbsp;by&nbsp;user_id&nbsp;order&nbsp;by&nbsp;pay_time&nbsp;rows&nbsp;between&nbsp;UNBOUNDED&nbsp;PRECEDING&nbsp;and&nbsp;current&nbsp;row)&nbsp;<br  />from&nbsp;or_order;<br  /></code></pre><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>SQL案例：当前行和前面一行做聚合<span style="display: none;"></span></h6><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">select&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;sum(money)&nbsp;over(partition&nbsp;by&nbsp;user_id&nbsp;order&nbsp;by&nbsp;pay_time&nbsp;rows&nbsp;between&nbsp;1&nbsp;PRECEDING&nbsp;and&nbsp;current&nbsp;row)&nbsp;<br  />from&nbsp;or_order;<br  /></code></pre><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>SQL案例：当前行和前面一行和后一行做聚合<span style="display: none;"></span></h6><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">select&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;sum(money)&nbsp;over(partition&nbsp;by&nbsp;user_id&nbsp;order&nbsp;by&nbsp;pay_time&nbsp;rows&nbsp;between&nbsp;1&nbsp;PRECEDING&nbsp;AND&nbsp;1&nbsp;FOLLOWING&nbsp;)<br  />from&nbsp;or_order;<br  /></code></pre><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>SQL案例：当前行及后面所有行<span style="display: none;"></span></h6><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">select&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;sum(money)&nbsp;over(partition&nbsp;by&nbsp;user_id&nbsp;order&nbsp;by&nbsp;pay_time&nbsp;rows&nbsp;between&nbsp;current&nbsp;row&nbsp;and&nbsp;UNBOUNDED&nbsp;FOLLOWING&nbsp;&nbsp;)<br  />from&nbsp;or_order;<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（3）LAG(col,n,default_val)</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">往前第n行数据，没有的话default_val</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（4）LEAD(col,n, default_val)</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">往后第n行数据，没有的话default_val</p><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>SQL案例：查询用户购买明细以及上次的购买时间和下次购买时间<span style="display: none;"></span></h5><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">select&nbsp;<br  />&nbsp;user_id,,pay_time,money,<br  />&nbsp;<br  />&nbsp;lag(pay_time,1,<span style="color: #98c379;line-height: 26px;">'1970-01-01'</span>)&nbsp;over(PARTITION&nbsp;by&nbsp;name&nbsp;order&nbsp;by&nbsp;pay_time)&nbsp;prev_time,<br  />&nbsp;<br  />&nbsp;lead(pay_time,1,<span style="color: #98c379;line-height: 26px;">'1970-01-01'</span>)&nbsp;over(PARTITION&nbsp;by&nbsp;name&nbsp;order&nbsp;by&nbsp;pay_time)&nbsp;next_time<br  />from&nbsp;or_order;<br  /><br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（5）FIRST_VALUE(col,true/false)</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">当前窗口下的第一个值，第二个参数为true，跳过空值。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（6）LAST_VALUE (col,true/false)</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">当前窗口下的最后一个值，第二个参数为true，跳过空值。</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>SQL案例：查询顾用户每个月第一次的购买时间 和 每个月的最后一次购买时间。<span style="display: none;"></span></h6><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">select<br  />&nbsp;FIRST_VALUE(pay_time)&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;over(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;partition&nbsp;by&nbsp;user_id,month(pay_time)&nbsp;order&nbsp;by&nbsp;pay_time&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows&nbsp;between&nbsp;UNBOUNDED&nbsp;PRECEDING&nbsp;and&nbsp;UNBOUNDED&nbsp;FOLLOWING<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;first_time,<br  />&nbsp;<br  />&nbsp;LAST_VALUE(pay_time)&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;over(partition&nbsp;by&nbsp;user_id,month(pay_time)&nbsp;order&nbsp;by&nbsp;pay_time&nbsp;rows&nbsp;between&nbsp;UNBOUNDED&nbsp;PRECEDING&nbsp;and&nbsp;UNBOUNDED&nbsp;FOLLOWING<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;last_time<br  />from&nbsp;or_order;<br  /><br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（7）NTILE(n)</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">把有序窗口的行分发到指定数据的组中，各个组有编号，编号从1开始，对于每一行，NTILE返回此行所属的组的编号。（用于将分组数据按照顺序切分成n片，返回当前切片值）</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>SQL案例：查询前25%时间的订单信息<span style="display: none;"></span></h6><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">select&nbsp;*&nbsp;from&nbsp;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;User_id,pay_time,money,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;ntile(4)&nbsp;over(order&nbsp;by&nbsp;pay_time)&nbsp;sorted<br  />&nbsp;&nbsp;&nbsp;&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;or_order<br  />)&nbsp;t<br  /><span style="color: #e6c07b;line-height: 26px;">where</span>&nbsp;sorted&nbsp;=&nbsp;1;<br  /><br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>4个By<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（1）Order By</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">全局排序，只有一个Reducer。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（2）Sort By</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">分区内有序。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（3）Distrbute By</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">类似MR中Partition，进行分区，结合sort by使用。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（4） Cluster By</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">当Distribute by和Sorts by字段相同时，可以使用Cluster by方式。Cluster by除了具有Distribute by的功能外还兼具Sort by的功能。但是排序只能是升序排序，不能指定排序规则为ASC或者DESC。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">在生产环境中Order By用的比较少，容易导致OOM。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">在生产环境中Sort By+ Distrbute By用的多。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>排序函数<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（1）RANK()</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">排序相同时会重复，总数不会变</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">1<br  />1<br  />3<br  />3<br  />5<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（2）DENSE_RANK()</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">排序相同时会重复，总数会减少</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">1<br  />1<br  />2<br  />2<br  />3<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>（3）ROW_NUMBER()</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">会根据顺序计算</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">1<br  />2<br  />3<br  />4<br  />5<br  /></code></pre><h2 data-tool="mdnice编辑器" style="font-weight: bold;color: black;font-size: 22px;margin-top: 20px;margin-right: 10px;"><span style="display: none;"></span><span style="font-size: 18px;display: inline-block;padding-left: 10px;border-left: 5px solid rgb(222, 198, 251);color: rgb(89, 89, 89);">Hive 优化</span></h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">首先要这样优化的原理，再去适当去调节参数和选择方案。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>1. 表的优化<span style="display: none;"></span></h4><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>（1） 小表、大表Join<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">将key相对分散，并且数据量小的表放在join的左边，这样可以有效减少内存溢出错误发生的几率；再进一步，可以使用map join让小的维度表（1000条以下的记录条数）先进内存。在map端完成reduce。</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>（2） 大表Join大表<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>a. 空key过滤</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">有时join超时是因为某些key对应的数据太多，而相同key对应的数据都会发送到相同的reducer上，从而导致内存不够。此时我们应该仔细分析这些异常的key，很多情况下，这些key对应的数据是异常数据，我们需要在SQL语句中进行过滤。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>b. 空key转换</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">有时虽然某个key为空对应的数据很多，但是相应的数据不是异常数据，必须要包含在join的结果中，此时我们可以表a中key为空的字段赋一个随机的值，使得数据随机均匀地分不到不同的reducer上。</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>（3） MapJoin<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">如果不指定MapJoin或者不符合MapJoin的条件，那么Hive解析器会将Join操作转换成Common Join，即：在Reduce阶段完成join。容易发生数据倾斜。可以用MapJoin把小表全部加载到内存在map端进行join，避免reducer处理。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">设置自动选择Mapjoin<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.auto.convert.join&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>;&nbsp;默认为<span style="color: #56b6c2;line-height: 26px;">true</span><br  /><br  />大表小表的阈值设置（默认25M以下认为是小表）：<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.mapjoin.smalltable.filesize=25000000;<br  /><br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>（4） Group By<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">Map阶段同一Key数据分发给一个reduce，当一个key数据过大时就倾斜了。并不是所有的聚合操作都需要在Reduce端完成，很多聚合操作都可以先在Map端进行部分聚合，最后在Reduce端得出最终结果。</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>（5） 开启Map端聚合<span style="display: none;"></span></h6><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">//&nbsp;是否在Map端进行聚合，默认为True<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.map.aggr&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span><br  /><br  />//&nbsp;在Map端进行聚合操作的条目数目<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.groupby.mapaggr.checkinterval&nbsp;=&nbsp;100000<br  /><br  />//&nbsp;有数据倾斜的时候进行负载均衡（默认是<span style="color: #56b6c2;line-height: 26px;">false</span>）<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.groupby.skewindata&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span><br  /><br  /></code></pre><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>对数据倾斜负载均衡的理解<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">会有两个MR Job。第一个MR Job中，Map的输出结果会随机分布到Reduce中，每个Reduce做部分聚合操作，并输出结果，这样处理的结果是相同的Group By Key有可能被分发到不同的Reduce中，从而达到负载均衡的目的；第二个MR Job再根据预处理的数据结果按照Group By Key分布到Reduce中（这个过程可以保证相同的Group By Key被分布到同一个Reduce中），最后完成最终的聚合操作。</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>(6) Count(Distinct) 去重统计<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">由于COUNT DISTINCT操作需要用一个Reduce Task来完成，这一个Reduce需要处理的数据量太大，就会导致整个Job很难完成，一般COUNT DISTINCT使用先GROUP BY再COUNT的方式替换,但是需要注意group by造成的数据倾斜问题。</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>(7) 笛卡尔积<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">尽量避免笛卡尔积，join的时候不加on条件，或者无效的on条件，Hive只能使用1个reducer来完成笛卡尔积。</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>(8) 行列过滤<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>「列处理」</strong>：在SELECT中，只拿需要的列，如果有，尽量使用分区过滤，少用SELECT *。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>「行处理」</strong>：在分区剪裁中，当使用外关联时，如果将副表的过滤条件写在Where后面，那么就会先全表关联，之后再过滤</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>2. 合理设置Map及Reduce数<span style="display: none;"></span></h4><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>首先理清楚Map数是越多越好吗？<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>「逻辑」</strong>：如果一个任务有很多小文件（远远小于块大小128m），则每个小文件也会被当做一个块，用一个map任务来完成，而一个map任务启动和初始化的时间远远大于逻辑处理的时间，就会造成很大的资源浪费。</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>保证每个map处理接近128m的文件块是不是就可以了？<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>「逻辑」</strong>：比如有一个127m的文件，正常会用一个map去完成，但这个文件只有一个或者两个小字段，却有几千万的记录，如果map处理的逻辑比较复杂，用一个map任务去做，肯定也比较耗时</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>复杂文件增加Map数<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><strong>「原理」</strong>：文件都很大，任务逻辑复杂，map执行非常慢的时候，可以考虑增加Map数，来使得每个map处理的数据量减少，从而提高任务的执行效率。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">computeSliteSize(Math.max(minSize,Math.min(maxSize,blocksize)))=blocksize=128M<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">调整maxSize最大值。让maxSize最大值低于blocksize就可以增加map的个数。</p><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>小文件进行合并，减少map数<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">在map执行前合并小文件，减少map数：CombineHiveInputFormat具有对小文件进行合并的功能（系统默认的格式）。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;"><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.input.format=&nbsp;org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">Map-Reduce的任务结束时合并小文件的设置</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">//&nbsp;在map-only任务结束时合并小文件，默认<span style="color: #56b6c2;line-height: 26px;">true</span><br  />SET&nbsp;hive.merge.mapfiles&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>;<br  /><br  />//&nbsp;在map-reduce任务结束时合并小文件，默认<span style="color: #56b6c2;line-height: 26px;">false</span><br  />SET&nbsp;hive.merge.mapredfiles&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>;<br  /><br  />//&nbsp;合并文件的大小，默认256M<br  />SET&nbsp;hive.merge.size.per.task&nbsp;=&nbsp;268435456;<br  /><br  />//当输出文件的平均大小小于该值时，启动一个独立的map-reduce任务进行文件merge<br  />SET&nbsp;hive.merge.smallfiles.avgsize&nbsp;=&nbsp;16777216;<br  /><br  /></code></pre><h6 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;"><span style="display: none;"></span>3. 合理设置Reduce数<span style="display: none;"></span></h6><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">同样考虑是不是越多越好？</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">过多的启动和初始化reduce也会消耗时间和资源。有多少个reduce，就会有多少个输出文件，如果生成了很多个小文件，那么如果这些小文件作为下一个任务的输入，则也会出现小文件过多的问题。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（1）数据量设置</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">//&nbsp;每个Reduce处理的数据量默认是256MB<br  />hive.exec.reducers.bytes.per.reducer=256000000<br  /><br  />//&nbsp;每个任务最大的reduce数，默认为1009<br  />hive.exec.reducers.max=1009<br  /><br  />//&nbsp;计算reducer数的公式<br  />N=min(hive.exec.reducers.max，总输入数据量/hive.exec.reducers.bytes.per.reducer)<br  /><br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（2）文件配置</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">mapreduce.job.reduces&nbsp;=&nbsp;15<br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>4. 并行执行<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">通过设置参数hive.exec.parallel值为true，就可以开启并发执行。不过，在共享集群中，需要注意下，如果job中并行阶段增多，那么集群利用率就会增加。建议在数据量大,sql很长的时候使用,数据量小,sql比较的小开启有可能还不如之前快。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">//打开任务并行执行，默认为<span style="color: #56b6c2;line-height: 26px;">false</span><br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.exec.parallel=<span style="color: #56b6c2;line-height: 26px;">true</span>;&nbsp;<br  /><br  />//同一个sql允许最大并行度，默认为8。<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.exec.parallel.thread.number=16;&nbsp;&nbsp;<br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>5. JVM重用<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">JVM来执行map和Reduce任务的。这时JVM的启动过程可能会造成相当大的开销，尤其是执行的job包含有成百上千task任务的情况。JVM重用可以使得JVM实例在同一个job中重新使用N次。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">缺点是，开启JVM重用将一直占用使用到的task插槽，以便进行重用，直到任务完成后才能释放。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;"><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;mapreduce.job.jvm.numtasks=10<br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>6. 列式存储<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">因为每个字段的数据聚集存储，在查询只需要少数几个字段的时候，能大大减少读取的数据量；每个字段的数据类型一定是相同的，列式存储可以针对性的设计更好的设计压缩算法。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">TEXTFILE和SEQUENCEFILE的存储格式都是基于行存储的；</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">ORC和PARQUET是基于列式存储的。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>7. 压缩（选择快的）<span style="display: none;"></span></h4><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">//&nbsp;启用中间数据压缩<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;hive.exec.compress.intermediate=<span style="color: #56b6c2;line-height: 26px;">true</span>&nbsp;<br  /><br  />//&nbsp;启用最终数据压缩<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;mapreduce.map.output.compress=<span style="color: #56b6c2;line-height: 26px;">true</span>&nbsp;<br  /><br  />//&nbsp;设置压缩方式<br  /><span style="color: #e6c07b;line-height: 26px;">set</span>&nbsp;mapreduce.map.outout.compress.codec=<br  /><br  />org.apache.hadoop.io.compress.DefaultCodec<br  />org.apache.hadoop.io.compress.GzipCodec<br  />org.apache.hadoop.io.compress.BZip2Codec<br  />org.apache.hadoop.io.compress.Lz4Codec<br  /><br  /></code></pre><h2 data-tool="mdnice编辑器" style="font-weight: bold;color: black;font-size: 22px;margin-top: 20px;margin-right: 10px;"><span style="display: none;"></span><span style="font-size: 18px;display: inline-block;padding-left: 10px;border-left: 5px solid rgb(222, 198, 251);color: rgb(89, 89, 89);">Hive数据倾斜</span></h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI4MjU4MzkwOQ==&amp;mid=2247484735&amp;idx=1&amp;sn=8f910ab0c7b48f1b699207eb22fbf14a&amp;chksm=eb96f335dce17a23e569ec4187d2f323b8747132d62c4611665e6d028a71e26234ef5f950a6a&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2">你的数据倾斜了吗？一文帮你数据处理再均衡</a><br  /></p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>Hive数据倾斜表现<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">就是单说hive自身的MR引擎：发现所有的map task全部完成，并且99%的reduce task完成，只剩下一个或者少数几个reduce task一直在执行，这种情况下一般都是发生了数据倾斜。说白了就是Hive的数据倾斜本质上是MapReduce的数据倾斜。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>Hive数据倾斜的原因<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">在MapReduce编程模型中十分常见，大量相同的key被分配到一个reduce里，造成一个reduce任务累死，其他reduce任务闲死。查看任务进度，发现长时间停留在99%或100%，查看任务监控界面，只有少量的reduce子任务未完成。</p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;font-size: 15px;" class=" list-paddingleft-2"><li style="font-weight: bold;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;"><strong>key分布不均衡。</strong></section></li><li style="font-weight: bold;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;"><strong>业务问题或者业务数据本身的问题，某些数据比较集中。</strong></section></li></ol><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（1）join小表：其中一个表是小表，但是key比较集中，导致的就是某些Reduce的值偏高。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（2）空值或无意义值：如果缺失的项很多，在做join时这些空值就会非常集中，拖累进度。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（3）group by：维度过小。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（4）distinct：导致最终只有一个Reduce任务。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;"><span style="display: none;"></span>Hive数据倾斜解决<span style="display: none;"></span></h4><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;font-size: 15px;" class=" list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;">group by代替distinct 要统计某一列的去重数时，如果数据量很大，count(distinct)就会非常慢，原因与order by类似，count(distinct)逻辑导致最终只有一个Reduce任务。</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;">对1再优化：group by配置调整</section></li></ol><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（1）map端预聚合</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（2）group by时，combiner在map端做部分预聚合，可以有效减少shuffle数据量。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（3）checkinterval：设置map端预聚合的行数阈值，超过该值就会分拆job。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">hive.map.aggr=<span style="color: #56b6c2;line-height: 26px;">true</span>&nbsp;//默认<br  /><br  />hive.groupby.mapaggr.checkinterval=100000&nbsp;//&nbsp;默认<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（4）倾斜均衡配置 Hive自带了一个均衡数据倾斜的配置项。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">其实现方法是在group by时启动两个MR job。第一个job会将map端数据随机输入reducer，每个reducer做部分聚合，相同的key就会分布在不同的reducer中。第二个job再将前面预处理过的数据按key聚合并输出结果，这样就起到了均衡的效果。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXuIozZ4WOO5An4NBXD6iayHIDcOae9pqMBGvBXtdN1OSKkIOqVGFKtNNiaTg3vHmys2U1NjkPnubLw2QJFic9rhyy/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(40, 44, 52);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">hive.groupby.skewindata=<span style="color: #56b6c2;line-height: 26px;">false</span>&nbsp;//&nbsp;默认<br  /></code></pre><ol start="3" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;font-size: 15px;" class=" list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;">join基础优化</section></li></ol><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（1） Hive在解析带join的SQL语句时，会默认将最后一个表作为大表，将前面的表作为小表，将它们读进内存。如果表顺序写反，如果大表在前面，引发OOM。不过现在hive自带优化。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（2） map join:特别适合大小表join的情况，大小表join在map端直接完成join过程，没有reduce，效率很高。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">（3）多表join时key相同：会将多个join合并为一个MR job来处理，两个join的条件不相同，就会拆成多个MR job计算。</p><ol start="4" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;font-size: 15px;" class=" list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;">sort by代替order by</section></li></ol><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">将结果按某字段全局排序，这会导致所有map端数据都进入一个reducer中，在数据量大时可能会长时间计算不完。使用sort by，那么还是会视情况启动多个reducer进行排序，并且保证每个reducer内局部有序。为了控制map端数据分配到reducer的key，往往还要配合distribute by一同使用。如果不加distribute by的话，map端数据就会随机分配到reducer。</p><ol start="5" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;font-size: 15px;" class=" list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;font-size: 14px;">单独处理倾斜key</section></li></ol><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;margin-top: 10px;margin-bottom: 10px;font-size: 14px;word-spacing: 2px;">一般来讲倾斜的key都很少，我们可以将它们抽样出来，对应的行单独存入临时表中，然后打上随机数前缀，最后再进行聚合。或者是先对key做一层hash，先将数据随机打散让它的并行度变大，再汇集。其实办法一样。</p><section class="mp_profile_iframe_wrp custom_select_card_wrp wx-edui-media-wrp"><mpprofile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzI4MjU4MzkwOQ==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/2gY1hzDz7dRCmOAs1H8E7QUDiaFQv0m4w2P7f4EkiacNxALJM0S7jPa7uL2a9sibAsHC6SzKZjZvylEhm4feUjlTQ/0?wx_fmt=png" data-nickname="大数据左右手" data-alias="ykc20161218" data-signature="技术如同手中的水有了生命似的，汇聚在了一起。作为大数据开发工作者，致力于大数据技术的学习与工作，分享大数据原理、架构、实时、离线、面试与总结，分享生活思考与读书见解。总有适合你的那一篇。" data-from="0"></mpprofile></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;outline: 0px;max-width: 100%;overflow-wrap: break-word;font-size: 16px;word-break: break-word;text-align: left;line-height: 1.75;color: rgb(89, 89, 89);font-family: Optima-Regular, Optima, PingFangTC-Light, PingFangSC-light, PingFangTC-light;letter-spacing: 2px;background-image: linear-gradient(90deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%), linear-gradient(360deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%);background-size: 20px 20px;background-position: center center;box-sizing: border-box !important;"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;outline: 0px;max-width: 100%;overflow-wrap: break-word;white-space: normal;word-break: break-word;line-height: 1.75;background-image: linear-gradient(90deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%), linear-gradient(360deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%);background-size: 20px 20px;background-position: center center;box-sizing: border-box !important;"><span style="outline: 0px;max-width: 100%;font-size: 14px;word-spacing: 2px;box-sizing: border-box !important;overflow-wrap: break-word !important;">关注回复关键字“<strong style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">大数据</strong>”获取海量学习资料，持续不断收集充实</span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;outline: 0px;max-width: 100%;overflow-wrap: break-word;white-space: normal;word-break: break-word;line-height: 1.75;background-image: linear-gradient(90deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%), linear-gradient(360deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%);background-size: 20px 20px;background-position: center center;box-sizing: border-box !important;"><br style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"  /></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;outline: 0px;max-width: 100%;overflow-wrap: break-word;white-space: normal;word-break: break-word;line-height: 1.75;background-image: linear-gradient(90deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%), linear-gradient(360deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%);background-size: 20px 20px;background-position: center center;box-sizing: border-box !important;"><span style="outline: 0px;max-width: 100%;font-size: 14px;word-spacing: 2px;box-sizing: border-box !important;overflow-wrap: break-word !important;">和我</span><span style="outline: 0px;max-width: 100%;font-size: 14px;word-spacing: 2px;box-sizing: border-box !important;overflow-wrap: break-word !important;">联系吧，交流大数据知识,一起成长~~~</span></section><p style="outline: 0px;max-width: 100%;white-space: normal;font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: right;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;font-weight: bolder;color: rgb(0, 122, 170);font-size: 12px;letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;">动动小手，让更多需要的人看到~</span></p><p style="outline: 0px;max-width: 100%;white-space: normal;font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: right;box-sizing: border-box !important;overflow-wrap: break-word !important;"><img class="rich_pages wxw-img __bg_gif" data-fileid="100001958" data-ratio="0.11333333333333333" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_gif/I0wRNtcLDEfq42GGpPpCfpAUGFrQ9pSeyR1yB1uvpUm4ia6A3eYdKlibggxeZjNj5M3WZabwicv5ojMv88gwicfQOw/640?wx_fmt=gif" data-type="gif" data-w="600" style="outline: 0px;letter-spacing: 0.544px;text-align: center;border-style: none;box-sizing: border-box !important;overflow-wrap: break-word !important;visibility: visible !important;width: 600px !important;height: auto !important;"  /></p></section></section><div class="msg_source_url"><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA3NjIzNjMwOA==&action=getalbum&album_id=2071950776880381955#wechat_redirect" target="_blank">阅读原文</a></div></content><div class="msg_source_url"><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA3NjIzNjMwOA==&action=getalbum&album_id=2071950776880381955#wechat_redirect" target="_blank">阅读原文</a></div>
</div>
</body>
</html>