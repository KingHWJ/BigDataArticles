<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 0 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic{color:#8e8e8e;background:#f7f7f7;border-radius:5px;padding:10px 8px;}.topic a{padding-right:5px;}.topic p{margin-bottom:5px;}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head><script>
var data={"mp":"数据治理体系","title":"Flink企业级优化全面总结（3万字长文，15张图）","time":"2021-12-15 07:16:00","timeStamp":"1639523760"};
</script>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="http://mp.weixin.qq.com/s?__biz=MzA3NjIzNjMwOA==&mid=2247485204&idx=1&sn=96b76622e47220d2335878c6bdd5643a&chksm=9f65146fa8129d79b5a4b1c8c9525b7dd593379359f7a88605a566f6e8798f60b66178668abf#rd" target="_blank">Flink企业级优化全面总结（3万字长文，15张图）</a></h1><div id="meta_content" class="rich_media_meta_list"><span class="rich_media_meta rich_media_meta_text">大数据老哥&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">数据治理体系&nbsp;&nbsp;</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-12-15 07:16:00</em></div><content><div class="reprint"><p>转自公众号：大数据老哥<br><a href="http://mp.weixin.qq.com/s?__biz=MzA3MjQ1MTQzMQ==&mid=2247493375&idx=1&sn=8c812fd41a2cafb73d1fb2f3fbe0640e" target="_blank" title="阅读原文">http://mp.weixin.qq.com/s?__biz=MzA3MjQ1MTQzMQ==&mid=2247493375&idx=1&sn=8c812fd41a2cafb73d1fb2f3fbe0640e</a></p></div><section data-mpa-category="背景" data-mpa-template="t" style="background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6sjpLCcwq0nXNIAz5LYEiaqaYob0vNibJsmHqFETeLrbE0ToJovIanxMw/640?wx_fmt=png&quot;);" data-mpa-powered-by="yiban.io"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="color: black;line-height: 1.6;letter-spacing: 0px;word-break: break-word;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 14px;padding: 10px;"><h2 data-tool="mdnice编辑器" style="font-size: 22px;text-align: center;font-weight: bold;line-height: 1.1em;padding-top: 12px;padding-bottom: 12px;margin: 70px 30px 30px;border-width: 1px;border-style: solid;border-color: rgb(0, 0, 0);"><span style="display: block;width: 3px;margin-left: 5%;height: 3px;line-height: 3px;overflow: hidden;background-color: rgb(0, 0, 0);box-shadow: rgb(0, 0, 0) 3px 0px, rgb(0, 0, 0) 0px 3px, rgb(0, 0, 0) -3px 0px, rgb(0, 0, 0) 0px -3px;"></span><span style="display: block;-webkit-box-reflect: below 0em -webkit-gradient(linear,left top,left bottom, from(rgba(0,0,0,0)),to(rgba(255,255,255,0.1)));">1、资源配置调优</span><span style="display: block;width: 3px;margin-left: 95%;height: 3px;line-height: 3px;overflow: hidden;background-color: rgb(0, 0, 0);box-shadow: rgb(0, 0, 0) 3px 0px, rgb(0, 0, 0) 0px 3px, rgb(0, 0, 0) -3px 0px, rgb(0, 0, 0) 0px -3px;"></span><span style="float: right;display: block;width: 90%;border-bottom: 1px solid #000;height: 1px;line-height: 1px;margin-right: -5px;margin-top: 16px;"> </span></h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Flink性能调优的第一步，就是为任务分配合适的资源，在一定范围内，增加资源的分配与性能的提升是成正比的，实现了最优的资源配置后，在此基础上再考虑进行后面论述的性能调优策略。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 提交方式主要是<code style="padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);">yarn-per-job</code>，资源的分配在使用脚本提交Flink任务时进行指定。标准的Flink任务提交脚本（Generic CLI 模式）从1.11开始，增加了通用客户端模式，参数使用-D <code style="padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);">&lt;property=value&gt;</code>指定。</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">bin/flink&nbsp;run<br  />-t&nbsp;yarn-per-job<br  />-d<br  />-p&nbsp;5&nbsp;\&nbsp;指定并行度<br  />-Dyarn.application.queue=test&nbsp;\&nbsp;指定yarn队列<br  />-Djobmanager.memory.process.size=1024mb&nbsp;\&nbsp;指定JM的总进程大小<br  />-Dtaskmanager.memory.process.size=1024mb&nbsp;\&nbsp;指定每个TM的总进程大小<br  />-Dtaskmanager.numberOfTaskSlots=2&nbsp;\&nbsp;指定每个TM的slot数<br  />-c&nbsp;com.atguigu.app.dwd.LogBaseApp<br  />/opt/module/gmall-flink/gmall-realtime-1.0-SNAPSHOT-jar-with-dependencies.jar<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>1.1 内存设置<span style="display: none;"></span></h3><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">bin/flink&nbsp;run<br  />-t&nbsp;yarn-per-job<br  />-d<br  />-p&nbsp;5&nbsp;\&nbsp;指定并行度<br  />-Dyarn.application.queue=test&nbsp;\&nbsp;指定yarn队列<br  />-Djobmanager.memory.process.size=2048mb&nbsp;\&nbsp;JM2~4G足够<br  />-Dtaskmanager.memory.process.size=6144mb&nbsp;\&nbsp;单个TM2~8G足够<br  />-Dtaskmanager.numberOfTaskSlots=2 \&nbsp;与容器核数1core：1slot或1core：2slot<br  />-c&nbsp;com.atguigu.app.dwd.LogBaseApp<br  />/opt/module/gmall-flink/gmall-realtime-1.0-SNAPSHOT-jar-with-dependencies.jar<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Flink是实时流处理，关键在于资源情况能不能抗住高峰时期每秒的数据量，通常用QPS/TPS来描述数据情况。</p><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>1.2 并行度设置<span style="display: none;"></span></h3><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>1.2.1 最优并行度计算<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">开发完成后，先进行压测。任务并行度给10以下，测试单个并行度的处理上限。</p><blockquote data-tool="mdnice编辑器" style="border-top: none;border-bottom: none;font-size: 0.9em;overflow: auto;color: rgb(106, 115, 125);padding: 10px 10px 10px 20px;margin-bottom: 20px;margin-top: 20px;border-left-color: rgba(0, 0, 0, 0.65);border-right: 1px solid rgba(0, 0, 0, 0.65);background: rgb(249, 249, 249);"><p style="padding-top: 8px;padding-bottom: 8px;font-size: 14px;color: black;line-height: 26px;">然后 总QPS/单并行度的处理能力 = 并行度</p></blockquote><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">不能只从QPS去得出并行度，因为有些字段少、逻辑简单的任务，单并行度一秒处理几万条数据。而有些数据字段多，处理逻辑复杂，单并行度一秒只能处理1000条数据。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">最好根据高峰期的QPS压测，<strong>并行度*1.2倍</strong>，富余一些资源。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>1.2.2 source端并行度的配置<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">**数据源端是 Kafka，Source的并行度设置为Kafka对应Topic的分区数。**如果已经等于 Kafka 的分区数，消费速度仍跟不上数据生产速度，考虑下Kafka 要扩大分区，同时调大并行度等于分区数。Flink 的一个并行度可以处理一至多个分区的数据，如果并行度多于 Kafka 的分区数，那么就会造成有的并行度空闲，浪费资源。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>1.2.3 Transform端并行度的配置<span style="display: none;"></span></h4><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">Keyby之前的算子</p><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">一般不会做太重的操作，都是比如map、filter、flatmap等处理较快的算子，并行度可以和source保持一致。</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">Keyby之后的算子</p><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">如果并发较大，建议设置并行度为 2 的整数次幂，例如：128、256、512；</p><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">小并发任务的并行度不一定需要设置成 2 的整数次幂；</p><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">大并发任务如果没有 KeyBy，并行度也无需设置为 2 的整数次幂；</p></section></li></ul><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>1.2.4 Sink端并行度的配置<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">Sink 端是数据流向下游的地方，可以根据 Sink 端的数据量及下游的服务抗压能力进行评估。如果Sink端是Kafka，可以设为Kafka对应Topic的分区数。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">Sink 端的数据量小，比较常见的就是监控告警的场景，并行度可以设置的小一些。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">Source 端的数据量是最小的，拿到 Source 端流过来的数据后做了细粒度的拆分，数据量不断的增加，到 Sink 端的数据量就非常大。那么在 Sink 到下游的存储中间件的时候就需要提高并行度。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">另外 Sink 端要与下游的服务进行交互，并行度还得根据下游的服务抗压能力来设置，如果在 Flink Sink 这端的数据量过大的话，且 Sink 处并行度也设置的很大，但下游的服务完全撑不住这么大的并发写入，可能会造成下游服务直接被写挂，所以最终还是要在 Sink 处的并行度做一定的权衡。</p><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>1.3 RocksDB大状态调优<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">RocksDB 是基于 LSM Tree 实现的（类似HBase），写数据都是先缓存到内存中，所以RocksDB 的写请求效率比较高。RocksDB 使用内存结合磁盘的方式来存储数据，每次获取数据时，先从内存中 blockcache 中查找，如果内存中没有再去磁盘中查询。优化后差不多单并行度 TPS 5000 record/s，性能瓶颈主要在于 RocksDB 对磁盘的读请求，所以当处理性能不够时，仅需要横向扩展并行度即可提高整个Job 的吞吐量。以下几个调优参数：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">设置本地RocksDB多目录</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在<code style="padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);">flink-conf.yaml</code>中配置：</p><blockquote data-tool="mdnice编辑器" style="border-top: none;border-bottom: none;font-size: 0.9em;overflow: auto;color: rgb(106, 115, 125);padding: 10px 10px 10px 20px;margin-bottom: 20px;margin-top: 20px;border-left-color: rgba(0, 0, 0, 0.65);border-right: 1px solid rgba(0, 0, 0, 0.65);background: rgb(249, 249, 249);"><p style="padding-top: 8px;padding-bottom: 8px;font-size: 14px;color: black;line-height: 26px;">state.backend.rocksdb.localdir: /data1/flink/rocksdb,/data2/flink/rocksdb,/data3/flink/rocksdb</p></blockquote><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;"><strong>注意</strong>：不要配置单块磁盘的多个目录，务必将目录配置到多块不同的磁盘上，让多块磁盘来分担压力。当设置多个 RocksDB 本地磁盘目录时，Flink 会随机选择要使用的目录，所以就可能存在三个并行度共用同一目录的情况。如果服务器磁盘数较多，一般不会出现该情况，但是如果任务重启后吞吐量较低，可以检查是否发生了多个并行度共用同一块磁盘的情况。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">当一个 TaskManager 包含 3 个 slot 时，那么单个服务器上的三个并行度都对磁盘造成频繁读写，从而导致三个并行度的之间相互争抢同一个磁盘 io，这样务必导致三个并行度的吞吐量都会下降。设置多目录实现三个并行度使用不同的硬盘从而减少资源竞争。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如下所示是测试过程中磁盘的 IO 使用率，可以看出三个大状态算子的并行度分别对应了三块磁盘，这三块磁盘的 IO 平均使用率都保持在 45% 左右，IO 最高使用率几乎都是 100%，而其他磁盘的 IO 平均使用率相对低很多。由此可见使用 RocksDB 做为状态后端且有大状态的频繁读取时， 对磁盘IO性能消耗确实比较大。</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009664" data-ratio="0.21951219512195122" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6RiaicAVaJicpc6XSyCXficvgIlpMAAicHzT4gn37ia2cSzyCthzt6clCDDtQ/640?wx_fmt=png" data-type="png" data-w="943" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如下图所示，其中两个并行度共用了 sdb 磁盘，一个并行度使用 sdj磁盘。可以看到 sdb 磁盘的 IO 使用率已经达到了 91.6%，就会导致 sdb 磁盘对应的两个并行度吞吐量大大降低，从而使得整个 Flink 任务吞吐量降低。如果每个服务器上有一两块 SSD，强烈建议将 RocksDB 的本地磁盘目录配置到 SSD 的目录下，从 HDD 改为 SSD 对于性能的提升可能比配置 10 个优化参数更有效。</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009665" data-ratio="0.29055441478439425" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S62LyOBdibfUwS6Xlvqyz9ib8EUAXoibnXzzDLTR5m0FldBZ28dUiaRiawb9w/640?wx_fmt=png" data-type="png" data-w="974" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">state.backend.incremental</strong>**：开启增量检查点，默认false，改为true。</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">state.backend.rocksdb.predefined-options</strong>：SPINNING_DISK_OPTIMIZED_HIGH_MEM设置为机械硬盘+内存模式，有条件上SSD，指定为FLASH_SSD_OPTIMIZED</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">state.backend.rocksdb.block.cache-size</strong>: 整个 RocksDB 共享一个 block cache，读数据时内存的 cache 大小，该参数越大读数据时缓存命中率越高，默认大小为 8 MB，建议设置到 64 ~ 256 MB。</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">state.backend.rocksdb.thread.num</strong>: 用于后台 flush 和合并 sst 文件的线程数，默认为 1，建议调大，机械硬盘用户可以改为 4 等更大的值。</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">state.backend.rocksdb.writebuffer.size</strong>: RocksDB 中，每个 State 使用一个 Column Family，每个 Column Family 使用独占的 write buffer，建议调大，例如：32M</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">state.backend.rocksdb.writebuffer.count</strong>: 每个 Column Family 对应的 writebuffer 数目，默认值是 2，对于机械磁盘来说，如果内存⾜够大，可以调大到 5 左右</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">state.backend.rocksdb.writebuffer.number-to-merge</strong>: 将数据从 writebuffer 中 flush 到磁盘时，需要合并的 writebuffer 数量，默认值为 1，可以调成3。.</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">state.backend.local-recovery</strong>: 设置本地恢复，当 Flink 任务失败时，可以基于本地的状态信息进行恢复任务，可能不需要从 hdfs 拉取数据</section></li></ul><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>1.4 Checkpoint设置<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">一般我们的 Checkpoint 时间间隔可以设置为分钟级别，例如 1 分钟、3 分钟，对于状态很大的任务每次 Checkpoint 访问 HDFS 比较耗时，可以设置为 5~10 分钟一次Checkpoint，并且调大两次 Checkpoint 之间的暂停间隔，例如设置两次Checkpoint 之间至少暂停 4或8 分钟。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果 Checkpoint 语义配置为 EXACTLY_ONCE，那么在 Checkpoint 过程中还会存在 barrier 对齐的过程，可以通过 Flink Web UI 的 Checkpoint 选项卡来查看 Checkpoint 过程中各阶段的耗时情况，从而确定到底是哪个阶段导致 Checkpoint 时间过长然后针对性的解决问题。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">RocksDB相关参数在1.3中已说明，可以在flink-conf.yaml指定，也可以在Job的代码中调用API单独指定，这里不再列出。</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;使⽤&nbsp;RocksDBStateBackend&nbsp;做为状态后端，并开启增量&nbsp;Checkpoint</span><br  />&nbsp;RocksDBStateBackend&nbsp;rocksDBStateBackend&nbsp;=&nbsp;<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;&nbsp;RocksDBStateBackend(<span style="color: #c41a16;line-height: 26px;">"hdfs://node01:8020/flink/checkpoints"</span>,&nbsp;<span style="color: #aa0d91;line-height: 26px;">true</span>);<br  />&nbsp;env.setStateBackend(rocksDBStateBackend);<br  /><br  />&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;开启Checkpoint，间隔为&nbsp;3&nbsp;分钟</span><br  />&nbsp;env.enableCheckpointing(TimeUnit.MINUTES.toMillis(<span style="color: #1c00cf;line-height: 26px;">3</span>));<br  />&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;配置&nbsp;Checkpoint</span><br  />&nbsp;CheckpointConfig&nbsp;checkpointConf&nbsp;=&nbsp;env.getCheckpointConfig();<br  />&nbsp;checkpointConf.setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE)<br  />&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;最小间隔&nbsp;4分钟</span><br  />&nbsp;checkpointConf.setMinPauseBetweenCheckpoints(TimeUnit.MINUTES.toMillis(<span style="color: #1c00cf;line-height: 26px;">4</span>))<br  />&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;超时时间&nbsp;10分钟</span><br  />&nbsp;checkpointConf.setCheckpointTimeout(TimeUnit.MINUTES.toMillis(<span style="color: #1c00cf;line-height: 26px;">10</span>));<br  />&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;保存checkpoint</span><br  />&nbsp;checkpointConf.enableExternalizedCheckpoints(<br  />&nbsp;CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION);<br  /><br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>1.5 使用 Flink ParameterTool 读取配置<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在实际开发中，有各种环境（<code style="padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);">开发</code>、<code style="padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);">测试</code>、<code style="padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);">预发</code>、<code style="padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);">生产</code>），作业也有很多的配置：算子的并行度配置、Kafka 数据源的配置（broker 地址、topic 名、group.id）、Checkpoint 是否开启、状态后端存储路径、数据库地址、用户名和密码等各种各样的配置，可能每个环境的这些配置对应的值都是不一样的。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果你是直接在代码⾥⾯写死的配置，每次换个环境去运行测试作业，都要重新去修改代码中的配置，然后编译打包，提交运行，这样就要花费很多时间在这些重复的劳动力上了。在 Flink 中可以通过使用 ParameterTool 类读取配置，它可以读取环境变量、运行参数、配置文件。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;"><strong>ParameterTool 是可序列化的，所以你可以将它当作参数进行传递给算子的自定义函数类。</strong></p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>1.5.1 读取运行参数<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">我们可以在Flink的提交脚本添加运行参数，格式：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">--参数名 参数值</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在 Flink 程序中可以直接使用 <code style="padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);">ParameterTool.fromArgs(args)</code> 获取到所有的参数，也可以通过 <code style="padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);">parameterTool.get(“username”)</code> 方法获取某个参数对应的值。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">举例：通过运行参数指定jobname</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">bin/flink&nbsp;run<br  />-t&nbsp;yarn-per-job<br  />-d<br  />-p&nbsp;5&nbsp;\&nbsp;指定并行度<br  />-Dyarn.application.queue=test&nbsp;\&nbsp;指定yarn队列<br  />-Djobmanager.memory.process.size=1024mb&nbsp;\&nbsp;指定JM的总进程大小<br  />-Dtaskmanager.memory.process.size=1024mb&nbsp;\&nbsp;指定每个TM的总进程大小<br  />-Dtaskmanager.numberOfTaskSlots=2&nbsp;\&nbsp;指定每个TM的slot数<br  />-c&nbsp;com.atguigu.app.dwd.LogBaseApp<br  />/opt/module/gmall-flink/gmall-realtime-1.0-SNAPSHOT-jar-with-dependencies.jar<br  />–jobname&nbsp;dwd-LogBaseApp&nbsp;//参数名自己随便起，代码里对应上即可<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在代码里获取参数值：</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">ParameterTool&nbsp;parameterTool&nbsp;=&nbsp;ParameterTool.fromArgs(args);<br  />String&nbsp;myJobname&nbsp;=&nbsp;parameterTool.get(<span style="color: #c41a16;line-height: 26px;">"jobname"</span>);&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">//参数名对应</span><br  />env.execute(myJobname);<br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>1.5.2 读取系统属性<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">arameterTool 还⽀持通过 ParameterTool.fromSystemProperties() 方法读取系统属性。做个打印：</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">ParameterTool&nbsp;parameterTool&nbsp;=&nbsp;ParameterTool.fromSystemProperties();<br  />System.out.println(parameterTool.toMap().toString());<br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>1.5.3 读取配置文件<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">可以使用<code style="padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);">ParameterTool.fromPropertiesFile("/application.properties")</code>读取 properties 配置文件。可以将所有要配置的地方（比如并行度和一些 Kafka、MySQL 等配置）都写成可配置的，然后其对应的 key 和 value 值都写在配置文件中，最后通过 ParameterTool 去读取配置文件获取对应的值。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>1.5.4 注册全局参数<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在ExecutionConfig 中可以将 ParameterTool 注册为全作业参数的参数，这样就可以被 JobManager 的web 端以及用户⾃定义函数中以配置值的形式访问。</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">StreamExecutionEnvironment&nbsp;env&nbsp;=&nbsp;StreamExecutionEnvironment.getExecutionEnvironment();&nbsp;env.getConfig().setGlobalJobParameters(ParameterTool.fromArgs(args));<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">可以不用将ParameterTool当作参数传递给算子的自定义函数，直接在用户⾃定义的Rich 函数中直接获取到参数值了。</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">env.addSource(<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;RichSourceFunction()&nbsp;{&nbsp;<br  /><span style="color: #643820;line-height: 26px;">@Override</span>&nbsp;<br  /><span style="line-height: 26px;"><span style="color: #aa0d91;line-height: 26px;">public</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">void</span>&nbsp;<span style="color: #1c00cf;line-height: 26px;">run</span><span style="color: #5c2699;line-height: 26px;">(SourceContext&nbsp;sourceContext)</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">throws</span>&nbsp;Exception&nbsp;</span>{<br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">while</span>&nbsp;(<span style="color: #aa0d91;line-height: 26px;">true</span>)&nbsp;{&nbsp;<br  />&nbsp;ParameterTool&nbsp;parameterTool&nbsp;=&nbsp;(ParameterTool)getRuntimeContext().getExecutionConfig().getGlobalJobParameters();<br  />&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;}&nbsp;<br  /><br  />&nbsp;&nbsp;<span style="color: #643820;line-height: 26px;">@Override</span>&nbsp;<br  />&nbsp;&nbsp;<span style="line-height: 26px;"><span style="color: #aa0d91;line-height: 26px;">public</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">void</span>&nbsp;<span style="color: #1c00cf;line-height: 26px;">cancel</span><span style="color: #5c2699;line-height: 26px;">()</span>&nbsp;</span>{<br  />&nbsp;&nbsp;}<br  />})<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>1.6 压测方式<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">压测的方式很简单，先在kafka中积压数据，之后开启Flink任务，出现反压，就是处理瓶颈。相当于水库先积水，一下子泄洪。数据可以是自己造的模拟数据，也可以是生产中的部分数据。</p><h2 data-tool="mdnice编辑器" style="font-size: 22px;text-align: center;font-weight: bold;line-height: 1.1em;padding-top: 12px;padding-bottom: 12px;margin: 70px 30px 30px;border-width: 1px;border-style: solid;border-color: rgb(0, 0, 0);"><span style="float: left;display: block;width: 90%;border-top: 1px solid #000;height: 1px;line-height: 1px;margin-left: -5px;margin-top: -17px;"> </span><span style="display: block;width: 3px;margin-left: 5%;height: 3px;line-height: 3px;overflow: hidden;background-color: rgb(0, 0, 0);box-shadow: rgb(0, 0, 0) 3px 0px, rgb(0, 0, 0) 0px 3px, rgb(0, 0, 0) -3px 0px, rgb(0, 0, 0) 0px -3px;"></span><span style="display: block;-webkit-box-reflect: below 0em -webkit-gradient(linear,left top,left bottom, from(rgba(0,0,0,0)),to(rgba(255,255,255,0.1)));">2、反压处理</span><span style="display: block;width: 3px;margin-left: 95%;height: 3px;line-height: 3px;overflow: hidden;background-color: rgb(0, 0, 0);box-shadow: rgb(0, 0, 0) 3px 0px, rgb(0, 0, 0) 0px 3px, rgb(0, 0, 0) -3px 0px, rgb(0, 0, 0) 0px -3px;"></span><span style="float: right;display: block;width: 90%;border-bottom: 1px solid #000;height: 1px;line-height: 1px;margin-right: -5px;margin-top: 16px;"> </span></h2><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">反压（BackPressure）通常产生于这样的场景：短时间的负载高峰导致系统接收数据的速率远高于它处理数据的速率。许多日常问题都会导致反压，例如，垃圾回收停顿可能会导致流入的数据快速堆积，或遇到大促、秒杀活动导致流量陡增。反压如果不能得到正确的处理，可能会导致资源耗尽甚至系统崩溃。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">反压机制是指系统能够自己检测到被阻塞的 Operator，然后自适应地降低源头或上游数据的发送速率，从而维持整个系统的稳定。Flink 任务一般运行在多个节点上，数据从上游算子发送到下游算子需要网络传输，若系统在反压时想要降低数据源头或上游算子数据的发送速率，那么肯定也需要网络传输。所以下面先来了解一下 Flink 的网络流控（Flink 对网络数据流量的控制）机制。</p><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>2.1 反压现象及定位<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">Flink 的反压太过于天然了，导致无法简单地通过监控 BufferPool 的使用情况来判断反压状态。Flink 通过对运行中的任务进行采样来确定其反压，如果一个 Task 因为反压导致处理速度降低了，那么它肯定会卡在向 LocalBufferPool 申请内存块上。那么该 Task 的 stack trace 应该是这样：</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">java.lang.Object.wait(Native&nbsp;Method)<br  />o.a.f.[...].LocalBufferPool.requestBuffer(LocalBufferPool.java:<span style="color: #1c00cf;line-height: 26px;">163</span>)&nbsp;o.a.f.[...].LocalBufferPool.requestBufferBlocking(LocalBufferPool.java:<span style="color: #1c00cf;line-height: 26px;">133</span>)&nbsp;[...]<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">监控对正常的任务运行有一定影响，因此只有当 Web 页面切换到 Job 的 BackPressure 页面时，JobManager 才会对该 Job 触发反压监控。默认情况下，JobManager 会触发 100 次 stack trace 采样，每次间隔 50ms 来确定反压。Web 界面看到的比率表示在内部方法调用中有多少 stack trace 被卡在LocalBufferPool.requestBufferBlocking()，例如: 0.01 表示在 100 个采样中只有 1 个被卡在LocalBufferPool.requestBufferBlocking()。采样得到的比例与反压状态的对应关系如下：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">OK: 0 &lt;= 比例 &lt;= 0.10</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">LOW: 0.10 &lt; 比例 &lt;= 0.5</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">HIGH: 0.5 &lt; 比例 &lt;= 1</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">Task 的状态为 OK 表示没有反压，HIGH 表示这个 Task 被反压。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>2.1.1 利用Flink Web UI定位产生反压的位置<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在 Flink Web UI 中有 BackPressure 的页面，通过该页面可以查看任务中 subtask 的反压状态，如下两图所示，分别展示了状态是 OK 和 HIGH 的场景。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;"><strong>排查的时候，先把operator chain禁用，方便定位。</strong></p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009666" data-ratio="0.41612483745123535" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6ulpVEJ8MJVWVWZs2tziaouicZbnbkMjuoELayZMkm3N33GM5tpxBiaicNw/640?wx_fmt=png" data-type="png" data-w="769" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009663" data-ratio="0.46029609690444145" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6uITwPic0n4SiaFwyButicBu1rHV4510FcJ4oOZ4VERaZS8UAZSDictHzmQ/640?wx_fmt=png" data-type="png" data-w="743" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>利用Metrics定位反压位置<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">当某个 Task 吞吐量下降时，基于 Credit 的反压机制，上游不会给该 Task 发送数据，所以该 Task 不会频繁卡在向 Buffer Pool 去申请 Buffer。反压监控实现原理就是监控 Task 是否卡在申请 buffer 这一步，所以遇到瓶颈的 Task 对应的反压⻚⾯必然会显示 OK，即表示没有受到反压。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果该 Task 吞吐量下降，造成该Task 上游的 Task 出现反压时，必然会存在：该 Task 对应的 InputChannel 变满，已经申请不到可用的Buffer 空间。如果该 Task 的 InputChannel 还能申请到可用 Buffer，那么上游就可以给该 Task 发送数据，上游 Task 也就不会被反压了，所以说遇到瓶颈且导致上游 Task 受到反压的 Task 对应的InputChannel 必然是满的（这⾥不考虑⽹络遇到瓶颈的情况）。从这个思路出发，可以对该 Task 的 InputChannel 的使用情况进行监控，如果 InputChannel 使用率 100%，那么该 Task 就是我们要找的反压源。Flink 1.9 及以上版本inPoolUsage 表示 inputFloatingBuffersUsage 和inputExclusiveBuffersUsage 的总和。</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009667" data-ratio="0.5404224326292789" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6k7whMicyHDvRFkYIbhPWu5HyStoQLbC1ib7prPDxNgywLWUPplKN6ZSA/640?wx_fmt=png" data-type="png" data-w="1373" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">反压时，可以看到<strong>遇到瓶颈的该Task的inPoolUage为1</strong>。</p><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>2.2 反压的原因及处理<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">先检查基本原因，然后再深入研究更复杂的原因，最后找出导致瓶颈的原因。下面列出从最基本到比较复杂的一些反压潜在原因。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;"><strong>注意</strong>：反压可能是暂时的，可能是由于负载高峰、CheckPoint 或作业重启引起的数据积压而导致反压。如果反压是暂时的，应该忽略它。另外，请记住，断断续续的反压会影响我们分析和解决问题。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>2.2.1 系统资源<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">检查涉及服务器基本资源的使用情况，如CPU、网络或磁盘I/O，目前 Flink 任务使用最主要的还是内存和 CPU 资源，本地磁盘、依赖的外部存储资源以及网卡资源一般都不会是瓶颈。如果某些资源被充分利用或大量使用，可以借助分析工具，分析性能瓶颈（JVM Profiler+ FlameGraph生成火焰图）。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">针对特定的资源调优Flink</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">通过增加并行度或增加集群中的服务器数量来横向扩展</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">减少瓶颈算子上游的并行度，从而减少瓶颈算子接收的数据量（不建议，可能造成整个Job数据延迟增大）</section></li></ul><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>2.2.2 垃圾回收（GC）<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">长时间GC暂停会导致性能问题。可以通过打印调试GC日志（通过-XX:+PrintGCDetails）或使用某些内存或 GC 分析器（GCViewer工具）来验证是否处于这种情况。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">在Flink提交脚本中,设置JVM参数，打印GC日志：</p><pre style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;display: -webkit-box;padding: 15px 4px 2px;margin-right: 2px;margin-left: 2px;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);background: rgb(255, 255, 255);border-radius: 5px;">bin/flink&nbsp;run<br  />-t&nbsp;yarn-per-job<br  />-d<br  />-p&nbsp;5&nbsp;\&nbsp;指定并行度<br  />-Dyarn.application.queue=test&nbsp;\&nbsp;指定yarn队列<br  />-Djobmanager.memory.process.size=1024mb&nbsp;\&nbsp;指定JM的总进程大小<br  />-Dtaskmanager.memory.process.size=1024mb&nbsp;\&nbsp;指定每个TM的总进程大小<br  />-Dtaskmanager.numberOfTaskSlots=2&nbsp;\&nbsp;指定每个TM的slot数<br  />-Denv.java.opts="-XX:+PrintGCDetails&nbsp;-XX:+PrintGCDateStamps"<br  />-c&nbsp;com.atguigu.app.dwd.LogBaseApp<br  />/opt/module/gmall-flink/gmall-realtime-1.0-SNAPSHOT-jar-with-dependencies.jar<br  /><br  /></code></pre><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">因为是on yarn模式，运行的节点一个一个找比较麻烦。可以打开WebUI，选择JobManager或者TaskManager，点击Stdout，即可看到GC日志，点击下载按钮即可将GC日志通过HTTP的方式下载下来。</p><figure style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009672" data-ratio="0.3931888544891641" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6gLbNhd72Wg7B8RRMaiaMoicic7Vibrz7ZxwffuqtsLkx4ZVdkA5emCskxw/640?wx_fmt=png" data-type="png" data-w="1615" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure></section></li><ul style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: circle;" class="list-paddingleft-2"><li style="list-style-type: circle;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">分析GC日志：</section></li><li style="list-style-type: circle;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">下载GC日志的方式：</section></li></ul></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">通过 GC 日志分析出单个 Flink Taskmanager 堆总大小、年轻代、老年代分配的内存空间、Full GC 后老年代剩余大小等，相关指标定义可以去 Github 具体查看。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;"><strong>扩展：最重要的指标是Full GC后，老年代剩余大小这个指标，按照《Java性能优化权威指南》这本Java堆大小计算法则，设Full GC后老年代剩余大小空间为M，那么堆的大小建议3 ~ 4倍M，新生代为1 ~ 1.5倍M，老年代应为2 ~ 3倍M。</strong></p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>2.2.4 线程竞争<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">与上⾯的 CPU/线程瓶颈问题类似，subtask 可能会因为共享资源上高负载线程的竞争而成为瓶颈。同样，可以考虑使用2.2.1提到的分析工具，考虑在用户代码中查找同步开销、锁竞争，尽管避免在用户代码中添加同步。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>2.4.5 负载不平衡<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果瓶颈是由数据倾斜引起的，可以尝试通过将数据分区的 key 进行加盐或通过实现本地预聚合来减轻数据倾斜的影响。（关于数据倾斜的详细解决方案，会在下一章节详细讨论）</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>2.4.6 外部依赖<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果发现我们的 Source 端数据读取性能比较低或者 Sink 端写入性能较差，需要检查第三方组件是否遇到瓶颈。例如，Kafka 集群是否需要扩容，Kafka 连接器是否并行度较低，HBase 的 rowkey 是否遇到热点问题。关于第三方组件的性能问题，需要结合具体的组件来分析。</p><h2 data-tool="mdnice编辑器" style="font-size: 22px;text-align: center;font-weight: bold;line-height: 1.1em;padding-top: 12px;padding-bottom: 12px;margin: 70px 30px 30px;border-width: 1px;border-style: solid;border-color: rgb(0, 0, 0);"><span style="float: left;display: block;width: 90%;border-top: 1px solid #000;height: 1px;line-height: 1px;margin-left: -5px;margin-top: -17px;"> </span><span style="display: block;width: 3px;margin-left: 5%;height: 3px;line-height: 3px;overflow: hidden;background-color: rgb(0, 0, 0);box-shadow: rgb(0, 0, 0) 3px 0px, rgb(0, 0, 0) 0px 3px, rgb(0, 0, 0) -3px 0px, rgb(0, 0, 0) 0px -3px;"></span><span style="display: block;-webkit-box-reflect: below 0em -webkit-gradient(linear,left top,left bottom, from(rgba(0,0,0,0)),to(rgba(255,255,255,0.1)));">3、数据倾斜</span><span style="display: block;width: 3px;margin-left: 95%;height: 3px;line-height: 3px;overflow: hidden;background-color: rgb(0, 0, 0);box-shadow: rgb(0, 0, 0) 3px 0px, rgb(0, 0, 0) 0px 3px, rgb(0, 0, 0) -3px 0px, rgb(0, 0, 0) 0px -3px;"></span><span style="float: right;display: block;width: 90%;border-bottom: 1px solid #000;height: 1px;line-height: 1px;margin-right: -5px;margin-top: 16px;"> </span></h2><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>3.1 判断是否存在数据倾斜<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">相同 Task 的多个 Subtask 中，个别Subtask 接收到的数据量明显大于其他 Subtask 接收到的数据量，通过 Flink Web UI 可以精确地看到每个 Subtask 处理了多少数据，即可判断出 Flink 任务是否存在数据倾斜。通常，数据倾斜也会引起反压。</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009668" data-ratio="1.0089445438282647" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6NVGIxvbfa8vsaOYyl0bIHZofw0KXjt4VicBeZvf6E6wpTYZQvfib9ic9w/640?wx_fmt=png" data-type="png" data-w="559" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>3.2 数据倾斜的解决<span style="display: none;"></span></h3><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>3.2.1 keyBy后的聚合操作存在数据倾斜<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">使用LocalKeyBy的思想：在 keyBy 上游算子数据发送之前，首先在上游算子的本地对数据进行聚合后再发送到下游，使下游接收到的数据量大大减少，从而使得 keyBy 之后的聚合操作不再是任务的瓶颈。类似MapReduce 中 Combiner 的思想，但是这要求聚合操作必须是多条数据或者一批数据才能聚合，单条数据没有办法通过聚合来减少数据量。从Flink LocalKeyBy 实现原理来讲，必然会存在一个积攒批次的过程，在上游算子中必须攒够一定的数据量，对这些数据聚合后再发送到下游。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">**注意：**Flink是实时流处理，如果keyby之后的聚合操作存在数据倾斜，且没有开窗口的情况下，简单的认为使用两阶段聚合，是不能解决问题的。因为这个时候Flink是来一条处理一条，且向下游发送一条结果，对于原来keyby的维度（第二阶段聚合）来讲，数据量并没有减少，且结果重复计算（非FlinkSQL，未使用回撤流），如下图所示：</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009669" data-ratio="0.3807062876830319" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6dxxKTtdiaU6nHgZzlSLmHvo3D0AFMkSWQW6bVbgkeAZTIVZKudibgZhg/640?wx_fmt=png" data-type="png" data-w="1161" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">**实现方式：**以计算PV为例，keyby之前，使用flatMap实现LocalKeyby</section></li></ul><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="line-height: 26px;"><span style="color: #aa0d91;line-height: 26px;">class</span>&nbsp;<span style="color: #5c2699;line-height: 26px;">LocalKeyByFlatMap</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">extends</span>&nbsp;<span style="color: #5c2699;line-height: 26px;">RichFlatMapFunction</span>&lt;<span style="color: #5c2699;line-height: 26px;">String</span>,&nbsp;<span style="color: #5c2699;line-height: 26px;">Tuple2</span>&lt;<span style="color: #5c2699;line-height: 26px;">String</span>,&nbsp;<br  />&nbsp;//<span style="color: #5c2699;line-height: 26px;">Checkpoint</span>&nbsp;时为了保证&nbsp;<span style="color: #5c2699;line-height: 26px;">Exactly</span>&nbsp;<span style="color: #5c2699;line-height: 26px;">Once</span>，将&nbsp;<span style="color: #5c2699;line-height: 26px;">buffer</span>&nbsp;中的数据保存到该&nbsp;<span style="color: #5c2699;line-height: 26px;">ListState</span>&nbsp;中<br  />&nbsp;<span style="color: #5c2699;line-height: 26px;">private</span>&nbsp;<span style="color: #5c2699;line-height: 26px;">ListState</span>&lt;<span style="color: #5c2699;line-height: 26px;">Tuple2</span>&lt;<span style="color: #5c2699;line-height: 26px;">String</span>,&nbsp;<span style="color: #5c2699;line-height: 26px;">Long</span>&gt;&gt;&nbsp;<span style="color: #5c2699;line-height: 26px;">localPvStatListState</span></span>;<br  />&nbsp;<br  />&nbsp;<span style="color: #007400;line-height: 26px;">//本地&nbsp;buffer，存放&nbsp;local&nbsp;端缓存的&nbsp;app&nbsp;的&nbsp;pv&nbsp;信息</span><br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">private</span>&nbsp;HashMap&lt;String,&nbsp;Long&gt;&nbsp;localPvStat;<br  />&nbsp;<br  />&nbsp;<span style="color: #007400;line-height: 26px;">//缓存的数据量大小，即：缓存多少数据再向下游发送</span><br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">private</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">int</span>&nbsp;batchSize;<br  />&nbsp;<br  />&nbsp;<span style="color: #007400;line-height: 26px;">//计数器，获取当前批次接收的数据量</span><br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">private</span>&nbsp;AtomicInteger&nbsp;currentSize;<br  /><br  />&nbsp;<span style="color: #007400;line-height: 26px;">//构造器，批次大小传参</span><br  />&nbsp;LocalKeyByFlatMap(<span style="color: #aa0d91;line-height: 26px;">int</span>&nbsp;batchSize){<br  />&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">this</span>.batchSize&nbsp;=&nbsp;batchSize;<br  />&nbsp;}<br  /><br  />&nbsp;<span style="color: #643820;line-height: 26px;">@Override</span><br  />&nbsp;<span style="line-height: 26px;"><span style="color: #aa0d91;line-height: 26px;">public</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">void</span>&nbsp;<span style="color: #1c00cf;line-height: 26px;">flatMap</span><span style="color: #5c2699;line-height: 26px;">(String&nbsp;in,&nbsp;Collector&nbsp;collector)</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">throws</span>&nbsp;Exception&nbsp;</span>{<br  />&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;将新来的数据添加到&nbsp;buffer&nbsp;中</span><br  />&nbsp;&nbsp;Long&nbsp;pv&nbsp;=&nbsp;localPvStat.getOrDefault(in,&nbsp;<span style="color: #1c00cf;line-height: 26px;">0L</span>);<br  />&nbsp;&nbsp;localPvStat.put(in,&nbsp;pv&nbsp;+&nbsp;<span style="color: #1c00cf;line-height: 26px;">1</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;如果到达设定的批次，则将&nbsp;buffer&nbsp;中的数据发送到下游</span><br  />&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">if</span>(currentSize.incrementAndGet()&nbsp;&gt;=&nbsp;batchSize){<br  />&nbsp;&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;遍历&nbsp;Buffer&nbsp;中数据，发送到下游</span><br  />&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">for</span>(Map.Entry&lt;String,&nbsp;Long&gt;&nbsp;appIdPv:&nbsp;localPvStat.entrySet())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;collector.collect(Tuple2.of(appIdPv.getKey(),&nbsp;appIdPv.getValue()<br  />&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;Buffer&nbsp;清空，计数器清零</span><br  />&nbsp;&nbsp;&nbsp;localPvStat.clear();<br  />&nbsp;&nbsp;&nbsp;currentSize.set(<span style="color: #1c00cf;line-height: 26px;">0</span>);<br  />&nbsp;&nbsp;}<br  />&nbsp;}<br  /><br  />&nbsp;<span style="color: #643820;line-height: 26px;">@Override</span><br  />&nbsp;<span style="line-height: 26px;"><span style="color: #aa0d91;line-height: 26px;">public</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">void</span>&nbsp;<span style="color: #1c00cf;line-height: 26px;">snapshotState</span><span style="color: #5c2699;line-height: 26px;">(FunctionSnapshotContext&nbsp;functionSnapshotConte<br  />&nbsp;&nbsp;//&nbsp;将&nbsp;buffer&nbsp;中的数据保存到状态中，来保证&nbsp;Exactly&nbsp;Once<br  />&nbsp;&nbsp;localPvStatListState.clear()</span></span>;<br  />&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">for</span>(Map.Entry&lt;String,&nbsp;Long&gt;&nbsp;appIdPv:&nbsp;localPvStat.entrySet())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;localPvStatListState.add(Tuple2.of(appIdPv.getKey(),&nbsp;appIdPv.ge<br  />&nbsp;&nbsp;}<br  />&nbsp;}<br  /><br  />&nbsp;<span style="color: #643820;line-height: 26px;">@Override</span><br  />&nbsp;<span style="line-height: 26px;"><span style="color: #aa0d91;line-height: 26px;">public</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">void</span>&nbsp;<span style="color: #1c00cf;line-height: 26px;">initializeState</span><span style="color: #5c2699;line-height: 26px;">(FunctionInitializationContext&nbsp;context)</span>&nbsp;</span>{<br  />&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;从状态中恢复&nbsp;buffer&nbsp;中的数据</span><br  />&nbsp;&nbsp;localPvStatListState&nbsp;=&nbsp;context.getOperatorStateStore().getListState<br  />&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;ListStateDescriptor&lt;&gt;(<span style="color: #c41a16;line-height: 26px;">"localPvStat"</span>,<br  />&nbsp;&nbsp;TypeInformation.of(<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;TypeHint&lt;Tuple2&lt;String,&nbsp;Long&gt;&gt;})));<br  />&nbsp;&nbsp;localPvStat&nbsp;=&nbsp;<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;HashMap();<br  />&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">if</span>(context.isRestored())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;从状态中恢复数据到&nbsp;localPvStat&nbsp;中</span><br  />&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">for</span>(Tuple2&lt;String,&nbsp;Long&gt;&nbsp;appIdPv:&nbsp;localPvStatListState.get()){<br  /><span style="color: #aa0d91;line-height: 26px;">long</span>&nbsp;pv&nbsp;=&nbsp;localPvStat.getOrDefault(appIdPv.f0,&nbsp;<span style="color: #1c00cf;line-height: 26px;">0L</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;如果出现&nbsp;pv&nbsp;!=&nbsp;0,说明改变了并行度，</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;ListState&nbsp;中的数据会被均匀分发到新的&nbsp;subtask中</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;所以单个&nbsp;subtask&nbsp;恢复的状态中可能包含两个相同的&nbsp;app&nbsp;的数据</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;localPvStat.put(appIdPv.f0,&nbsp;pv&nbsp;+&nbsp;appIdPv.f1);<br  />&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">//&nbsp;从状态恢复时，默认认为&nbsp;buffer&nbsp;中数据量达到了&nbsp;batchSize，需要向下游发</span><br  />&nbsp;&nbsp;&nbsp;currentSize&nbsp;=&nbsp;<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;AtomicInteger(batchSize);<br  />&nbsp;&nbsp;}&nbsp;<span style="color: #aa0d91;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;currentSize&nbsp;=&nbsp;<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;AtomicInteger(<span style="color: #1c00cf;line-height: 26px;">0</span>);<br  />&nbsp;&nbsp;}<br  />&nbsp;}<br  />}<br  /><br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>3.2.2 keyBy之前发生数据倾斜<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果 keyBy 之前就存在数据倾斜，上游算子的某些实例可能处理的数据较多，某些实例可能处理的数据较少，产生该情况可能是因为数据源的数据本身就不均匀，例如由于某些原因 Kafka 的 topic 中某些 partition 的数据量较大，某些 partition 的数据量较少。对于不存在 keyBy 的 Flink 任务也会出现该情况。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">这种情况，需要让 Flink 任务强制进行shuffle。使用shuffle、rebalance 或 rescale算子即可将数据均匀分配，从而解决数据倾斜的问题。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>3.2.3 keyBy后的窗口聚合操作存在数据倾斜<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">因为使用了窗口，变成了有界数据的处理（3.2.1已分析过），窗口默认是触发时才会输出一条结果发往下游，所以可以使用两阶段聚合的方式：</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;"><strong>实现思路：</strong></p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">第一阶段聚合：key拼接随机数前缀或后缀，进行keyby、开窗、聚合</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">注意：聚合完不再是WindowedStream，要获取WindowEnd作为窗口标记作为第二阶段分组依据，避免不同窗口的结果聚合到一起）</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">第二阶段聚合：去掉随机数前缀或后缀，按照原来的key及windowEnd作keyby、聚合</section></li></ul><h2 data-tool="mdnice编辑器" style="font-size: 22px;text-align: center;font-weight: bold;line-height: 1.1em;padding-top: 12px;padding-bottom: 12px;margin: 70px 30px 30px;border-width: 1px;border-style: solid;border-color: rgb(0, 0, 0);"><span style="float: left;display: block;width: 90%;border-top: 1px solid #000;height: 1px;line-height: 1px;margin-left: -5px;margin-top: -17px;"> </span><span style="display: block;width: 3px;margin-left: 5%;height: 3px;line-height: 3px;overflow: hidden;background-color: rgb(0, 0, 0);box-shadow: rgb(0, 0, 0) 3px 0px, rgb(0, 0, 0) 0px 3px, rgb(0, 0, 0) -3px 0px, rgb(0, 0, 0) 0px -3px;"></span><span style="display: block;-webkit-box-reflect: below 0em -webkit-gradient(linear,left top,left bottom, from(rgba(0,0,0,0)),to(rgba(255,255,255,0.1)));">4、KafkaSource调休</span><span style="display: block;width: 3px;margin-left: 95%;height: 3px;line-height: 3px;overflow: hidden;background-color: rgb(0, 0, 0);box-shadow: rgb(0, 0, 0) 3px 0px, rgb(0, 0, 0) 0px 3px, rgb(0, 0, 0) -3px 0px, rgb(0, 0, 0) 0px -3px;"></span><span style="float: right;display: block;width: 90%;border-bottom: 1px solid #000;height: 1px;line-height: 1px;margin-right: -5px;margin-top: 16px;"> </span></h2><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>4.1 动态发现分区<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">当 FlinkKafkaConsumer 初始化时，每个 subtask 会订阅一批 partition，但是当 Flink 任务运行过程中，如果被订阅的 topic 创建了新的 partition，FlinkKafkaConsumer 如何实现动态发现新创建的 partition 并消费呢？</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在使用 FlinkKafkaConsumer 时，可以开启 partition 的动态发现。通过 Properties指定参数开启（单位是毫秒）:</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">FlinkKafkaConsumerBase.KEY_PARTITION_DISCOVERY_INTERVAL_MILLIS&nbsp;<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">该参数表示间隔多久检测一次是否有新创建的 partition。默认值是Long的最小值，表示不开启，大于0表示开启。开启时会启动一个线程根据传入的interval定期获取Kafka最新的元数据，新 partition 对应的那一个 subtask 会自动发现并从earliest 位置开始消费，新创建的 partition 对其他 subtask 并不会产生影响。</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">properties.setProperty(FlinkKafkaConsumerBase.KEY_PARTITION_DISCOVERY_INTERVAL_MILLIS,&nbsp;<span style="color: #1c00cf;line-height: 26px;">30</span>&nbsp;*&nbsp;<span style="color: #1c00cf;line-height: 26px;">1000</span>&nbsp;+&nbsp;<span style="color: #c41a16;line-height: 26px;">""</span>);&nbsp;<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>4.2 从kafka数据源生成watermark<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">Kafka单分区内有序，多分区间无序。在这种情况下，可以使用 Flink 中可识别 Kafka 分区的 watermark 生成机制。使用此特性，将在 Kafka 消费端内部针对每个 Kafka 分区生成 watermark，并且不同分区 watermark 的合并方式与在数据流 shuffle 时的合并方式相同。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在单分区内有序的情况下，使用时间戳单调递增按分区生成的 watermark 将生成完美的全局 watermark。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">可以不使用 TimestampAssigner，直接用 Kafka 记录自身的时间戳：</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">StreamExecutionEnvironment&nbsp;env&nbsp;=&nbsp;StreamExecutionEnvironment.getExecutionEnvironment();<br  /><br  />Properties&nbsp;properties&nbsp;=&nbsp;<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;Properties();<br  />properties.setProperty(<span style="color: #c41a16;line-height: 26px;">"bootstrap.servers"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"node01:9092,node01:9092,node03:9092"</span>);<br  />properties.setProperty(<span style="color: #c41a16;line-height: 26px;">"group.id"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"dsjlg"</span>);<br  />FlinkKafkaConsumer&lt;String&gt;&nbsp;kafkaSourceFunction&nbsp;=&nbsp;<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;FlinkKafkaConsumer&lt;&gt;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c41a16;line-height: 26px;">"flinktest"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;SimpleStringSchema(),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;properties<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br  /><br  />kafkaSourceFunction.assignTimestampsAndWatermarks(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WatermarkStrategy<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.forBoundedOutOfOrderness(Duration.ofMinutes(<span style="color: #1c00cf;line-height: 26px;">2</span>))<br  />);<br  /><br  />env.addSource(kafkaSourceFunction);<br  /><br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>4.3 设置空闲等待<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果数据源中的某一个分区/分片在一段时间内未发送事件数据，则意味着 WatermarkGenerator 也不会获得任何新数据去生成 watermark。我们称这类数据源为空闲输入或空闲源。在这种情况下，当某些其他分区仍然发送事件数据的时候就会出现问题。比如Kafka的Topic中，由于某些原因，造成个别Partition一直没有新的数据。由于下游算子 watermark 的计算方式是取所有不同的上游并行数据源 watermark 的最小值，则其 watermark 将不会发生变化，导致窗口、定时器等不会被触发。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">为了解决这个问题，你可以使用 WatermarkStrategy 来检测空闲输入并将其标记为空闲状态。</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">StreamExecutionEnvironment&nbsp;env&nbsp;=&nbsp;StreamExecutionEnvironment.getExecutionEnvironment();<br  /><br  />Properties&nbsp;properties&nbsp;=&nbsp;<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;Properties();<br  />properties.setProperty(<span style="color: #c41a16;line-height: 26px;">"bootstrap.servers"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"node01:9092,node02:9092,node03:9092"</span>);<br  />properties.setProperty(<span style="color: #c41a16;line-height: 26px;">"group.id"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"gzhdsjlg"</span>);<br  /><br  /><br  />FlinkKafkaConsumer&lt;String&gt;&nbsp;kafkaSourceFunction&nbsp;=&nbsp;<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;FlinkKafkaConsumer&lt;&gt;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c41a16;line-height: 26px;">"flinktest"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">new</span>&nbsp;SimpleStringSchema(),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;properties<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br  /><br  />kafkaSourceFunction.assignTimestampsAndWatermarks(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WatermarkStrategy<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.forBoundedOutOfOrderness(Duration.ofMinutes(<span style="color: #1c00cf;line-height: 26px;">2</span>))<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withIdleness(Duration.ofMinutes(<span style="color: #1c00cf;line-height: 26px;">5</span>))<br  />);<br  /><br  />env.addSource(kafkaSourceFunction)<br  /><br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>4.4 Kafka的offset消费策略<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">FlinkKafkaConsumer可以调用以下API，注意与<code style="padding: 2px 4px;border-radius: 4px;margin-right: 2px;margin-left: 2px;background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;color: rgb(255, 100, 65);">auto.offset.reset</code>区分开：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">setStartFromGroupOffsets()：默认消费策略，默认读取上次保存的offset信息，如果是应用第一次启动，读取不到上次的offset信息，则会根据这个参数auto.offset.reset的值来进行消费数据。建议使用这个。</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">setStartFromEarliest()：从最早的数据开始进行消费，忽略存储的offset信息</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">setStartFromLatest()：从最新的数据进行消费，忽略存储的offset信息</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">setStartFromSpecificOffsets(Map)：从指定位置进行消费</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">setStartFromTimestamp(long)：从topic中指定的时间点开始消费，指定时间点之前的数据忽略</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">当checkpoint机制开启的时候，KafkaConsumer会定期把kafka的offset信息还有其他operator的状态信息一块保存起来。当job失败重启的时候，Flink会从最近一次的checkpoint中进行恢复数据，重新从保存的offset消费kafka中的数据（也就是说，上面几种策略，只有第一次启动的时候起作用）。</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;color: black;">为了能够使用支持容错的kafka Consumer，需要开启checkpoint</p></section></li></ul><h2 data-tool="mdnice编辑器" style="font-size: 22px;text-align: center;font-weight: bold;line-height: 1.1em;padding-top: 12px;padding-bottom: 12px;margin: 70px 30px 30px;border-width: 1px;border-style: solid;border-color: rgb(0, 0, 0);"><span style="float: left;display: block;width: 90%;border-top: 1px solid #000;height: 1px;line-height: 1px;margin-left: -5px;margin-top: -17px;"> </span><span style="display: block;width: 3px;margin-left: 5%;height: 3px;line-height: 3px;overflow: hidden;background-color: rgb(0, 0, 0);box-shadow: rgb(0, 0, 0) 3px 0px, rgb(0, 0, 0) 0px 3px, rgb(0, 0, 0) -3px 0px, rgb(0, 0, 0) 0px -3px;"></span><span style="display: block;-webkit-box-reflect: below 0em -webkit-gradient(linear,left top,left bottom, from(rgba(0,0,0,0)),to(rgba(255,255,255,0.1)));">5、FlinkSQL调优</span><span style="display: block;width: 3px;margin-left: 95%;height: 3px;line-height: 3px;overflow: hidden;background-color: rgb(0, 0, 0);box-shadow: rgb(0, 0, 0) 3px 0px, rgb(0, 0, 0) 0px 3px, rgb(0, 0, 0) -3px 0px, rgb(0, 0, 0) 0px -3px;"></span><span style="float: right;display: block;width: 90%;border-bottom: 1px solid #000;height: 1px;line-height: 1px;margin-right: -5px;margin-top: 16px;"> </span></h2><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>5.1 Group Aggregate优化<span style="display: none;"></span></h3><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>5.1.1 开启MiniBatch（提升吞吐）<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">MiniBatch是微批处理，原理是缓存一定的数据后再触发处理，以减少对State的访问，从而提升吞吐并减少数据的输出量。MiniBatch主要依靠在每个Task上注册的Timer线程来触发微批，需要消耗一定的线程调度性能。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">MiniBatch默认关闭，开启方式如下:</section></li></ul><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #007400;line-height: 26px;">//&nbsp;初始化table&nbsp;environment</span><br  />TableEnvironment&nbsp;tEnv&nbsp;=&nbsp;...<br  /><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;获取&nbsp;tableEnv的配置对象</span><br  />Configuration&nbsp;configuration&nbsp;=&nbsp;tEnv.getConfig().getConfiguration();<br  /><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;设置参数：</span><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;开启miniBatch</span><br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.exec.mini-batch.enabled"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"true"</span>);<br  /><span style="color: #007400;line-height: 26px;">//&nbsp;批量输出的间隔时间</span><br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.exec.mini-batch.allow-latency"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"5&nbsp;s"</span>);<br  /><span style="color: #007400;line-height: 26px;">//&nbsp;防止OOM设置每个批次最多缓存数据的条数，可以设为2万条</span><br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.exec.mini-batch.size"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"20000"</span>);<br  /><br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">FlinkSQL参数配置列表：</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/config.html</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">适用场景</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">微批处理通过增加延迟换取高吞吐，如果有超低延迟的要求，不建议开启微批处理。通常对于聚合的场景，微批处理可以显著的提升系统性能，建议开启。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">注意事项</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">1）目前，key-value 配置项仅被 Blink planner 支持。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">2）1.12之前的版本有bug，开启miniBatch，不会清理过期状态，也就是说如果设置状态的TTL，无法清理过期状态。1.12版本才修复这个问题。参考ISSUE：https://issues.apache.org/jira/browse/FLINK-17096</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>5.1.2 开启LocalGlobal（解决常见数据热点问题）<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">LocalGlobal优化将原先的Aggregate分成Local+Global两阶段聚合，即MapReduce模型中的Combine+Reduce处理模式。第一阶段在上游节点本地攒一批数据进行聚合（localAgg），并输出这次微批的增量值（Accumulator）。第二阶段再将收到的Accumulator合并（Merge），得到最终的结果（GlobalAgg）。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">LocalGlobal本质上能够靠LocalAgg的聚合筛除部分倾斜数据，从而降低GlobalAgg的热点，提升性能。结合下图理解LocalGlobal如何解决数据倾斜的问题。</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009670" data-ratio="0.44724409448818897" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6UElWmicxGqMKhZmXzicdosEZQlzGRdS9LRibhSM1Jy2A7VEFhUAnNy68w/640?wx_fmt=png" data-type="png" data-w="1270" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">由上图可知：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">未开启LocalGlobal优化，由于流中的数据倾斜，Key为红色的聚合算子实例需要处理更多的记录，这就导致了热点问题。</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">开启LocalGlobal优化后，先进行本地聚合，再进行全局聚合。可大大减少GlobalAgg的热点，提高性能。</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;"><strong>LocalGlobal开启方式：</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">1）LocalGlobal优化需要先开启MiniBatch，依赖于MiniBatch的参数。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">2）table.optimizer.agg-phase-strategy: 聚合策略。默认AUTO，支持参数AUTO、TWO_PHASE(使用LocalGlobal两阶段聚合)、ONE_PHASE(仅使用Global一阶段聚合)。</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #007400;line-height: 26px;">//&nbsp;初始化table&nbsp;environment</span><br  />TableEnvironment&nbsp;tEnv&nbsp;=&nbsp;...<br  /><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;获取&nbsp;tableEnv的配置对象</span><br  />Configuration&nbsp;configuration&nbsp;=&nbsp;tEnv.getConfig().getConfiguration();<br  /><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;设置参数：</span><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;开启miniBatch</span><br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.exec.mini-batch.enabled"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"true"</span>);<br  /><span style="color: #007400;line-height: 26px;">//&nbsp;批量输出的间隔时间</span><br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.exec.mini-batch.allow-latency"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"5&nbsp;s"</span>);<br  /><span style="color: #007400;line-height: 26px;">//&nbsp;防止OOM设置每个批次最多缓存数据的条数，可以设为2万条</span><br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.exec.mini-batch.size"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"20000"</span>);<br  /><span style="color: #007400;line-height: 26px;">//&nbsp;开启LocalGlobal</span><br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.optimizer.agg-phase-strategy"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"TWO_PHASE"</span>);<br  /><br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">判断是否生效</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">观察最终生成的拓扑图的节点名字中是否包含GlobalGroupAggregate或LocalGroupAggregate。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">适用场景</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">LocalGlobal适用于提升如SUM、COUNT、MAX、MIN和AVG等普通聚合的性能，以及解决这些场景下的数据热点问题。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">注意事项：</strong></section></li></ul><blockquote data-tool="mdnice编辑器" style="border-top: none;border-bottom: none;font-size: 0.9em;overflow: auto;color: rgb(106, 115, 125);padding: 10px 10px 10px 20px;margin-bottom: 20px;margin-top: 20px;border-left-color: rgba(0, 0, 0, 0.65);border-right: 1px solid rgba(0, 0, 0, 0.65);background: rgb(249, 249, 249);"><p style="padding-top: 8px;padding-bottom: 8px;font-size: 14px;color: black;line-height: 26px;">1）需要先开启MiniBatch
2）开启LocalGlobal需要UDAF实现Merge方法。</p></blockquote><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>5.1.3 开启split distinct（解决count distinct热点问题）<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">LocalGlobal优化针对普通聚合（例如SUM、COUNT、MAX、MIN和AVG）有较好的效果，对于COUNT DISTINCT收效不明显，因为COUNT DISTINCT在Local聚合时，对于DISTINCT KEY的去重率不高，导致在Global节点仍然存在热点。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">之前，为了解决COUNT DISTINCT的热点问题，通常需要手动改写为两层聚合（增加按Distinct Key取模的打散层）。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">从Flink1.9.0版本开始，提供了COU</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">NT DISTINCT自动打散功能，不需要手动重写。Split Distinct和LocalGlobal的原理对比参见下图。</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009671" data-ratio="0.48974763406940064" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S64xOc8JF1Ac8RtZNZPoz8oh8xjXtUq4MEhMDVrwGxOMW982I6p8sHDA/640?wx_fmt=png" data-type="png" data-w="1268" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">举例：统计一天的UV</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #aa0d91;line-height: 26px;">SELECT</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">day</span>,&nbsp;<span style="color: #aa0d91;line-height: 26px;">COUNT</span>(<span style="color: #aa0d91;line-height: 26px;">DISTINCT</span>&nbsp;user_id)<br  /><span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;T<br  /><span style="color: #aa0d91;line-height: 26px;">GROUP</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">day</span><br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果手动实现两阶段聚合：</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #aa0d91;line-height: 26px;">SELECT</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">day</span>,&nbsp;<span style="color: #aa0d91;line-height: 26px;">SUM</span>(cnt)<br  /><span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">SELECT</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">day</span>,&nbsp;<span style="color: #aa0d91;line-height: 26px;">COUNT</span>(<span style="color: #aa0d91;line-height: 26px;">DISTINCT</span>&nbsp;user_id)&nbsp;<span style="color: #aa0d91;line-height: 26px;">as</span>&nbsp;cnt<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;T<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">GROUP</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">day</span>,&nbsp;<span style="color: #aa0d91;line-height: 26px;">MOD</span>(HASH_CODE(user_id),&nbsp;<span style="color: #1c00cf;line-height: 26px;">1024</span>)<br  />)<br  /><span style="color: #aa0d91;line-height: 26px;">GROUP</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">day</span><br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">第一层聚合: 将Distinct Key打散求COUNT DISTINCT。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">第二层聚合: 对打散去重后的数据进行SUM汇总。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;"><strong>Split Distinct开启方式</strong></p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">默认不开启，使用参数显式开启：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">table.optimizer.distinct-agg.split.enabled: true，默认false。</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">table.optimizer.distinct-agg.split.bucket-num: Split Distinct优化在第一层聚合中，被打散的bucket数目。默认1024。</section></li></ul><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #007400;line-height: 26px;">//&nbsp;初始化table&nbsp;environment</span><br  />TableEnvironment&nbsp;tEnv&nbsp;=&nbsp;...<br  /><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;获取&nbsp;tableEnv的配置对象</span><br  />Configuration&nbsp;configuration&nbsp;=&nbsp;tEnv.getConfig().getConfiguration();<br  /><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;设置参数：</span><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;开启Split&nbsp;Distinct</span><br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.optimizer.distinct-agg.split.enabled"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"true"</span>);<br  /><span style="color: #007400;line-height: 26px;">//&nbsp;第一层打散的bucket数目</span><br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.optimizer.distinct-agg.split.bucket-num"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"1024"</span>);<br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">判断是否生效</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">观察最终生成的拓扑图的节点名中是否包含Expand节点，或者原来一层的聚合变成了两层的聚合。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">适用场景</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">使用COUNT DISTINCT，但无法满足聚合节点性能要求。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">注意事项：</strong></section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">1）目前不能在包含UDAF的Flink SQL中使用Split Distinct优化方法。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">2）拆分出来的两个GROUP聚合还可参与LocalGlobal优化。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">3）从Flink1.9.0版本开始，提供了COUNT DISTINCT自动打散功能，不需要手动重写（不用像上面的例子去手动实现）。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>5.1.4 改写为AGG WITH FILTER语法（提升大量count distinct场景性能）<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在某些场景下，可能需要从不同维度来统计UV，如Android中的UV，iPhone中的UV，Web中的UV和总UV，这时，可能会使用如下CASE WHEN语法。</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #aa0d91;line-height: 26px;">SELECT</span><br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">day</span>,<br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">COUNT</span>(<span style="color: #aa0d91;line-height: 26px;">DISTINCT</span>&nbsp;user_id)&nbsp;<span style="color: #aa0d91;line-height: 26px;">AS</span>&nbsp;total_uv,<br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">COUNT</span>(<span style="color: #aa0d91;line-height: 26px;">DISTINCT</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">CASE</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">WHEN</span>&nbsp;flag&nbsp;<span style="color: #aa0d91;line-height: 26px;">IN</span>&nbsp;(<span style="color: #c41a16;line-height: 26px;">'android'</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">'iphone'</span>)&nbsp;<span style="color: #aa0d91;line-height: 26px;">THEN</span>&nbsp;user_id&nbsp;<span style="color: #aa0d91;line-height: 26px;">ELSE</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">NULL</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">END</span>)&nbsp;<span style="color: #aa0d91;line-height: 26px;">AS</span>&nbsp;app_uv,<br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">COUNT</span>(<span style="color: #aa0d91;line-height: 26px;">DISTINCT</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">CASE</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">WHEN</span>&nbsp;flag&nbsp;<span style="color: #aa0d91;line-height: 26px;">IN</span>&nbsp;(<span style="color: #c41a16;line-height: 26px;">'wap'</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">'other'</span>)&nbsp;<span style="color: #aa0d91;line-height: 26px;">THEN</span>&nbsp;user_id&nbsp;<span style="color: #aa0d91;line-height: 26px;">ELSE</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">NULL</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">END</span>)&nbsp;<span style="color: #aa0d91;line-height: 26px;">AS</span>&nbsp;web_uv<br  /><span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;T<br  /><span style="color: #aa0d91;line-height: 26px;">GROUP</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">day</span><br  /><br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在这种情况下，建议使用FILTER语法, 目前的Flink SQL优化器可以识别同一唯一键上的不同FILTER参数。如，在上面的示例中，三个COUNT DISTINCT都作用在user_id列上。此时，经过优化器识别后，Flink可以只使用一个共享状态实例，而不是三个状态实例，可减少状态的大小和对状态的访问。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">将上边的CASE WHEN替换成FILTER后，如下所示:</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #aa0d91;line-height: 26px;">SELECT</span><br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">day</span>,<br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">COUNT</span>(<span style="color: #aa0d91;line-height: 26px;">DISTINCT</span>&nbsp;user_id)&nbsp;<span style="color: #aa0d91;line-height: 26px;">AS</span>&nbsp;total_uv,<br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">COUNT</span>(<span style="color: #aa0d91;line-height: 26px;">DISTINCT</span>&nbsp;user_id)&nbsp;FILTER&nbsp;(<span style="color: #aa0d91;line-height: 26px;">WHERE</span>&nbsp;flag&nbsp;<span style="color: #aa0d91;line-height: 26px;">IN</span>&nbsp;(<span style="color: #c41a16;line-height: 26px;">'android'</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">'iphone'</span>))&nbsp;<span style="color: #aa0d91;line-height: 26px;">AS</span>&nbsp;app_uv,<br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">COUNT</span>(<span style="color: #aa0d91;line-height: 26px;">DISTINCT</span>&nbsp;user_id)&nbsp;FILTER&nbsp;(<span style="color: #aa0d91;line-height: 26px;">WHERE</span>&nbsp;flag&nbsp;<span style="color: #aa0d91;line-height: 26px;">IN</span>&nbsp;(<span style="color: #c41a16;line-height: 26px;">'wap'</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">'other'</span>))&nbsp;<span style="color: #aa0d91;line-height: 26px;">AS</span>&nbsp;web_uv<br  /><span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;T<br  /><span style="color: #aa0d91;line-height: 26px;">GROUP</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">day</span><br  /><br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>5.2 TopN优化<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">当TopN的输入是非更新流（例如Source），TopN只有一种算法AppendRank。当TopN的输入是更新流时（例如经过了AGG/JOIN计算），TopN有2种算法，性能从高到低分别是：UpdateFastRank 和RetractRank。算法名字会显示在拓扑图的节点名字上。</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009674" data-ratio="0.3076923076923077" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6xHDns8dFn0c2HDzicia3Pic9lw532Xuqh1bG22ibqmKNWYPDLUFicVKLRbQ/640?wx_fmt=png" data-type="png" data-w="585" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">注意：apache社区版的Flink1.12目前还没有UnaryUpdateRank，阿里云实时计算版Flink才有</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009677" data-ratio="0.47342026078234706" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6GZB1CBfeT555kWujpmLibS50d1UauxAnM0D8Jw0gdF5ydN9q2YPMzYQ/640?wx_fmt=png" data-type="png" data-w="997" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009675" data-ratio="0.18629173989455183" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6R1LKpkrumMRkeiab1t2UkicOjYSoVw2JbvfJeqX8Qh6maFeukibGYD0TA/640?wx_fmt=png" data-type="png" data-w="569" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><strong style="color: black;">UpdateFastRank</strong> <strong style="color: black;">：最优算法</strong></section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">需要具备2个条件：</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">1）输入流有PK（Primary Key）信息，例如ORDER BY AVG。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">2）排序字段的更新是单调的，且单调方向与排序方向相反。例如，ORDER BY COUNT/COUNT_DISTINCT/SUM（正数）DESC。</p><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">如果要获取到优化Plan，则您需要在使用ORDER BY SUM DESC时，添加SUM为正数的过滤条件。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">AppendFast：结果只追加，不更新</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">RetractRank：普通算法，性能差</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">不建议在生产环境使用该算法。请检查输入流是否存在PK信息，如果存在，则可进行UpdateFastRank优化。</section></li></ul><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>5.2.2 无排名优化（解决数据膨胀问题）<span style="display: none;"></span></h4><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">TopN语法</section></li></ul><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #aa0d91;line-height: 26px;">SELECT</span>&nbsp;*<br  /><span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;(<br  /><span style="color: #aa0d91;line-height: 26px;">SELECT</span>&nbsp;*,<br  />&nbsp;&nbsp;&nbsp;ROW_NUMBER()&nbsp;<span style="color: #aa0d91;line-height: 26px;">OVER</span>&nbsp;([<span style="color: #aa0d91;line-height: 26px;">PARTITION</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;col1[,&nbsp;col2..]]<br  />&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">ORDER</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;col1&nbsp;[<span style="color: #aa0d91;line-height: 26px;">asc</span>|<span style="color: #aa0d91;line-height: 26px;">desc</span>][,&nbsp;col2&nbsp;[<span style="color: #aa0d91;line-height: 26px;">asc</span>|<span style="color: #aa0d91;line-height: 26px;">desc</span>]...])&nbsp;<span style="color: #aa0d91;line-height: 26px;">AS</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">rownum</span><br  /><span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;table_name)<br  /><span style="color: #aa0d91;line-height: 26px;">WHERE</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">rownum</span>&nbsp;&lt;=&nbsp;N&nbsp;[<span style="color: #aa0d91;line-height: 26px;">AND</span>&nbsp;conditions]<br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">数据膨胀问题</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">根据TopN的语法，rownum字段会作为结果表的主键字段之一写入结果表。但是这可能导致数据膨胀的问题。例如，收到一条原排名9的更新数据，更新后排名上升到1，则从1到9的数据排名都发生变化了，需要将这些数据作为更新都写入结果表。这样就产生了数据膨胀，导致结果表因为收到了太多的数据而降低更新速度。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">使用方式</section></li></ul><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">TopN的输出结果无需要显示rownum值，仅需在最终前端显式时进行1次排序，极大地减少输入结果表的数据量。只需要在外层查询中将rownum字段裁剪掉即可</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">//&nbsp;最外层的字段，不写&nbsp;rownum<br  /><span style="color: #aa0d91;line-height: 26px;">SELECT</span>&nbsp;col1,&nbsp;col2,&nbsp;col3<br  /><span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;(<br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">SELECT</span>&nbsp;col1,&nbsp;col2,&nbsp;col3<br  />&nbsp;&nbsp;&nbsp;ROW_NUMBER()&nbsp;<span style="color: #aa0d91;line-height: 26px;">OVER</span>&nbsp;([<span style="color: #aa0d91;line-height: 26px;">PARTITION</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;col1[,&nbsp;col2..]]<br  />&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">ORDER</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;col1&nbsp;[<span style="color: #aa0d91;line-height: 26px;">asc</span>|<span style="color: #aa0d91;line-height: 26px;">desc</span>][,&nbsp;col2&nbsp;[<span style="color: #aa0d91;line-height: 26px;">asc</span>|<span style="color: #aa0d91;line-height: 26px;">desc</span>]...])&nbsp;<span style="color: #aa0d91;line-height: 26px;">AS</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">rownum</span><br  />&nbsp;<span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;table_name)<br  /><span style="color: #aa0d91;line-height: 26px;">WHERE</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">rownum</span>&nbsp;&lt;=&nbsp;N&nbsp;[<span style="color: #aa0d91;line-height: 26px;">AND</span>&nbsp;conditions]<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">在无rownum的场景中，对于结果表主键的定义需要特别小心。如果定义有误，会直接导致TopN结果的不正确。无rownum场景中，主键应为TopN上游GROUP BY节点的KEY列表。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>5.2.3 增加TopN的Cache大小<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">TopN为了提升性能有一个State Cache层，Cache层能提升对State的访问效率。TopN的Cache命中率的计算公式为。</p><blockquote data-tool="mdnice编辑器" style="border-top: none;border-bottom: none;font-size: 0.9em;overflow: auto;color: rgb(106, 115, 125);padding: 10px 10px 10px 20px;margin-bottom: 20px;margin-top: 20px;border-left-color: rgba(0, 0, 0, 0.65);border-right: 1px solid rgba(0, 0, 0, 0.65);background: rgb(249, 249, 249);"><p style="padding-top: 8px;padding-bottom: 8px;font-size: 14px;color: black;line-height: 26px;">cache_hit = cache_size*parallelism/top_n/partition_key_num</p></blockquote><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">例如，Top100配置缓存10000条，并发50，当PatitionBy的key维度较大时，例如10万级别时，Cache命中率只有10000*50/100/100000=5%，命中率会很低，导致大量的请求都会击中State（磁盘），性能会大幅下降。因此当PartitionKey维度特别大时，可以适当加大TopN的CacheS ize，相对应的也建议适当加大TopN节点的Heap Memory。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;list-style-type: square;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">使用方式</section></li></ul><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #007400;line-height: 26px;">//&nbsp;初始化table&nbsp;environment</span><br  />TableEnvironment&nbsp;tEnv&nbsp;=&nbsp;...<br  /><span style="color: #007400;line-height: 26px;">//&nbsp;获取&nbsp;tableEnv的配置对象</span><br  />Configuration&nbsp;configuration&nbsp;=&nbsp;tEnv.getConfig().getConfiguration();<br  /><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;设置参数：</span><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;默认10000条，调整TopN&nbsp;cahce到20万，那么理论命中率能达200000*50/100/100000&nbsp;=&nbsp;100%</span><br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.exec.topn.cache-size"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"200000"</span>);<br  /><br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">注意：目前源码中标记为实验项，官网中未列出该参数</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img data-fileid="100009676" data-ratio="0.19702276707530647" src="https://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBfmMF1GHmZ4TnUKutsicR3S6LTt8EzEUJ2f10CYcmE9Ec5gpPbZkwalXAiaxHFReK7sT0sBRC3JQDSg/640?wx_fmt=png" data-type="png" data-w="1142" style="display: block;margin-right: auto;margin-left: auto;box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;"  /></figure><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>5.2.4 PartitionBy的字段中要有时间类字段<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">例如每天的排名，要带上Day字段。否则TopN的结果到最后会由于State ttl有错乱。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>5.2.5 优化后的SQL示例<span style="display: none;"></span></h4><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #aa0d91;line-height: 26px;">insert</span><br  />&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">into</span>&nbsp;print_test<br  /><span style="color: #aa0d91;line-height: 26px;">SELECT</span><br  />&nbsp;&nbsp;cate_id,<br  />&nbsp;&nbsp;seller_id,<br  />&nbsp;&nbsp;stat_date,<br  />&nbsp;&nbsp;pay_ord_amt&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">--不输出rownum字段，能减小结果表的输出量（无排名优化）</span><br  /><span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">SELECT</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROW_NUMBER&nbsp;()&nbsp;<span style="color: #aa0d91;line-height: 26px;">OVER</span>&nbsp;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">PARTITION</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;cate_id,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat_date&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">--注意要有时间字段，否则state过期会导致数据错乱（分区字段优化）</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">ORDER</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;pay_ord_amt&nbsp;<span style="color: #aa0d91;line-height: 26px;">DESC</span>&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">--根据上游sum结果排序。排序字段的更新是单调的，且单调方向与排序方向相反（走最优算法）</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span style="color: #aa0d91;line-height: 26px;">as</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">rownum</span>&nbsp;&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">SELECT</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cate_id,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seller_id,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat_date,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #007400;line-height: 26px;">--重点。声明Sum的参数都是正数，所以Sum的结果是单调递增的，因此TopN能使用优化算法，只获取前100个数据（走最优算法）</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">sum</span>&nbsp;(total_fee)&nbsp;filter&nbsp;(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">where</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total_fee&nbsp;&gt;=&nbsp;<span style="color: #1c00cf;line-height: 26px;">0</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span style="color: #aa0d91;line-height: 26px;">as</span>&nbsp;pay_ord_amt<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">FROM</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;random_test<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">WHERE</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total_fee&nbsp;&gt;=&nbsp;<span style="color: #1c00cf;line-height: 26px;">0</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">GROUP</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;cate_name,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seller_id,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stat_date<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;a<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">WHERE</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">rownum</span>&nbsp;&lt;=&nbsp;<span style="color: #1c00cf;line-height: 26px;">100</span><br  />&nbsp;&nbsp;);<br  /><br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>5.3 高效去重方案<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">由于SQL上没有直接支持去重的语法，还要灵活的保留第一条或保留最后一条。因此我们使用了SQL的ROW_NUMBER OVER WINDOW功能来实现去重语法。去重本质上是一种特殊的TopN。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>5.3.1 保留首行的去重策略<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">保留KEY下第一条出现的数据，之后出现该KEY下的数据会被丢弃掉。因为STATE中只存储了KEY数据，所以性能较优，示例如下：</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #aa0d91;line-height: 26px;">SELECT</span>&nbsp;*<br  /><span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;(<br  />&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">SELECT</span>&nbsp;*,<br  />&nbsp;&nbsp;&nbsp;&nbsp;ROW_NUMBER()&nbsp;<span style="color: #aa0d91;line-height: 26px;">OVER</span>&nbsp;(<span style="color: #aa0d91;line-height: 26px;">PARTITION</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;b&nbsp;<span style="color: #aa0d91;line-height: 26px;">ORDER</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;proctime)&nbsp;<span style="color: #aa0d91;line-height: 26px;">as</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">rowNum</span><br  />&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;T<br  />)<br  /><span style="color: #aa0d91;line-height: 26px;">WHERE</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">rowNum</span>&nbsp;=&nbsp;<span style="color: #1c00cf;line-height: 26px;">1</span><br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">以上示例是将T表按照b字段进行去重，并按照系统时间保留第一条数据。Proctime在这里是源表T中的一个具有Processing Time属性的字段。如果按照系统时间去重，也可以将Proctime字段简化PROCTIME()函数调用，可以省略Proctime字段的声明。</p><h4 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;font-size: 18px;"><span style="display: none;"></span>5.3.2 保留末行的去重策略<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">保留KEY下最后一条出现的数据。保留末行的去重策略性能略优于LAST_VALUE函数，示例如下：</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #aa0d91;line-height: 26px;">SELECT</span>&nbsp;*<br  /><span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;(<br  />&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">SELECT</span>&nbsp;*,<br  />&nbsp;&nbsp;&nbsp;&nbsp;ROW_NUMBER()&nbsp;<span style="color: #aa0d91;line-height: 26px;">OVER</span>&nbsp;(<span style="color: #aa0d91;line-height: 26px;">PARTITION</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;b,&nbsp;d&nbsp;<span style="color: #aa0d91;line-height: 26px;">ORDER</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">BY</span>&nbsp;rowtime&nbsp;<span style="color: #aa0d91;line-height: 26px;">DESC</span>)&nbsp;<span style="color: #aa0d91;line-height: 26px;">as</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">rowNum</span><br  />&nbsp;&nbsp;<span style="color: #aa0d91;line-height: 26px;">FROM</span>&nbsp;T<br  />)<br  /><span style="color: #aa0d91;line-height: 26px;">WHERE</span>&nbsp;<span style="color: #aa0d91;line-height: 26px;">rowNum</span>&nbsp;=&nbsp;<span style="color: #1c00cf;line-height: 26px;">1</span><br  /><br  /></code></pre><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">以上示例是将T表按照b和d字段进行去重，并按照业务时间保留最后一条数据。Rowtime在这里是源表T中的一个具有Event Time属性的字段。</p><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>5.4 指定时区<span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-top: 8px;padding-bottom: 8px;line-height: 26px;">本地时区定义了当前会话时区id。当本地时区的时间戳进行转换时使用。在内部，带有本地时区的时间戳总是以UTC时区表示。但是，当转换为不包含时区的数据类型时(例如TIMESTAMP, TIME或简单的STRING)，会话时区在转换期间被使用。为了避免时区错乱的问题，可以参数指定时区。</p><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;"><span style="color: #007400;line-height: 26px;">//&nbsp;初始化table&nbsp;environment</span><br  />TableEnvironment&nbsp;tEnv&nbsp;=&nbsp;...<br  /><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;获取&nbsp;tableEnv的配置对象</span><br  />Configuration&nbsp;configuration&nbsp;=&nbsp;tEnv.getConfig().getConfiguration();<br  /><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;设置参数：</span><br  /><span style="color: #007400;line-height: 26px;">//&nbsp;指定时区</span><br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.local-time-zone"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"Asia/Shanghai"</span>);<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;font-weight: bold;background-color: #000;color: #fff;padding: 2px 10px;width: fit-content;font-size: 17px;margin: 60px auto 10px;"><span style="display: none;"></span>5.5 设置参数总结<span style="display: none;"></span></h3><pre data-tool="mdnice编辑器" style="box-shadow: rgba(170, 170, 170, 0.48) 0px 0px 6px 0px;border-radius: 4px;margin-top: 10px;margin-right: auto;margin-left: auto;"><span style="display: block;background: url(&quot;https://mmbiz.qpic.cn/mmbiz_svg/YCOL3hU8ffWEPhzf8x8tDk8OhmBTKozd2JgzGwJXWLlWfSOPB7ApRg4vs5iaIRTpIEfUpiaT3TbhMGPWXeV9EOyRgwVMRUibrP2/640?wx_fmt=svg&quot;) 10px 10px / 40px no-repeat rgb(255, 255, 255);height: 30px;width: 100%;margin-bottom: -7px;border-radius: 5px;"></span><code style="overflow-x: auto;padding: 15px 16px 16px;display: -webkit-box;font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;font-size: 12px;background: rgb(255, 255, 255);border-radius: 5px;">//&nbsp;初始化table&nbsp;environment<br  />TableEnvironment&nbsp;tEnv&nbsp;=&nbsp;...<br  /><br  />//&nbsp;获取&nbsp;tableEnv的配置对象<br  />Configuration&nbsp;configuration&nbsp;=&nbsp;tEnv.getConfig().getConfiguration();<br  /><br  />//&nbsp;设置参数：<br  />//&nbsp;开启miniBatch<br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.exec.mini-batch.enabled"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"true"</span>);<br  />//&nbsp;批量输出的间隔时间<br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.exec.mini-batch.allow-latency"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"5&nbsp;s"</span>);<br  />//&nbsp;防止OOM设置每个批次最多缓存数据的条数，可以设为2万条<br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.exec.mini-batch.size"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"20000"</span>);<br  />//&nbsp;开启LocalGlobal<br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.optimizer.agg-phase-strategy"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"TWO_PHASE"</span>);<br  />//&nbsp;开启Split&nbsp;Distinct<br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.optimizer.distinct-agg.split.enabled"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"true"</span>);<br  />//&nbsp;第一层打散的bucket数目<br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.optimizer.distinct-agg.split.bucket-num"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"1024"</span>);<br  />//&nbsp;TopN&nbsp;的缓存条数<br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.exec.topn.cache-size"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"200000"</span>);<br  />//&nbsp;指定时区<br  />configuration.setString(<span style="color: #c41a16;line-height: 26px;">"table.local-time-zone"</span>,&nbsp;<span style="color: #c41a16;line-height: 26px;">"Asia/Shanghai"</span>);<br  /></code></pre><br  /><section data-mid="" mpa-from-tpl="t" style="outline: 0px;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 14px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);width: 621px;height: 3px;"><img data-fileid="100009719" data-ratio="0.008695652173913044" src="https://mmbiz.qpic.cn/mmbiz_png/3wAU40iaiaJzCyFgm72ooL4mPwJ21btH6vmMZOg53X0liaGke7muYswenwJmds5AcojKK3FIsW89dLNb1y4qJZdPQ/640?wx_fmt=png" data-type="png" data-w="690" style="outline: 0px;vertical-align: middle;border-style: none;display: block;box-sizing: border-box !important;width: 677px !important;visibility: visible !important;"  /></section><section data-mpa-template="t" mpa-from-tpl="t"><section style="display: flex;justify-content: center;align-items: center;width: 100%;padding: 0px 20px;" data-mid="" mpa-from-tpl="t"><section style="display: flex;justify-content: flex-start;align-items: center;flex-direction: column;width: 100%;" data-mid="" mpa-from-tpl="t"><section style="background: rgb(244, 244, 244);padding: 15px;border-width: 1px 0px;border-top-style: solid;border-bottom-style: solid;border-top-color: rgb(19, 20, 21);border-bottom-color: rgb(19, 20, 21);border-left-style: initial;border-left-color: initial;border-right-style: initial;border-right-color: initial;width: 100%;" data-mid="" mpa-from-tpl="t"><p style="font-size: 14px;font-family: PingFangSC-Regular, PingFang SC;color: #131415;line-height: 20px;" data-mid=""><span style="color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 14px;text-align: left;outline: 0px;background-color: rgb(249, 249, 249);">资源</span><span style="color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 14px;text-align: left;outline: 0px;background-color: rgb(249, 249, 249);">获</span><span style="color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 14px;text-align: left;outline: 0px;background-color: rgb(249, 249, 249);">取 获取Flink面试题，Spark面试题，程序员必备软件，hive面试题，Hadoop面试题，Docker面试题，简历模板等资源请去 GitHub自行下载 https://github.com/lhh2002/Framework-Of-BigData Gitee 自</span><span style="color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 14px;text-align: left;outline: 0px;background-color: rgb(249, 249, 249);">行下载 &nbsp;https://gitee.com/li_hey_hey/dashboard/projects</span><span style="font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;letter-spacing: 0px;outline: 0px;background-color: rgb(249, 249, 249);color: rgb(153, 153, 153);font-size: 15px;text-align: center;">&nbsp;</span></p></section><section style="width: 25px;height: 25px;align-self: flex-end;margin-right: 5px;margin-top: -25px;" data-mid="" mpa-from-tpl="t"><img data-fileid="100009718" data-ratio="1" src="https://mmbiz.qpic.cn/mmbiz_png/v2xdUItjMNib4HsBWcwjGcyN0r7lOW63yx70K2M5cangicNVdORFgCGa3dQIlicaWibIvlia0jBvsrougL2ViaLt8ngA/640?wx_fmt=png" data-type="png" data-w="50" style="display: block;"  /></section></section></section></section><center data-tool="mdnice编辑器" style="outline: 0px;letter-spacing: 0.544px;white-space: normal;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 16px;background-color: rgb(255, 255, 255);word-spacing: 2px;"><center data-tool="mdnice编辑器" style="outline: 0px;letter-spacing: 0.544px;"><span style="outline: 0px;color: rgb(255, 169, 0);letter-spacing: 0px;text-align: left;">大数据老哥</span></center><section class="mp_profile_iframe_wrp"><mpprofile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzA3MjQ1MTQzMQ==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/2UHIhrbfNBcaVkoNT9zIhLeABq1xb4p11Bn5NK0hMIvw60EX2vY5drumsb036H4W60O5rGpVlN5hzeVVicHODSQ/0?wx_fmt=png" data-nickname="大数据老哥" data-alias="" data-signature="欢迎来自CSDN、GitHub、哔哩哔哩等小伙伴。以自信、人际交往、情感为核心的学习成长的学习方法论。同时分享我的一些人生经验、学习成长方法。" data-from="0"></mpprofile></section></center><center data-tool="mdnice编辑器" style="outline: 0px;letter-spacing: 0.544px;white-space: normal;color: rgb(0, 0, 0);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 16px;background-color: rgb(255, 255, 255);word-spacing: 2px;"><center data-tool="mdnice编辑器" style="outline: 0px;letter-spacing: 0.544px;"><span style="outline: 0px;color: rgb(136, 136, 136);">希望这篇文章可以帮到你~<br style="outline: 0px;"  />记得点赞收藏哦</span></center><section data-mpa-template="t" data-from="yb-recommend-list"><section data-mpa-template="t" data-from="yb-recommend" data-recommend-article-type="normal" data-recomment-template-id="1" data-recommend-article-id="2247493262_1" data-recommend-article-time="1634860800" data-recommend-article-cover="http://mmbiz.qpic.cn/mmbiz_jpg/2UHIhrbfNBe1xVvxhmAQticwhhgP8JrS4OCkamfibz34Xeq51EgZBD8FrYyLrd1HdxiaGQwBOqic2J7H9nqjjXm2yA/0?wx_fmt=jpeg" data-recommend-article-title="企业级Hive SQL迁移Spark SQL" data-recommend-article-content-url="http://mp.weixin.qq.com/s?__biz=MzA3MjQ1MTQzMQ==&amp;mid=2247493262&amp;idx=1&amp;sn=e3a3a6474074eb296092afef5b529495&amp;chksm=9f1cb286a86b3b9020d1fce77fd6e5d92f8043725def7dff102eb43265594c33b0c3dfa8be5f#rd"><a href="http://mp.weixin.qq.com/s?__biz=MzA3MjQ1MTQzMQ==&amp;mid=2247493262&amp;idx=1&amp;sn=e3a3a6474074eb296092afef5b529495&amp;chksm=9f1cb286a86b3b9020d1fce77fd6e5d92f8043725def7dff102eb43265594c33b0c3dfa8be5f&amp;scene=21#wechat_redirect" data-linktype="1"><section data-recommend-type="normal" data-recommend-tid="1" style="width: 100%;display: flex;justify-content: center;align-items: center;" data-mid=""><section style="width: 100%;background: #ffffff;display: flex;justify-content: flex-start;align-items: center;flex-direction: column;" data-mid=""><section style="width: 100%;display: flex;justify-content: center;align-items: center;" data-mid=""><span class="js_jump_icon h5_image_link" data-positionback="static" style="inset: auto;margin: 0px;"><img data-fileid="100009723" data-ratio="0.42592592592592593" src="https://mmbiz.qpic.cn/mmbiz_jpg/2UHIhrbfNBe1xVvxhmAQticwhhgP8JrS4OCkamfibz34Xeq51EgZBD8FrYyLrd1HdxiaGQwBOqic2J7H9nqjjXm2yA/640?wx_fmt=jpeg" data-type="jpeg" data-w="1080" style="width: 100%;max-height: 160px;object-fit: cover;margin: 0px;"  /></span></section><section style="width: 100%;padding: 9px 7px 8px;background: rgba(0, 0, 0, 0.65);font-size: 13px;font-weight: 400;color: #ffffff;line-height: 18px;margin-top: -35px;z-index: 20;" data-mid=""><p data-recommend-title="t" data-mid="">企业级Hive SQL迁移Spark SQL</p></section></section></section></a></section><br  /><section data-mpa-template="t" data-from="yb-recommend" data-recommend-article-type="normal" data-recomment-template-id="1" data-recommend-article-id="2247493209_1" data-recommend-article-time="1634688000" data-recommend-article-cover="http://mmbiz.qpic.cn/mmbiz_jpg/2UHIhrbfNBcRly9da86vsGOD5uBvBlicUVknUrKPmWJqiaobX0DGcCvGibxPgibDNjOa5UEZmwnFk1qKia7eQ42hnBA/0?wx_fmt=jpeg" data-recommend-article-title="实时离线一体化技术架构(万字，15张图）" data-recommend-article-content-url="http://mp.weixin.qq.com/s?__biz=MzA3MjQ1MTQzMQ==&amp;mid=2247493209&amp;idx=1&amp;sn=c1aa31f396385d14e400aee424ce434f&amp;chksm=9f1cb251a86b3b47c03ed2e7b17d9f3fa79f0c8a7180e6f56a2e53af03ed930083def1539469#rd"><a href="http://mp.weixin.qq.com/s?__biz=MzA3MjQ1MTQzMQ==&amp;mid=2247493209&amp;idx=1&amp;sn=c1aa31f396385d14e400aee424ce434f&amp;chksm=9f1cb251a86b3b47c03ed2e7b17d9f3fa79f0c8a7180e6f56a2e53af03ed930083def1539469&amp;scene=21#wechat_redirect" data-linktype="1"><section data-recommend-type="normal" data-recommend-tid="1" style="width: 100%;display: flex;justify-content: center;align-items: center;" data-mid=""><section style="width: 100%;background: #ffffff;display: flex;justify-content: flex-start;align-items: center;flex-direction: column;" data-mid=""><section style="width: 100%;display: flex;justify-content: center;align-items: center;" data-mid=""><span class="js_jump_icon h5_image_link" data-positionback="static" style="inset: auto;margin: 0px;"><img data-fileid="100009722" data-ratio="0.42525533890436396" src="https://mmbiz.qpic.cn/mmbiz_jpg/2UHIhrbfNBcRly9da86vsGOD5uBvBlicUVknUrKPmWJqiaobX0DGcCvGibxPgibDNjOa5UEZmwnFk1qKia7eQ42hnBA/640?wx_fmt=jpeg" data-type="jpeg" data-w="1077" style="width: 100%;max-height: 160px;object-fit: cover;margin: 0px;"  /></span></section><section style="width: 100%;padding: 9px 7px 8px;background: rgba(0, 0, 0, 0.65);font-size: 13px;font-weight: 400;color: #ffffff;line-height: 18px;margin-top: -35px;z-index: 20;" data-mid=""><p data-recommend-title="t" data-mid="">实时离线一体化技术架构(万字，15张图）</p></section></section></section></a></section><br  /><section data-mpa-template="t" data-from="yb-recommend" data-recommend-article-type="normal" data-recomment-template-id="1" data-recommend-article-id="2247493164_1" data-recommend-article-time="1634554800" data-recommend-article-cover="http://mmbiz.qpic.cn/mmbiz_jpg/2UHIhrbfNBd1wTYSEmoicL8MFUnicqFk5MQkpHo8SEL8FJ2xcqMsWHWpialG5nauicGF5sdQNkXstKsHovITpO7Bjg/0?wx_fmt=jpeg" data-recommend-article-title="Hbase、Kudu 和 ClickHouse 全面对比（万字、16张图）" data-recommend-article-content-url="http://mp.weixin.qq.com/s?__biz=MzA3MjQ1MTQzMQ==&amp;mid=2247493164&amp;idx=1&amp;sn=275854e762107f22fbd504cabaee0040&amp;chksm=9f1cb224a86b3b32ec19c7370af2056224ee00844cdcb53dc5312ab9a166fdf6b98e0543dacf#rd"><a href="http://mp.weixin.qq.com/s?__biz=MzA3MjQ1MTQzMQ==&amp;mid=2247493164&amp;idx=1&amp;sn=275854e762107f22fbd504cabaee0040&amp;chksm=9f1cb224a86b3b32ec19c7370af2056224ee00844cdcb53dc5312ab9a166fdf6b98e0543dacf&amp;scene=21#wechat_redirect" data-linktype="1"><section data-recommend-type="normal" data-recommend-tid="1" style="width: 100%;display: flex;justify-content: center;align-items: center;" data-mid=""><section style="width: 100%;background: #ffffff;display: flex;justify-content: flex-start;align-items: center;flex-direction: column;" data-mid=""><section style="width: 100%;display: flex;justify-content: center;align-items: center;" data-mid=""><span class="js_jump_icon h5_image_link" data-positionback="static" style="inset: auto;margin: 0px;"><img class="rich_pages wxw-img" data-fileid="100009721" data-ratio="0.4243369734789392" src="https://mmbiz.qpic.cn/mmbiz_jpg/2UHIhrbfNBd1wTYSEmoicL8MFUnicqFk5MQkpHo8SEL8FJ2xcqMsWHWpialG5nauicGF5sdQNkXstKsHovITpO7Bjg/640?wx_fmt=jpeg" data-type="jpeg" data-w="641" style="width: 100%;max-height: 160px;object-fit: cover;margin: 0px;"  /></span></section><section style="width: 100%;padding: 9px 7px 8px;background: rgba(0, 0, 0, 0.65);font-size: 13px;font-weight: 400;color: #ffffff;line-height: 18px;margin-top: -35px;z-index: 20;" data-mid=""><p data-recommend-title="t" data-mid="">Hbase、Kudu 和 ClickHouse 全面对比（万字、16张图）</p></section></section></section></a></section><br  /></section><center data-tool="mdnice编辑器" style="outline: 0px;letter-spacing: 0.544px;text-align: right;"><span style="outline: 0px;font-style: italic;font-weight: 700;letter-spacing: 0.544px;widows: 1;word-spacing: 2px;caret-color: rgb(255, 0, 0);text-indent: 29.3333px;font-family: 微软雅黑;font-size: 15px;text-align: left;color: rgb(63, 74, 89);">🧐</span><span style="outline: 0px;font-style: italic;font-weight: 700;letter-spacing: 0.544px;widows: 1;word-spacing: 2px;caret-color: rgb(255, 0, 0);text-indent: 29.3333px;font-family: 微软雅黑;font-size: 15px;text-align: left;color: rgb(0, 128, 255);"><span style="outline: 0px;font-weight: bolder;">分享</span></span><span style="outline: 0px;font-style: italic;font-weight: 700;letter-spacing: 0.544px;widows: 1;word-spacing: 2px;caret-color: rgb(255, 0, 0);text-indent: 29.3333px;font-family: 微软雅黑;font-size: 15px;text-align: left;color: rgb(63, 74, 89);"><span style="outline: 0px;font-weight: bolder;">、</span></span><span style="outline: 0px;font-style: italic;font-weight: 700;letter-spacing: 0.544px;widows: 1;word-spacing: 2px;caret-color: rgb(255, 0, 0);text-indent: 29.3333px;font-family: 微软雅黑;font-size: 15px;text-align: left;color: rgb(255, 79, 121);"><span style="outline: 0px;font-weight: bolder;">点赞</span></span><span style="outline: 0px;font-style: italic;font-weight: 700;letter-spacing: 0.544px;widows: 1;word-spacing: 2px;caret-color: rgb(255, 0, 0);text-indent: 29.3333px;font-family: 微软雅黑;font-size: 15px;text-align: left;color: rgb(63, 74, 89);"><span style="outline: 0px;font-weight: bolder;">、</span></span><span style="outline: 0px;font-style: italic;font-weight: 700;letter-spacing: 0.544px;widows: 1;word-spacing: 2px;caret-color: rgb(255, 0, 0);text-indent: 29.3333px;font-family: 微软雅黑;font-size: 15px;text-align: left;color: rgb(255, 104, 39);"><span style="outline: 0px;font-weight: bolder;">在看</span></span><span style="outline: 0px;font-style: italic;font-weight: 700;letter-spacing: 0.544px;widows: 1;word-spacing: 2px;caret-color: rgb(255, 0, 0);text-indent: 29.3333px;font-family: 微软雅黑;font-size: 15px;text-align: left;color: rgb(63, 74, 89);">，给个</span><span style="outline: 0px;font-style: italic;font-weight: 700;letter-spacing: 0.544px;widows: 1;word-spacing: 2px;caret-color: rgb(255, 0, 0);text-indent: 29.3333px;font-family: 微软雅黑;font-size: 15px;text-align: left;color: rgb(122, 79, 214);"><span style="outline: 0px;font-weight: bolder;">3连击</span></span><span style="outline: 0px;font-style: italic;font-weight: 700;letter-spacing: 0.544px;widows: 1;word-spacing: 2px;caret-color: rgb(255, 0, 0);text-indent: 29.3333px;font-family: 微软雅黑;font-size: 15px;text-align: left;color: rgb(63, 74, 89);">呗！<span style="outline: 0px;font-weight: bolder;letter-spacing: 0.544px;">👇</span></span><span style="outline: 0px;color: rgb(136, 136, 136);"></span><br  /></center></center></section></section><div class="msg_source_url"><a href="https://mp.weixin.qq.com/s?__biz=MzA3NjIzNjMwOA==&mid=2247484607&idx=1&sn=c87219f0266c9f3700af3da5aa3db025&chksm=9f6517c4a8129ed22a0b46c50e627346d99e4ec1cf26d8db70205954de4beb81115e9e330487&token=162392568&lang=zh_CN#rd" target="_blank">阅读原文</a></div></content><div class="msg_source_url"><a href="https://mp.weixin.qq.com/s?__biz=MzA3NjIzNjMwOA==&mid=2247484607&idx=1&sn=c87219f0266c9f3700af3da5aa3db025&chksm=9f6517c4a8129ed22a0b46c50e627346d99e4ec1cf26d8db70205954de4beb81115e9e330487&token=162392568&lang=zh_CN#rd" target="_blank">阅读原文</a></div>
</div>
</body>
</html>