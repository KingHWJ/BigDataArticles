<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 0 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic{color:#8e8e8e;background:#f7f7f7;border-radius:5px;padding:10px 8px;}.topic a{padding-right:5px;}.topic p{margin-bottom:5px;}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head><script>
var data={"mp":"大数据技术与架构","title":"数据仓库实践-拉链表设计","time":"2021-12-18 10:03:12","timeStamp":"1639792992"};
</script>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&mid=2247508964&idx=3&sn=c99c3b92a1eb685930c24958b3410164&chksm=fd3ee571ca496c674232812d77723dd91262a8bd5442e61e6948a8f7150d8d0e3491b7c27874#rd" target="_blank">数据仓库实践-拉链表设计</a></h1><div id="meta_content" class="rich_media_meta_list"><span class="rich_media_meta rich_media_meta_text">otw&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">大数据技术与架构&nbsp;&nbsp;</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-12-18 10:03:12</em></div><content><div class="reprint"><p>转自公众号：数仓与大数据<br><a href="http://mp.weixin.qq.com/s?__biz=Mzg4NTI1MjkxOA==&mid=2247483687&idx=1&sn=3d018030de8f22622f79570c606528f4" target="_blank" title="阅读原文">http://mp.weixin.qq.com/s?__biz=Mzg4NTI1MjkxOA==&mid=2247483687&idx=1&sn=3d018030de8f22622f79570c606528f4</a></p></div><section class="mp_profile_iframe_wrp" data-mpa-powered-by="yiban.io"><mpprofile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzU3MzgwNTU2Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MrfCUBgMwsXeyxKKIxY5GNfl3g0zm1ibib46XO7tlIEs8ncmlp3Zzq8JJs0ibLbHdL4AWox8hSUIMDw/0?wx_fmt=png" data-nickname="大数据技术与架构" data-alias="import_bigdata" data-signature="大数据开发、大数据面试、大数据框架、大数据实时计算、大数据离线计算Flink/Spark/Hadoop/数仓开发，干货，面试，资料下载，源码解读等" data-from="0"></mpprofile></section><p data-lake-id="u52d70e65" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><h2 data-lake-id="JeCKb" data-wording="true" style="padding-top: 7px;padding-bottom: 7px;font-weight: 700;font-size: 24px;line-height: 32px;">1 写在开头的话</h2><p data-lake-id="u7b6540b6" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><p data-lake-id="u97eab5d7" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">拉链表，学名叫缓慢变化维（<span style="color: rgb(51, 51, 51);font-size: 13px;" data-mce-style="font-size: 10px">Slowly Changing Dimensions</span>），简称渐变维（SCD），俗称拉链表，是为了记录关键字段的历史变化而设计出来的一种数据存储模型，常见于维度表设计，在数据仓库相关的面试中，也经常有被问到。但是在工程实践中，拉链表真是太麻烦了，而且是在模型设计、初始化、ETL 开发、运维、日常取数等各个环节都很麻烦，而麻烦的设计通常都容易出错，或者对团队成员能力要求高些。</p><p data-lake-id="uaa1b8c63" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><p data-lake-id="u25381b27" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">使用拉链表，需要考虑的问题很多，我先简单列几个，大家可以先思考下，真的必须用拉链表吗？</p><p data-lake-id="ubb637e72" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><ol lake-indent="0" style="padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>新建的拉链表，历史数据要不要补充；</p></li><li><p>新建的拉链表，主键怎么设置，需要引入代理键吗；</p></li><li><p>构建好的拉链表，更新的时候只能逐天往后计算，中间有一天计算错误，后续的都得重刷；</p></li><li><p>运维的时候，更新的时候如果部分数据 update 错误，如何更正？</p></li><li><p>关系型数据库还好可以 update，那大数据环境下呢，如何处理增量数据？</p></li><li><p>使用的时候，什么时候取最新快照，什么时候取历史某一时刻的数据？</p></li><li><p>使用的时候，事实表关联拉链表，join 该怎么写，会不会写错？</p></li></ol><h2 data-lake-id="kBGiQ" style="padding-top: 7px;padding-bottom: 7px;font-weight: 700;font-size: 24px;line-height: 32px;"><br  /></h2><h2 data-lake-id="hbZeX" data-wording="true" style="padding-top: 7px;padding-bottom: 7px;font-weight: 700;font-size: 24px;line-height: 32px;">2 先分享一篇类似的文章</h2><p data-lake-id="ud338efd4" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><p data-lake-id="ub39cbf6f" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">漫谈数据仓库之拉链表（原理、设计以及在Hive中的实现）</p><p data-lake-id="ub39cbf6f" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">https://blog.csdn.net/zhaodedong/article/details/54177686</p><p data-lake-id="uf54b6fee" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><p data-lake-id="u2c168162" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">上边是木东居士在前些年分享在 CSDN 的一篇文章，目前已有 3.9 万浏览。写的非常棒，思路清晰、简单易懂，也是是网络上流传的常规拉链表设计思路。</p><p data-lake-id="u54688369" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><h2 data-lake-id="rtGCw" data-wording="true" style="padding-top: 7px;padding-bottom: 7px;font-weight: 700;font-size: 24px;line-height: 32px;">3 对于变化数据的处理方案</h2><p data-lake-id="u7564a35f" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><p data-lake-id="ue3e3147f" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">我们常说，数据模型设计一定要切合实际业务需求。对于变化数据的处理，<span style="letter-spacing: 0.05em;">常见需求有以下三种</span><span style="letter-spacing: 0.05em;">：</span></p><p data-lake-id="u5042fb92" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><p data-lake-id="u3ce66d4e" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><span style="color: #F5222D;">需求一：保护第一个值</span></p><p data-lake-id="u0ff9bffe" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">在广告投放的业务场景中，有个很重要的概念叫广告归因，这就是一个典型的必须保护第一个值的案例。就是说一个安装归属到渠道 1 后，就应该永远绑定在该渠道上。</p><p data-lake-id="u04fcca6e" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">该需求实现最简单，只需要追加新数据就好了。</p><p data-lake-id="uaf86c8e8" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><span style="color: #F5222D;">需求二：保留最新值</span></p><p data-lake-id="u03161efa" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">当我们不需要记录历史变化的时候，就可以只保留最新值。比如用户修改了出生日期，有可能之前给的是系统默认值。</p><p data-lake-id="ucab41ac4" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">该需求处理会稍微复杂，需要 update 用户维表，同时如果有对于用户年龄相关的分析，还要重刷相关的事实表数据。</p><p data-lake-id="u02178dda" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><span style="color: #F5222D;">需求三：记录历史变化</span></p><p data-lake-id="u2bb04f58" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">我们需要回溯主体历史某一时点的状态的时候，就必须记录历史变化了。比如某一天，某业务员转岗了，那么部门业绩月度汇总的时候，就需要知道该业务员过去在哪些部门待过以及起始日期。</p><p data-lake-id="u4620c302" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><p data-lake-id="u93a5b94d" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><span style="color: #F5222D;">需求三处理起来比较麻烦，方案如下</span>：</p><p data-lake-id="ud79a1ebd" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><ul lake-indent="0" style="padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>方案一：每天记录一份快照，快照在木东居士文章里称为切片。</p></li><li><p>方案二：增加新的列，比如只需要存最近 3 次变化，那么我们新增三列就好了。</p></li><li><p>方案三：增加新的行，核心属性变化一次，新增一条，同时新增 2 列（数据开始日期、数据截止日期）。</p></li></ul><p data-lake-id="uf3c88689" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><p data-lake-id="u73df3824" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><span style="color: #F5222D;">方案一</span>：</p><p data-lake-id="u21f02ba2" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">好处是写入和查询特别方便。但如果数据量巨大，数仓场景，您至少得存三年吧，由此带来存储、计算成本，都将是非常巨大的。</p><p data-lake-id="u2f894ce4" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">互联网时代的快餐模式，大家都没时间建模了，同时主流大数据数仓组件基本不支持 Update ，或者目前的存储还吃的消，又或者数据量没那么大，因此该方案被采用的还是比多的。</p><p data-lake-id="u8c4ade04" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><span style="color: #F5222D;">方案二</span>：&nbsp; &nbsp; &nbsp;</p><p data-lake-id="u537cc770" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">对于某些特定的使用场景，该方案还是蛮香的。再次强调，数据开发者一定要懂业务，许多技术上实现非常复杂的，换一种业务角度会简单太多了，</p><p data-lake-id="u44cacff9" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><span style="color: #F5222D;">方案三</span>：&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p><p data-lake-id="u9524e978" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">这是多数人都能想到的处理思路，即拉链表。适用场景必须是缓慢变化，例如一张表有 10 亿数据，每天变化的只有几万、几十万才能称为缓慢变化，反之如果 10 亿的表每天有 7 亿都会发生变化，那这还适合用拉链表吗？</p><p data-lake-id="ubad1ef8d" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">拉链表的优点是，相对于快照表可以极大的节省存储空间，缺点也很明显就是太麻烦了。</p><p data-lake-id="u7bcb37e9" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><h2 data-lake-id="FxbGR" data-wording="true" style="padding-top: 7px;padding-bottom: 7px;font-weight: 700;font-size: 24px;line-height: 32px;">4 实现方法</h2><p data-lake-id="udc438d4f" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">大数据数仓不支持 Update ，因此跟传统数仓实现还是有区别的。（当然这是个伪命题，因为 ODPS 从 2021 年 3 月份已经开始支持 Update，虽然是试用阶段但未来可期。）</p><p data-lake-id="u677a2678" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">另外，有些需求，纯 SQL 实现确实很难。大家不要太迷恋 SQL，时代不同了，拉链表的计算，有时候写 MR 反而更容易理解。有时候多写几个 UDF、UDAF、UDTF，SQL 写起来反而更方便、执行效率反而会更好。</p><h3 data-lake-id="e6Hd3" data-wording="true" style="padding-top: 7px;padding-bottom: 7px;font-weight: 700;font-size: 20px;line-height: 28px;">4.1 数据模型设计-传统数仓设计方案</h3><p data-lake-id="u9152eb33" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><p data-lake-id="u2318fc10" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;">因为数量不大，通常也就几万几十万的数据量，<span style="letter-spacing: 0.05em;">业务系统和数仓 ODS 层也不太需要启用数据删除策略。因此不用</span><span style="letter-spacing: 0.05em;">考虑分区设计。</span></p><p data-lake-id="u2318fc10" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><br  /></p><p data-lake-id="u4ba08f94" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><img class="rich_pages wxw-img" data-galleryid="" data-ratio="0.5949868073878628" data-s="300,640" src="图片/大数据技术与架构_2021-12-18_「转」数据仓库实践-拉链表设计/1_wddo8wMibNchwAlRGbuN7uHHtxZkJg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/qnZHkGT44TWHlDhUHiahsMF2xM9TKBeqTqPouGuUicDT6icxuRM3cdJZyFGuwddo8wMibNchwAlRGbuN7uHHtxZkJg/640?wx_fmt=png'" data-type="png" data-w="758" style="text-align: center;white-space: normal;"><span style="color: #F5222D;"></span><br  /></p><p data-lake-id="u4ba08f94" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><h3 data-lake-id="XhHes" data-wording="true" style="padding: 7px 0px;margin: 0px;font-weight: 700;font-size: 20px;line-height: 28px;">4.2 数据模型设计-大数据数仓设计方案</h3><p data-lake-id="u8067bb6f" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="uc2bcb130" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">网络上分享出来的文章，还是沿用关系型数据的模型设计思路。所有数据都放一个分区或者干脆不建分区，往往会带来一系列问题。比如：</p><ol lake-indent="0" style="list-style-type: decimal;margin: 0px;padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>随着存储时间的拉长，这张表势必会越来越大，查询效率会越来越底，然而大部分查询场景只需要查询快照或者最近一段时间的历史变化。</p></li><li><p>如果某次更新，由于误操作造成拉链表数据错误，已经存放五年历史变化的拉链表该怎么恢复？存储备份肯定是不可能的，如果我们每次都将全量数据写入新的分区，至少得存近三天的全量拉链表数据吧？这又会带来存储空间的消耗。</p></li></ol><p data-lake-id="u19bec3fc" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u5e18f487" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">例如，</p><p data-lake-id="u2f0da250" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">有这么一个场景，需要存储 SDK 上报的手机硬件信息，主键是设备 ID，关键的设备属性大概 30 个，设备数量 40 亿，在只存储一份快照的情况下，需占用 400 G 存储空间，一开始用的是快照表方式，考虑存储开销我们只存最近 7 天快照，带来的问题是设备历史变化的 imei 、mac、os、品牌、机型等重要属性都会丢失。所以，最好的方案应该是使用拉链表。由于数据已经累积了三四年，使用拉链表数据的话，数据条数会从 40 亿膨胀到 60 亿，需占 600 G 存储空间。</p><p data-lake-id="ua443b4df" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;text-align: left;"><br  /></p><p data-lake-id="ub6fbdc6d" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;text-align: center;"><span style="color: #F5222D;">==========设计思路、更新办法=======================</span></p><p data-lake-id="u6db43fe5" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">分区列：</p><ol lake-indent="0" style="list-style-type: decimal;margin: 0px;padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>day comment '生成日期。如果 is_latest_row=0，则 day=t_end_date。如果 is_latest_row=1，则day='99991231'。如果day=t_start_date，则说明该用户是今日新增的。'</p></li><li><p>is_latest_row comment '是否最新一条数据。1是0否。如果标记为 0 说明该条数据不会再被更新'</p></li></ol><p data-lake-id="u53c91cfb" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u8a253e3e" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #F5222D;">20170101 这一天的数据</span></p><p style="text-align: center;"><img class="rich_pages wxw-img" data-galleryid="" data-ratio="0.23279816513761467" data-s="300,640" src="图片/大数据技术与架构_2021-12-18_「转」数据仓库实践-拉链表设计/2_b5HGh3PaeibRFlnMicMpz31DC8zTxg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/qnZHkGT44TWHlDhUHiahsMF2xM9TKBeqTKibbzCyv60rtrCOPItGcUCGicnUFb5HGh3PaeibRFlnMicMpz31DC8zTxg/640?wx_fmt=png'" data-type="png" data-w="872" style=""></p><p style="text-align: center;"><br  /></p><p data-lake-id="ub5a4befa" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">相比于前一天，用户2、3没变化，用户4更新了手机号。</p><p data-lake-id="u59ed66a0" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u59ed66a0" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">用户2、用户3没变化，直接从前一天的分区里移过来放到当天的 is_latest_row='1' 分区下。</p><p data-lake-id="u59ed66a0" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u59ed66a0" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="letter-spacing: 0.05em;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">用户4 修改了手机号码，更新库里已有的那条数据 t_end_date='20170101'，然后放入当天的 is_latest_row='0' 分区下，说明该条数据因为失效被归档了。</span><span style="letter-spacing: 0.05em;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">新增的那条用户4 数据 t_start_date='20170101' ,t_end_date='99991231',放入当天的 is_latest_row='1' 分区下。</span></p><p data-lake-id="ucc6aa2fd" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u9e353595" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="uda804ef3" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #F5222D;">20170102 这一天生成的数据</span></p><p style="text-align: center;"><img class="rich_pages wxw-img" data-galleryid="" data-ratio="0.28718535469107553" data-s="300,640" src="图片/大数据技术与架构_2021-12-18_「转」数据仓库实践-拉链表设计/3_GKQrd6nvOWVeIClsPXcOichgTyiaKQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/qnZHkGT44TWHlDhUHiahsMF2xM9TKBeqTd5fKAEiawzPQR2PKqchlFb71HFlGKQrd6nvOWVeIClsPXcOichgTyiaKQ/640?wx_fmt=png'" data-type="png" data-w="874" style=""></p><p data-lake-id="uc7526b7a" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="uc7526b7a" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="letter-spacing: 0.05em;">用户5是新增的，该条数据的失效日期是永久，所以 is_latest_row = '1'。</span>&nbsp; &nbsp; &nbsp;相比于前一天，新增了用户5，同时更新了用户2的手机号码，用户3、4无变化。</p><p data-lake-id="u3e0b215a" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u3e0b215a" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">用户3、4没变化，直接从前一天的分区里移过来放到当天的 is_latest_row='1' 分区下。</p><p data-lake-id="u1d247d29" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u1d247d29" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">用户2 修改了手机号码，更新库里已有的那条数据 t_end_date='20170102'，然后放入当天的 is_latest_row='0' 分区下，说明该条数据因为失效被归档了。新增的那条用户2 数据 t_start_date='20170102' ,t_end_date='99991231',放入当天的 is_latest_row='1' 分区下。</p><p data-lake-id="u66eff476" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u232f58dc" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;text-align: center;"><span style="color: #F5222D;"><span style="color: rgb(245, 34, 45);font-size: 14px;letter-spacing: 0.7px;">=======</span><span style="color: rgb(245, 34, 45);font-size: 14px;letter-spacing: 0.7px;">===</span>使用方法=========</span></p><p data-lake-id="ua88d9d36" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u0ca9ba1f" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">假如数据已经更新到了 20170102 这一天。</p><ol lake-indent="0" style="list-style-type: decimal;margin: 0px;padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>is_latest_row = '0' 的分区绝对不允许删除，保证历史变化都能记录下来。</p></li><li><p>is_latest_row = '1' 的分区只保留最近 7 天或最近 3 天的数据，节省存储空间的同时，就是某一天更新错误也能很快的修正数据。</p></li><li><p>可以查最新快照：</p></li></ol><blockquote style="margin-top: 5px;margin-bottom: 5px;padding-left: 1em;margin-left: 0px;border-left: 3px solid rgb(238, 238, 238);opacity: 0.6;"><p data-lake-id="u5817ecb1" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">select * from dim_user_history where day='20170102' and is_latest_row='1' &nbsp;;</p></blockquote><ol start="4" lake-indent="0" style="list-style-type: decimal;margin: 0px;padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>可以查历史任意一天[20161002]的快照：</p></li></ol><blockquote style="margin-top: 5px;margin-bottom: 5px;padding-left: 1em;margin-left: 0px;border-left: 3px solid rgb(238, 238, 238);opacity: 0.6;"><p data-lake-id="u4a8ab6d6" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">select t.*</p><p data-lake-id="ufeed5ea5" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">from</p><p data-lake-id="u03142442" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">(</p><p data-lake-id="udc93f46b" style="padding-left: 2em;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;" data-wording="true">select t.*</p><p data-lake-id="u968faff0" style="padding-left: 2em;text-indent: 2em;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;" data-wording="true">,row_number() over (partition by user_id order by t_end_date) rn</p><p data-lake-id="u8842a532" style="padding-left: 2em;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;" data-wording="true">from dim_user_history</p><p data-lake-id="u869881a4" style="padding-left: 2em;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;" data-wording="true">where (day&gt;='20161002' and is_latest_row='0') &nbsp;or (day='20170102' and is_latest_row='1')</p><p data-lake-id="uefd815bc" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">) t</p><p data-lake-id="u1be75396" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">where t.rn=1</p><p data-lake-id="ue4308b9b" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">;</p></blockquote><ol start="5" lake-indent="0" style="list-style-type: decimal;margin: 0px;padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>可以查指定时间范围内的[20161002-20161101]的所有状态：</p></li></ol><blockquote style="margin-top: 5px;margin-bottom: 5px;padding-left: 1em;margin-left: 0px;border-left: 3px solid rgb(238, 238, 238);opacity: 0.6;"><p data-lake-id="uf23483ae" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">select t.*</p><p data-lake-id="u8a03f1ca" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">from dim_user_history</p><p data-lake-id="uc4157731" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">where (day&lt;'20161101' and is_latest_row='0' &nbsp;and &nbsp;t_start_date&gt;'20161002') &nbsp;</p><p data-lake-id="ueae45320" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">or (day='20170102' and is_latest_row='1' and t_start_date&gt;'20161002')</p><p data-lake-id="ud5f0645f" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">;</p></blockquote><p data-lake-id="u57c77ae8" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u57c77ae8" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: rgb(38, 38, 38);font-size: 14px;letter-spacing: 0.7px;">拉链表</span><span style="color: rgb(38, 38, 38);font-size: 14px;letter-spacing: 0.7px;">虽然能解决很多问题，但是，只要一个日期卡错，就会出问题。</span><span style="color: rgb(38, 38, 38);font-size: 14px;letter-spacing: 0.7px;">使用起来真的太太太难了。</span><span style="color: rgb(38, 38, 38);font-size: 14px;letter-spacing: 0.7px;">。</span><span style="color: rgb(38, 38, 38);font-size: 14px;letter-spacing: 0.7px;">。</span><span style="color: rgb(38, 38, 38);font-size: 14px;letter-spacing: 0.7px;">。</span></p><p data-lake-id="u57c77ae8" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: rgb(38, 38, 38);font-size: 14px;letter-spacing: 0.7px;"><br  /></span></p><h3 data-lake-id="VBF9d" data-wording="true" style="padding: 7px 0px;margin: 0px;font-weight: 700;font-size: 20px;line-height: 28px;">4.3 历史数据初始化</h3><p data-lake-id="u6fb4890b" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="uf6928292" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">上边，我们了解到，拉链表的使用有多麻烦。这一节我们接着讨论下写入。</p><p data-lake-id="ua84f82c5" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="ue1c29efe" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">如果我们构建拉链表的时候，历史数据已经沉淀一段时间了，那么大概率我们是需要全量加工处理，并一次性写入进来的。当然，我们可以从第一天开始、一天一天的往后计算。</p><p data-lake-id="u3ae7102a" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u3ae7102a" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">但是，总觉得吧，这不是我们技术该干的事儿，因为这也太 lower 了吧。一天一天算，那得等多久啊，技术不能提高效率，要技术干嘛？</p><p data-lake-id="u4705b13f" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="uab807310" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">这个时候 SQL Boy 该上场了。有啥事情是一条 SQL 搞不定的呢？如果有，那就两条吧。哈哈哈。。。</p><p data-lake-id="ub44b6a21" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u68d4c6ee" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">接下来先说一下思路吧：</p><p data-lake-id="ue9370e56" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">增量更新相对简单些，我们直接拿上一次统计周期的全量快照，关联本次统计周期的变化量即可。</p><p data-lake-id="ufc4c10eb" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">历史数据初始化，由于存在某一个业务主键对应的属性可能会变化多次的情况，处理起来就会复杂很多：</p><ol lake-indent="0" style="list-style-type: decimal;margin: 0px;padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>相邻两个统计周期的数据如果没有变化，需要去重。</p></li><li><p>剩下的数据，需要按时间正序排列，第一条的数据止期=第二条的数据起期、第二条的数据止期=第三条的数据起期，以此类推。</p></li><li><p>而 SQL 对于行间数据的处理常常无能为力，那我们能否把行间数据计算转化成行内数据计算呢？</p></li></ol><p data-lake-id="u5eed1ea7" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp;</p><p data-lake-id="uf257ccf0" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #F5222D;">结合以上分析，实现步骤如下（以统计周期为天来举例）：</span></p><ol lake-indent="0" style="list-style-type: decimal;margin: 0px;padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>原始数据表。</p></li></ol><table width="583"><tbody><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ua8e3148b" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">user_id</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ub58c1dbc" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">user_name</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u703cc024" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">other_column</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u5293c119" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">update_date</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ub7a316af" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">update_time</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u6e46fa21" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">1</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u8347feba" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">aaa</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u9bd87073" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">11</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uad54a714" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">20210101</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ud8751a27" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">2021/1/1 12:00</span></p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uac52c602" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">1</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u71edb880" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">bbb</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u5fe53da4" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">22</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u590aed82" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">20210101</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ubb63fe33" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">2021/1/1 15:00</span></p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ue394e603" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ub7fdb0e0" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">aaa</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ua0db6e24" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">33</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u559e11bc" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210102</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u9d2aeb1d" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">2021/1/2 12:00</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u9aa9bc2b" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u99750ff4" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">aaa</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u479d52a1" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">44</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ua25a648a" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210103</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u6d85e10e" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">2021/1/3 12:00</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ub5943d25" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u5949db39" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">aaa</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u5c808710" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">55</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u143acd6e" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210104</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u84c5aa2d" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">2021/1/4 12:00</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uefac9efc" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ufd101638" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">bbb</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u5dbcac9f" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">66</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u66837593" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210105</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ud992a3b7" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">2021/1/5 12:00</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u360c99df" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u7d476bca" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">bbb</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u3518b874" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">77</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u9e3a8858" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210106</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u80efeced" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">2021/1/6 12:00</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u6d161a71" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uea99f94e" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">bbb</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ua72c85be" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">88</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ufd0b0880" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210107</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u0450cd10" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">2021/1/7 12:00</p></td></tr></tbody></table><ol start="2" lake-indent="0" style="list-style-type: decimal;margin: 0px;padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>按更新时间，每天只保留最后一条数据，数据起期为当天，止期为无限大。</p></li></ol><blockquote style="margin-top: 5px;margin-bottom: 5px;padding-left: 1em;margin-left: 0px;border-left: 3px solid rgb(238, 238, 238);opacity: 0.6;"><p data-lake-id="u202c4885" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">create table dws.user_his_mid_01 as</p><p data-lake-id="u5717c6a9" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">select user_id,user_name,update_day b_date,'99990101' e_date</p><p data-lake-id="ue2c3726b" style="text-indent: 2em;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;" data-wording="true">,row_number() over (partition by user_id order by update_day ) rn</p><p data-lake-id="ub4cc33d4" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">from</p><p data-lake-id="uae81c934" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">(</p><p data-lake-id="u5fa17386" style="padding-left: 2em;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;" data-wording="true">select update_day,user_id,user_name</p><p data-lake-id="uf5f26f53" style="text-indent: 2em;padding-left: 2em;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;" data-wording="true">,row_number() over (partition by update_day,user_id order by update_time desc ) rn</p><p data-lake-id="uedd3501f" style="padding-left: 2em;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;" data-wording="true">from ods.user</p><p data-lake-id="u2f1d1e2a" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">) t</p><p data-lake-id="ue4178daf" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">where rn=1</p><p data-lake-id="ua7f3645e" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">；</p></blockquote><p data-lake-id="u5bbee3fa" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">前两条数据会只留下一条</p><table width="583"><tbody><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u32098ec2" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">user_id</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uc4c0814d" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">user_name</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uf32f1868" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">b_date</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ucf76cd66" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">e_date</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u5649bea9" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">rn</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u4a59c0b8" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u3656db49" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">bbb</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ua5f24f5b" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210101</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ubd8db6c9" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">99990101</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u80a1039b" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u93dd04ba" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ufbd82cfb" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">aaa</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ufbf635d1" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210102</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u61bbe133" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">99990101</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ucdcd06a8" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">2</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u8f779f5f" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u71f6c523" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">aaa</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="udd742289" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210103</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u7132cb99" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">99990101</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u0e78a73a" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">3</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uae439069" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u0589e259" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">aaa</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ua4f44e05" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210104</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uf728608d" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">99990101</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ube1f3329" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">4</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u40931e73" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uf500af67" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">bbb</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uc151a674" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210105</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ue82ce8d1" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">99990101</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ua840fd1b" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">5</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u1cedd3a8" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ub4917ecf" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">bbb</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u591dab69" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210106</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ud9de8604" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">99990101</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ubddfad8d" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">6</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u36a4a4f8" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u725a7efc" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">bbb</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u39a5b47c" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210107</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u22498d9e" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">99990101</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u98e2d8bc" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">7</p></td></tr></tbody></table><ol start="3" lake-indent="0" style="list-style-type: decimal;margin: 0px;padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>修正数据起止期。</p></li></ol><blockquote style="margin-top: 5px;margin-bottom: 5px;padding-left: 1em;margin-left: 0px;border-left: 3px solid rgb(238, 238, 238);opacity: 0.6;"><p data-lake-id="u94102287" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">create table dws.user_his_mid_02 as</p><p data-lake-id="u2a47b536" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">select t1.user_id,t1.user_name</p><p data-lake-id="u2bf6baea" style="text-indent: 2em;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;" data-wording="true">,t1.b_date</p><p data-lake-id="u8d677134" style="text-indent: 2em;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;" data-wording="true">,nvl(t2.b_date,t1.e_date) e_date</p><p data-lake-id="u9755d864" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">from dws.user_his_mid_01 t1</p><p data-lake-id="u6cd5af2e" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">left join dws.user_his_mid t2 on t1.user_id=t2.user_id and t1.rn=t2.rn-1</p><p data-lake-id="u7f453cc2" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">;</p></blockquote><p data-lake-id="u29aca625" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span data-card-type="inline" data-lake-card="image" data-card-value="data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1535216%2F1622305764888-f362309f-3963-4c44-a77c-1b392ad2d38b.png%22%2C%22taskId%22%3A%22ub36458c0-95a3-4392-969e-fed80ca5d22%22%2C%22clientId%22%3A%22u2f6fb6ad-a103-4%22%2C%22originalType%22%3A%22binary%22%2C%22width%22%3A628.5%2C%22height%22%3A153%2C%22linkTarget%22%3A%22_blank%22%2C%22name%22%3A%22image.png%22%2C%22size%22%3A29320%2C%22from%22%3A%22paste%22%2C%22originWidth%22%3A1087%2C%22originHeight%22%3A264%2C%22status%22%3A%22done%22%2C%22style%22%3A%22none%22%2C%22search%22%3A%22userid%20date%20usernamab_date%20rn%201%201bbb%2020210101%2099990101%20bdate%20date%20user_id%20username%2020210101%201bbb%2099990101%2099990101%202%2020210102%20aaa%2020210102%2020210103%2099990101%203%2099990101%20aaa%20aaa%203%2099990101%2099990101%2020210104%2020210103%201%204%20aaa%20aaa%204%205%2099990101%2099990101%2020210105%201%20bbb%2020210104%20aaa%205%201bbb%206%201bbb%2099990101%2099990101%2020210106%2020210105%207%201bbb%201bbb%2099990101%2020210107%2020210106%206%2099990101%2020210107%201bbb%2099990101%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A597.19073%2C%22y%22%3A38.768936%2C%22width%22%3A64.57263999999998%2C%22height%22%3A15.546288000000004%2C%22text%22%3A%22userid%22%7D%2C%7B%22x%22%3A860.6391%2C%22y%22%3A39.670673%2C%22width%22%3A39.13745000000006%2C%22height%22%3A14.725910999999996%2C%22text%22%3A%22date%22%7D%2C%7B%22x%22%3A675.2015%2C%22y%22%3A40.66797%2C%22width%22%3A138.75339999999994%2C%22height%22%3A15.759944000000004%2C%22text%22%3A%22usernamab_date%22%7D%2C%7B%22x%22%3A931.14087%2C%22y%22%3A42.454197%2C%22width%22%3A21.458130000000097%2C%22height%22%3A12.435063%2C%22text%22%3A%22rn%22%7D%2C%7B%22x%22%3A992.7367%2C%22y%22%3A61.992966%2C%22width%22%3A12.738299999999981%2C%22height%22%3A16.984373999999995%2C%22text%22%3A%221%22%7D%2C%7B%22x%22%3A665.0218%2C%22y%22%3A62.218754%2C%22width%22%3A39.93640000000005%2C%22height%22%3A16.73028200000001%2C%22text%22%3A%221bbb%22%7D%2C%7B%22x%22%3A768.17914%2C%22y%22%3A62.719364%2C%22width%22%3A69.71856000000002%2C%22height%22%3A15.693866%2C%22text%22%3A%2220210101%22%7D%2C%7B%22x%22%3A854.0942%2C%22y%22%3A63.204617%2C%22width%22%3A70.50375999999994%2C%22height%22%3A14.877832999999995%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A190.5664%2C%22y%22%3A63.066536%2C%22width%22%3A54.99973%2C%22height%22%3A16.326324%2C%22text%22%3A%22bdate%22%7D%2C%7B%22x%22%3A322.36588%2C%22y%22%3A63.949127%2C%22width%22%3A42.68588%2C%22height%22%3A14.845703000000007%2C%22text%22%3A%22date%22%7D%2C%7B%22x%22%3A13.46881%2C%22y%22%3A62.075397%2C%22width%22%3A68.99687%2C%22height%22%3A20.628122999999995%2C%22text%22%3A%22user_id%22%7D%2C%7B%22x%22%3A94.00645%2C%22y%22%3A65.71816%2C%22width%22%3A84.88004000000001%2C%22height%22%3A13.43911%2C%22text%22%3A%22username%22%7D%2C%7B%22x%22%3A232.18796%2C%22y%22%3A85.51616%2C%22width%22%3A71.63568000000001%2C%22height%22%3A16.8853%2C%22text%22%3A%2220210101%22%7D%2C%7B%22x%22%3A82.11788%2C%22y%22%3A86.25654%2C%22width%22%3A41.455470000000005%2C%22height%22%3A16.74781%2C%22text%22%3A%221bbb%22%7D%2C%7B%22x%22%3A344.2292%2C%22y%22%3A86.90964%2C%22width%22%3A72.17180000000002%2C%22height%22%3A15.787810000000007%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A852.876%2C%22y%22%3A87.27167%2C%22width%22%3A72.13130000000001%2C%22height%22%3A14.583849999999998%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A995.1158%2C%22y%22%3A87.29629%2C%22width%22%3A12.680830000000014%2C%22height%22%3A14.943203999999994%2C%22text%22%3A%222%22%7D%2C%7B%22x%22%3A766.3823%2C%22y%22%3A87.14076%2C%22width%22%3A74.25905999999998%2C%22height%22%3A15.362634999999997%2C%22text%22%3A%2220210102%22%7D%2C%7B%22x%22%3A677.0407%2C%22y%22%3A89.83849%2C%22width%22%3A29.3365%2C%22height%22%3A12.878810000000001%2C%22text%22%3A%22aaa%22%7D%2C%7B%22x%22%3A233.05746%2C%22y%22%3A110.58933%2C%22width%22%3A72.154%2C%22height%22%3A15.466493999999997%2C%22text%22%3A%2220210102%22%7D%2C%7B%22x%22%3A767.4383%2C%22y%22%3A111.24295%2C%22width%22%3A71.64379999999994%2C%22height%22%3A14.585816000000008%2C%22text%22%3A%2220210103%22%7D%2C%7B%22x%22%3A343.55994%2C%22y%22%3A111.42839%2C%22width%22%3A72.63134000000002%2C%22height%22%3A14.926510000000007%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A995.3631%2C%22y%22%3A111.41486%2C%22width%22%3A11.545499999999947%2C%22height%22%3A15.834040000000002%2C%22text%22%3A%223%22%7D%2C%7B%22x%22%3A854.34827%2C%22y%22%3A111.518135%2C%22width%22%3A69.67322999999999%2C%22height%22%3A14.395724999999999%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A677.0967%2C%22y%22%3A113.824%2C%22width%22%3A28.858499999999935%2C%22height%22%3A12.682249999999996%2C%22text%22%3A%22aaa%22%7D%2C%7B%22x%22%3A92.34935%2C%22y%22%3A114.123436%2C%22width%22%3A31.8429%2C%22height%22%3A12.846243999999999%2C%22text%22%3A%22aaa%22%7D%2C%7B%22x%22%3A582.564%2C%22y%22%3A133.32733%2C%22width%22%3A10.19064000000003%2C%22height%22%3A17.305170000000004%2C%22text%22%3A%223%22%7D%2C%7B%22x%22%3A853.14886%2C%22y%22%3A134.40231%2C%22width%22%3A73.17376999999999%2C%22height%22%3A16.48579000000001%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A344.42297%2C%22y%22%3A135.18951%2C%22width%22%3A72.77625%2C%22height%22%3A15.455399999999997%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A766.77466%2C%22y%22%3A135.32613%2C%22width%22%3A72.11663999999996%2C%22height%22%3A15.215720000000005%2C%22text%22%3A%2220210104%22%7D%2C%7B%22x%22%3A232.72783%2C%22y%22%3A136.21873%2C%22width%22%3A72.86943%2C%22height%22%3A13.840370000000007%2C%22text%22%3A%2220210103%22%7D%2C%7B%22x%22%3A77.70235%2C%22y%22%3A136.40414%2C%22width%22%3A13.363675%2C%22height%22%3A15.07853%2C%22text%22%3A%221%22%7D%2C%7B%22x%22%3A995.06195%2C%22y%22%3A136.89465%2C%22width%22%3A11.697749999999928%2C%22height%22%3A12.684769999999986%2C%22text%22%3A%224%22%7D%2C%7B%22x%22%3A677.53503%2C%22y%22%3A139.12576%2C%22width%22%3A29.09789999999998%2C%22height%22%3A11.18862999999999%2C%22text%22%3A%22aaa%22%7D%2C%7B%22x%22%3A94.77761%2C%22y%22%3A138.89278%2C%22width%22%3A28.81652000000001%2C%22height%22%3A11.786770000000018%2C%22text%22%3A%22aaa%22%7D%2C%7B%22x%22%3A580.94366%2C%22y%22%3A157.05037%2C%22width%22%3A12.32704000000001%2C%22height%22%3A19.006830000000008%2C%22text%22%3A%224%22%7D%2C%7B%22x%22%3A994.65393%2C%22y%22%3A157.70241%2C%22width%22%3A11.603210000000104%2C%22height%22%3A17.200290000000024%2C%22text%22%3A%225%22%7D%2C%7B%22x%22%3A853.16254%2C%22y%22%3A158.63124%2C%22width%22%3A72.77405999999996%2C%22height%22%3A16.275900000000007%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A344.2799%2C%22y%22%3A159.02411%2C%22width%22%3A71.23133000000001%2C%22height%22%3A15.283140000000003%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A766.7257%2C%22y%22%3A159.67857%2C%22width%22%3A72.03700000000003%2C%22height%22%3A14.39649%2C%22text%22%3A%2220210105%22%7D%2C%7B%22x%22%3A77.956825%2C%22y%22%3A160.02628%2C%22width%22%3A13.375785000000008%2C%22height%22%3A15.154199999999975%2C%22text%22%3A%221%22%7D%2C%7B%22x%22%3A676.6848%2C%22y%22%3A160.07991%2C%22width%22%3A30.118600000000015%2C%22height%22%3A13.855099999999993%2C%22text%22%3A%22bbb%22%7D%2C%7B%22x%22%3A232.85443%2C%22y%22%3A160.25223%2C%22width%22%3A73.26471000000001%2C%22height%22%3A14.47614999999999%2C%22text%22%3A%2220210104%22%7D%2C%7B%22x%22%3A95.58958%2C%22y%22%3A162.2588%2C%22width%22%3A28.200000000000003%2C%22height%22%3A11.987779999999987%2C%22text%22%3A%22aaa%22%7D%2C%7B%22x%22%3A581.7416%2C%22y%22%3A181.33318%2C%22width%22%3A12.160000000000082%2C%22height%22%3A18.742729999999995%2C%22text%22%3A%225%22%7D%2C%7B%22x%22%3A78.014404%2C%22y%22%3A181.83643%2C%22width%22%3A45.414936%2C%22height%22%3A16.29160999999999%2C%22text%22%3A%221bbb%22%7D%2C%7B%22x%22%3A993.7461%2C%22y%22%3A181.94028%2C%22width%22%3A13.427400000000034%2C%22height%22%3A17.229749999999996%2C%22text%22%3A%226%22%7D%2C%7B%22x%22%3A662.54346%2C%22y%22%3A182.01991%2C%22width%22%3A44.164980000000014%2C%22height%22%3A16.121769999999998%2C%22text%22%3A%221bbb%22%7D%2C%7B%22x%22%3A852.4357%2C%22y%22%3A182.31682%2C%22width%22%3A74.26459999999997%2C%22height%22%3A16.261200000000002%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A344.6381%2C%22y%22%3A182.44392%2C%22width%22%3A70.84370000000001%2C%22height%22%3A14.927430000000015%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A766.87177%2C%22y%22%3A182.87688%2C%22width%22%3A71.82452999999998%2C%22height%22%3A14.457210000000003%2C%22text%22%3A%2220210106%22%7D%2C%7B%22x%22%3A232.85854%2C%22y%22%3A182.99696%2C%22width%22%3A72.98656%2C%22height%22%3A15.484620000000007%2C%22text%22%3A%2220210105%22%7D%2C%7B%22x%22%3A994.5785%2C%22y%22%3A205.34698%2C%22width%22%3A13.18380000000002%2C%22height%22%3A17.906419999999997%2C%22text%22%3A%227%22%7D%2C%7B%22x%22%3A77.351906%2C%22y%22%3A205.47983%2C%22width%22%3A45.909724%2C%22height%22%3A16.83572000000001%2C%22text%22%3A%221bbb%22%7D%2C%7B%22x%22%3A662.139%2C%22y%22%3A205.16093%2C%22width%22%3A44.37829999999997%2C%22height%22%3A17.3279%2C%22text%22%3A%221bbb%22%7D%2C%7B%22x%22%3A853.39746%2C%22y%22%3A206.56831%2C%22width%22%3A71.00883999999996%2C%22height%22%3A15.587880000000013%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A767.3277%2C%22y%22%3A206.63849%2C%22width%22%3A71.22109999999998%2C%22height%22%3A15.051940000000002%2C%22text%22%3A%2220210107%22%7D%2C%7B%22x%22%3A232.50188%2C%22y%22%3A206.3721%2C%22width%22%3A73.85434999999998%2C%22height%22%3A16.20308%2C%22text%22%3A%2220210106%22%7D%2C%7B%22x%22%3A581.9926%2C%22y%22%3A206.6516%2C%22width%22%3A12.597800000000007%2C%22height%22%3A14.992629999999991%2C%22text%22%3A%226%22%7D%2C%7B%22x%22%3A344.4745%2C%22y%22%3A207.36862%2C%22width%22%3A71.04503%2C%22height%22%3A14.986080000000015%2C%22text%22%3A%2299990101%22%7D%2C%7B%22x%22%3A231.98563%2C%22y%22%3A229.85973%2C%22width%22%3A72.28729000000001%2C%22height%22%3A16.582039999999978%2C%22text%22%3A%2220210107%22%7D%2C%7B%22x%22%3A77.49196%2C%22y%22%3A230.06302%2C%22width%22%3A45.26651%2C%22height%22%3A16.90512000000001%2C%22text%22%3A%221bbb%22%7D%2C%7B%22x%22%3A344.68573%2C%22y%22%3A231.46043%2C%22width%22%3A71.53547000000003%2C%22height%22%3A14.633729999999986%2C%22text%22%3A%2299990101%22%7D%5D%2C%22id%22%3A%22ud0b30db7%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%7D"><img class="rich_pages wxw-img" data-height="153px" data-ratio="0.24287028518859247" src="图片/大数据技术与架构_2021-12-18_「转」数据仓库实践-拉链表设计/4_6DhMKUdp4ujRoVPPPV4dDDdkaft5TQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/qnZHkGT44TWHlDhUHiahsMF2xM9TKBeqTvlEHkAUp4xtlmkiaSz652W2Px6DhMKUdp4ujRoVPPPV4dDDdkaft5TQ/640?wx_fmt=png'" data-type="png" data-w="1087" style="visibility: visible;width: 628.5px;" title="image.png"></span></p><table width="408"><tbody><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u45c66d77" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">user_id</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ued8c7ca0" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">user_name</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uadf8f924" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">b_date</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u62343444" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">e_date</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uf0721aad" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ub1d0c7f2" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">bbb</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u70261fbc" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210101</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u0e202576" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210102</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u2e786f94" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">1</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ue461250d" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">aaa</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u68ff7755" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">20210102</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ubfb5ed75" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">20210103</span></p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ua31046b3" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">1</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ud9093abf" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">aaa</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u2331e021" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">20210103</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u328948a7" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">20210104</span></p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uff7bc63f" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">1</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uddc03226" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">aaa</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u76d4f206" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">20210104</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ud0c83a0a" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #52C41A;">20210105</span></p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u48d2e399" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">1</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u10365eb4" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">bbb</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u8583acb8" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">20210105</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u5b0d8880" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">20210106</span></p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u859d1eb4" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">1</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u442947ba" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">bbb</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ubb986d23" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">20210106</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u238df28f" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">20210107</span></p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ueb29d50c" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">1</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u6f73f0a2" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">bbb</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u234356b5" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">20210107</span></p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u5381b266" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #FFBB96;">99990101</span></p></td></tr></tbody></table><ol start="4" lake-indent="0" style="list-style-type: decimal;margin: 0px;padding-left: 23px;font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;" class="list-paddingleft-2"><li><p>相邻两条数据，属性无变化的去重。</p></li></ol><p data-lake-id="ub9d75c5b" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">上表数据，会合并为三条。</p><table width="408"><tbody><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ud8f3c1b0" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">user_id</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u87150608" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">user_name</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u7db1ef39" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">b_date</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u1a0f0b03" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">e_date</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uad1cf87a" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u4ef2d03b" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">bbb</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ucdcd990c" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210101</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uf56fbdcc" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210102</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u2137e9ad" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ubb376f40" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">aaa</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ud77827cf" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210102</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ub988436a" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210105</p></td></tr><tr style="height: 24px;"><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u3fcaba62" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">1</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="u29619d03" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">bbb</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="ubd5ad2e4" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">20210105</p></td><td style="min-width: 90px;font-size: 14px;white-space: normal;overflow-wrap: break-word;border-width: 1px;border-style: solid;border-color: rgb(217, 217, 217);padding: 4px 8px;cursor: default;"><p data-lake-id="uac1e21ae" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">99990101</p></td></tr></tbody></table><p data-lake-id="u92214134" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u6573e61c" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #000000;">好吧。</span><span style="color: #000000;">历史数据初始化</span><span style="color: #000000;">，当时是有写过 SQL 的，好多年过去实在想不起来，当时的 SQL 也找不到了。</span></p><p data-lake-id="uc684a051" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #000000;">本想重现当时的 SQL，不过写到第三条实在写不动了，因为太难了。</span></p><p data-lake-id="u2edb60dc" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u9c6d5a82" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">换做现在的我，其实更愿意写 MR 或者 UDAF 去实现这一业务逻辑的。思路特简单，就是将相同业务主键的数据放到一个 Reduce 里，按 update_time 排序后，循环遍历，返回结果。</p><p data-lake-id="u8979debe" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><h3 data-lake-id="eQS6b" data-wording="true" style="padding: 7px 0px;margin: 0px;font-weight: 700;font-size: 20px;line-height: 28px;">4.4 增量更新</h3><p data-lake-id="u103dd0a7" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">木东居士这条 SQL 写的非常简介、实用，借过来给大家看看。</p><p data-lake-id="u9332a8bc" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">ods.user_update 表应该存的是前一天的变化量（新增 + Update）。</p><p data-lake-id="u598913a4" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">这是关系型数据库的写法，具体到大数据场景，大家还得参照上文，加上分区列，直接 overwrite 总感觉心里不踏实。</p><blockquote style="margin-top: 5px;margin-bottom: 5px;padding-left: 1em;margin-left: 0px;border-left: 3px solid rgb(238, 238, 238);opacity: 0.6;"><p data-lake-id="u1c931569" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">INSERT OVERWRITE TABLE dws.user_his</p><p data-lake-id="u1b37d9ad" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">SELECT * FROM</p><p data-lake-id="u75978311" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">(</p><p data-lake-id="u56d48d47" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp;SELECT A.user_num,</p><p data-lake-id="u8c2cf69a" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; A.mobile,</p><p data-lake-id="u3b5357e9" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; A.reg_date,</p><p data-lake-id="u75c93793" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; A.t_start_time,</p><p data-lake-id="ua779067d" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CASE</p><p data-lake-id="ucc9f5349" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN A.t_end_time = '9999-12-31' AND B.user_num IS NOT NULL THEN '2017-01-01'</p><p data-lake-id="u845f7ec3" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE A.t_end_time</p><p data-lake-id="u909e2d76" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; END AS t_end_time</p><p data-lake-id="u3176c6bc" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp;FROM dws.user_his AS A</p><p data-lake-id="ud1742059" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp;LEFT JOIN ods.user_update AS B</p><p data-lake-id="ua530d89f" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp;ON A.user_num = B.user_num</p><p data-lake-id="u21c9434c" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">UNION</p><p data-lake-id="ufde6330d" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp;SELECT C.user_num,</p><p data-lake-id="ud7928206" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; C.mobile,</p><p data-lake-id="uab66ac40" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; C.reg_date,</p><p data-lake-id="u2b9a1693" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '2017-01-02' AS t_start_time,</p><p data-lake-id="ua92b683a" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '9999-12-31' AS t_end_time</p><p data-lake-id="u5dce9934" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp;FROM ods.user_update AS C</p><p data-lake-id="uea459919" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">) AS T</p><p data-lake-id="u176153e0" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">；</p></blockquote><p data-lake-id="uf12ed3c0" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">下边是我之前写的，每月计算 IP 地址经纬度历史变化的拉链表。</p><p data-lake-id="uf12ed3c0" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="uf6ea477c" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">牵涉到部分计算逻辑，会稍微有点复杂，大家看核心代码段即可。</p><p data-lake-id="uf6ea477c" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u0cc21a87" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">第一条 SQL 是，这个月的变化量，关联上个月的全量快照，更新这个月变化量的起止日期，暂时放到这个月的全量快照分区里（类似上边 SQL 的 ods.user_update &nbsp;作用）。</p><p data-lake-id="u0b01e186" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">第二条 SQL 是，上个月的全量快照，关联这个月的变化量，得到这个月的全量快照+这个月失效的数据（数据止期='$1'）。</p><p data-lake-id="u0b01e186" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u7a0b441f" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #F5222D;">奥，看了好久，下边 SQL 的数据止期有问题。因为当时的需求跟拉链表的不太一样。</span>数据止期用的不是一个无限大的日期，而是（数据止期='$1'） 。意味着，如果某ip只在其中一个月份出现过，那么起止日期都是一样的，如果连续出现过2个月，数据起期是第一月，数据止期是第二月。</p><blockquote style="margin-top: 5px;margin-bottom: 5px;padding-left: 1em;margin-left: 0px;border-left: 3px solid rgb(238, 238, 238);opacity: 0.6;"><p data-lake-id="ud86d4b5f" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">insert OVERWRITE table bds_ip_info partition(month='$1',is_latest_row='1')<br  /> &nbsp;select a.ip,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; if(size(split(lgt_list,';'))=1,split(lgt_list,';')[0],if(size(split(lgt_list,';'))=2,(split(lgt_list,';')[0]+split(lgt_list,';')[1])/2,b.lgt_center)) lgt_center,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; if(size(split(ltt_list,';'))=1,split(ltt_list,';')[0],if(size(split(ltt_list,';'))=2,(split(ltt_list,';')[0]+split(ltt_list,';')[1])/2,b.ltt_center)) ltt_center,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; if(size(split(lgt_list,';'))=1,0,if(size(split(lgt_list,';'))=2,lipb_GetDistance(concat(split(lgt_list,';')[0],',',split(ltt_list,';')[0]),concat(split(lgt_list,';')[1],',',split(ltt_list,';')[1]))/2,b.radius)) radius,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; a.b_month,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; a.e_month,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; size(split(a.geo_list,',')) geo_num,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; a.geo_list,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; month_from_list<br  /> &nbsp;from<br  /> &nbsp;(<br  /> &nbsp; &nbsp;select t1.ip<br  /> &nbsp; &nbsp;,if(t2.ip is null,substring(t1.month,1,6),t2.b_month) b_month<br  /> &nbsp; &nbsp;,substring(t1.month,1,6) e_month<br  /> &nbsp; &nbsp;,if(t2.ip is null,t1.month,concat(t1.month,';',t2.month_from_list)) month_from_list<br  /> &nbsp; &nbsp;,if(t2.ip is null,GetGeoList(time_list,ltt_list,lgt_list)<br  /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,GetGeoLatest(GetGeoList(time_list,ltt_list,lgt_list),t2.geo_list,'500')) geo_list<br  /> &nbsp; &nbsp;,split(SplitGeoList(if(t2.ip is null,GetGeoList(time_list,ltt_list,lgt_list)<br  /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,GetGeoLatest(GetGeoList(time_list,ltt_list,lgt_list),t2.geo_list,'500'))),',')[0] ltt_list<br  /> &nbsp; &nbsp;,split(SplitGeoList(if(t2.ip is null,GetGeoList(time_list,ltt_list,lgt_list)<br  /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ,GetGeoLatest(GetGeoList(time_list,ltt_list,lgt_list),t2.geo_list,'500'))),',')[1] lgt_list<br  /> &nbsp; &nbsp;from ods_ip_info_m t1<br  /> &nbsp; &nbsp; &nbsp;left join<br  /> &nbsp; &nbsp; &nbsp;(<br  /> &nbsp; &nbsp; &nbsp; &nbsp;select *<br  /> &nbsp; &nbsp; &nbsp; &nbsp;from bds_ip_info t2<br  /> &nbsp; &nbsp; &nbsp; &nbsp;where month=to_char(dateadd(dateadd(dateadd(to_date('$1','yyyymmdd'),1,'dd'),-1,'mm'),-1,'dd'),'yyyymmdd')<br  /> &nbsp; &nbsp; &nbsp; &nbsp;and is_latest_row='1'<br  /> &nbsp; &nbsp; &nbsp;) t2<br  /> &nbsp; &nbsp; &nbsp; &nbsp;on t1.ip=t2.ip<br  /> &nbsp; &nbsp; &nbsp;and abs(t1.radius-t2.radius)&lt;=200<br  /> &nbsp; &nbsp; &nbsp;and lipb_GetDistance(concat(t1.lgt_center,',',t1.ltt_center),concat(t2.lgt_center,',',t2.ltt_center))&lt;=400<br  /> &nbsp; &nbsp;where t1.month='$1'<br  /> &nbsp;) a lateral view MapMedianRadius(ltt_list,lgt_list,';') b as ltt_center,lgt_center,radius<br  />;<br  />insert overwrite &nbsp;table bds_ip_info partition(month,is_latest_row)<br  /> &nbsp;select a.ip,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; a.lgt_center,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; a.ltt_center,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; a.radius,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; a.b_month,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; a.e_month,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; a.geo_num,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; a.geo_list,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; a.month_from_list,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; '$1' month,<br  /> &nbsp; &nbsp; &nbsp; &nbsp; if(b.ip is null,'1',if(a.e_month&lt;&gt;b.e_month,'0','1')) is_latest_row<br  /> &nbsp;from<br  /> &nbsp;(<br  /> &nbsp; &nbsp;select * from bds_ip_info t1<br  /> &nbsp; &nbsp;where month=to_char(dateadd(dateadd(dateadd(to_date('$1','yyyymmdd'),1,'dd'),-1,'mm'),-1,'dd'),'yyyymmdd')<br  /> &nbsp; &nbsp;and is_latest_row='1'<br  /> &nbsp;) a<br  /> &nbsp; &nbsp;left join<br  /> &nbsp; &nbsp;(<br  /> &nbsp; &nbsp; &nbsp;select t1.ip,e_month from bds_ip_info t1 where t1.month='$1' and is_latest_row='1'<br  /> &nbsp; &nbsp;) b on a.ip=b.ip<br  />union all<br  />select * from bds_ip_info t1 where t1.month='$1' and is_latest_row='1'<br  />;</p></blockquote><p data-lake-id="u8357c32f" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><h2 data-lake-id="kxXCc" data-wording="true" style="padding: 7px 0px;margin: 0px;font-weight: 700;font-size: 24px;line-height: 32px;">5 典型案例</h2><p data-lake-id="ub7ae4e04" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">拉链表概念来源于数仓，数仓的面试也经常会被问到。拉链表也切实解决了数仓四大特性之一的反应历史变化这一诉求。</p><p data-lake-id="u19e9ae65" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u19e9ae65" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">但是，拉链表在数仓之外是否还有用武之地呢？事实上，数仓体系内的各种方法论、规范、核心技术等，在整个数据开发流程内始终有着巨大的指导借鉴意义。</p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">数仓人不应局限于数仓，可以跳出数仓来看问题。我是数仓人，但我一定要建数仓吗？我们更应该思考的是如何让组织内的数据能够相对低成本、高效率的使用起来，发挥更大的价值，我们构建的是组织内的一整套数据流转体系。</p><p data-lake-id="u88f8236b" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u1d90f4b6" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #F5222D;">案例一</span>：记录设备库核心属性的历史变更</p><p data-lake-id="u6ec732c6" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u6ec732c6" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">上边提到过，我们有一个设备库，需要记录核心属性的历史变更。记录历史变更有什么用呢？比如识别假冒设备，一部手机，imei、mac地址经常变化，很可能它不是一个真实的设备。</p><p data-lake-id="ub2d97f2a" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: rgb(38, 38, 38);font-size: 14px;letter-spacing: 0.7px;"><br  /></span></p><p data-lake-id="ub2d97f2a" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: rgb(38, 38, 38);font-size: 14px;letter-spacing: 0.7px;">由于设备库非常大，4.2 大数据数仓设计方案 是更好的选择。</span></p><p data-lake-id="ub2d97f2a" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: rgb(38, 38, 38);font-size: 14px;letter-spacing: 0.7px;"><br  /></span></p><p data-lake-id="ufb39d9d2" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #F5222D;">案例二</span>：记录商品成本价格的变化</p><p data-lake-id="u607b9c21" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u607b9c21" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">我们有销售订单，订单里只有销售价格，我们想要计算毛利润，就必须要有对应商品的成本价格，而商品的成本价，是随着每一次进货入库实时变更的（当时用到一个移动加权平均算法），比如该笔订单是昨天下午2点整完成的，那么我必须拿到该商品昨天下午2点整的时点值价格。</p><p data-lake-id="u4a1e928b" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u4a1e928b" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">该场景，我们的数据起止日期（t_start_date、t_end_date）就不适用了，因为理论上，商品价格一天可能会变更多次，必须改成数据起止时间（t_start_time、t_end_time），由此带来的数据处理逻辑的变化，上边 4.4 增量更新的处理逻辑就不适用了，必须改用 4.3 历史数据初始化方式了。</p><p data-lake-id="u4a1e928b" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u8c327816" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="letter-spacing: 0.05em;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">商品成本价格维表，数据量大概也就几万条数据吧，可以采用 4.1 传统数仓设计方案存储。</span><span style="letter-spacing: 0.05em;font-family: mp-quote, -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">当然也可以使用两张表，热表存放近一个月或近7天的成本价格数据，其它的都归档到冷表。</span><br  /></p><p data-lake-id="u5b1371ef" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p data-lake-id="u7efd7bef" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><span style="color: #F5222D;">案例三</span>：拉链表确实能解决你的问题，但是有没有别的方案呢？</p><h2 data-lake-id="z31XW" data-wording="true" style="padding: 7px 0px;margin: 0px;font-weight: 700;font-size: 24px;line-height: 32px;"><span data-card-type="inline" data-lake-card="image" data-card-value="data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2021%2Fpng%2F1535216%2F1622290071337-192a6b84-caba-4254-bc3e-e33c9ec24dd3.png%22%2C%22taskId%22%3A%22ub3573a7b-afbe-43f8-a711-fbcac5092f3%22%2C%22clientId%22%3A%22u6a083ebd-5980-4%22%2C%22originalType%22%3A%22binary%22%2C%22width%22%3A313.5%2C%22height%22%3A354%2C%22linkTarget%22%3A%22_blank%22%2C%22name%22%3A%22image.png%22%2C%22size%22%3A70077%2C%22from%22%3A%22paste%22%2C%22originWidth%22%3A627%2C%22originHeight%22%3A707%2C%22status%22%3A%22done%22%2C%22style%22%3A%22none%22%2C%22search%22%3A%22%E5%97%AF%E5%97%AF%2C%E5%85%84%E5%BC%9F%E4%BD%A0%E4%BB%AC%E9%82%A3%E8%BE%B9%E6%9C%89%E6%8B%89%E9%93%BE%E8%A1%A8%E5%90%97%20%E6%98%9F%E6%9C%9F%E4%BA%8C9%3A24%20%E7%9B%AE%E5%89%8D%E6%B2%A1%E6%9C%89%20%E4%BD%A0%E4%BB%AC%E6%9C%89%E7%94%A8%E6%8B%89%E9%93%BE%E8%A1%A8%E7%9A%84%E5%9C%BA%E6%99%AF%E5%90%97%20%E6%9C%89%20%E6%9C%89%E4%BA%9B%E6%88%91%E9%83%BD%E9%87%87%E7%94%A8%E5%A2%9E%E9%87%8F%E6%8A%BD%2C%E5%85%A8%E9%87%8F%E5%AD%98%E8%BF%99%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%9B%BF%E4%BB%A3%E4%BA%86%20%E4%BF%9D%E8%AF%81%E6%8A%BD%E6%95%B0%E6%97%B6%E9%97%B4%E7%BC%A9%E7%9F%AD%2C%E4%BF%9D%E8%AF%81%E6%95%B4%E4%BD%93%E9%93%BE%E8%B7%AF%E7%9A%84SLA%20%E6%88%91%E4%BB%AC%E9%87%91%E8%9E%8D%E4%B8%9A%E5%8A%A1%E6%9C%89%E4%B8%AA%E8%BF%98%E6%AC%BE%E8%AE%A1%E5%88%92%E8%A1%A8%2C%E5%B7%B2%E7%BB%8F%E4%B8%80%E4%B8%AA%E5%A4%9A%E4%BA%BF%20%E4%BA%86%2C%E8%BF%98%E6%98%AF%E6%AF%8F%E5%A4%A9%E5%85%A8%E9%87%8F%E5%AD%98%E7%9A%84%2C%E6%88%91%E7%9C%8B%E6%80%8E%E4%B9%88%E4%BC%98%E5%8C%96%E4%B8%8B%20%E8%BF%99%E4%B8%AA%E9%9C%80%E8%A6%81%E8%AE%B0%E5%BD%95%E5%8E%86%E5%8F%B2%E5%8F%98%E5%8C%96%E5%90%97%3F%20%E9%9C%80%E8%A6%81%2C%E6%AF%8F%E5%A4%A9%E9%83%BD%E4%BC%9A%E5%8F%91%E7%94%9F%E8%BF%98%E6%AC%BE%2C%E4%BD%99%E9%A2%9D%E5%92%8C%E4%B8%80%E4%BA%9B%E7%8A%B6%E6%80%81%E9%83%BD%20%E4%BC%9A%E5%8F%98%E5%8C%96%2C%E8%80%8C%E4%B8%94%E5%AF%B9%E4%BA%8E%E5%B7%B2%E7%BB%8F%E8%BF%98%E6%AC%BE%E7%9A%84%E5%80%9F%E6%8D%AE%2C%E6%95%B0%E6%8D%AE%E5%9F%BA%E6%9C%AC%20%E9%83%BD%E4%B8%8D%E5%8F%98%E4%BA%86%22%2C%22ocrLocations%22%3A%5B%7B%22x%22%3A20.02765%2C%22y%22%3A14.176216%2C%22width%22%3A253.25113%2C%22height%22%3A19.631013999999997%2C%22text%22%3A%22%E5%97%AF%E5%97%AF%2C%E5%85%84%E5%BC%9F%E4%BD%A0%E4%BB%AC%E9%82%A3%E8%BE%B9%E6%9C%89%E6%8B%89%E9%93%BE%E8%A1%A8%E5%90%97%22%7D%2C%7B%22x%22%3A247.34406%2C%22y%22%3A73.97944%2C%22width%22%3A80.18212%2C%22height%22%3A14.568979999999996%2C%22text%22%3A%22%E6%98%9F%E6%9C%9F%E4%BA%8C9%3A24%22%7D%2C%7B%22x%22%3A483.1058%2C%22y%22%3A118.5054%2C%22width%22%3A71.27024%2C%22height%22%3A20.434370000000015%2C%22text%22%3A%22%E7%9B%AE%E5%89%8D%E6%B2%A1%E6%9C%89%22%7D%2C%7B%22x%22%3A355.1122%2C%22y%22%3A256.75577%2C%22width%22%3A200.27910000000003%2C%22height%22%3A19.249300000000005%2C%22text%22%3A%22%E4%BD%A0%E4%BB%AC%E6%9C%89%E7%94%A8%E6%8B%89%E9%93%BE%E8%A1%A8%E7%9A%84%E5%9C%BA%E6%99%AF%E5%90%97%22%7D%2C%7B%22x%22%3A18.395323%2C%22y%22%3A319.9504%2C%22width%22%3A21.014742000000002%2C%22height%22%3A19.14440000000002%2C%22text%22%3A%22%E6%9C%89%22%7D%2C%7B%22x%22%3A19.641602%2C%22y%22%3A382.67798%2C%22width%22%3A360.88583800000004%2C%22height%22%3A19.941020000000037%2C%22text%22%3A%22%E6%9C%89%E4%BA%9B%E6%88%91%E9%83%BD%E9%87%87%E7%94%A8%E5%A2%9E%E9%87%8F%E6%8A%BD%2C%E5%85%A8%E9%87%8F%E5%AD%98%E8%BF%99%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%9B%BF%E4%BB%A3%E4%BA%86%22%7D%2C%7B%22x%22%3A35.255604%2C%22y%22%3A405.34793%2C%22width%22%3A324.363446%2C%22height%22%3A20.97542999999996%2C%22text%22%3A%22%E4%BF%9D%E8%AF%81%E6%8A%BD%E6%95%B0%E6%97%B6%E9%97%B4%E7%BC%A9%E7%9F%AD%2C%E4%BF%9D%E8%AF%81%E6%95%B4%E4%BD%93%E9%93%BE%E8%B7%AF%E7%9A%84SLA%22%7D%2C%7B%22x%22%3A19.47052%2C%22y%22%3A468.07434%2C%22width%22%3A362.88504%2C%22height%22%3A21.984379999999987%2C%22text%22%3A%22%E6%88%91%E4%BB%AC%E9%87%91%E8%9E%8D%E4%B8%9A%E5%8A%A1%E6%9C%89%E4%B8%AA%E8%BF%98%E6%AC%BE%E8%AE%A1%E5%88%92%E8%A1%A8%2C%E5%B7%B2%E7%BB%8F%E4%B8%80%E4%B8%AA%E5%A4%9A%E4%BA%BF%22%7D%2C%7B%22x%22%3A19.780733%2C%22y%22%3A493.2902%2C%22width%22%3A325.734437%2C%22height%22%3A21.06704000000002%2C%22text%22%3A%22%E4%BA%86%2C%E8%BF%98%E6%98%AF%E6%AF%8F%E5%A4%A9%E5%85%A8%E9%87%8F%E5%AD%98%E7%9A%84%2C%E6%88%91%E7%9C%8B%E6%80%8E%E4%B9%88%E4%BC%98%E5%8C%96%E4%B8%8B%22%7D%2C%7B%22x%22%3A336.19315%2C%22y%22%3A556.39935%2C%22width%22%3A208.65195%2C%22height%22%3A19.90414999999996%2C%22text%22%3A%22%E8%BF%99%E4%B8%AA%E9%9C%80%E8%A6%81%E8%AE%B0%E5%BD%95%E5%8E%86%E5%8F%B2%E5%8F%98%E5%8C%96%E5%90%97%3F%22%7D%2C%7B%22x%22%3A19.25338%2C%22y%22%3A618.2269%2C%22width%22%3A365.19465%2C%22height%22%3A22.37674000000004%2C%22text%22%3A%22%E9%9C%80%E8%A6%81%2C%E6%AF%8F%E5%A4%A9%E9%83%BD%E4%BC%9A%E5%8F%91%E7%94%9F%E8%BF%98%E6%AC%BE%2C%E4%BD%99%E9%A2%9D%E5%92%8C%E4%B8%80%E4%BA%9B%E7%8A%B6%E6%80%81%E9%83%BD%22%7D%2C%7B%22x%22%3A21.01597%2C%22y%22%3A643.2602%2C%22width%22%3A362.95840000000004%2C%22height%22%3A21.354099999999903%2C%22text%22%3A%22%E4%BC%9A%E5%8F%98%E5%8C%96%2C%E8%80%8C%E4%B8%94%E5%AF%B9%E4%BA%8E%E5%B7%B2%E7%BB%8F%E8%BF%98%E6%AC%BE%E7%9A%84%E5%80%9F%E6%8D%AE%2C%E6%95%B0%E6%8D%AE%E5%9F%BA%E6%9C%AC%22%7D%2C%7B%22x%22%3A20.07615%2C%22y%22%3A668.53143%2C%22width%22%3A71.21233000000001%2C%22height%22%3A18.116700000000037%2C%22text%22%3A%22%E9%83%BD%E4%B8%8D%E5%8F%98%E4%BA%86%22%7D%5D%2C%22id%22%3A%22uc62195ed%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%7D"><img class="rich_pages wxw-img" data-height="354px" data-ratio="1.127591706539075" src="图片/大数据技术与架构_2021-12-18_「转」数据仓库实践-拉链表设计/5_8BrJpAtYb8pDGQkKgcpS54oyXEcP9w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/qnZHkGT44TWHlDhUHiahsMF2xM9TKBeqTlCeCtXXKPvibyJJYE4c2m0Xpn8BrJpAtYb8pDGQkKgcpS54oyXEcP9w/640?wx_fmt=png'" data-type="png" data-w="627" style="visibility: visible;width: 313.5px;" title="image.png"></span></h2><p data-lake-id="u58de2a79" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp;</p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">上边是一位网友的问题，很快彭总的群里也有人问到了拉链表的设计，风大佬还在发言了，这让我回忆起曾经跟拉链表的各种纠葛，联想到网上这类文章太过零碎，就想尝试着写一下。但，写文章真的太难啦，就这简单的一个拉链表，从早八点写到凌晨两点。。。</p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp;言归正传，简单几句闲聊，隐约感觉到，这个需求根本不需要采用拉链表的。但本着实时求实的态度，了解详情后，给他了他更好的解决方案。经得本人同意，脱敏后，特分享给大家。</p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp;</p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp;业务上有一张贷款详情表，记录了大概七八个属性状态，每一次业务事件会导致状态发生变化，其实吧数仓也可以自己算的，但太麻烦还容易造成数据不一致，所以还是每日从业务库取时点值。业务库是主从结构，其中一个从库，当天的数据同步结束后会自动断开跟主库的连接，零点以后的状态变更会等待 ETL 抽数完成后重新开启。</p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp;业务库贷款详情表属性状态没有更新时间这个时间戳，业务系统也不愿意加字段，说是该表数据量太大，加这个字段可能会影响业务。这么大一顶帽子扣过来，咱也拿他没办法，只能每天全量抽。</p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp;但是吧，数据抽取，每天都是全量抽，后续 ETL 处理不能也也这么干呀。比如每天存一份全量快照，后续直接从快照出结果，有时候还要拿最近好多天的快照去跟别的表关联。好长一段时间的快照都得存着，因为独此一份啊，删了数据就丢了。由此带来了大量的存储、计算资源的开销，并且随着该表的持续膨胀，里边数据也没有清退机制，快照会越滚越大，而且还清贷款的数据，所有属性状态是不会再变动的。</p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp;以上是网友的困惑，为了提高计算效率，降低存储成本，他想要使用拉链表，记录历史变化。</p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;"><br  /></p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp;说实话，拉链表确实能解决他的问题，但引进董卓消灭了外戚，万一袁绍降不住大魔头咋办？</p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp;</p><p style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">下面是不用拉链表的问题解决思路。以截图开始，就让我们以截图结束吧。</p><p data-lake-id="ua34e971c" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;margin: 0px;">&nbsp; &nbsp; &nbsp;</p><p data-lake-id="u52d70e65" data-wording="true" style="font-size: 14px;color: rgb(38, 38, 38);line-height: 1.74;letter-spacing: 0.05em;outline-style: none;overflow-wrap: break-word;"><img class="rich_pages wxw-img" data-ratio="1.6953488372093024" src="图片/大数据技术与架构_2021-12-18_「转」数据仓库实践-拉链表设计/6_vk6uv35Po9gdGJoK5l58OOwya93ozQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/qnZHkGT44TWHlDhUHiahsMF2xM9TKBeqTQic900cWu2Pd1MCDczUGB4VX9vk6uv35Po9gdGJoK5l58OOwya93ozQ/640?wx_fmt=png'" data-type="png" data-w="430"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;max-width: 100%;white-space: normal;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;line-height: 1.6;letter-spacing: 0.034em;color: rgb(63, 63, 63);font-size: 16px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;max-width: 100%;line-height: 1.6;letter-spacing: 0.034em;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;outline: 0px;letter-spacing: 0.034em;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;line-height: 1.6;color: rgb(63, 63, 63);font-size: 16px;"><p data-tool="mdnice编辑器" style="padding-top: 1em;padding-bottom: 8px;outline: 0px;color: rgb(74, 74, 74);line-height: 1.75em;"><br  /></p></section><hr data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;outline: 0px;letter-spacing: 0.544px;white-space: normal;color: rgb(63, 63, 63);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 16px;background-color: rgb(255, 255, 255);height: 1px;border-width: initial;border-style: none;border-color: initial;text-align: center;background-image: linear-gradient(to right, rgba(93, 186, 133, 0), rgba(93, 186, 133, 0.75), rgba(93, 186, 133, 0));"  /><section style="padding-top: 1em;padding-bottom: 8px;outline: 0px;letter-spacing: 0.544px;white-space: normal;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 16px;text-align: left;background-color: rgb(255, 255, 255);color: rgb(74, 74, 74);line-height: 1.75em;"><span style="outline: 0px;font-size: 14px;">《大数据成神之路》正在全面PDF化。</span></section><section style="padding-top: 1em;padding-bottom: 8px;outline: 0px;letter-spacing: 0.544px;white-space: normal;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 16px;text-align: left;background-color: rgb(255, 255, 255);color: rgb(74, 74, 74);line-height: 1.75em;"><strong style="outline: 0px;font-size: 14px;letter-spacing: 0.034em;"><span style="outline: 0px;color: rgb(255, 104, 39);"><span style="outline: 0px;letter-spacing: 0.544px;text-align: center;">你只需要关注下面名片，后台回复「</span><strong style="outline: 0px;color: rgb(74, 74, 74);font-size: 15px;letter-spacing: 0.544px;text-align: center;line-height: 1.75em;">PDF</strong><span style="outline: 0px;letter-spacing: 0.544px;text-align: center;">」就可以看到阿里云盘下载链接了！</span></span></strong></section><section class="mp_profile_iframe_wrp"><mpprofile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzU3MzgwNTU2Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MrfCUBgMwsXeyxKKIxY5GNfl3g0zm1ibib46XO7tlIEs8ncmlp3Zzq8JJs0ibLbHdL4AWox8hSUIMDw/0?wx_fmt=png" data-nickname="大数据技术与架构" data-alias="import_bigdata" data-signature="大数据开发、大数据面试、大数据框架、大数据实时计算、大数据离线计算Flink/Spark/Hadoop/数仓开发，干货，面试，资料下载，源码解读等" data-from="0"></mpprofile></section><section style="padding-top: 1em;padding-bottom: 8px;outline: 0px;letter-spacing: 0.544px;white-space: normal;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 16px;text-align: left;background-color: rgb(255, 255, 255);color: rgb(74, 74, 74);line-height: 1.75em;"><span style="outline: 0px;font-size: 14px;"><span style="outline: 0px;letter-spacing: 0.544px;">目前我把这些文章按照体系全部整理好了。</span>现在你可以在公众号方便的进行查找：</span></section><p style="padding-right: 0.5em;padding-left: 0.5em;outline: 0px;font-family: -apple-system, &quot;system-ui&quot;, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;"><img class="rich_pages wxw-img" data-ratio="0.6712962962962963" src="图片/大数据技术与架构_2021-12-18_「转」数据仓库实践-拉链表设计/7_5ohqAK9m2Ev9aqTJG8tcPS7TXLnIMQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2OLF4eZl0FNVVnpXVouibicDUTpqeejBenX4TNEhJibwyl35GR5ohqAK9m2Ev9aqTJG8tcPS7TXLnIMQ/640?wx_fmt=png'" data-type="png" data-w="1080" style="outline: 0px;border-radius: 6px;box-shadow: rgb(180, 180, 180) 0em 0em 0.5em 0px;box-sizing: border-box !important;width: 485px !important;visibility: visible !important;"></p><p style="padding-right: 0.5em;padding-left: 0.5em;outline: 0px;font-family: -apple-system, &quot;system-ui&quot;, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);text-align: center;"><img class="rich_pages wxw-img" data-ratio="0.6574074074074074" src="图片/大数据技术与架构_2021-12-18_「转」数据仓库实践-拉链表设计/8_3OdIibibeR2VxicXpHibIvicUKNhWQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2OLF4eZl0FNVVnpXVouibicDUPfkt9rQXjbhuelonTVhvlVS3NeuV23OdIibibeR2VxicXpHibIvicUKNhWQ/640?wx_fmt=png'" data-type="png" data-w="1080" style="outline: 0px;border-radius: 6px;box-shadow: rgb(180, 180, 180) 0em 0em 0.5em 0px;box-sizing: border-box !important;width: 486px !important;visibility: visible !important;"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;outline: 0px;letter-spacing: 0.034em;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;line-height: 1.6;color: rgb(63, 63, 63);font-size: 16px;"><section style="padding-right: 10px;padding-left: 10px;outline: 0px;line-height: 1.6;letter-spacing: 0.034em;"><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;padding-right: 0.5em;padding-left: 0.5em;outline: 0px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><span style="outline: 0px;color: rgb(74, 74, 74);font-size: 14px;letter-spacing: 0.034em;">电子版把他们分类做成了下面这个样子，并且放在了阿里云盘提供下载。</span></figure><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;padding-right: 0.5em;padding-left: 0.5em;outline: 0px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.42314814814814816" src="图片/大数据技术与架构_2021-12-18_「转」数据仓库实践-拉链表设计/9_4MVicQg6rJLKMzliaaGos5dTCSr4WA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2OLF4eZl0FNVVnpXVouibicDUNdDTknrw0U7d59yjOzzLRiaL1ZA4MVicQg6rJLKMzliaaGos5dTCSr4WA/640?wx_fmt=png'" data-type="png" data-w="1080" style="margin-right: auto;margin-bottom: 25px;margin-left: auto;outline: 0px;display: block;border-radius: 16px;box-shadow: rgb(120, 120, 120) 0em 0em 0.5em 0px;font-size: 17px;box-sizing: border-box !important;visibility: visible !important;width: 479px !important;"><span style="outline: 0px;font-size: 14px;color: rgb(74, 74, 74);letter-spacing: 0.034em;text-align: left;">我们点开一个文件夹后:</span></figure><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;padding-right: 0.5em;padding-left: 0.5em;outline: 0px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.7435185185185185" src="图片/大数据技术与架构_2021-12-18_「转」数据仓库实践-拉链表设计/10_mOXP993eibEXcm12ye1Ip85tKUuvUA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2OLF4eZl0FNVVnpXVouibicDUmvOf8znic9w9fSXoNIhGwabRcRmOXP993eibEXcm12ye1Ip85tKUuvUA/640?wx_fmt=png'" data-type="png" data-w="1080" style="margin-right: auto;margin-bottom: 25px;margin-left: auto;outline: 0px;display: block;border-radius: 16px;box-shadow: rgb(120, 120, 120) 0em 0em 0.5em 0px;font-size: 17px;box-sizing: border-box !important;visibility: visible !important;width: 452px !important;"></figure><strong style="outline: 0px;color: rgb(74, 74, 74);font-size: 14px;letter-spacing: 0.034em;"><span style="outline: 0px;color: rgb(255, 104, 39);"><span style="outline: 0px;letter-spacing: 0.544px;text-align: center;">你只需要在后台回复「</span><strong style="outline: 0px;color: rgb(74, 74, 74);font-size: 15px;letter-spacing: 0.544px;text-align: center;line-height: 1.75em;">PDF</strong><span style="outline: 0px;letter-spacing: 0.544px;text-align: center;">」就可以看到阿里云盘下载链接了！</span></span></strong></section><blockquote data-tool="mdnice编辑器" style="margin-top: 20px;margin-bottom: 20px;padding: 15px 20px;outline: 0px;border-left-color: rgb(53, 179, 120);color: rgb(106, 115, 125);font-size: 0.9em;line-height: 27px;border-top: none;border-right: none;border-bottom: none;overflow: auto;background: rgb(251, 249, 253);"><section style="outline: 0px;line-height: 26px;font-size: 15px;color: rgb(89, 89, 89);"><strong style="outline: 0px;"><span style="outline: 0px;font-size: 14px;">Hi，我是王知无，一个大数据领域的原创作者。&nbsp;</span></strong></section><section style="outline: 0px;line-height: 26px;font-size: 15px;color: rgb(89, 89, 89);"><strong style="outline: 0px;"><span style="outline: 0px;font-size: 14px;">放心关注我，获取更多行业的一手消息。</span></strong></section></blockquote></section></section></section></content>
</div>
</body>
</html>