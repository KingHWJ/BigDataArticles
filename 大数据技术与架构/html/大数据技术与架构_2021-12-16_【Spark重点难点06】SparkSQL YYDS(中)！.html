<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 0 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic{color:#8e8e8e;background:#f7f7f7;border-radius:5px;padding:10px 8px;}.topic a{padding-right:5px;}.topic p{margin-bottom:5px;}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head><script>
var data={"mp":"大数据技术与架构","title":"【Spark重点难点06】SparkSQL YYDS(中)！","time":"2021-12-16 08:12:48","timeStamp":"1639613568"};
</script>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&mid=2247508865&idx=1&sn=405e3b4c985b6c44c11ed72e294f958f&chksm=fd3ee514ca496c028eadb02ae95b8c3808d79f0b8904a8a08d8972bb076e2e14a3726e7daf7f#rd" target="_blank">【Spark重点难点06】SparkSQL YYDS(中)！</a></h1><div id="meta_content" class="rich_media_meta_list"><span id="copyright_logo" class="wx_tap_link js_wx_tap_highlight rich_media_meta icon_appmsg_tag appmsg_title_tag weui-wa-hotarea">原创&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_text">群主王知无&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">大数据技术与架构&nbsp;&nbsp;</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-12-16 08:12:48</em></div><content><div class="topic"><p>收录于话题</p><p><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU3MzgwNTU2Mg==&action=getalbum&album_id=1369031183400747008#wechat_redirect" title="大数据成神之路" target="_blank">#大数据成神之路</a><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU3MzgwNTU2Mg==&action=getalbum&album_id=1679098221391855620#wechat_redirect" title="大数据" target="_blank">#大数据</a></p></div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;line-height: 1.6;letter-spacing: 0.034em;color: rgb(63, 63, 63);font-size: 16px;" data-mpa-powered-by="yiban.io"><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;"><span style="outline: 0px;color: rgb(74, 74, 74);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;letter-spacing: 0.544px;text-align: left;background-color: rgb(255, 255, 255);font-size: 15px;">本文已经加入「大数据成神之路PDF版」中提供下载。</span></span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;"><strong style="outline: 0px;color: rgb(74, 74, 74);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 16px;letter-spacing: 0.544px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);"><span style="outline: 0px;font-size: 15px;color: rgb(255, 104, 39);">你可以关注公众号，后台回复：「<strong style="outline: 0px;line-height: 1.75em;">PDF</strong>」即可获取。</span></strong></span><strong style="letter-spacing: 0.544px;outline: 0px;background-color: rgb(255, 255, 255);"><span style="outline: 0px;font-size: 15px;color: rgb(255, 104, 39);"></span></strong></p><section class="mp_profile_iframe_wrp"><mpprofile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzU3MzgwNTU2Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MrfCUBgMwsXeyxKKIxY5GNfl3g0zm1ibib46XO7tlIEs8ncmlp3Zzq8JJs0ibLbHdL4AWox8hSUIMDw/0?wx_fmt=png" data-nickname="大数据技术与架构" data-alias="import_bigdata" data-signature="大数据开发、大数据面试、大数据框架、大数据实时计算、大数据离线计算Flink/Spark/Hadoop/数仓开发，干货，面试，资料下载，源码解读等" data-from="0"></mpprofile></section><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">更多PDF下载可以参考：</span><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508675&amp;idx=1&amp;sn=520f7caf9cbadec68ea14bfa0e3ec4e4&amp;chksm=fd3ee456ca496d40a9a98436e765e5101ac911ca8c24df9cf100b86c6b83f58485e70b6e799d&amp;token=426407136&amp;lang=zh_CN&amp;scene=21#wechat_redirect" style="font-weight: bold;color: rgb(72, 179, 120);border-bottom: 1px solid rgb(72, 179, 120);font-size: 15px;" data-linktype="2"><span style="font-size: 15px;">《重磅,大数据成神之路PDF可以分类下载啦!》</span></a><br  /></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">Spark重点难点系列：</span></p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><a href="https://mp.weixin.qq.com/s?__biz=MzI0NjU2NDkzMQ==&amp;mid=2247495063&amp;idx=1&amp;sn=992d7bcccbface7353485b31225d42b9&amp;scene=21#wechat_redirect" style="font-weight: bold;color: rgb(72, 179, 120);border-bottom: 1px solid rgb(72, 179, 120);font-size: 15px;" data-linktype="2"><span style="font-size: 15px;">《【Spark重点难点01】你从未深入理解的RDD和关键角色》</span></a></section></li><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508303&amp;idx=1&amp;sn=26ea211c966a24705f0fbb26504b433f&amp;scene=21#wechat_redirect" style="font-weight: bold;color: rgb(72, 179, 120);border-bottom: 1px solid rgb(72, 179, 120);font-size: 15px;" data-linktype="2"><span style="font-size: 15px;">《【Spark重点难点02】你以为的Shuffle和真正的Shuffle》</span></a></section></li><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508382&amp;idx=1&amp;sn=4ca3a18b3d36a18feddd1cea5ce11eee&amp;chksm=fd3ee70bca496e1d68e5e99c4b46353eb6140f6810d28734077311925588ff1f6af7970c47a5&amp;token=251449232&amp;lang=zh_CN&amp;scene=21#wechat_redirect" style="font-weight: bold;color: rgb(72, 179, 120);border-bottom: 1px solid rgb(72, 179, 120);font-size: 15px;" data-linktype="2"><span style="font-size: 15px;">《【Spark重点难点03】你的数据存在哪了?》</span></a></section></li><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508467&amp;idx=1&amp;sn=ec70ca42aea250ea0e6da98c2114eb47&amp;chksm=fd3ee766ca496e70ef93570ea0bd0c42764499b05959220e39126171133bee0182e77aba663e&amp;token=1296698652&amp;lang=zh_CN&amp;scene=21#wechat_redirect" style="font-weight: bold;color: rgb(72, 179, 120);border-bottom: 1px solid rgb(72, 179, 120);font-size: 15px;" data-linktype="2"><span style="font-size: 15px;">《【Spark重点难点04】你的代码跑起来谁说了算？(内存管理)》</span></a></section></li><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508803&amp;idx=1&amp;sn=f9c068788217a488c0d42fba79477bc6&amp;chksm=fd3ee5d6ca496cc01d52d1ccc713e506f25d900b4961b3cf36502be4d5fba161a79189b9ef22&amp;token=2010089950&amp;lang=zh_CN&amp;scene=21#wechat_redirect" style="font-weight: bold;color: rgb(72, 179, 120);border-bottom: 1px solid rgb(72, 179, 120);font-size: 15px;" data-linktype="2"><span style="font-size: 15px;">《【Spark重点难点05】SparkSQL YYDS(上)！》</span></a></section></li></ul><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">在上节课中我们讲解了Spark SQL的来源，Spark DataFrame创建的方式以及常用的算子。这节课继续<strong style="outline: 0px;color: rgb(74, 74, 74);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 15px;letter-spacing: 0.544px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);">讲解Spark SQL中的Catalyst优化器和Tungsten，以及Spark SQL的Join策略选择。</strong></span></p><h2 data-tool="mdnice编辑器" style="font-weight: bold;color: black;font-size: 22px;text-align: center;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2NAovQ2PCibXIJj9JB0fkX4ozA3H0EJNLTb0EV9yTd07wibSQJ5VIlPTuEaCgLowXibMjLCaSic99LMicw/640?wx_fmt=png&quot;);background-position: center center;background-repeat: no-repeat;background-attachment: initial;background-origin: initial;background-clip: initial;background-size: 50px;margin-top: 1em;margin-bottom: 10px;"><span style="display: inline-block;height: 38px;line-height: 42px;color: rgb(72, 179, 120);background-position: left center;background-repeat: no-repeat;background-attachment: initial;background-origin: initial;background-clip: initial;background-size: 63px;margin-top: 38px;font-size: 18px;margin-bottom: 10px;">Spark SQL的关联</span></h2><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">你大概从茫茫多的网上博客中可以看到Spark SQL支持的Join有哪几种？比如NLJ(Nested Loop Join)、SMJ(Sort Merge Join)和 HJ(Hash Join)，一会又是
Shuffle Join、Broadcast Join。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">好了，你是不是已经懵逼了。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">下面我来告诉大家这些是怎么分类的：</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">在分布式环境中，Spark支持两类数据分发模式:<strong style="line-height: 1.75em;">Shuffle</strong>和<strong style="line-height: 1.75em;">Broadcast</strong>。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">因此，</span><span style="font-size: 15px;color: rgb(255, 104, 39);"><strong style="line-height: 1.75em;">从数据分发模式的角度出发</strong></span><span style="font-size: 15px;">，数据关联可以分为<strong style="line-height: 1.75em;">Shuffle Join</strong>和<strong style="line-height: 1.75em;">Broadcast Join</strong>这两大类。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;color: rgb(255, 104, 39);"><strong style="line-height: 1.75em;">从实现机制来看</strong></span><span style="font-size: 15px;">，Join又可以分为<strong style="line-height: 1.75em;">NLJ(Nested Loop Join)</strong>、<strong style="line-height: 1.75em;">SMJ(Sort Merge Join)<strong style="line-height: 1.75em;">和</strong>HJ(Hash Join)</strong>。</span></p><blockquote data-tool="mdnice编辑器" style="border-top: none;border-right: none;border-bottom: none;font-size: 0.9em;overflow: auto;background: rgb(251, 249, 253);color: rgb(106, 115, 125);margin-bottom: 20px;margin-top: 20px;padding: 15px 20px;line-height: 27px;border-left-color: rgb(53, 179, 120);"><p style="line-height: 26px;font-size: 15px;color: rgb(89, 89, 89);"><span style="font-size: 14px;">上面的<strong>2种分发模式和3种实现机制的笛卡尔积</strong>，就构成了Spark支持的5种Join策略。(图中白色BroadCast SMJ不支持)。</span></p></blockquote><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">如图所示：</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.27155172413793105" src="图片/大数据技术与架构_2021-12-16_【Spark重点难点06】SparkSQL YYDS(中)！/1_QwW7gVugtuwzECvWZpvnK9VibLnFdA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2NAovQ2PCibXIJj9JB0fkX4oGBqc7sBJD601Fnhhd25a6zcA2QwW7gVugtuwzECvWZpvnK9VibLnFdA/640?wx_fmt=png'" data-type="png" data-w="1392" style="display: block;margin-right: auto;margin-left: auto;border-radius: 4px;margin-bottom: 25px;"  /></figure><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">这五种关联机制，Spark会怎么选择呢？</span></p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><span style="font-size: 15px;">等值关联：Broadcast HJ &gt; Shuffle SMJ &gt; Shuffle HJ</span></section></li><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><span style="font-size: 15px;">不等值关联：Broadcast NLJ &gt; Shuffle NLJ</span></section></li></ul><h2 data-tool="mdnice编辑器" style="font-weight: bold;color: black;font-size: 22px;text-align: center;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2NAovQ2PCibXIJj9JB0fkX4ozA3H0EJNLTb0EV9yTd07wibSQJ5VIlPTuEaCgLowXibMjLCaSic99LMicw/640?wx_fmt=png&quot;);background-position: center center;background-repeat: no-repeat;background-attachment: initial;background-origin: initial;background-clip: initial;background-size: 50px;margin-top: 1em;margin-bottom: 10px;"><span style="display: inline-block;height: 38px;line-height: 42px;color: rgb(72, 179, 120);background-position: left center;background-repeat: no-repeat;background-attachment: initial;background-origin: initial;background-clip: initial;background-size: 63px;margin-top: 38px;font-size: 18px;margin-bottom: 10px;">我们重点看看关联机制</span></h2><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">Nested Loop Join</span></h3><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">在探讨关联机制的时候，我们又常常把左表称作是"驱动表"，而把右表称为"基表"。一般来说，驱动表的体量往往较大，在实现关联的过程中，驱动表是主动扫描数据的那一方。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">Nested Loop Join会使用外、内两个嵌套的for循环，来依次扫描驱动表与基表中的数据记录。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">假设驱动表有M行数据，而基表有N行数据，那么NLJ算法的计算复杂度是O(M * N)。尽管 NLJ 的实现方式简单、直观、易懂，但它的执行效率显然很差。</span></p><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">Sort Merge Join</span></h3><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">当两个表都非常大时，SparkSQL采用了一种全新的方案来对表进行Join，即Sort Merge Join。这种实现方式不用将一侧数据全部加载后再进行hash join，但需要在join前将<strong style="line-height: 1.75em;">数据排序</strong>。可以看到，首先将两张表按照join keys进行了重新shuffle，保证join keys值相同的记录会被分在相应的分区。分区后对每个分区内的数据进行排序，排序后再对相应的分区内的记录进行连接。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">因为两个序列都是有序的，从头遍历，碰到key相同的就输出；如果不同，左边小就继续取左边，反之取右边。可以看出，无论分区有多大，Sort Merge Join都不用把某一侧的数据全部加载到内存中，而是即用即取即丢弃，从而大大提升了大数据量下sql join的稳定性。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">Sort Merge Join算法的计算复杂度为O(M + N)。</span></p><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">Hash Join</span></h3><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">HJ 的设计初衷是以空间换时间，力图将基表扫描的计算复杂度降低至 O(1)。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">HJ 的计算分为两个阶段，分别是 Build 阶段和 Probe 阶段。在 Build 阶段，在基表之上，算法使用既定的哈希函数构建哈希表。哈希表中的 Key 是 id 字段应用哈希函数之后的哈希值，而哈希表的Value同时包含了原始的Join Key和Payload。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">在Probe阶段，算法依次遍历驱动表的每一条数据记录。首先使用同样的哈希函数，以动态的方式计算 Join Key 的哈希值。然后，算法再用哈希值去查询刚刚在 Build 阶段创建好的哈希表。如果查询失败，则说明该条记录与基表中的数据不存在关联关系；相反，如果查询成功，则继续对比两边的 Join Key。如果 Join Key 一致，就把两边的记录进行拼接并输出，从而完成数据关联。</span></p><h2 data-tool="mdnice编辑器" style="font-weight: bold;color: black;font-size: 22px;text-align: center;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2NAovQ2PCibXIJj9JB0fkX4ozA3H0EJNLTb0EV9yTd07wibSQJ5VIlPTuEaCgLowXibMjLCaSic99LMicw/640?wx_fmt=png&quot;);background-position: center center;background-repeat: no-repeat;background-attachment: initial;background-origin: initial;background-clip: initial;background-size: 50px;margin-top: 1em;margin-bottom: 10px;"><span style="display: inline-block;height: 38px;line-height: 42px;color: rgb(72, 179, 120);background-position: left center;background-repeat: no-repeat;background-attachment: initial;background-origin: initial;background-clip: initial;background-size: 63px;margin-top: 38px;font-size: 18px;margin-bottom: 10px;">SparkSQL的优化器</span></h2><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">Catalyst优化器</span></h3><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">Catalyst优化器，主要用来创建并优化执行计划，包含：创建语法树并生成执行计划、逻辑阶段优化和物理阶段优化。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">Catalyst优化器的核心工作流程包括：</span></p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><span style="font-size: 15px;">解析SQL,并且生成AST(抽象语法树)</span></section></li><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><span style="font-size: 15px;">把元数据信息（列的标识和类型）添加到AST(抽象语法树)中</span></section></li><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><span style="font-size: 15px;">对已经加入元数据的AST,输入优化器,进行优化</span></section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">这里的优化包括：</span></p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><span style="font-size: 15px;">谓词下推 Predicate Pushdown, 将 Filter 这种可以减小数据集的操作下推, 放在 Scan（表） 的位置, 这样可以减少操作时候的数据量</span></section></li><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><span style="font-size: 15px;">列值裁剪 Column Pruning, 在谓词下推后,可以把表中没有用到的列裁剪掉, 这样可以减少处理的数据量, 从而优化处理速度</span></section></li></ul><ol start="4" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><span style="font-size: 15px;">由逻辑执行计划生成物理计划,从而生成RDD来运行</span></section></li></ol><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">Tungsten</span></h3><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">有一段时间，Tungsten被称为Spark有史以来最大的改动。其致力于提升Spark程序对内存和CPU的利用率，使性能达到硬件的极限，主要包含以下三个方面:</span></p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><span style="font-size: 15px;"><strong style="line-height: 1.75em;color: rgb(74, 74, 74);">Memory Management and Binary Processing</strong>: off-heap管理内存，降低对象的开销和消除JVM GC带来的延时。</span></section></li><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><span style="font-size: 15px;"><strong style="line-height: 1.75em;color: rgb(74, 74, 74);">Cache-aware computation</strong>: 优化存储，提升CPU L1/ L2/L3缓存命中率。</span></section></li><li style="font-size: 15px;"><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><span style="font-size: 15px;"><strong style="line-height: 1.75em;color: rgb(74, 74, 74);">Code generation</strong>: 优化Spark SQL的代码生成部分，提升CPU利用率。</span></section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">Tungsten设计并实现了一种叫做<strong style="line-height: 1.75em;">Unsafe Row</strong>的二进制数据结构。<strong style="line-height: 1.75em;">Unsafe Row本质上是字节数组，它以极其紧凑的格式来存储DataFrame的每一条数据记录，大幅削减存储开销，从而提升数据的存储与访问效率</strong>。</span></p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="font-size: 15px;">与默认的Java Object相比，二进制的Unsafe Row以更加紧凑的方式来存储数据记录，大幅提升了数据的存储与访问效率。</span></p></section><hr data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;outline: 0px;color: rgb(63, 63, 63);font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 16px;letter-spacing: 0.544px;white-space: normal;background-color: rgb(255, 255, 255);height: 1px;border-width: initial;border-style: none;border-color: initial;text-align: center;background-image: linear-gradient(to right, rgba(93, 186, 133, 0), rgba(93, 186, 133, 0.75), rgba(93, 186, 133, 0));"  /><section style="padding-top: 1em;padding-bottom: 8px;outline: 0px;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 16px;letter-spacing: 0.544px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(74, 74, 74);line-height: 1.75em;"><span style="outline: 0px;font-size: 14px;">《大数据成神之路》正在全面PDF化，</span><strong style="outline: 0px;font-size: 14px;letter-spacing: 0.034em;"><span style="outline: 0px;color: rgb(255, 104, 39);"><span style="outline: 0px;letter-spacing: 0.544px;text-align: center;">你只需要在后台回复「</span><strong style="outline: 0px;color: rgb(74, 74, 74);font-size: 15px;letter-spacing: 0.544px;text-align: center;line-height: 1.75em;">PDF</strong><span style="outline: 0px;letter-spacing: 0.544px;text-align: center;">」就可以看到阿里云盘下载链接了！</span></span></strong></section><section style="padding-top: 1em;padding-bottom: 8px;outline: 0px;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;font-size: 16px;letter-spacing: 0.544px;text-align: left;white-space: normal;background-color: rgb(255, 255, 255);color: rgb(74, 74, 74);line-height: 1.75em;"><span style="outline: 0px;font-size: 14px;"><span style="outline: 0px;letter-spacing: 0.544px;">目前我把这些文章按照体系全部整理好了。</span>现在你可以在公众号方便的进行查找：</span></section><p style="padding: 0px 0.5em;text-align: center;"><img class="rich_pages wxw-img" data-ratio="0.6712962962962963" src="图片/大数据技术与架构_2021-12-16_【Spark重点难点06】SparkSQL YYDS(中)！/2_5ohqAK9m2Ev9aqTJG8tcPS7TXLnIMQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2OLF4eZl0FNVVnpXVouibicDUTpqeejBenX4TNEhJibwyl35GR5ohqAK9m2Ev9aqTJG8tcPS7TXLnIMQ/640?wx_fmt=png'" data-type="png" data-w="1080" style="width: 485px;height: 326px;border-radius: 6px;box-shadow: rgb(180, 180, 180) 0em 0em 0.5em 0px;font-size: 17px;"  /></p><p style="padding: 0px 0.5em;text-align: center;"><img class="rich_pages wxw-img" data-ratio="0.6574074074074074" src="图片/大数据技术与架构_2021-12-16_【Spark重点难点06】SparkSQL YYDS(中)！/3_3OdIibibeR2VxicXpHibIvicUKNhWQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2OLF4eZl0FNVVnpXVouibicDUPfkt9rQXjbhuelonTVhvlVS3NeuV23OdIibibeR2VxicXpHibIvicUKNhWQ/640?wx_fmt=png'" data-type="png" data-w="1080" style="border-radius: 6px;box-shadow: rgb(180, 180, 180) 0em 0em 0.5em 0px;font-size: 17px;width: 486px;height: 320px;"  /></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;outline: 0px;letter-spacing: 0.034em;white-space: normal;background-color: rgb(255, 255, 255);text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;line-height: 1.6;color: rgb(63, 63, 63);font-size: 16px;"><section style="padding-right: 10px;padding-left: 10px;outline: 0px;line-height: 1.6;letter-spacing: 0.034em;"><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;padding-right: 0.5em;padding-left: 0.5em;outline: 0px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><span style="outline: 0px;color: rgb(74, 74, 74);font-size: 14px;letter-spacing: 0.034em;text-align: left;">电子版把他们分类做成了下面这个样子，并且放在了阿里云盘提供下载。</span></figure><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;padding: 0px 0.5em;outline: 0px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.42314814814814816" src="图片/大数据技术与架构_2021-12-16_【Spark重点难点06】SparkSQL YYDS(中)！/4_4MVicQg6rJLKMzliaaGos5dTCSr4WA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2OLF4eZl0FNVVnpXVouibicDUNdDTknrw0U7d59yjOzzLRiaL1ZA4MVicQg6rJLKMzliaaGos5dTCSr4WA/640?wx_fmt=png'" data-type="png" data-w="1080" style="margin-right: auto;margin-bottom: 25px;margin-left: auto;outline: 0px;display: block;border-radius: 16px;box-shadow: rgb(120, 120, 120) 0em 0em 0.5em 0px;font-size: 17px;box-sizing: border-box !important;width: 479px;visibility: visible !important;height: 203px;"  /><span style="outline: 0px;font-size: 14px;color: rgb(74, 74, 74);letter-spacing: 0.034em;">我们点开一个文件夹后:</span></figure><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;padding: 0px 0.5em;outline: 0px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.7435185185185185" src="图片/大数据技术与架构_2021-12-16_【Spark重点难点06】SparkSQL YYDS(中)！/5_mOXP993eibEXcm12ye1Ip85tKUuvUA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2OLF4eZl0FNVVnpXVouibicDUmvOf8znic9w9fSXoNIhGwabRcRmOXP993eibEXcm12ye1Ip85tKUuvUA/640?wx_fmt=png'" data-type="png" data-w="1080" style="margin-right: auto;margin-bottom: 25px;margin-left: auto;outline: 0px;display: block;border-radius: 16px;box-shadow: rgb(120, 120, 120) 0em 0em 0.5em 0px;font-size: 17px;box-sizing: border-box !important;width: 452px;visibility: visible !important;height: 336px;"  /></figure><strong style="outline: 0px;color: rgb(74, 74, 74);font-size: 14px;letter-spacing: 0.034em;"><span style="outline: 0px;color: rgb(255, 104, 39);"><span style="outline: 0px;letter-spacing: 0.544px;text-align: center;">你只需要在后台回复「</span><strong style="outline: 0px;color: rgb(74, 74, 74);font-size: 15px;letter-spacing: 0.544px;text-align: center;line-height: 1.75em;">PDF</strong><span style="outline: 0px;letter-spacing: 0.544px;text-align: center;">」就可以看到阿里云盘下载链接了！</span></span></strong></section><blockquote data-tool="mdnice编辑器" style="margin-top: 20px;margin-bottom: 20px;padding: 15px 20px;outline: 0px;border-left-color: rgb(53, 179, 120);color: rgb(106, 115, 125);font-size: 0.9em;line-height: 27px;border-top: none;border-right: none;border-bottom: none;overflow: auto;background: rgb(251, 249, 253);"><section style="outline: 0px;line-height: 26px;font-size: 15px;color: rgb(89, 89, 89);"><strong style="outline: 0px;"><span style="outline: 0px;font-size: 14px;">Hi，我是王知无，一个大数据领域的原创作者。&nbsp;</span></strong></section><section style="outline: 0px;line-height: 26px;font-size: 15px;color: rgb(89, 89, 89);"><strong style="outline: 0px;"><span style="outline: 0px;font-size: 14px;">放心关注我，获取更多行业的一手消息。</span></strong></section></blockquote></section></content>
</div>
</body>
</html>