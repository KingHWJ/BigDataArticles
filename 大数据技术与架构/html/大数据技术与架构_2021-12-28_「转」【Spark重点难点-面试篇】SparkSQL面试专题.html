<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 0 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic{color:#8e8e8e;background:#f7f7f7;border-radius:5px;padding:10px 8px;}.topic a{padding-right:5px;}.topic p{margin-bottom:5px;}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head><script>
var data={"mp":"大数据技术与架构","title":"【Spark重点难点-面试篇】SparkSQL面试专题","time":"2021-12-28 08:30:00","timeStamp":"1640651400"};
</script>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&mid=2247509759&idx=2&sn=efe0108d4b9e4a19a398fb83cff3e393&chksm=fd3ee06aca49697c69d71890137d5a4711239ef6e4b24f0964a511f39a1b0f4f0a3a79fb3d4d#rd" target="_blank">【Spark重点难点-面试篇】SparkSQL面试专题</a></h1><div id="meta_content" class="rich_media_meta_list"><span class="rich_media_meta rich_media_meta_text">大数据真好玩&nbsp;&nbsp;</span><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">大数据技术与架构&nbsp;&nbsp;</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2021-12-28 08:30:00</em></div><content><div class="reprint"><p>转自公众号：大数据真好玩<br><a href="http://mp.weixin.qq.com/s?__biz=MzI0NjU2NDkzMQ==&mid=2247493957&idx=1&sn=790cc8fdea7c60bfc1a16b446ceaedac" target="_blank" title="阅读原文">http://mp.weixin.qq.com/s?__biz=MzI0NjU2NDkzMQ==&mid=2247493957&idx=1&sn=790cc8fdea7c60bfc1a16b446ceaedac</a></p></div><section style="max-width: 100%;color: rgb(178, 178, 178);outline: 0px;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 14px;line-height: normal;font-family: &quot;Helvetica Neue&quot;;-webkit-text-stroke-color: rgb(178, 178, 178);text-align: center;background-color: rgb(255, 255, 255);margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;" data-mpa-powered-by="yiban.io"><span style="max-width: 100%;outline: 0px;font-kerning: none;overflow-wrap: break-word !important;box-sizing: border-box !important;">点击上方</span><strong style="max-width: 100%;outline: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="max-width: 100%;outline: 0px;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 15px;line-height: normal;font-kerning: none;color: rgb(87, 107, 148);-webkit-text-stroke-color: rgb(87, 107, 148);overflow-wrap: break-word !important;box-sizing: border-box !important;">蓝色字体</span></strong><span style="max-width: 100%;outline: 0px;font-kerning: none;overflow-wrap: break-word !important;box-sizing: border-box !important;">，选择“设为星标”</span></section><section style="max-width: 100%;color: rgb(178, 178, 178);outline: 0px;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 14px;line-height: normal;font-family: &quot;Helvetica Neue&quot;;-webkit-text-stroke-color: rgb(178, 178, 178);text-align: center;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="max-width: 100%;outline: 0px;font-kerning: none;background-color: rgb(255, 255, 255);overflow-wrap: break-word !important;box-sizing: border-box !important;">回复”</span><strong style="max-width: 100%;outline: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="max-width: 100%;outline: 0px;font-kerning: none;background-color: rgb(255, 255, 255);color: rgb(255, 0, 0);overflow-wrap: break-word !important;box-sizing: border-box !important;">面试</span></strong><span style="max-width: 100%;outline: 0px;font-kerning: none;background-color: rgb(255, 255, 255);overflow-wrap: break-word !important;box-sizing: border-box !important;">“获取更多惊喜</span></section><section style="max-width: 100%;color: rgb(178, 178, 178);outline: 0px;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 14px;line-height: normal;font-family: &quot;Helvetica Neue&quot;;-webkit-text-stroke-color: rgb(178, 178, 178);text-align: center;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="max-width: 100%;outline: 0px;font-kerning: none;background-color: rgb(255, 255, 255);overflow-wrap: break-word !important;box-sizing: border-box !important;"><img class="rich_pages wxw-img" data-ratio="0.0625" src="图片/大数据技术与架构_2021-12-28_「转」【Spark重点难点-面试篇】SparkSQL面试专题/1_TMnLIpBq96wT1ibdccSSd3LVdSE3LQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/sq2uE6cicHYxoldXibjHyWbvjJfI6ibEm5Kw715uVJTBLdX1gkVpExwlFh22TMnLIpBq96wT1ibdccSSd3LVdSE3LQ/640?wx_fmt=png'" data-type="png" data-w="640" style="outline: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;width: 640px !important;visibility: visible !important;"  /></span></section><blockquote style="margin-top: 20px;margin-bottom: 20px;padding: 15px 20px;border-left-color: rgb(53, 179, 120);color: rgb(106, 115, 125);line-height: 27px;font-size: 0.9em;max-width: 100%;border-top: none;border-right: none;border-bottom: none;overflow: auto;background: rgb(251, 249, 253);letter-spacing: 0.544px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;font-size: 15px;line-height: 26px;color: rgb(89, 89, 89);margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;text-align: left;"><span style="max-width: 100%;font-size: 14px;overflow-wrap: break-word !important;box-sizing: border-box !important;">本文已经加入「大数据成神之路PDF版」中提供下载。<br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /><strong>你可以关注公众号，后台回复：</strong></span><span style="color: rgb(255, 76, 65);max-width: 100%;font-size: 14px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><strong style="max-width: 100%;color: rgb(74, 74, 74);line-height: 1.75em;overflow-wrap: break-word !important;box-sizing: border-box !important;">「</strong><strong>PDF</strong><strong style="max-width: 100%;color: rgb(74, 74, 74);line-height: 1.75em;overflow-wrap: break-word !important;box-sizing: border-box !important;">」</strong>&nbsp;</span><strong><span style="max-width: 100%;font-size: 14px;overflow-wrap: break-word !important;box-sizing: border-box !important;">即可获取。</span></strong></section></blockquote><section style="padding-top: 8px;padding-bottom: 8px;max-width: 100%;line-height: 26px;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;text-align: left;"><span style="max-width: 100%;font-size: 15px;overflow-wrap: break-word !important;box-sizing: border-box !important;">更多PDF下载可以参考：</span><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508675&amp;idx=1&amp;sn=520f7caf9cbadec68ea14bfa0e3ec4e4&amp;chksm=fd3ee456ca496d40a9a98436e765e5101ac911ca8c24df9cf100b86c6b83f58485e70b6e799d&amp;token=426407136&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2" style="color: rgb(30, 107, 184);max-width: 100%;font-weight: bold;border-bottom: 1px solid rgb(30, 107, 184);font-size: 15px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">《重磅,大数据成神之路PDF可以分类下载啦!》</span></a><br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="padding-top: 8px;padding-bottom: 8px;max-width: 100%;line-height: 26px;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;text-align: left;"><span style="max-width: 100%;font-size: 15px;overflow-wrap: break-word !important;box-sizing: border-box !important;">Spark重点难点系列：</span></section><ul data-tool="mdnice编辑器" class="list-paddingleft-2" style="margin: 8px 0px;padding-left: 25px;width: 517.469px;max-width: 100%;overflow-wrap: break-word !important;"><li style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><section style="margin-top: 5px;margin-bottom: 5px;outline: 0px;line-height: 26px;color: rgb(1, 1, 1);text-align: left;"><a href="https://mp.weixin.qq.com/s?__biz=MzI0NjU2NDkzMQ==&amp;mid=2247495063&amp;idx=1&amp;sn=992d7bcccbface7353485b31225d42b9&amp;scene=21#wechat_redirect" data-linktype="2" wah-hotarea="click" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;font-weight: bold;border-bottom: 1px solid rgb(239, 112, 96);outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><span style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);">《【Spark重点难点01】你从未深入理解的RDD和关键角色》</span></a></section></li><li style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><section style="margin-top: 5px;margin-bottom: 5px;outline: 0px;line-height: 26px;color: rgb(1, 1, 1);text-align: left;"><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508303&amp;idx=1&amp;sn=26ea211c966a24705f0fbb26504b433f&amp;scene=21#wechat_redirect" data-linktype="2" wah-hotarea="click" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;font-weight: bold;border-bottom: 1px solid rgb(239, 112, 96);outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><span style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);">《【Spark重点难点02】你以为的Shuffle和真正的Shuffle》</span></a></section></li><li style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><section style="margin-top: 5px;margin-bottom: 5px;outline: 0px;line-height: 26px;color: rgb(1, 1, 1);text-align: left;"><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508382&amp;idx=1&amp;sn=4ca3a18b3d36a18feddd1cea5ce11eee&amp;chksm=fd3ee70bca496e1d68e5e99c4b46353eb6140f6810d28734077311925588ff1f6af7970c47a5&amp;token=251449232&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2" wah-hotarea="click" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;font-weight: bold;border-bottom: 1px solid rgb(239, 112, 96);outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><span style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);">《【Spark重点难点03】你的数据存在哪了?》</span></a></section></li><li style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><section style="margin-top: 5px;margin-bottom: 5px;outline: 0px;line-height: 26px;color: rgb(1, 1, 1);text-align: left;"><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508467&amp;idx=1&amp;sn=ec70ca42aea250ea0e6da98c2114eb47&amp;chksm=fd3ee766ca496e70ef93570ea0bd0c42764499b05959220e39126171133bee0182e77aba663e&amp;token=1296698652&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2" wah-hotarea="click" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;font-weight: bold;border-bottom: 1px solid rgb(239, 112, 96);outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><span style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);">《【Spark重点难点04】你的代码跑起来谁说了算？(内存管理)》</span></a></section></li><li style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><section style="margin-top: 5px;margin-bottom: 5px;outline: 0px;line-height: 26px;color: rgb(1, 1, 1);text-align: left;"><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508803&amp;idx=1&amp;sn=f9c068788217a488c0d42fba79477bc6&amp;chksm=fd3ee5d6ca496cc01d52d1ccc713e506f25d900b4961b3cf36502be4d5fba161a79189b9ef22&amp;token=2010089950&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2" wah-hotarea="click" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;font-weight: bold;border-bottom: 1px solid rgb(239, 112, 96);outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><span style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);">《【Spark重点难点05】SparkSQL YYDS(上)！》</span></a></section></li><li style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><section style="margin-top: 5px;margin-bottom: 5px;outline: 0px;line-height: 26px;color: rgb(1, 1, 1);text-align: left;"><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508865&amp;idx=1&amp;sn=405e3b4c985b6c44c11ed72e294f958f&amp;chksm=fd3ee514ca496c028eadb02ae95b8c3808d79f0b8904a8a08d8972bb076e2e14a3726e7daf7f&amp;token=2010089950&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2" wah-hotarea="click" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;font-weight: bold;border-bottom: 1px solid rgb(239, 112, 96);outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><span style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);">《【Spark重点难点06】SparkSQL YYDS(中)！》</span></a></section></li><li style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><section style="margin-top: 5px;margin-bottom: 5px;outline: 0px;line-height: 26px;color: rgb(1, 1, 1);text-align: left;"><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247509188&amp;idx=2&amp;sn=fbdd7fe8dd633cad8bcc3c1bb9e371f2&amp;chksm=fd3ee251ca496b47dfb4cf958ef39bbb5bf486515fe056a600d97fe8f4e268869706c1d9832e&amp;token=1453956085&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2" wah-hotarea="click" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;font-weight: bold;border-bottom: 1px solid rgb(239, 112, 96);outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><span style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);">《【Spark重点难点07】SparkSQL YYDS(加餐)！》</span></a></section></li><li style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);"><section style="margin-top: 5px;margin-bottom: 5px;outline: 0px;line-height: 26px;color: rgb(1, 1, 1);text-align: left;"><a href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247509434&amp;idx=1&amp;sn=aa46d8564336460c9a823ce84e79263e&amp;chksm=fd3ee32fca496a39900cc4723c71b45da7dbca1fe7129d5e7c88ddd9217d957ee39653d56396&amp;token=1161317657&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2" wah-hotarea="click" style="outline: 0px;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;font-weight: bold;border-bottom: 1px solid rgb(239, 112, 96);font-size: 14px;color: rgb(255, 104, 39);"><span style="font-size: 14px;color: rgb(255, 104, 39);">《【Spark重点难点08】Spark3.0中的AQE和DPP小总结》</span></a></section></li><li style="outline: 0px;font-size: 14px;color: rgb(255, 104, 39);font-weight: bold;"><section style="margin-top: 5px;margin-bottom: 5px;outline: 0px;line-height: 26px;color: rgb(1, 1, 1);text-align: left;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247509475&amp;idx=1&amp;sn=f37562ab1dbd2847621b5777bf3206c1&amp;chksm=fd3ee376ca496a606db832ba5f782996dcef3bb578521cf9f5ecb4d7d2fbab758e3c086e2598&amp;scene=21#wechat_redirect" textvalue="《Spark3.0核心调优参数小总结》" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" style="text-decoration: underline;font-size: 14px;color: rgb(255, 104, 39);" data-linktype="2"><span style="font-size: 14px;color: rgb(255, 104, 39);"><strong>《Spark3.0核心调优参数小总结》</strong></span></a></section><section style="margin-top: 5px;margin-bottom: 5px;outline: 0px;line-height: 26px;color: rgb(1, 1, 1);"><hr style="border-style: solid;border-width: 1px 0 0;border-color: rgba(0,0,0,0.1);-webkit-transform-origin: 0 0;-webkit-transform: scale(1, 0.5);transform-origin: 0 0;transform: scale(1, 0.5);"  /><hr style="border-style: solid;border-width: 1px 0 0;border-color: rgba(0,0,0,0.1);-webkit-transform-origin: 0 0;-webkit-transform: scale(1, 0.5);transform-origin: 0 0;transform: scale(1, 0.5);"  /><hr style="border-style: solid;border-width: 1px 0 0;border-color: rgba(0,0,0,0.1);-webkit-transform-origin: 0 0;-webkit-transform: scale(1, 0.5);transform-origin: 0 0;transform: scale(1, 0.5);"  /></section></li></ul><h2 data-tool="mdnice编辑器" style="margin: 30px 0px 15px;font-weight: bold;font-size: 22px;max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;text-align: left;"><span style="font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;letter-spacing: 0.034em;font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">1.谈谈你对Spark SQL的理解</span><br  /></h2><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;line-height: 1.6;letter-spacing: 0.034em;color: rgb(63, 63, 63);font-size: 16px;"><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">Spark SQL是一个用来处理结构化数据的Spark组件，前身是shark，但是shark过多的依赖于hive如采用hive的语法解析器、查询优化器等，制约了Spark各个组件之间的相互集成，因此Spark SQL应运而生。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">Spark SQL在汲取了shark诸多优势如内存列存储、兼容hive等基础上，做了重新的构造，因此也摆脱了对hive的依赖，但同时兼容hive。除了采取内存列存储优化性能，还引入了字节码生成技术、CBO和RBO对查询等进行动态评估获取最优逻辑计划、物理计划执行等。基于这些优化，使得Spark SQL相对于原有的SQL on Hadoop技术在性能方面得到有效提升。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">同时，Spark SQL支持多种数据源，如JDBC、HDFS、HBase。它的内部组件，如SQL的语法解析器、分析器等支持重定义进行扩展，能更好的满足不同的业务场景。与Spark Core无缝集成，提供了DataSet/DataFrame的可编程抽象数据模型，并且可被视为一个分布式的SQL查询引擎。</p><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.8037383177570093" src="图片/大数据技术与架构_2021-12-28_「转」【Spark重点难点-面试篇】SparkSQL面试专题/2_bHich88DW3EmmHsAtrUkZ0gwFxERVw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PZ5bqKjMfL3z4PcB7Z7eMfXdjwgSQSyXx0os0hiag3zMFfz9bHich88DW3EmmHsAtrUkZ0gwFxERVw/640?wx_fmt=png'" data-type="png" data-w="1070" style="display: block;margin-right: auto;margin-left: auto;border-radius: 4px;margin-bottom: 25px;"  /></figure><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PZ5bqKjMfL3z4PcB7Z7eMfyYMcZ9DYviaKpZqibd7qdJw19I9JQ7XjY45Qccic7t2jAPr9ucibricZVLw/640?wx_fmt=png&quot;);background-size: 100% 100%;background-repeat: no-repeat;display: inline-block;width: 16px;height: 15px;line-height: 15px;margin-bottom: -1px;"></span><span style="display: none;"></span><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">2.谈谈你对DataSet/DataFrame的理解</span><span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">DataSet/DataFrame都是Spark SQL提供的分布式数据集，相对于RDD而言，除了记录数据以外，还记录表的schema信息。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">DataSet是自Spark1.6开始提供的一个分布式数据集，具有RDD的特性比如强类型、可以使用强大的lambda表达式，并且使用Spark SQL的优化执行引擎。DataSet API支持Scala和Java语言，不支持Python。但是鉴于Python的动态特性，它仍然能够受益于DataSet API（如，你可以通过一个列名从Row里获取这个字段 row.columnName），类似的还有R语言。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">DataFrame是DataSet以命名列方式组织的分布式数据集，类似于RDBMS中的表，或者R和Python中的 data frame。DataFrame API支持Scala、Java、Python、R。在Scala API中，DataFrame变成类型为Row的Dataset：
type DataFrame = Dataset[Row]。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">DataFrame在编译期不进行数据中字段的类型检查，在运行期进行检查。但DataSet则与之相反，因为它是强类型的。此外，二者都是使用catalyst进行sql的解析和优化。为了方便，以下统一使用DataSet统称。</p><h4 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;margin-top: 30px;"><span style="display: none;"></span>DataSet创建<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">DataSet通常通过加载外部数据或通过RDD转化创建。</p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">加载外部数据</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">以加载json和mysql为例：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">val&nbsp;ds&nbsp;=&nbsp;sparkSession.read.json(<span style="color: #d14;line-height: 26px;">"/路径/people.json"</span>)<br  /><br  />val&nbsp;ds&nbsp;=&nbsp;sparkSession.read.format(<span style="color: #d14;line-height: 26px;">"jdbc"</span>)<br  />.options(Map(<span style="color: #d14;line-height: 26px;">"url"</span>&nbsp;-&gt;&nbsp;<span style="color: #d14;line-height: 26px;">"jdbc:mysql://ip:port/db"</span>,<br  /><span style="color: #d14;line-height: 26px;">"driver"</span>&nbsp;-&gt;&nbsp;<span style="color: #d14;line-height: 26px;">"com.mysql.jdbc.Driver"</span>,<br  /><span style="color: #d14;line-height: 26px;">"dbtable"</span>&nbsp;-&gt;&nbsp;<span style="color: #d14;line-height: 26px;">"tableName"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"user"</span>&nbsp;-&gt;&nbsp;<span style="color: #d14;line-height: 26px;">"root"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"root"</span>&nbsp;-&gt;&nbsp;<span style="color: #d14;line-height: 26px;">"123"</span>)).load()<br  /></code></pre><ol start="2" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">RDD转换为DataSet</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">通过RDD转化创建DataSet，关键在于为RDD指定schema，通常有两种方式（伪代码）：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">1.定义一个<span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;class，利用反射机制来推断<br  /><br  />1)&nbsp;从HDFS中加载文件为普通RDD<br  />val&nbsp;lineRDD&nbsp;=&nbsp;sparkContext.textFile(<span style="color: #d14;line-height: 26px;">"hdfs://ip:port/person.txt"</span>).map(_.split(<span style="color: #d14;line-height: 26px;">"&nbsp;"</span>))<br  /><br  />2)&nbsp;定义<span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;class（相当于表的schema）<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;class&nbsp;Person(id:Int,&nbsp;name:String,&nbsp;age:Int)<br  /><br  />3)&nbsp;将RDD和<span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;class关联<br  />val&nbsp;personRDD&nbsp;=&nbsp;lineRDD.map(x&nbsp;=&gt;&nbsp;Person(x(0).toInt,&nbsp;x(1),&nbsp;x(2).toInt))<br  /><br  />4)&nbsp;将RDD转换成DataFrame<br  />val&nbsp;ds=&nbsp;personRDD.toDF<br  /><br  />2.&nbsp;手动定义一个schema&nbsp;StructType，直接指定在RDD上<br  /><br  />val&nbsp;schemaString&nbsp;=<span style="color: #d14;line-height: 26px;">"name&nbsp;age"</span><br  /><br  />val&nbsp;schema&nbsp;=&nbsp;&nbsp;StructType(schemaString.split(<span style="color: #d14;line-height: 26px;">"&nbsp;"</span>).map(fieldName&nbsp;=&gt;&nbsp;StructField(fieldName,&nbsp;StringType,&nbsp;<span style="color: #008080;line-height: 26px;">true</span>)))<br  /><br  />val&nbsp;rowRdd&nbsp;=&nbsp;peopleRdd.map(p=&gt;Row(p(0),p(1)))<br  /><br  />val&nbsp;ds&nbsp;=&nbsp;sparkSession.createDataFrame(rowRdd,schema)<br  /><br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;margin-top: 30px;"><span style="display: none;"></span>操作DataSet的两种风格语法<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">DSL语法</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">1.查询DataSet部分列中的内容<br  />personDS.select(col(<span style="color: #d14;line-height: 26px;">"name"</span>))<br  />personDS.select(col(<span style="color: #d14;line-height: 26px;">"name"</span>),&nbsp;col(<span style="color: #d14;line-height: 26px;">"age"</span>))<br  />2.查询所有的name和age和salary，并将salary加1000<br  />personDS.select(col(<span style="color: #d14;line-height: 26px;">"name"</span>),&nbsp;col(<span style="color: #d14;line-height: 26px;">"age"</span>),&nbsp;col(<span style="color: #d14;line-height: 26px;">"salary"</span>)&nbsp;+&nbsp;1000)<br  />personDS.select(personDS(<span style="color: #d14;line-height: 26px;">"name"</span>),&nbsp;personDS(<span style="color: #d14;line-height: 26px;">"age"</span>),&nbsp;personDS(<span style="color: #d14;line-height: 26px;">"salary"</span>)&nbsp;+&nbsp;1000)<br  />3.过滤age大于18的<br  />personDS.filter(col(<span style="color: #d14;line-height: 26px;">"age"</span>)&nbsp;&gt;&nbsp;18)<br  />4.按年龄进行分组并统计相同年龄的人数<br  />personDS.groupBy(<span style="color: #d14;line-height: 26px;">"age"</span>).count()<br  />注意：直接使用col方法需要import&nbsp;org.apache.spark.sql.functions._<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">SQL语法</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">如果想使用SQL风格的语法，需要将DataSet注册成表<br  />personDS.registerTempTable(<span style="color: #d14;line-height: 26px;">"person"</span>)<br  />//查询年龄最大的前两名<br  />val&nbsp;result&nbsp;=&nbsp;sparkSession.sql(<span style="color: #d14;line-height: 26px;">"select&nbsp;*&nbsp;from&nbsp;person&nbsp;order&nbsp;by&nbsp;age&nbsp;desc&nbsp;limit&nbsp;2"</span>)<br  />//保存结果为json文件。注意：如果不指定存储格式，则默认存储为parquet<br  />result.write.format(<span style="color: #d14;line-height: 26px;">"json"</span>).save(<span style="color: #d14;line-height: 26px;">"hdfs://ip:port/res2"</span>)&nbsp;<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PZ5bqKjMfL3z4PcB7Z7eMfyYMcZ9DYviaKpZqibd7qdJw19I9JQ7XjY45Qccic7t2jAPr9ucibricZVLw/640?wx_fmt=png&quot;);background-size: 100% 100%;background-repeat: no-repeat;display: inline-block;width: 16px;height: 15px;line-height: 15px;margin-bottom: -1px;"></span><span style="display: none;"></span><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">3.说说Spark SQL的几种使用方式</span><span style="display: none;"></span></h3><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">sparksql-shell交互式查询</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">就是利用Spark提供的shell命令行执行SQL</p><ol start="2" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">编程</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">首先要获取Spark SQL编程"入口"：SparkSession（当然在早期版本中大家可能更熟悉的是SQLContext，如果是操作hive则为HiveContext）。这里以读取parquet为例：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">val&nbsp;spark&nbsp;=&nbsp;SparkSession.builder()<br  />.appName(<span style="color: #d14;line-height: 26px;">"example"</span>).master(<span style="color: #d14;line-height: 26px;">"local[*]"</span>).getOrCreate();<br  />val&nbsp;df&nbsp;=&nbsp;sparkSession.read.format(<span style="color: #d14;line-height: 26px;">"parquet"</span>).load(<span style="color: #d14;line-height: 26px;">"/路径/parquet文件"</span>)<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">然后就可以针对df进行业务处理了。</p><ol start="3" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">Thriftserver</section></li></ol><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">beeline客户端连接操作</section></li></ul><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">启动spark-sql的thrift服务，sbin/start-thriftserver.sh，启动脚本中配置好Spark集群服务资源、地址等信息。然后通过beeline连接thrift服务进行数据处理。</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">hive-jdbc驱动包来访问spark-sql的thrift服务</section></li></ul><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">在项目pom文件中引入相关驱动包，跟访问mysql等jdbc数据源类似。示例：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">Class.forName(<span style="color: #d14;line-height: 26px;">"org.apache.hive.jdbc.HiveDriver"</span>)<br  />val&nbsp;conn&nbsp;=&nbsp;DriverManager.getConnection(<span style="color: #d14;line-height: 26px;">"jdbc:hive2://ip:port"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"root"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"123"</span>);<br  />try&nbsp;{<br  />&nbsp;&nbsp;val&nbsp;<span style="color: #0086b3;line-height: 26px;">stat</span>&nbsp;=&nbsp;conn.createStatement()<br  />&nbsp;&nbsp;val&nbsp;res&nbsp;=&nbsp;stat.executeQuery(<span style="color: #d14;line-height: 26px;">"select&nbsp;*&nbsp;from&nbsp;people&nbsp;limit&nbsp;1"</span>)<br  />&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">while</span>&nbsp;(res.next())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;println(res.getString(<span style="color: #d14;line-height: 26px;">"name"</span>))<br  />&nbsp;&nbsp;}<br  />}&nbsp;catch&nbsp;{<br  />&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;e:&nbsp;Exception&nbsp;=&gt;&nbsp;e.printStackTrace()<br  />}&nbsp;finally{<br  />&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">if</span>(conn!=null)&nbsp;conn.close()<br  />}<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PZ5bqKjMfL3z4PcB7Z7eMfyYMcZ9DYviaKpZqibd7qdJw19I9JQ7XjY45Qccic7t2jAPr9ucibricZVLw/640?wx_fmt=png&quot;);background-size: 100% 100%;background-repeat: no-repeat;display: inline-block;width: 16px;height: 15px;line-height: 15px;margin-bottom: -1px;"></span><span style="display: none;"></span><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">4. 说说Spark SQL 获取Hive数据的方式</span><span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">Spark SQL读取hive数据的关键在于将hive的元数据作为服务暴露给Spark。除了通过上面thriftserver jdbc连接hive的方式，也可以通过下面这种方式：</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">首先，配置 $HIVE_HOME/conf/hive-site.xml，增加如下内容：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">&lt;property&gt;<br  />&lt;name&gt;hive.metastore.uris&lt;/name&gt;<br  />&lt;value&gt;thrift://ip:port&lt;/value&gt;<br  />&lt;/property&gt;<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">然后，启动hive metastore。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">最后，将hive-site.xml复制或者软链到<span style="cursor:pointer;"><span role="presentation" data-formula="SPARK_HOME/conf/。如果hive的元数据存储在mysql中，那么需要将mysql的连接驱动jar包如mysql-connector-java-5.1.12.jar放到" data-formula-type="inline-equation" style=""><embed style="vertical-align: -0.566ex;width: 142.104ex;height: auto;" src="https://mmbiz.qlogo.cn/mmbiz_svg/I1YzhXxW8YDib7eVzyq7GTYYWP6PxqGWhxH0N6qFGLsow9LZaapz3KUicJIb6u37ribJ5aP6g5r4X6uFliaECkOQ2wV5Jluca1yD/0?wx_fmt=svg" data-type="svg+xml"></embed></span></span>SPARK_HOME/lib/下，启动spark-sql即可操作hive中的库和表。而此时使用hive元数据获取SparkSession的方式为：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">val&nbsp;spark&nbsp;=&nbsp;SparkSession.builder()<br  />.config(sparkConf).enableHiveSupport().getOrCreate()<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PZ5bqKjMfL3z4PcB7Z7eMfyYMcZ9DYviaKpZqibd7qdJw19I9JQ7XjY45Qccic7t2jAPr9ucibricZVLw/640?wx_fmt=png&quot;);background-size: 100% 100%;background-repeat: no-repeat;display: inline-block;width: 16px;height: 15px;line-height: 15px;margin-bottom: -1px;"></span><span style="display: none;"></span><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">5. 分别说明UDF、UDAF、Aggregator</span><span style="display: none;"></span></h3><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">UDF</section></li></ul><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">UDF是最基础的用户自定义函数，以自定义一个求字符串长度的udf为例：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">val&nbsp;udf_str_length&nbsp;=&nbsp;udf{(str:String)&nbsp;=&gt;&nbsp;str.length}<br  />spark.udf.register(<span style="color: #d14;line-height: 26px;">"str_length"</span>,udf_str_length)<br  />val&nbsp;ds&nbsp;=sparkSession.read.json(<span style="color: #d14;line-height: 26px;">"路径/people.json"</span>)<br  />ds.createOrReplaceTempView(<span style="color: #d14;line-height: 26px;">"people"</span>)<br  />sparkSession.sql(<span style="color: #d14;line-height: 26px;">"select&nbsp;str_length(address)&nbsp;from&nbsp;people"</span>)<br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">UDAF</section></li></ul><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">定义UDAF，需要继承抽象类UserDefinedAggregateFunction，它是弱类型的，下面的aggregator是强类型的。以求平均数为例：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">import&nbsp;org.apache.spark.sql.{Row,&nbsp;SparkSession}<br  />import&nbsp;org.apache.spark.sql.expressions.MutableAggregationBuffer<br  />import&nbsp;org.apache.spark.sql.expressions.UserDefinedAggregateFunction<br  />import&nbsp;org.apache.spark.sql.types._<br  /><br  />object&nbsp;MyAverage&nbsp;extends&nbsp;UserDefinedAggregateFunction&nbsp;{<br  />&nbsp;&nbsp;//&nbsp;Data&nbsp;types&nbsp;of&nbsp;input&nbsp;arguments&nbsp;of&nbsp;this&nbsp;aggregate&nbsp;<span style="font-weight: bold;line-height: 26px;">function</span><br  />&nbsp;&nbsp;def&nbsp;inputSchema:&nbsp;StructType&nbsp;=&nbsp;StructType(StructField(<span style="color: #d14;line-height: 26px;">"inputColumn"</span>,&nbsp;LongType)&nbsp;::&nbsp;Nil)<br  />&nbsp;&nbsp;//&nbsp;Data&nbsp;types&nbsp;of&nbsp;values&nbsp;<span style="font-weight: bold;line-height: 26px;">in</span>&nbsp;the&nbsp;aggregation&nbsp;buffer<br  />&nbsp;&nbsp;def&nbsp;bufferSchema:&nbsp;StructType&nbsp;=&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;StructType(StructField(<span style="color: #d14;line-height: 26px;">"sum"</span>,&nbsp;LongType)&nbsp;::&nbsp;StructField(<span style="color: #d14;line-height: 26px;">"count"</span>,&nbsp;LongType)&nbsp;::&nbsp;Nil)<br  />&nbsp;&nbsp;}<br  />&nbsp;&nbsp;//&nbsp;The&nbsp;data&nbsp;<span style="color: #0086b3;line-height: 26px;">type</span>&nbsp;of&nbsp;the&nbsp;returned&nbsp;value<br  />&nbsp;&nbsp;def&nbsp;dataType:&nbsp;DataType&nbsp;=&nbsp;DoubleType<br  />&nbsp;&nbsp;//&nbsp;Whether&nbsp;this&nbsp;<span style="font-weight: bold;line-height: 26px;">function</span>&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;output&nbsp;on&nbsp;the&nbsp;identical&nbsp;input<br  />&nbsp;&nbsp;def&nbsp;deterministic:&nbsp;Boolean&nbsp;=&nbsp;<span style="color: #008080;line-height: 26px;">true</span><br  />&nbsp;&nbsp;//&nbsp;Initializes&nbsp;the&nbsp;given&nbsp;aggregation&nbsp;buffer.&nbsp;The&nbsp;buffer&nbsp;itself&nbsp;is&nbsp;a&nbsp;`Row`&nbsp;that&nbsp;<span style="font-weight: bold;line-height: 26px;">in</span>&nbsp;addition&nbsp;to<br  />&nbsp;&nbsp;//&nbsp;standard&nbsp;methods&nbsp;like&nbsp;retrieving&nbsp;a&nbsp;value&nbsp;at&nbsp;an&nbsp;index&nbsp;(e.g.,&nbsp;get(),&nbsp;getBoolean()),&nbsp;provides<br  />&nbsp;&nbsp;//&nbsp;the&nbsp;opportunity&nbsp;to&nbsp;update&nbsp;its&nbsp;values.&nbsp;Note&nbsp;that&nbsp;arrays&nbsp;and&nbsp;maps&nbsp;inside&nbsp;the&nbsp;buffer&nbsp;are&nbsp;still<br  />&nbsp;&nbsp;//&nbsp;immutable.<br  />&nbsp;&nbsp;def&nbsp;initialize(buffer:&nbsp;MutableAggregationBuffer):&nbsp;Unit&nbsp;=&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;buffer(0)&nbsp;=&nbsp;0L<br  />&nbsp;&nbsp;&nbsp;&nbsp;buffer(1)&nbsp;=&nbsp;0L<br  />&nbsp;&nbsp;}<br  />&nbsp;&nbsp;//&nbsp;Updates&nbsp;the&nbsp;given&nbsp;aggregation&nbsp;buffer&nbsp;`buffer`&nbsp;with&nbsp;new&nbsp;input&nbsp;data&nbsp;from&nbsp;`input`<br  />&nbsp;&nbsp;def&nbsp;update(buffer:&nbsp;MutableAggregationBuffer,&nbsp;input:&nbsp;Row):&nbsp;Unit&nbsp;=&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-weight: bold;line-height: 26px;">if</span>&nbsp;(!input.isNullAt(0))&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer(0)&nbsp;=&nbsp;buffer.getLong(0)&nbsp;+&nbsp;input.getLong(0)<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer(1)&nbsp;=&nbsp;buffer.getLong(1)&nbsp;+&nbsp;1<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;}<br  />&nbsp;&nbsp;//&nbsp;Merges&nbsp;two&nbsp;aggregation&nbsp;buffers&nbsp;and&nbsp;stores&nbsp;the&nbsp;updated&nbsp;buffer&nbsp;values&nbsp;back&nbsp;to&nbsp;`buffer1`<br  />&nbsp;&nbsp;def&nbsp;merge(buffer1:&nbsp;MutableAggregationBuffer,&nbsp;buffer2:&nbsp;Row):&nbsp;Unit&nbsp;=&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;buffer1(0)&nbsp;=&nbsp;buffer1.getLong(0)&nbsp;+&nbsp;buffer2.getLong(0)<br  />&nbsp;&nbsp;&nbsp;&nbsp;buffer1(1)&nbsp;=&nbsp;buffer1.getLong(1)&nbsp;+&nbsp;buffer2.getLong(1)<br  />&nbsp;&nbsp;}<br  />&nbsp;&nbsp;//&nbsp;Calculates&nbsp;the&nbsp;final&nbsp;result<br  />&nbsp;&nbsp;def&nbsp;evaluate(buffer:&nbsp;Row):&nbsp;Double&nbsp;=&nbsp;buffer.getLong(0).toDouble&nbsp;/&nbsp;buffer.getLong(1)<br  />}<br  /><br  />//&nbsp;Register&nbsp;the&nbsp;<span style="font-weight: bold;line-height: 26px;">function</span>&nbsp;to&nbsp;access&nbsp;it<br  />spark.udf.register(<span style="color: #d14;line-height: 26px;">"myAverage"</span>,&nbsp;MyAverage)<br  /><br  />val&nbsp;df&nbsp;=&nbsp;spark.read.json(<span style="color: #d14;line-height: 26px;">"examples/src/main/resources/employees.json"</span>)<br  />df.createOrReplaceTempView(<span style="color: #d14;line-height: 26px;">"employees"</span>)<br  />df.show()<br  />val&nbsp;result&nbsp;=&nbsp;spark.sql(<span style="color: #d14;line-height: 26px;">"SELECT&nbsp;myAverage(salary)&nbsp;as&nbsp;average_salary&nbsp;FROM&nbsp;employees"</span>)<br  />result.show()<br  /></code></pre><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">Aggregator</section></li></ul><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">import&nbsp;org.apache.spark.sql.{Encoder,&nbsp;Encoders,&nbsp;SparkSession}<br  />import&nbsp;org.apache.spark.sql.expressions.Aggregator<br  /><br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;class&nbsp;Employee(name:&nbsp;String,&nbsp;salary:&nbsp;Long)<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;class&nbsp;Average(var&nbsp;sum:&nbsp;Long,&nbsp;var&nbsp;count:&nbsp;Long)<br  /><br  />object&nbsp;MyAverage&nbsp;extends&nbsp;Aggregator[Employee,&nbsp;Average,&nbsp;Double]&nbsp;{<br  />&nbsp;&nbsp;//&nbsp;A&nbsp;zero&nbsp;value&nbsp;<span style="font-weight: bold;line-height: 26px;">for</span>&nbsp;this&nbsp;aggregation.&nbsp;Should&nbsp;satisfy&nbsp;the&nbsp;property&nbsp;that&nbsp;any&nbsp;b&nbsp;+&nbsp;zero&nbsp;=&nbsp;b<br  />&nbsp;&nbsp;def&nbsp;zero:&nbsp;Average&nbsp;=&nbsp;Average(0L,&nbsp;0L)<br  />&nbsp;&nbsp;//&nbsp;Combine&nbsp;two&nbsp;values&nbsp;to&nbsp;produce&nbsp;a&nbsp;new&nbsp;value.&nbsp;For&nbsp;performance,&nbsp;the&nbsp;<span style="font-weight: bold;line-height: 26px;">function</span>&nbsp;may&nbsp;modify&nbsp;`buffer`<br  />&nbsp;&nbsp;//&nbsp;and&nbsp;<span style="color: #0086b3;line-height: 26px;">return</span>&nbsp;it&nbsp;instead&nbsp;of&nbsp;constructing&nbsp;a&nbsp;new&nbsp;object<br  />&nbsp;&nbsp;def&nbsp;reduce(buffer:&nbsp;Average,&nbsp;employee:&nbsp;Employee):&nbsp;Average&nbsp;=&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;buffer.sum&nbsp;+=&nbsp;employee.salary<br  />&nbsp;&nbsp;&nbsp;&nbsp;buffer.count&nbsp;+=&nbsp;1<br  />&nbsp;&nbsp;&nbsp;&nbsp;buffer<br  />&nbsp;&nbsp;}<br  />&nbsp;&nbsp;//&nbsp;Merge&nbsp;two&nbsp;intermediate&nbsp;values<br  />&nbsp;&nbsp;def&nbsp;merge(b1:&nbsp;Average,&nbsp;b2:&nbsp;Average):&nbsp;Average&nbsp;=&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;b1.sum&nbsp;+=&nbsp;b2.sum<br  />&nbsp;&nbsp;&nbsp;&nbsp;b1.count&nbsp;+=&nbsp;b2.count<br  />&nbsp;&nbsp;&nbsp;&nbsp;b1<br  />&nbsp;&nbsp;}<br  />&nbsp;&nbsp;//&nbsp;Transform&nbsp;the&nbsp;output&nbsp;of&nbsp;the&nbsp;reduction<br  />&nbsp;&nbsp;def&nbsp;finish(reduction:&nbsp;Average):&nbsp;Double&nbsp;=&nbsp;reduction.sum.toDouble&nbsp;/&nbsp;reduction.count<br  />&nbsp;&nbsp;//&nbsp;Specifies&nbsp;the&nbsp;Encoder&nbsp;<span style="font-weight: bold;line-height: 26px;">for</span>&nbsp;the&nbsp;intermediate&nbsp;value&nbsp;<span style="color: #0086b3;line-height: 26px;">type</span><br  />&nbsp;&nbsp;def&nbsp;bufferEncoder:&nbsp;Encoder[Average]&nbsp;=&nbsp;Encoders.product<br  />&nbsp;&nbsp;//&nbsp;Specifies&nbsp;the&nbsp;Encoder&nbsp;<span style="font-weight: bold;line-height: 26px;">for</span>&nbsp;the&nbsp;final&nbsp;output&nbsp;value&nbsp;<span style="color: #0086b3;line-height: 26px;">type</span><br  />&nbsp;&nbsp;def&nbsp;outputEncoder:&nbsp;Encoder[Double]&nbsp;=&nbsp;Encoders.scalaDouble<br  />}<br  /><br  />val&nbsp;ds&nbsp;=&nbsp;spark.read.json(<span style="color: #d14;line-height: 26px;">"examples/src/main/resources/employees.json"</span>).as[Employee]<br  />ds.show()<br  />//&nbsp;Convert&nbsp;the&nbsp;<span style="font-weight: bold;line-height: 26px;">function</span>&nbsp;to&nbsp;a&nbsp;`TypedColumn`&nbsp;and&nbsp;give&nbsp;it&nbsp;a&nbsp;name<br  />val&nbsp;averageSalary&nbsp;=&nbsp;MyAverage.toColumn.name(<span style="color: #d14;line-height: 26px;">"average_salary"</span>)<br  />val&nbsp;result&nbsp;=&nbsp;ds.select(averageSalary)<br  />result.show()<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PZ5bqKjMfL3z4PcB7Z7eMfyYMcZ9DYviaKpZqibd7qdJw19I9JQ7XjY45Qccic7t2jAPr9ucibricZVLw/640?wx_fmt=png&quot;);background-size: 100% 100%;background-repeat: no-repeat;display: inline-block;width: 16px;height: 15px;line-height: 15px;margin-bottom: -1px;"></span><span style="display: none;"></span><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">6. 对比一下Spark SQL与HiveSQL</span><span style="display: none;"></span></h3><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.5805555555555556" src="图片/大数据技术与架构_2021-12-28_「转」【Spark重点难点-面试篇】SparkSQL面试专题/3_vdS9J6D44Uwq7JJa0LyShvib0yh8xQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PZ5bqKjMfL3z4PcB7Z7eMfxialx12CA6WVdnhnmkJ6JpTss3vdS9J6D44Uwq7JJa0LyShvib0yh8xQ/640?wx_fmt=png'" data-type="png" data-w="1080" style="display: block;margin-right: auto;margin-left: auto;border-radius: 4px;margin-bottom: 25px;"  /></figure><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PZ5bqKjMfL3z4PcB7Z7eMfyYMcZ9DYviaKpZqibd7qdJw19I9JQ7XjY45Qccic7t2jAPr9ucibricZVLw/640?wx_fmt=png&quot;);background-size: 100% 100%;background-repeat: no-repeat;display: inline-block;width: 16px;height: 15px;line-height: 15px;margin-bottom: -1px;"></span><span style="display: none;"></span><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">7.说说你对Spark SQL 小文件问题处理的理解</span><span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">在生产中，无论是通过SQL语句或者Scala/Java等代码的方式使用Spark SQL处理数据，在Spark SQL写数据时，往往会遇到生成的小文件过多的问题，而管理这些大量的小文件，是一件非常头疼的事情。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">大量的小文件会影响Hadoop集群管理或者Spark在处理数据时的稳定性：</p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">Spark SQL写Hive或者直接写入HDFS，过多的小文件会对NameNode内存管理等产生巨大的压力，会影响整个集群的稳定运行</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">容易导致task数过多，如果超过参数spark.driver.maxResultSize的配置（默认1g），会抛出类似如下的异常，影响任务的处理</p></section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">Caused&nbsp;by:&nbsp;org.apache.spark.SparkException:&nbsp;Job&nbsp;aborted&nbsp;due&nbsp;to&nbsp;stage&nbsp;failure:&nbsp;Total&nbsp;size&nbsp;of&nbsp;serialized&nbsp;results&nbsp;of&nbsp;478&nbsp;tasks&nbsp;(2026.0&nbsp;MB)&nbsp;is&nbsp;bigger&nbsp;than&nbsp;spark.driver.maxResultSize&nbsp;(1024.0&nbsp;MB)<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">当然可以通过调大spark.driver.maxResultSize的默认配置来解决问题，但如果不能从源头上解决小文件问题，以后还可能遇到类似的问题。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">此外，Spark在处理任务时，一个分区分配一个task进行处理，多个分区并行处理，虽然并行处理能够提高处理效率，但不是意味着task数越多越好。如果数据量不大，过多的task运行反而会影响效率。
最后，Spark中一个task处理一个分区从而也会影响最终生成的文件数。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">在数仓建设中，产生小文件过多的原因有很多种，比如：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><br  /></section></li><ol style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">流式处理中，每个批次的处理执行保存操作也会产生很多小文件</section></li></ol><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><br  /></section></li><ol start="2" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">为了解决数据更新问题，同一份数据保存了不同的几个状态，也容易导致文件数过多</section></li></ol></ul><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">那么如何解决这种小文件的问题呢？</p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">通过repartition或coalesce算子控制最后的DataSet的分区数
注意repartition和coalesce的区别</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">将Hive风格的Coalesce and Repartition Hint 应用到Spark SQL
需要注意这种方式对Spark的版本有要求，建议在Spark2.4.X及以上版本使用，示例：</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">INSERT&nbsp;...&nbsp;SELECT&nbsp;/*+&nbsp;COALESCE(numPartitions)&nbsp;*/&nbsp;...<br  />INSERT&nbsp;...&nbsp;SELECT&nbsp;/*+&nbsp;REPARTITION(numPartitions)&nbsp;*/&nbsp;...<br  /></code></pre><ol start="3" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">小文件定期合并可以定时通过异步的方式针对Hive分区表的每一个分区中的小文件进行合并操作</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">上述只是给出3种常见的解决办法，并且要结合实际用到的技术和场景去具体处理，比如对于HDFS小文件过多，也可以通过生成HAR 文件或者Sequence File来解决。</p><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PZ5bqKjMfL3z4PcB7Z7eMfyYMcZ9DYviaKpZqibd7qdJw19I9JQ7XjY45Qccic7t2jAPr9ucibricZVLw/640?wx_fmt=png&quot;);background-size: 100% 100%;background-repeat: no-repeat;display: inline-block;width: 16px;height: 15px;line-height: 15px;margin-bottom: -1px;"></span><span style="display: none;"></span><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">8.SparkSQL读写Hive metastore Parquet遇到过什么问题吗？</span><span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">Spark SQL为了更好的性能，在读写Hive metastore parquet格式的表时，会默认使用自己的Parquet SerDe，而不是采用Hive的SerDe进行序列化和反序列化。该行为可以通过配置参数spark.sql.hive.convertMetastoreParquet进行控制，默认true。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">这里从表schema的处理角度而言，就必须注意Hive和Parquet兼容性，主要有两个区别：</p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">Hive是大小写敏感的，但Parquet相反</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">Hive会将所有列视为nullable，但是nullability在parquet里有独特的意义</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">由于上面的原因，在将Hive metastore parquet转化为Spark SQL parquet时，需要兼容处理一下Hive和Parquet的schema，即需要对二者的结构进行一致化。主要处理规则是：</p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">有相同名字的字段必须要有相同的数据类型，忽略nullability。兼容处理的字段应该保持Parquet侧的数据类型，这样就可以处理到nullability类型了（空值问题）</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">兼容处理的schema应只包含在Hive元数据里的schema信息，主要体现在以下两个方面：
（1）只出现在Parquet schema的字段会被忽略
（2）只出现在Hive元数据里的字段将会被视为nullable，并处理到兼容后的schema中</p></section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">关于schema（或者说元数据metastore），Spark SQL在处理Parquet表时，同样为了更好的性能，会缓存Parquet的元数据信息。此时，如果直接通过Hive或者其他工具对该Parquet表进行修改导致了元数据的变化，那么Spark SQL缓存的元数据并不能同步更新，此时需要手动刷新Spark SQL缓存的元数据，来确保元数据的一致性，方式如下：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">//&nbsp;第一种方式应用的比较多<br  />1.&nbsp;sparkSession.catalog.refreshTable(s<span style="color: #d14;line-height: 26px;">"<span style="color: #008080;line-height: 26px;">${dbName.tableName}</span>"</span>)<br  />2.&nbsp;sparkSession.catalog.refreshByPath(s<span style="color: #d14;line-height: 26px;">"<span style="color: #008080;line-height: 26px;">${path}</span>"</span>)<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PZ5bqKjMfL3z4PcB7Z7eMfyYMcZ9DYviaKpZqibd7qdJw19I9JQ7XjY45Qccic7t2jAPr9ucibricZVLw/640?wx_fmt=png&quot;);background-size: 100% 100%;background-repeat: no-repeat;display: inline-block;width: 16px;height: 15px;line-height: 15px;margin-bottom: -1px;"></span><span style="display: none;"></span><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">9.说说SparkSQL中产生笛卡尔积的几种典型场景以及处理策略</span><span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">Spark SQL几种产生笛卡尔积的典型场景</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">首先来看一下在Spark SQL中产生笛卡尔积的几种典型SQL：</p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">join语句中不指定on条件</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">select&nbsp;*&nbsp;from&nbsp;test_partition1&nbsp;join&nbsp;test_partition2;<br  /></code></pre><ol start="2" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">join语句中指定不等值连接</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">select&nbsp;*&nbsp;from&nbsp;test_partition1&nbsp;t1&nbsp;inner&nbsp;join&nbsp;test_partition2&nbsp;t2&nbsp;on&nbsp;t1.name&nbsp;&lt;&gt;&nbsp;t2.name;<br  /></code></pre><ol start="3" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">join语句on中用or指定连接条件</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">select&nbsp;*&nbsp;from&nbsp;test_partition1&nbsp;t1&nbsp;join&nbsp;test_partition2&nbsp;t2&nbsp;on&nbsp;t1.id&nbsp;=&nbsp;t2.id&nbsp;or&nbsp;t1.name&nbsp;=&nbsp;t2.name;<br  /></code></pre><ol start="4" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">join语句on中用||指定连接条件</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">select&nbsp;*&nbsp;from&nbsp;test_partition1&nbsp;t1&nbsp;join&nbsp;test_partition2&nbsp;t2&nbsp;on&nbsp;t1.id&nbsp;=&nbsp;t2.id&nbsp;||&nbsp;t1.name&nbsp;=&nbsp;t2.name;<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">除了上述举的几个典型例子，实际业务开发中产生笛卡尔积的原因多种多样。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">同时需要注意，在一些SQL中即使满足了上述4种规则之一也不一定产生笛卡尔积。比如，对于join语句中指定不等值连接条件的下述SQL不会产生笛卡尔积:</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--在Spark&nbsp;SQL内部优化过程中针对join策略的选择，最终会通过SortMergeJoin进行处理。<br  />select&nbsp;*&nbsp;from&nbsp;test_partition1&nbsp;t1&nbsp;join&nbsp;test_partition2&nbsp;t2&nbsp;on&nbsp;t1.id&nbsp;=&nbsp;t2.i<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">此外，对于直接在SQL中使用cross join的方式，也不一定产生笛卡尔积。比如下述SQL：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;Spark&nbsp;SQL内部优化过程中选择了SortMergeJoin方式进行处理<br  />select&nbsp;*&nbsp;from&nbsp;test_partition1&nbsp;t1&nbsp;cross&nbsp;&nbsp;join&nbsp;test_partition2&nbsp;t2&nbsp;on&nbsp;t1.id&nbsp;=&nbsp;t2.id;<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">但是如果cross join没有指定on条件同样会产生笛卡尔积。
那么如何判断一个SQL是否产生了笛卡尔积呢？</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">Spark SQL是否产生了笛卡尔积</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">以join语句不指定on条件产生笛卡尔积的SQL为例:</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;test_partition1和test_partition2是Hive分区表<br  />select&nbsp;*&nbsp;from&nbsp;test_partition1&nbsp;join&nbsp;test_partition2;<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">通过Spark UI上SQL一栏查看上述SQL执行图，如下：</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">可以看出，因为该join语句中没有指定on连接查询条件，导致了CartesianProduct即笛卡尔积。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">再来看一下该join语句的逻辑计划和物理计划：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">==&nbsp;Parsed&nbsp;Logical&nbsp;Plan&nbsp;==<br  /><span style="color: #d14;line-height: 26px;">'GlobalLimit&nbsp;1000<br  />+-&nbsp;'</span>LocalLimit&nbsp;1000<br  />&nbsp;&nbsp;&nbsp;+-&nbsp;<span style="color: #d14;line-height: 26px;">'Project&nbsp;[*]<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+-&nbsp;'</span>UnresolvedRelation&nbsp;`t`<br  /><br  />==&nbsp;Analyzed&nbsp;Logical&nbsp;Plan&nbsp;==<br  />id:&nbsp;string,&nbsp;name:&nbsp;string,&nbsp;dt:&nbsp;string,&nbsp;id:&nbsp;string,&nbsp;name:&nbsp;string,&nbsp;dt:&nbsp;string<br  />GlobalLimit&nbsp;1000<br  />+-&nbsp;LocalLimit&nbsp;1000<br  />&nbsp;&nbsp;&nbsp;+-&nbsp;Project&nbsp;[id<span style="color: #998;font-style: italic;line-height: 26px;">#84,&nbsp;name#85,&nbsp;dt#86,&nbsp;id#87,&nbsp;name#88,&nbsp;dt#89]</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+-&nbsp;SubqueryAlias&nbsp;`t`<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+-&nbsp;Project&nbsp;[id<span style="color: #998;font-style: italic;line-height: 26px;">#84,&nbsp;name#85,&nbsp;dt#86,&nbsp;id#87,&nbsp;name#88,&nbsp;dt#89]</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+-&nbsp;Join&nbsp;Inner<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:-&nbsp;SubqueryAlias&nbsp;`default`.`test_partition1`<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;+-&nbsp;HiveTableRelation&nbsp;`default`.`test_partition1`,&nbsp;org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe,&nbsp;[id<span style="color: #998;font-style: italic;line-height: 26px;">#84,&nbsp;name#85],&nbsp;[dt#86]</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+-&nbsp;SubqueryAlias&nbsp;`default`.`test_partition2`<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+-&nbsp;HiveTableRelation&nbsp;`default`.`test_partition2`,&nbsp;org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe,&nbsp;[id<span style="color: #998;font-style: italic;line-height: 26px;">#87,&nbsp;name#88],&nbsp;[dt#89]</span><br  /><br  />==&nbsp;Optimized&nbsp;Logical&nbsp;Plan&nbsp;==<br  />GlobalLimit&nbsp;1000<br  />+-&nbsp;LocalLimit&nbsp;1000<br  />&nbsp;&nbsp;&nbsp;+-&nbsp;Join&nbsp;Inner<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:-&nbsp;HiveTableRelation&nbsp;`default`.`test_partition1`,&nbsp;org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe,&nbsp;[id<span style="color: #998;font-style: italic;line-height: 26px;">#84,&nbsp;name#85],&nbsp;[dt#86]</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+-&nbsp;HiveTableRelation&nbsp;`default`.`test_partition2`,&nbsp;org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe,&nbsp;[id<span style="color: #998;font-style: italic;line-height: 26px;">#87,&nbsp;name#88],&nbsp;[dt#89]</span><br  /><br  />==&nbsp;Physical&nbsp;Plan&nbsp;==<br  />CollectLimit&nbsp;1000<br  />+-&nbsp;CartesianProduct<br  />&nbsp;&nbsp;&nbsp;:-&nbsp;Scan&nbsp;hive&nbsp;default.test_partition1&nbsp;[id<span style="color: #998;font-style: italic;line-height: 26px;">#84,&nbsp;name#85,&nbsp;dt#86],&nbsp;HiveTableRelation&nbsp;`default`.`test_partition1`,&nbsp;org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe,&nbsp;[id#84,&nbsp;name#85],&nbsp;[dt#86]</span><br  />&nbsp;&nbsp;&nbsp;+-&nbsp;Scan&nbsp;hive&nbsp;default.test_partition2&nbsp;[id<span style="color: #998;font-style: italic;line-height: 26px;">#87,&nbsp;name#88,&nbsp;dt#89],&nbsp;HiveTableRelation&nbsp;`default`.`test_partition2`,&nbsp;org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe,&nbsp;[id#87,&nbsp;name#88],&nbsp;[dt#89]</span><br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">通过逻辑计划到物理计划，以及最终的物理计划选择CartesianProduct，可以分析得出该SQL最终确实产生了笛卡尔积。</p><h4 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;margin-top: 30px;"><span style="display: none;"></span>Spark SQL中产生笛卡尔积的处理策略<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">Spark SQL中主要有ExtractEquiJoinKeys（Broadcast Hash Join、Shuffle Hash Join、Sort Merge Join，这3种是我们比较熟知的Spark SQL join）和Without joining keys（CartesianProduct、BroadcastNestedLoopJoin）join策略。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">那么，如何判断SQL是否产生了笛卡尔积就迎刃而解。</p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">在利用Spark SQL执行SQL任务时，通过查看SQL的执行图来分析是否产生了笛卡尔积。如果产生笛卡尔积，则将任务杀死，进行任务优化避免笛卡尔积。</p></section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);"><p style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">分析Spark SQL的逻辑计划和物理计划，通过程序解析计划推断SQL最终是否选择了笛卡尔积执行策略。如果是，及时提示风险。具体可以参考Spark SQL join策略选择的源码:</p></section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">def&nbsp;apply(plan:&nbsp;LogicalPlan):&nbsp;Seq[SparkPlan]&nbsp;=&nbsp;plan&nbsp;match&nbsp;{<br  />//&nbsp;---&nbsp;BroadcastHashJoin&nbsp;--------------------------------------------------------------------<br  />//&nbsp;broadcast&nbsp;hints&nbsp;were&nbsp;specified<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;ExtractEquiJoinKeys(joinType,&nbsp;leftKeys,&nbsp;rightKeys,&nbsp;condition,&nbsp;left,&nbsp;right)<br  /><span style="font-weight: bold;line-height: 26px;">if</span>&nbsp;canBroadcastByHints(joinType,&nbsp;left,&nbsp;right)&nbsp;=&gt;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;buildSide&nbsp;=&nbsp;broadcastSideByHints(joinType,&nbsp;left,&nbsp;right)<br  />Seq(joins.BroadcastHashJoinExec(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leftKeys,&nbsp;rightKeys,&nbsp;joinType,&nbsp;buildSide,&nbsp;condition,&nbsp;planLater(left),&nbsp;planLater(right)))<br  />//&nbsp;broadcast&nbsp;hints&nbsp;were&nbsp;not&nbsp;specified,&nbsp;so&nbsp;need&nbsp;to&nbsp;infer&nbsp;it&nbsp;from&nbsp;size&nbsp;and&nbsp;configuration.<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;ExtractEquiJoinKeys(joinType,&nbsp;leftKeys,&nbsp;rightKeys,&nbsp;condition,&nbsp;left,&nbsp;right)<br  /><span style="font-weight: bold;line-height: 26px;">if</span>&nbsp;canBroadcastBySizes(joinType,&nbsp;left,&nbsp;right)&nbsp;=&gt;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;buildSide&nbsp;=&nbsp;broadcastSideBySizes(joinType,&nbsp;left,&nbsp;right)<br  />Seq(joins.BroadcastHashJoinExec(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leftKeys,&nbsp;rightKeys,&nbsp;joinType,&nbsp;buildSide,&nbsp;condition,&nbsp;planLater(left),&nbsp;planLater(right)))<br  />//&nbsp;---&nbsp;ShuffledHashJoin&nbsp;---------------------------------------------------------------------<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;ExtractEquiJoinKeys(joinType,&nbsp;leftKeys,&nbsp;rightKeys,&nbsp;condition,&nbsp;left,&nbsp;right)<br  /><span style="font-weight: bold;line-height: 26px;">if</span>&nbsp;!conf.preferSortMergeJoin&nbsp;&amp;&amp;&nbsp;canBuildRight(joinType)&nbsp;&amp;&amp;&nbsp;canBuildLocalHashMap(right)<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;muchSmaller(right,&nbsp;left)&nbsp;||<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!RowOrdering.isOrderable(leftKeys)&nbsp;=&gt;<br  />Seq(joins.ShuffledHashJoinExec(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leftKeys,&nbsp;rightKeys,&nbsp;joinType,&nbsp;BuildRight,&nbsp;condition,&nbsp;planLater(left),&nbsp;planLater(right)))<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;ExtractEquiJoinKeys(joinType,&nbsp;leftKeys,&nbsp;rightKeys,&nbsp;condition,&nbsp;left,&nbsp;right)<br  /><span style="font-weight: bold;line-height: 26px;">if</span>&nbsp;!conf.preferSortMergeJoin&nbsp;&amp;&amp;&nbsp;canBuildLeft(joinType)&nbsp;&amp;&amp;&nbsp;canBuildLocalHashMap(left)<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;muchSmaller(left,&nbsp;right)&nbsp;||<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!RowOrdering.isOrderable(leftKeys)&nbsp;=&gt;<br  />Seq(joins.ShuffledHashJoinExec(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leftKeys,&nbsp;rightKeys,&nbsp;joinType,&nbsp;BuildLeft,&nbsp;condition,&nbsp;planLater(left),&nbsp;planLater(right)))<br  />//&nbsp;---&nbsp;SortMergeJoin&nbsp;------------------------------------------------------------<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;ExtractEquiJoinKeys(joinType,&nbsp;leftKeys,&nbsp;rightKeys,&nbsp;condition,&nbsp;left,&nbsp;right)<br  /><span style="font-weight: bold;line-height: 26px;">if</span>&nbsp;RowOrdering.isOrderable(leftKeys)&nbsp;=&gt;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joins.SortMergeJoinExec(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leftKeys,&nbsp;rightKeys,&nbsp;joinType,&nbsp;condition,&nbsp;planLater(left),&nbsp;planLater(right))&nbsp;::&nbsp;Nil<br  />//&nbsp;---&nbsp;Without&nbsp;joining&nbsp;keys&nbsp;------------------------------------------------------------<br  />//&nbsp;Pick&nbsp;BroadcastNestedLoopJoin&nbsp;<span style="font-weight: bold;line-height: 26px;">if</span>&nbsp;one&nbsp;side&nbsp;could&nbsp;be&nbsp;broadcast<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;j&nbsp;@&nbsp;logical.Join(left,&nbsp;right,&nbsp;joinType,&nbsp;condition)<br  /><span style="font-weight: bold;line-height: 26px;">if</span>&nbsp;canBroadcastByHints(joinType,&nbsp;left,&nbsp;right)&nbsp;=&gt;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;buildSide&nbsp;=&nbsp;broadcastSideByHints(joinType,&nbsp;left,&nbsp;right)<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joins.BroadcastNestedLoopJoinExec(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;planLater(left),&nbsp;planLater(right),&nbsp;buildSide,&nbsp;joinType,&nbsp;condition)&nbsp;::&nbsp;Nil<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;j&nbsp;@&nbsp;logical.Join(left,&nbsp;right,&nbsp;joinType,&nbsp;condition)<br  /><span style="font-weight: bold;line-height: 26px;">if</span>&nbsp;canBroadcastBySizes(joinType,&nbsp;left,&nbsp;right)&nbsp;=&gt;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;buildSide&nbsp;=&nbsp;broadcastSideBySizes(joinType,&nbsp;left,&nbsp;right)<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joins.BroadcastNestedLoopJoinExec(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;planLater(left),&nbsp;planLater(right),&nbsp;buildSide,&nbsp;joinType,&nbsp;condition)&nbsp;::&nbsp;Nil<br  />//&nbsp;Pick&nbsp;CartesianProduct&nbsp;<span style="font-weight: bold;line-height: 26px;">for</span>&nbsp;InnerJoin<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;logical.Join(left,&nbsp;right,&nbsp;_:&nbsp;InnerLike,&nbsp;condition)&nbsp;=&gt;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joins.CartesianProductExec(planLater(left),&nbsp;planLater(right),&nbsp;condition)&nbsp;::&nbsp;Nil<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;logical.Join(left,&nbsp;right,&nbsp;joinType,&nbsp;condition)&nbsp;=&gt;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;buildSide&nbsp;=&nbsp;broadcastSide(<br  />left.stats.hints.broadcast,&nbsp;right.stats.hints.broadcast,&nbsp;left,&nbsp;right)<br  />//&nbsp;This&nbsp;join&nbsp;could&nbsp;be&nbsp;very&nbsp;slow&nbsp;or&nbsp;OOM<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;joins.BroadcastNestedLoopJoinExec(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;planLater(left),&nbsp;planLater(right),&nbsp;buildSide,&nbsp;joinType,&nbsp;condition)&nbsp;::&nbsp;Nil<br  />//&nbsp;---&nbsp;Cases&nbsp;<span style="color: #0086b3;line-height: 26px;">where</span>&nbsp;this&nbsp;strategy&nbsp;does&nbsp;not&nbsp;apply&nbsp;---------------------------------------------<br  /><span style="font-weight: bold;line-height: 26px;">case</span>&nbsp;_&nbsp;=&gt;&nbsp;Nil<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><h3 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 20px;margin-top: 1.2em;"><span style="background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PZ5bqKjMfL3z4PcB7Z7eMfyYMcZ9DYviaKpZqibd7qdJw19I9JQ7XjY45Qccic7t2jAPr9ucibricZVLw/640?wx_fmt=png&quot;);background-size: 100% 100%;background-repeat: no-repeat;display: inline-block;width: 16px;height: 15px;line-height: 15px;margin-bottom: -1px;"></span><span style="display: none;"></span><span style="font-size: 17px;display: inline-block;margin-left: 8px;color: rgb(72, 179, 120);">10. 具体讲讲Spark SQL/Hive中的一些实用函数</span><span style="display: none;"></span></h3><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">字符串函数</p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">concat</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">对字符串进行拼接：concat(str1, str2, ..., strN) ，参数：str1、str2...是要进行拼接的字符串。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;<span style="color: #0086b3;line-height: 26px;">return</span>&nbsp;the&nbsp;concatenation&nbsp;of&nbsp;str1、str2、...,&nbsp;strN<br  />--&nbsp;SparkSQL<br  />select&nbsp;concat(<span style="color: #d14;line-height: 26px;">'Spark'</span>,&nbsp;<span style="color: #d14;line-height: 26px;">'SQL'</span>);<br  /></code></pre><ol start="2" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">concat_ws</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">在拼接的字符串中间添加某种分隔符：concat_ws(sep, [str | array(str)]+)。
参数1：分隔符，如 - ；参数2：要拼接的字符串（可多个）</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;<span style="color: #0086b3;line-height: 26px;">return</span>&nbsp;the&nbsp;concatenation&nbsp;of&nbsp;the&nbsp;strings&nbsp;separated&nbsp;by&nbsp;sep<br  />--&nbsp;Spark-SQL<br  />select&nbsp;concat_ws(<span style="color: #d14;line-height: 26px;">"-"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"Spark"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"SQL"</span>);<br  /></code></pre><ol start="3" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">encode</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">设置编码格式：encode(str, charset)。
参数1：要进行编码的字符串 ；参数2：使用的编码格式，如UTF-8</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;encode&nbsp;the&nbsp;first&nbsp;argument&nbsp;using&nbsp;the&nbsp;second&nbsp;argument&nbsp;character&nbsp;<span style="color: #0086b3;line-height: 26px;">set</span><br  />select&nbsp;encode(<span style="color: #d14;line-height: 26px;">"HIVE"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"UTF-8"</span>);<br  /></code></pre><ol start="4" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">decode</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">转码：decode(bin, charset)。
参数1：进行转码的binary ；
参数2：使用的转码格式，如UTF-8</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;decode&nbsp;the&nbsp;first&nbsp;argument&nbsp;using&nbsp;the&nbsp;second&nbsp;argument&nbsp;character&nbsp;<span style="color: #0086b3;line-height: 26px;">set</span><br  />select&nbsp;decode(encode(<span style="color: #d14;line-height: 26px;">"HIVE"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"UTF-8"</span>),&nbsp;<span style="color: #d14;line-height: 26px;">"UTF-8"</span>);<br  /></code></pre><ol start="5" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">format_string / printf</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">格式化字符串：format_string(strfmt, obj, ...)</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;returns&nbsp;a&nbsp;formatted&nbsp;string&nbsp;from&nbsp;<span style="color: #0086b3;line-height: 26px;">printf</span>-style&nbsp;format&nbsp;strings<br  />select&nbsp;format_string(<span style="color: #d14;line-height: 26px;">"Spark&nbsp;SQL&nbsp;%d&nbsp;%s"</span>,&nbsp;100,&nbsp;<span style="color: #d14;line-height: 26px;">"days"</span>);<br  /></code></pre><ol start="6" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">initcap / lower / upper</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">initcap：将每个单词的首字母转为大写，其他字母小写。单词之间以空白分隔。
upper：全部转为大写。
lower：全部转为小写。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;Spark&nbsp;Sql<br  />select&nbsp;initcap(<span style="color: #d14;line-height: 26px;">"spaRk&nbsp;sql"</span>);<br  /><br  />--&nbsp;SPARK&nbsp;SQL<br  />select&nbsp;upper(<span style="color: #d14;line-height: 26px;">"sPark&nbsp;sql"</span>);<br  /><br  />--&nbsp;spark&nbsp;sql<br  />select&nbsp;lower(<span style="color: #d14;line-height: 26px;">"Spark&nbsp;Sql"</span>);<br  /></code></pre><ol start="7" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">length</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">返回字符串的长度。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;返回4<br  />select&nbsp;length(<span style="color: #d14;line-height: 26px;">"Hive"</span>);<br  /></code></pre><ol start="8" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">lpad / rpad</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">返回固定长度的字符串，如果长度不够，用某种字符进行补全。
lpad(str, len, pad)：左补全
rpad(str, len, pad)：右补全
注意：如果参数str的长度大于参数len，则返回的结果长度会被截取为长度为len的字符串</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;vehi<br  />select&nbsp;lpad(<span style="color: #d14;line-height: 26px;">"hi"</span>,&nbsp;4,&nbsp;<span style="color: #d14;line-height: 26px;">"ve"</span>);<br  /><br  />--&nbsp;hive<br  />select&nbsp;rpad(<span style="color: #d14;line-height: 26px;">"hi"</span>,&nbsp;4,&nbsp;<span style="color: #d14;line-height: 26px;">"ve"</span>);<br  /><br  />--&nbsp;spar<br  />select&nbsp;lpad(<span style="color: #d14;line-height: 26px;">"spark"</span>,&nbsp;4,&nbsp;<span style="color: #d14;line-height: 26px;">"ve"</span>);<br  /></code></pre><ol start="9" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">trim / ltrim / rtrim</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">去除空格或者某种字符。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">trim(str) / trim(trimStr, str)：首尾去除。
ltrim(str) / ltrim(trimStr, str)：左去除。
rtrim(str) / rtrim(trimStr, str)：右去除。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;hive<br  />select&nbsp;trim(<span style="color: #d14;line-height: 26px;">"&nbsp;hive&nbsp;"</span>);<br  /><br  />--&nbsp;SparkSQL<br  />SELECT&nbsp;ltrim(<span style="color: #d14;line-height: 26px;">"Sp"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"SSparkSQLS"</span>)&nbsp;as&nbsp;tmp;<br  /></code></pre><ol start="10" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">regexp_extract</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">正则提取某些字符串</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;2000<br  />select&nbsp;regexp_extract(<span style="color: #d14;line-height: 26px;">"1000-2000"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"(\\d+)-(\\d+)"</span>,&nbsp;2);<br  /></code></pre><ol start="11" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">regexp_replace</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">正则替换</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;r-r<br  />select&nbsp;regexp_replace(<span style="color: #d14;line-height: 26px;">"100-200"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"(\\d+)"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"r"</span>);<br  /></code></pre><ol start="12" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">repeat</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">repeat(str,&nbsp;n)：复制给定的字符串n次<br  />--&nbsp;aa<br  />select&nbsp;repeat(<span style="color: #d14;line-height: 26px;">"a"</span>,&nbsp;2);<br  /></code></pre><ol start="13" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">instr / locate</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">返回截取字符串的位置。如果匹配的字符串不存在，则返回0</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;returns&nbsp;the&nbsp;(1-based)&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;substr&nbsp;<span style="font-weight: bold;line-height: 26px;">in</span>&nbsp;str.<br  /><br  />--&nbsp;6<br  />select&nbsp;instr(<span style="color: #d14;line-height: 26px;">"SparkSQL"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"SQL"</span>);<br  /><br  />--&nbsp;0<br  />select&nbsp;locate(<span style="color: #d14;line-height: 26px;">"A"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"fruit"</span>);<br  /></code></pre><ol start="14" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">space</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">在字符串前面加n个空格</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">select&nbsp;concat(space(2),&nbsp;<span style="color: #d14;line-height: 26px;">"A"</span>);<br  /></code></pre><ol start="15" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">split</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">split(str, regex)：以某字符拆分字符串 split(str, regex)</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;[<span style="color: #d14;line-height: 26px;">"one"</span>,<span style="color: #d14;line-height: 26px;">"two"</span>]<br  />select&nbsp;split(<span style="color: #d14;line-height: 26px;">"one&nbsp;two"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"&nbsp;"</span>);<br  /></code></pre><ol start="16" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">substr / substring_index</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;k&nbsp;SQL<br  />select&nbsp;substr(<span style="color: #d14;line-height: 26px;">"Spark&nbsp;SQL"</span>,&nbsp;5);<br  /><br  />--&nbsp;从后面开始截取，返回SQL<br  />select&nbsp;substr(<span style="color: #d14;line-height: 26px;">"Spark&nbsp;SQL"</span>,&nbsp;-3);<br  /><br  />--&nbsp;k<br  />select&nbsp;substr(<span style="color: #d14;line-height: 26px;">"Spark&nbsp;SQL"</span>,&nbsp;5,&nbsp;1);<br  /><br  />--&nbsp;org.apache。注意：如果参数3为负值，则从右边取值<br  />select&nbsp;substring_index(<span style="color: #d14;line-height: 26px;">"org.apache.spark"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"."</span>,&nbsp;2);<br  /></code></pre><ol start="17" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">translate</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">替换某些字符为指定字符</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;The&nbsp;translate&nbsp;will&nbsp;happen&nbsp;when&nbsp;any&nbsp;character&nbsp;<span style="font-weight: bold;line-height: 26px;">in</span>&nbsp;the&nbsp;string&nbsp;matches&nbsp;the&nbsp;character&nbsp;<span style="font-weight: bold;line-height: 26px;">in</span>&nbsp;the&nbsp;`matchingString`<br  />--&nbsp;A1B2C3<br  />select&nbsp;translate(<span style="color: #d14;line-height: 26px;">"AaBbCc"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"abc"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"123"</span>);<br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;margin-top: 30px;"><span style="display: none;"></span>JSON函数<span style="display: none;"></span></h4><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">get_json_object</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;v2<br  />select&nbsp;get_json_object(<span style="color: #d14;line-height: 26px;">'{"k1":&nbsp;"v1",&nbsp;"k2":&nbsp;"v2"}'</span>,&nbsp;<span style="color: #d14;line-height: 26px;">'$.k2'</span>);<br  /></code></pre><ol start="2" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">from_json</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">select&nbsp;tmp.k&nbsp;from&nbsp;&nbsp;(<br  />select&nbsp;from_json(<span style="color: #d14;line-height: 26px;">'{"k":&nbsp;"fruit",&nbsp;"v":&nbsp;"apple"}'</span>,<span style="color: #d14;line-height: 26px;">'k&nbsp;STRING,&nbsp;v&nbsp;STRING'</span>,&nbsp;map(<span style="color: #d14;line-height: 26px;">""</span>,<span style="color: #d14;line-height: 26px;">""</span>))&nbsp;as&nbsp;tmp<br  />);<br  /></code></pre><ol start="3" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">to_json</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;可以把所有字段转化为json字符串，然后表示成value字段<br  />select&nbsp;to_json(struct(*))&nbsp;AS&nbsp;value;<br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;margin-top: 30px;"><span style="display: none;"></span>时间函数<span style="display: none;"></span></h4><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">current_date / current_timestamp</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">获取当前时间<br  />select&nbsp;current_date;<br  /><br  />select&nbsp;current_timestamp;<br  /></code></pre><ol start="2" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">从日期时间中提取字段/格式化时间</section></li></ol><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">1）year、month、day、dayofmonth、hour、minute、second<br  />--&nbsp;20<br  />select&nbsp;day(<span style="color: #d14;line-height: 26px;">"2020-12-20"</span>);<br  /><br  />2）dayofweek(1&nbsp;=&nbsp;Sunday,&nbsp;2&nbsp;=&nbsp;Monday,&nbsp;...,&nbsp;7&nbsp;=&nbsp;Saturday)、dayofye<br  />--&nbsp;7<br  />select&nbsp;dayofweek(<span style="color: #d14;line-height: 26px;">"2020-12-12"</span>);<br  /><br  />3）weekofyear(date)<br  /><br  />/**<br  />&nbsp;&nbsp;&nbsp;*&nbsp;Extracts&nbsp;the&nbsp;week&nbsp;number&nbsp;as&nbsp;an&nbsp;<span style="color: #0086b3;line-height: 26px;">integer</span>&nbsp;from&nbsp;a&nbsp;given&nbsp;date/timestamp/string.<br  />&nbsp;&nbsp;&nbsp;*<br  />&nbsp;&nbsp;&nbsp;*&nbsp;A&nbsp;week&nbsp;is&nbsp;considered&nbsp;to&nbsp;start&nbsp;on&nbsp;a&nbsp;Monday&nbsp;and&nbsp;week&nbsp;1&nbsp;is&nbsp;the&nbsp;first&nbsp;week&nbsp;with&nbsp;more&nbsp;than&nbsp;3&nbsp;days,<br  />&nbsp;&nbsp;&nbsp;*&nbsp;as&nbsp;defined&nbsp;by&nbsp;ISO&nbsp;8601<br  />&nbsp;&nbsp;&nbsp;*<br  />&nbsp;&nbsp;&nbsp;*&nbsp;@<span style="color: #0086b3;line-height: 26px;">return</span>&nbsp;An&nbsp;<span style="color: #0086b3;line-height: 26px;">integer</span>,&nbsp;or&nbsp;null&nbsp;<span style="font-weight: bold;line-height: 26px;">if</span>&nbsp;the&nbsp;input&nbsp;was&nbsp;a&nbsp;string&nbsp;that&nbsp;could&nbsp;not&nbsp;be&nbsp;cast&nbsp;to&nbsp;a&nbsp;date<br  />&nbsp;&nbsp;&nbsp;*&nbsp;@group&nbsp;datetime_funcs<br  />&nbsp;&nbsp;&nbsp;*&nbsp;@since&nbsp;1.5.0<br  />&nbsp;&nbsp;&nbsp;*/<br  />&nbsp;&nbsp;def&nbsp;weekofyear(e:&nbsp;Column):&nbsp;Column&nbsp;=&nbsp;withExpr&nbsp;{&nbsp;WeekOfYear(e.expr)&nbsp;}<br  /><br  />--&nbsp;50<br  />select&nbsp;weekofyear(<span style="color: #d14;line-height: 26px;">"2020-12-12"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">4）trunc</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">截取某部分的日期，其他部分默认为01。第二个参数: YEAR、YYYY、YY、MON、MONTH、MM</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;2020-01-01<br  />select&nbsp;trunc(<span style="color: #d14;line-height: 26px;">"2020-12-12"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"YEAR"</span>);<br  /><br  />--&nbsp;2020-12-01<br  />select&nbsp;trunc(<span style="color: #d14;line-height: 26px;">"2020-12-12"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"MM"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">5）date_trunc</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">参数：YEAR、YYYY、YY、MON、MONTH、MM、DAY、DD、HOUR、MINUTE、SECOND、WEEK、QUARTER</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;2012-12-12&nbsp;09:00:00<br  />select&nbsp;date_trunc(<span style="color: #d14;line-height: 26px;">"HOUR"</span>&nbsp;,<span style="color: #d14;line-height: 26px;">"2012-12-12T09:32:05.359"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">6）date_format</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">按照某种格式格式化时间</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;2020-12-12<br  />select&nbsp;date_format(<span style="color: #d14;line-height: 26px;">"2020-12-12&nbsp;12:12:12"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"yyyy-MM-dd"</span>);<br  /></code></pre><ol start="3" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">日期时间转换</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">1）unix_timestamp
返回当前时间的unix时间戳。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">select&nbsp;unix_timestamp();<br  /><br  />--&nbsp;1609257600<br  />select&nbsp;unix_timestamp(<span style="color: #d14;line-height: 26px;">"2020-12-30"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"yyyy-MM-dd"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">2）from_unixtime</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">将unix epoch（1970-01-01 00:00:00 UTC）中的秒数转换为以给定格式表示当前系统时区中该时刻的时间戳的字符串。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">select&nbsp;from_unixtime(1609257600,&nbsp;<span style="color: #d14;line-height: 26px;">"yyyy-MM-dd&nbsp;HH:mm:ss"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">3）to_unix_timestamp</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">将时间转化为时间戳。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;1609257600<br  />select&nbsp;to_unix_timestamp(<span style="color: #d14;line-height: 26px;">"2020-12-30"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"yyyy-MM-dd"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">4）to_date / date</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">将时间字符串转化为date。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;2020-12-30<br  />select&nbsp;to_date(<span style="color: #d14;line-height: 26px;">"2020-12-30&nbsp;12:30:00"</span>);<br  />select&nbsp;date(<span style="color: #d14;line-height: 26px;">"2020-12-30"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">5）to_timestamp</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">将时间字符串转化为timestamp。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">select&nbsp;to_timestamp(<span style="color: #d14;line-height: 26px;">"2020-12-30&nbsp;12:30:00"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">6）quarter</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">从给定的日期/时间戳/字符串中提取季度。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;4<br  />select&nbsp;quarter(<span style="color: #d14;line-height: 26px;">"2020-12-30"</span>);<br  /></code></pre><ol start="4" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">日期、时间计算</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">1）months_between(end, start)
返回两个日期之间的月数。参数1为截止时间，参数2为开始时间</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;3.94959677<br  />select&nbsp;months_between(<span style="color: #d14;line-height: 26px;">"1997-02-28&nbsp;10:30:00"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"1996-10-30"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">2）add_months</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">返回某日期后n个月后的日期。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;2020-12-28<br  />select&nbsp;add_months(<span style="color: #d14;line-height: 26px;">"2020-11-28"</span>,&nbsp;1);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">3）last_day(date)</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">返回某个时间的当月最后一天</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;2020-12-31<br  />select&nbsp;last_day(<span style="color: #d14;line-height: 26px;">"2020-12-01"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">4）next_day(start_date, day_of_week)</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">返回某时间后the first date基于specified day of the week。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">参数1：开始时间。<br  />参数2：Mon、Tue、Wed、Thu、Fri、Sat、Sun。<br  />--&nbsp;2020-12-07<br  />select&nbsp;next_day(<span style="color: #d14;line-height: 26px;">"2020-12-01"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"Mon"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">5）date_add(start_date, num_days)</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">返回指定时间增加num_days天后的时间</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;2020-12-02<br  />select&nbsp;date_add(<span style="color: #d14;line-height: 26px;">"2020-12-01"</span>,&nbsp;1);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">6）datediff(endDate, startDate)
两个日期相差的天数</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;3<br  />select&nbsp;datediff(<span style="color: #d14;line-height: 26px;">"2020-12-01"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"2020-11-28"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">7）关于UTC时间</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">--&nbsp;to_utc_timestamp(timestamp,&nbsp;timezone)&nbsp;-&nbsp;Given&nbsp;a&nbsp;timestamp&nbsp;like&nbsp;<span style="color: #d14;line-height: 26px;">'2017-07-14&nbsp;02:40:00.0'</span>,&nbsp;interprets&nbsp;it&nbsp;as&nbsp;a&nbsp;time&nbsp;<span style="font-weight: bold;line-height: 26px;">in</span>&nbsp;the&nbsp;given&nbsp;time&nbsp;zone,&nbsp;and&nbsp;renders&nbsp;that&nbsp;time&nbsp;as&nbsp;a&nbsp;timestamp&nbsp;<span style="font-weight: bold;line-height: 26px;">in</span>&nbsp;UTC.&nbsp;For&nbsp;example,&nbsp;<span style="color: #d14;line-height: 26px;">'GMT+1'</span>&nbsp;would&nbsp;yield&nbsp;<span style="color: #d14;line-height: 26px;">'2017-07-14&nbsp;01:40:00.0'</span>.<br  /><br  />select&nbsp;to_utc_timestamp(<span style="color: #d14;line-height: 26px;">"2020-12-01"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"Asia/Seoul"</span>)&nbsp;;<br  /><br  />--&nbsp;from_utc_timestamp(timestamp,&nbsp;timezone)&nbsp;-&nbsp;Given&nbsp;a&nbsp;timestamp&nbsp;like&nbsp;<span style="color: #d14;line-height: 26px;">'2017-07-14&nbsp;02:40:00.0'</span>,&nbsp;interprets&nbsp;it&nbsp;as&nbsp;a&nbsp;time&nbsp;<span style="font-weight: bold;line-height: 26px;">in</span>&nbsp;UTC,&nbsp;and&nbsp;renders&nbsp;that&nbsp;time&nbsp;as&nbsp;a&nbsp;timestamp&nbsp;<span style="font-weight: bold;line-height: 26px;">in</span>&nbsp;the&nbsp;given&nbsp;time&nbsp;zone.&nbsp;For&nbsp;example,&nbsp;<span style="color: #d14;line-height: 26px;">'GMT+1'</span>&nbsp;would&nbsp;yield&nbsp;<span style="color: #d14;line-height: 26px;">'2017-07-14&nbsp;03:40:00.0'</span>.<br  /><br  />select&nbsp;from_utc_timestamp(<span style="color: #d14;line-height: 26px;">"2020-12-01"</span>,&nbsp;<span style="color: #d14;line-height: 26px;">"Asia/Seoul"</span>);<br  /><br  /></code></pre><h4 data-tool="mdnice编辑器" style="margin-bottom: 15px;font-weight: bold;color: black;font-size: 18px;margin-top: 30px;"><span style="display: none;"></span>常用的开窗函数<span style="display: none;"></span></h4><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">开窗函数格式通常满足：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">function_name([argument_list])<br  />OVER&nbsp;(<br  />[PARTITION&nbsp;BY&nbsp;partition_expression,…]<br  />[ORDER&nbsp;BY&nbsp;sort_expression,&nbsp;…&nbsp;[ASC|DESC]])<br  /><br  />function_name:&nbsp;函数名称，比如SUM()、AVG()<br  /><br  />partition_expression：分区列<br  /><br  />sort_expression：排序列<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">注意：以下举例涉及的表employee中字段含义：name（员工姓名）、dept_no（部门编号）、salary（工资）</p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">cume_dist</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">如果按升序排列，则统计：小于等于当前值的行数/总行数(number of rows ≤ current row)/(total number of rows）。如果是降序排列，则统计：大于等于当前值的行数/总行数。用于累计统计。</p><ol start="2" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">lead(value_expr[,offset[,default]])</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">用于统计窗口内往下第n行值。第一个参数为列名，第二个参数为往下第n行（可选，默认为1），第三个参数为默认值（当往下第n行为NULL时候，取默认值，如不指定，则为NULL）。</p><ol start="3" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">lag(value_expr[,offset[,default]])</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">与lead相反，用于统计窗口内往上第n行值。第一个参数为列名，第二个参数为往上第n行（可选，默认为1），第三个参数为默认值（当往上第n行为NULL时候，取默认值，如不指定，则为NULL）。</p><ol start="4" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">first_value</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">取分组内排序后，截止到当前行，第一个值。</p><ol start="5" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">last_value</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">取分组内排序后，截止到当前行，最后一个值。</p><ol start="6" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">rank</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">对组中的数据进行排名，如果名次相同，则排名也相同，但是下一个名次的排名序号会出现不连续。比如查找具体条件的topN行。RANK() 排序为 (1,2,2,4)。</p><ol start="7" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">dense_rank</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">dense_rank函数的功能与rank函数类似，dense_rank函数在生成序号时是连续的，而rank函数生成的序号有可能不连续。当出现名次相同时，则排名序号也相同。而下一个排名的序号与上一个排名序号是连续的。
DENSE_RANK() 排序为 (1,2,2,3)。</p><ol start="8" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">SUM/AVG/MIN/MAX</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">数据：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pv<br  />1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2015-04-10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1<br  />1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2015-04-11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3<br  />1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2015-04-12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6<br  />1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2015-04-13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3<br  />1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2015-04-14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<br  />2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2015-05-15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8<br  />2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2015-05-16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6<br  /></code></pre><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">结果：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;"><code style="overflow-x: auto;padding: 16px;color: #333;background: #f8f8f8;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;">SELECT&nbsp;id,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pv,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(pv)&nbsp;OVER(PARTITION&nbsp;BY&nbsp;id&nbsp;ORDER&nbsp;BY&nbsp;time)&nbsp;AS&nbsp;pv1,&nbsp;--&nbsp;默认为从起点到当前行<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(pv)&nbsp;OVER(PARTITION&nbsp;BY&nbsp;id&nbsp;ORDER&nbsp;BY&nbsp;time&nbsp;ROWS&nbsp;BETWEEN&nbsp;UNBOUNDED&nbsp;PRECEDING&nbsp;AND&nbsp;CURRENT&nbsp;ROW)&nbsp;AS&nbsp;pv2,&nbsp;--从起点到当前行，结果同pv1<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(pv)&nbsp;OVER(PARTITION&nbsp;BY&nbsp;id)&nbsp;AS&nbsp;pv3,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--分组内所有行<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(pv)&nbsp;OVER(PARTITION&nbsp;BY&nbsp;id&nbsp;ORDER&nbsp;BY&nbsp;time&nbsp;ROWS&nbsp;BETWEEN&nbsp;3&nbsp;PRECEDING&nbsp;AND&nbsp;CURRENT&nbsp;ROW)&nbsp;AS&nbsp;pv4,&nbsp;&nbsp;&nbsp;--当前行+往前3行<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(pv)&nbsp;OVER(PARTITION&nbsp;BY&nbsp;id&nbsp;ORDER&nbsp;BY&nbsp;time&nbsp;ROWS&nbsp;BETWEEN&nbsp;3&nbsp;PRECEDING&nbsp;AND&nbsp;1&nbsp;FOLLOWING)&nbsp;AS&nbsp;pv5,&nbsp;&nbsp;&nbsp;&nbsp;--当前行+往前3行+往后1行<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(pv)&nbsp;OVER(PARTITION&nbsp;BY&nbsp;id&nbsp;ORDER&nbsp;BY&nbsp;time&nbsp;ROWS&nbsp;BETWEEN&nbsp;CURRENT&nbsp;ROW&nbsp;AND&nbsp;UNBOUNDED&nbsp;FOLLOWING)&nbsp;AS&nbsp;pv6&nbsp;&nbsp;&nbsp;---当前行+往后所有行&nbsp;&nbsp;<br  />FROM&nbsp;data;<br  /></code></pre><ol start="9" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">NTILE</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">NTILE(n)，用于将分组数据按照顺序切分成n片，返回当前切片值。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">NTILE不支持ROWS BETWEEN，比如 NTILE(2) OVER(PARTITION BY cookieid ORDER BY createtime ROWS BETWEEN 3 PRECEDING AND CURRENT ROW)。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">如果切片不均匀，默认增加第一个切片的分布。</p><ol start="10" data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;" class="list-paddingleft-2"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;color: rgb(1, 1, 1);">ROW_NUMBER</section></li></ol><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">从1开始，按照顺序，生成分组内记录的序列。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;">比如，按照pv降序排列，生成分组内每天的pv名次
ROW_NUMBER() 的应用场景非常多，比如获取分组内排序第一的记录。</p><p data-tool="mdnice编辑器" style="padding-bottom: 8px;padding-top: 1em;color: rgb(74, 74, 74);line-height: 1.75em;"><br  /></p></section><hr data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;max-width: 100%;height: 1px;border-right: none;border-bottom: none;border-left: none;border-top-style: solid;border-top-color: black;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /><section style="padding-top: 8px;padding-bottom: 8px;max-width: 100%;line-height: 26px;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="max-width: 100%;font-size: 14px;overflow-wrap: break-word !important;box-sizing: border-box !important;">《大数据成神之路》正在全面PDF化。</span></section><section style="padding-top: 8px;padding-bottom: 8px;max-width: 100%;line-height: 26px;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="max-width: 100%;font-size: 14px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><strong style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">你只需要关注并在后台回复</strong><strong style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><code style="margin-right: 2px;margin-left: 2px;padding: 2px 4px;max-width: 100%;font-size: 14px;border-radius: 4px;color: rgb(30, 107, 184);background-color: rgba(27, 31, 35, 0.05);font-family: &quot;Operator Mono&quot;, Consolas, Monaco, Menlo, monospace;word-break: break-all;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="max-width: 100%;color: rgb(255, 104, 39);overflow-wrap: break-word !important;box-sizing: border-box !important;">「PDF」</span></code></strong><strong style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">就可以看到阿里云盘下载链接了！</strong></span></section><section class="mp_profile_iframe_wrp"><mpprofile class="js_uneditable custom_select_card mp_profile_iframe" data-pluginname="mpprofile" data-id="MzU3MzgwNTU2Mg==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MrfCUBgMwsXeyxKKIxY5GNfl3g0zm1ibib46XO7tlIEs8ncmlp3Zzq8JJs0ibLbHdL4AWox8hSUIMDw/0?wx_fmt=png" data-nickname="大数据技术与架构" data-alias="import_bigdata" data-signature="大数据开发、大数据面试、大数据框架、大数据实时计算、大数据离线计算Flink/Spark/Hadoop/数仓开发，干货，面试，资料下载，源码解读等" data-from="0"></mpprofile></section><section style="padding-top: 8px;padding-bottom: 8px;max-width: 100%;line-height: 26px;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="max-width: 100%;font-size: 14px;overflow-wrap: break-word !important;box-sizing: border-box !important;">另外我把发表过的文章按照体系全部整理好了。现在你可以在后台方便的进行查找：</span></section><section style="padding-right: 10px;padding-left: 10px;max-width: 100%;color: black;line-height: 1.6;letter-spacing: 0px;word-break: break-word;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;padding-right: 0.5em;padding-left: 0.5em;max-width: 100%;display: flex;flex-direction: column;justify-content: center;align-items: center;overflow-wrap: break-word !important;box-sizing: border-box !important;"><img class="rich_pages wxw-img" data-ratio="0.6712962962962963" src="图片/大数据技术与架构_2021-12-28_「转」【Spark重点难点-面试篇】SparkSQL面试专题/4_yPb94gicvelDmiaGhnMem0cs9p9LLw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PM7nI3CL3Oy36gcxKeHdodXia8jHXrOPpe2ZePDiaoCeLFvdKbyPb94gicvelDmiaGhnMem0cs9p9LLw/640?wx_fmt=png'" data-type="png" data-w="1080" style="margin-right: auto;margin-left: auto;display: block;border-radius: 6px;box-shadow: rgb(180, 180, 180) 0em 0em 0.5em 0px;font-size: 17px;overflow-wrap: break-word !important;"  /></figure><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;padding-right: 0.5em;padding-left: 0.5em;max-width: 100%;display: flex;flex-direction: column;justify-content: center;align-items: center;overflow-wrap: break-word !important;box-sizing: border-box !important;"><img class="rich_pages wxw-img" data-ratio="0.6574074074074074" src="图片/大数据技术与架构_2021-12-28_「转」【Spark重点难点-面试篇】SparkSQL面试专题/5_ibqM9S3BOIOicTSNuqbIw29KGsTIPw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PM7nI3CL3Oy36gcxKeHdodsDazT1XgoDW32ye4TAd3fnOhDSibqM9S3BOIOicTSNuqbIw29KGsTIPw/640?wx_fmt=png'" data-type="png" data-w="1080" style="margin-right: auto;margin-left: auto;display: block;border-radius: 6px;box-shadow: rgb(180, 180, 180) 0em 0em 0.5em 0px;font-size: 17px;overflow-wrap: break-word !important;"  /></figure></section><section style="padding-top: 8px;padding-bottom: 8px;max-width: 100%;line-height: 26px;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="font-size: 14px;">电子版把他们分类做成了下面这个样子，并且放在了阿里云盘提供下载。</span></section><section style="padding-right: 10px;padding-left: 10px;max-width: 100%;line-height: 1.6;letter-spacing: 0.034em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;padding-right: 0.5em;padding-left: 0.5em;max-width: 100%;display: flex;flex-direction: column;justify-content: center;align-items: center;overflow-wrap: break-word !important;box-sizing: border-box !important;"><img class="rich_pages wxw-img" data-ratio="0.42314814814814816" src="图片/大数据技术与架构_2021-12-28_「转」【Spark重点难点-面试篇】SparkSQL面试专题/6_aSS56bw8SAal18vVZXoAccvxJ1ZEog.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PM7nI3CL3Oy36gcxKeHdodduk3T8FicKOfOTaks0WNX5EKJiaSS56bw8SAal18vVZXoAccvxJ1ZEog/640?wx_fmt=png'" data-type="png" data-w="1080" style="margin-right: auto;margin-left: auto;display: block;border-radius: 6px;box-shadow: rgb(180, 180, 180) 0em 0em 0.5em 0px;font-size: 17px;overflow-wrap: break-word !important;"  /></figure></section><section style="padding-top: 8px;padding-bottom: 8px;max-width: 100%;line-height: 26px;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="font-size: 14px;">我们点开一个文件夹后:</span></section><section style="padding-right: 10px;padding-left: 10px;max-width: 100%;white-space: normal;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;line-height: 1.6;letter-spacing: 0.034em;font-size: 16px;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><figure data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;padding-right: 0.5em;padding-left: 0.5em;max-width: 100%;display: flex;flex-direction: column;justify-content: center;align-items: center;overflow-wrap: break-word !important;box-sizing: border-box !important;"><img class="rich_pages wxw-img" data-ratio="0.7435185185185185" src="图片/大数据技术与架构_2021-12-28_「转」【Spark重点难点-面试篇】SparkSQL面试专题/7_mHztuezIg8YLzqrHmnaLaW2M5iaEmg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2PM7nI3CL3Oy36gcxKeHdodxsrfAZf18GhJRbPZWqTzlUoUumHztuezIg8YLzqrHmnaLaW2M5iaEmg/640?wx_fmt=png'" data-type="png" data-w="1080" style="margin-right: auto;margin-left: auto;display: block;border-radius: 6px;box-shadow: rgb(180, 180, 180) 0em 0em 0.5em 0px;font-size: 17px;overflow-wrap: break-word !important;"  /></figure></section><section style="padding-top: 1em;padding-bottom: 8px;max-width: 100%;color: rgb(74, 74, 74);line-height: 1.75em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="font-size: 14px;"><span style="font-size: 14px;max-width: 100%;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);overflow-wrap: break-word !important;box-sizing: border-box !important;">如果这个文章对你有帮助，不要忘记&nbsp;</span><span style="font-size: 14px;max-width: 100%;outline: 0px;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);color: rgb(255, 104, 39);overflow-wrap: break-word !important;box-sizing: border-box !important;"><strong style="max-width: 100%;outline: 0px;line-height: 1.75em;overflow-wrap: break-word !important;box-sizing: border-box !important;">「在看」</strong>&nbsp;<strong style="max-width: 100%;outline: 0px;line-height: 1.75em;overflow-wrap: break-word !important;box-sizing: border-box !important;">「点赞」</strong>&nbsp;<strong style="max-width: 100%;outline: 0px;line-height: 1.75em;overflow-wrap: break-word !important;box-sizing: border-box !important;">「收藏」</strong></span><span style="font-size: 14px;max-width: 100%;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);overflow-wrap: break-word !important;box-sizing: border-box !important;">&nbsp;三连啊喂！</span></span></section><blockquote data-tool="mdnice编辑器" style="margin-top: 20px;margin-bottom: 20px;padding: 15px 20px;border-left-color: rgb(53, 179, 120);color: rgb(106, 115, 125);line-height: 27px;font-size: 0.9em;max-width: 100%;border-top: none;border-right: none;border-bottom: none;overflow: auto;background: rgb(251, 249, 253);overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;line-height: 26px;font-size: 15px;color: rgb(89, 89, 89);margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="font-size: 14px;">Hi，我是王知无，一个大数据领域的原创作者。&nbsp;</span></section><section style="max-width: 100%;line-height: 26px;font-size: 15px;color: rgb(89, 89, 89);margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="font-size: 14px;">放心关注我，获取更多行业的一手消息。</span></section></blockquote><section style="max-width: 100%;white-space: normal;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;line-height: normal;font-family: &quot;Helvetica Neue&quot;;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><img class="rich_pages wxw-img" data-ratio="0.4662576687116564" data-s="300,640" src="图片/大数据技术与架构_2021-12-28_「转」【Spark重点难点-面试篇】SparkSQL面试专题/8_T7huEHTT4z45Jibay1ZebmsSSqiaeA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MPL7m13Yrluz8WJicNiaVRsiaCqArkyO99exPDGicFIH6AF7ZWRpT7huEHTT4z45Jibay1ZebmsSSqiaeA/640?wx_fmt=jpeg'" data-type="jpeg" data-w="978" style="height: 241px;font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;text-align: center;widows: 1;color: rgb(255, 97, 149);font-size: 15px;letter-spacing: 1px;border-radius: 30px;box-shadow: rgb(150, 150, 150) 0em 0em 0.5em 0px;width: 518px;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="padding-right: 0.5em;padding-left: 0.5em;max-width: 100%;text-align: left;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;line-height: normal;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 1px;-webkit-text-stroke-color: rgb(136, 136, 136);color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><br  /></section><section style="padding-right: 0.5em;padding-left: 0.5em;max-width: 100%;text-align: left;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;line-height: normal;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 1px;-webkit-text-stroke-color: rgb(136, 136, 136);color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><br  /></section><section style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-tools="135编辑器" data-id="98469" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section hm_fix="349:393" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><img class="rich_pages wxw-img" data-ratio="0.10979228486646884" src="图片/大数据技术与架构_2021-12-28_「转」【Spark重点难点-面试篇】SparkSQL面试专题/9_zrkyKUN5kNeUFicVC3bMP1GEqKz1OQ.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/BSBqCXrZtzAicMToibKuIysLrB62M5A5YaLhZg6z86tI7ZeEZqTLLYyNrmlzrkyKUN5kNeUFicVC3bMP1GEqKz1OQ/640?wx_fmt=jpeg'" data-type="jpeg" data-w="1011" style="height: 42px;color: rgb(136, 136, 136);font-family: &quot;Helvetica Neue&quot;;font-size: 13px;letter-spacing: 1px;-webkit-text-stroke-color: rgb(136, 136, 136);box-sizing: border-box;width: 384px;overflow-wrap: break-word !important;"  /></section><section style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-tools="135编辑器" data-id="98469" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section hm_fix="349:393" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504680&amp;idx=1&amp;sn=9f2547b40316b8dc8a748bbc8b6b6015&amp;chksm=fd3e95bdca491cab9e0badbd7a1144f7511638ae80db684fd5383c771129a16bb08ba5e72515&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;letter-spacing: 0.544px;overflow-wrap: break-word !important;box-sizing: border-box !important;">八千里路云和月 | 从零到大数据专家学习路径指南</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508317&amp;idx=1&amp;sn=0bcb7fb6997b42306994b890eaa0d47f&amp;chksm=fd3ee7c8ca496ede347a2971002c6ea68dcfd70abeeb90b43c8b02a2a60ebc7cec3a87ef7d52&amp;scene=21#wechat_redirect" textvalue="互联网最坏的时代可能真的来了" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">互联网最坏的时代可能真的来了</a><br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247507860&amp;idx=1&amp;sn=807ac5003762f29c127bc4071dcebe33&amp;chksm=fd3e9901ca4910178cfc816043ea86c29f881f70cd943d252de9ae2e21cb7e8ba80bff162e1b&amp;scene=21#wechat_redirect" textvalue="我在B站读大学，大数据专业" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">我在B站读大学，大数据专业</a><br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247499604&amp;idx=1&amp;sn=d938dfb30d221774704982d2938b30c1&amp;chksm=fd3eb9c1ca4930d76a391241333de461ca22d2aa27472eab3cffab1564872ae37f1b48fe2d3c&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">我们在学习Flink的时候，到底在学习什么？</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504856&amp;idx=2&amp;sn=6f62e2a0c756ce56773eed253d2f41ee&amp;chksm=fd3e954dca491c5b732b7e2aa46db32efbc3f690e528522098659bb3c6e78e1582ab4529b5dc&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;letter-spacing: 0.544px;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">193篇文章暴揍Flink，这个合集你需要关注一下</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504742&amp;idx=1&amp;sn=8765c198d8ad66219a7bcabb221e4a23&amp;chksm=fd3e95f3ca491ce52d0724b9e4154a47af0f5ea349e1e184c8fbc65aa17c0000242aa9b58429&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;letter-spacing: 0.544px;overflow-wrap: break-word !important;box-sizing: border-box !important;">Flink生产环境TOP难题与优化，阿里巴巴藏经阁YYDS</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504813&amp;idx=1&amp;sn=f5cd6ae2aa2b1e30f87a5ae55971c514&amp;chksm=fd3e9538ca491c2eb191677d070f2c7e4f1098eece00e256d6205b8a5d21b21c1e74f875f16f&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;letter-spacing: 0.544px;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">Flink CDC我吃定了耶稣也留不住他！| Flink CDC线上问题小盘点</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI0NjU2NDkzMQ==&amp;mid=2247492567&amp;idx=1&amp;sn=1f693e549f76622725b936041ff8896e&amp;chksm=e9bff2fbdec87bedecbdeed4547d7d612c72fc8d4918614a26a4e31666cf0128fd57b537f347&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">我们在学习Spark的时候，到底在学习什么？</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504834&amp;idx=1&amp;sn=46ca1a3924b8fdb89ac1c2acb0319d6c&amp;chksm=fd3e9557ca491c41d837b917639ea62007ea16d3c2cc6c0c02d1f8a8c6e44318f5183b787c46&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;letter-spacing: 0.544px;overflow-wrap: break-word !important;box-sizing: border-box !important;">在所有Spark模块中，我愿称SparkSQL为最强！</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247502750&amp;idx=1&amp;sn=bd9a9173d060dc4e4ebd49c8efc6acfe&amp;chksm=fd3e8d0bca49041dea84da93910e5efdc4935e520525c09887c986691377aeb48e5cf7fb5667&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">硬刚Hive | 4万字基础调优面试小总结</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504382&amp;idx=2&amp;sn=550b78802acfe727e0e77cd9195f8784&amp;chksm=fd3e976bca491e7db2b8b2446d231736df01bbf13653804d680ac4390597ec17fa466ad4ae83&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">数据治理方法论和实践小百科全书</a><br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247503741&amp;idx=1&amp;sn=e5039be93123f2e337013756a818bfc3&amp;chksm=fd3e89e8ca4900fe603b63c5722a6fb8a32bd63d6ba23e0028851948a71b877eb1f742d95087&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">标签体系下的用户画像建设小指南</a><br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247503675&amp;idx=1&amp;sn=3ee6af64d0126c78b48cad219308f81e&amp;chksm=fd3e89aeca4900b8b8954e9569ee3c0877881fac8c792bfafc22e7e9d3e8524da8eb860d33d8&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">4万字长文 | ClickHouse基础&amp;实践&amp;调优全视角解析</a><br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI0NjU2NDkzMQ==&amp;mid=2247492567&amp;idx=2&amp;sn=57ecc77718f1b6f2f262d62e8318dcc9&amp;chksm=e9bff2fbdec87bedb1986765bfae7dbabb9aece45b0b2af147bbad1ac5d79ebc934c64df40ea&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">【面试&amp;个人成长】2021年过半，社招和校招的经验之谈</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504478&amp;idx=1&amp;sn=14efef3868ba42bd044f9618745a7fdc&amp;chksm=fd3e94cbca491dddb961b7b8b93105b2869c5bcf4c03f9f0dc83ad62be0dce4c124b52ed0ba3&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">大数据方向另一个十年开启 |《硬刚系列》第一版完结</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504410&amp;idx=1&amp;sn=7e81ab5a324395eb0f12397c40247ca1&amp;chksm=fd3e948fca491d9946456acbd93b2d651ae4d7a7d0127a211981e08f50f377e60d1b7c0d7b3a&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">我写过的关于成长/面试/职场进阶的文章</a></section><section style="max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-tools="135编辑器" data-id="98469" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section hm_fix="349:393" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504783&amp;idx=1&amp;sn=72aed147a459368ed934a007a2df3bc9&amp;chksm=fd3e951aca491c0cade212390011eca7d8a68951fee6aa2844b8f4d14bcbd5b3ed26305d69dc&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">当我们在学习Hive的时候在学习什么？「硬刚Hive续集」</a></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></content>
</div>
</body>
</html>