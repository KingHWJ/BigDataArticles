<html>
<head>
<title></title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0,viewport-fit=cover">
<style>
*{margin:0;padding:0}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;line-height:1.6}img{z-index:999;position:relative;max-width:100%;margin:10px 0;}body{letter-spacing:.034em}h1,h2,h3,h4,h5,h6{font-weight:400;font-size:16px}a{color:#576b95;text-decoration:none;-webkit-tap-highlight-color:rgba(0,0,0,0)}td,th{word-wrap:break-word;padding:5px 10px;border:1px solid #DDD;}table{margin-bottom:10px;border-collapse:collapse;display:table;width:100%!important;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}.rich_media_area_primary{padding:20px 16px 12px;background-color:#fafafa}@media (max-width:375px){.rich_media_area_primary{padding:20px 60px 15px 60px}.rich_media_area_extra{padding:0 60px 21px 60px}}@media (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner,body{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media{padding:20px;overflow:hidden;}.appmsg_skin_default .rich_media_area_primary{background-color:#fff}.appmsg_skin_default .rich_media_area_primary .weui-loadmore_line .weui-loadmore__tips{background-color:#fff}@media screen and (min-width:1024px){.rich_media_area_primary_inner,.rich_media_area_extra_inner{max-width:677px;margin-left:auto;margin-right:auto}.rich_media_area_primary{padding-top:32px}}.rich_media_content{overflow:hidden;color:#333;font-size:17px;word-wrap:break-word;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;text-align:justify;position:relative;z-index:0}.rich_media_content *{max-width:100%!important;box-sizing:border-box!important;-webkit-box-sizing:border-box!important;word-wrap:break-word!important}.rich_media_content p{clear:both;min-height:1em}.rich_media_content em{font-style:italic}.rich_media_content fieldset{min-width:0}.rich_media_content .list-paddingleft-1,.rich_media_content .list-paddingleft-2,.rich_media_content .list-paddingleft-3{padding-left:2.2em}.rich_media_content .list-paddingleft-1 .list-paddingleft-2,.rich_media_content .list-paddingleft-2 .list-paddingleft-2,.rich_media_content .list-paddingleft-3 .list-paddingleft-2{padding-left:30px}.rich_media_content .list-paddingleft-1{padding-left:1.2em}.rich_media_content .list-paddingleft-3{padding-left:3.2em}.rich_media_content .code-snippet,.rich_media_content .code-snippet__fix{max-width:1000%!important}.rich_media_content .code-snippet *,.rich_media_content .code-snippet__fix *{max-width:1000%!important}.rich_media_title{font-size:22px;line-height:1.4;margin-bottom:13px;padding-bottom:13px;border-bottom:1px solid #e7e7eb;}@supports(-webkit-overflow-scrolling:touch){.rich_media_title{font-weight:700}}.rich_media_meta{display:inline-block;vertical-align:middle;padding:0 0 10px 0;font-size:15px;-webkit-tap-highlight-color:rgba(0,0,0,0)}.rich_media_meta.icon_appmsg_tag{margin-right:0px}.rich_media_meta.meta_tag_text{margin-right:0}.rich_media_meta_list em{font-style:normal}.rich_media_meta_text{color:#a5a5a5;}p{margin:0;}.msgBox{margin-top:20px;padding-top:20px;padding-left:50px;overflow:hidden;border-top:2px dashed #09a2ff;}.msg{padding-top:7px;clear:both;}.msgBody{float:right;width:100%;margin-left:55px;padding-bottom:15px;border-bottom:1px dashed #e0e0e0;}.userHeadImg{float:left;margin-left:-50px;}.userHeadImg img{width:40px;height:40px;margin-right:10px;border-radius:3px;}.userName{color:#888888;line-height:24px;font-size:14px;margin:5px 0 5px 0;height:24px;}.replyBody,.autherBody{color:#565656;font-size:15px;}.replyIcon{border-left:4px solid #33ab01;margin-right:5px;}.ad{text-decoration:none;color:#d6d4d4;font-size:12px;}.msgBodyReply{padding-top:5px;}.userName span{float:right;color:#afafaf;font-size:14px;}code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;}.code-snippet__fix{font-size:14px;margin:10px 0;display:block;color:#333;position:relative;background-color:rgba(0,0,0,0.03);border:1px solid #f0f0f0;border-radius:2px;display:-webkit-box;display:-webkit-flex;display:flex;padding-left:25px;line-height:26px}.code-snippet__fix code{text-align:left;font-size:14px;display:block;white-space:pre;display:-webkit-box;display:-webkit-flex;display:flex;position:relative;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace}.code-snippet__comment,.code-snippet__quote{color:#afafaf;font-style:italic}.code-snippet__keyword,.code-snippet__selector-tag,.code-snippet__subst{color:#ca7d37}.code-snippet__number,.code-snippet__literal,.code-snippet__variable,.code-snippet__template-variable,.code-snippet__tag .code-snippet__attr{color:#0e9ce5}.code-snippet__string,.code-snippet__doctag{color:#d14}.code-snippet__title,.code-snippet__section,.code-snippet__selector-id{color:#d14}.code-snippet__subst{font-weight:normal}.code-snippet__type,.code-snippet__class .code-snippet__title{color:#0e9ce5}.code-snippet__tag,.code-snippet__name,.code-snippet__attribute{color:#0e9ce5;font-weight:normal}.code-snippet__regexp,.code-snippet__link{color:#ca7d37}.code-snippet__symbol,.code-snippet__bullet{color:#d14}.code-snippet__built_in,.code-snippet__builtin-name{color:#ca7d37}.code-snippet__meta{color:#afafaf}.code-snippet__deletion{background:#fdd}.code-snippet__addition{background:#dfd}.code-snippet__emphasis{font-style:italic}.code-snippet__strong{font-weight:bold}.account_avatar{width:40px;height:40px;padding:0;}.account_info{display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-align:center;-webkit-align-items:center;padding:20px 0;align-items:center}.flex_bd{padding-left:14px;}.account_nickname{display:inline-block;vertical-align:middle;line-height:1.2;color:#576b95;font-size:14px}.account_desc{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:1;color:rgba(0,0,0,0.3);font-size:14px;line-height:1.2;padding-top:.4em}.msg_source_url{text-align:left;word-break:break-all;margin-top:20px;}.msg_source_url a{padding-right:10px;}.msg_source_url .url_text{color:#a8a8a8;}.video-desc{font-size:14px;margin-top:15px;color:#6c6c6c;}.msg_source_url{text-align:left;}.original_primary_card_tips{color:rgba(0,0,0,0.3);line-height:1.4;font-size:15px;}.weui-flex__item{margin-bottom:20px;padding:20px 16px;margin-top:16px;line-height:1.4;align-items:center;background-color:#f7f7f7;border-radius:8px;position:relative;}.original_primary_desc{color:rgba(0,0,0,0.5);font-size:14px;padding-top:4px;width:auto;overflow:hidden;text-overflow:ellipsis;}.msgBodyReplyList{border-top:1px solid #e1e1e1;margin-top:10px;}.msgBodyReplyListTop{border-top:0;}.reply_like_num{float:right;font-size:14px;color:#c7c7c7;}.msgData{margin-top:20px;color:#626262;}.msgData span{font-size:14px;padding-right:15px;}.msgData .likes{float:right;padding-right:0;}.js_text_content p{font-size:18px;}.rich_media_meta_link{font-size:15px;}blockquote {padding-left: 10px;border-left: 3px solid #dbdbdb;color: rgba(0,0,0,0.5);font-size: 15px;padding-top: 4px;margin: 1em 0;}.video_iframe{width:500px;height:400px;}.blockquote_info{color:#b5b5b5;margin-top:10px;}#copyright_logo{color:#bdbdbd;}.rich_media_meta_list{margin-bottom:10px;}.reprint{background:#efefef;border-radius:5px;padding:8px;color:#1f1f1f;}.reprint a{word-break:break-all;}.topic{color:#8e8e8e;background:#f7f7f7;border-radius:5px;padding:10px 8px;}.topic a{padding-right:5px;}.topic p{margin-bottom:5px;}
</style>
<link href="https://www.juyifx.cn/config/css/wxArticle.css" rel="stylesheet"/>
</head><script>
var data={"mp":"大数据技术与架构","title":"Apache Iceberg核心原理分析文件存储及数据写入流程","time":"2022-07-06 18:10:57","timeStamp":"1657102257"};
</script>
<body>
<div class="rich_media"><h1 class="rich_media_title" id="activity-name"><a href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&mid=2247514427&idx=1&sn=4116b24cb48d4c0b3a89292640df17e6&chksm=fd3effaeca4976b8ab8a23221ab70a45f290158105a3ca60ffbef0f09a144dc416556cf91d4b#rd" target="_blank">Apache Iceberg核心原理分析文件存储及数据写入流程</a></h1><div id="meta_content" class="rich_media_meta_list"><span class="rich_media_meta rich_media_meta_nickname" id="profileBt"><a href="javascript:void(0);" class="wx_tap_link js_wx_tap_highlight weui-wa-hotarea" id="js_name">大数据技术与架构&nbsp;&nbsp;</a></span><em id="publish_time" class="rich_media_meta rich_media_meta_text">2022-07-06 18:10:57</em></div><content><div class="topic"><p>收录于话题</p><p><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzU3MzgwNTU2Mg==&action=getalbum&album_id=1369031183400747008#wechat_redirect" title="大数据成神之路" target="_blank">#大数据成神之路</a></p></div><section mp-original-font-size="14" mp-original-line-height="24.5" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;font-style: normal;font-variant-caps: normal;font-weight: normal;letter-spacing: 0.47600001096725464px;orphans: auto;text-indent: 0px;text-transform: none;white-space: normal;widows: auto;word-spacing: 0px;-webkit-text-size-adjust: auto;-webkit-text-stroke-width: 0px;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 12.25px;font-family: &quot;Helvetica Neue&quot;;-webkit-text-stroke-color: rgb(178, 178, 178);text-align: center;color: rgb(178, 178, 178);background-color: rgb(255, 255, 255);line-height: 21.4375px;visibility: visible;overflow-wrap: break-word !important;" data-mpa-powered-by="yiban.io"><span style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;visibility: visible;line-height: 16.4131px;font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;">点击上方<strong mp-original-font-size="14" mp-original-line-height="24.5" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;visibility: visible;font-size: 12.25px;line-height: 21.4375px;overflow-wrap: break-word !important;"><span mp-original-font-size="14" mp-original-line-height="17" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;line-height: 14.875px;color: rgb(87, 107, 148);-webkit-text-stroke-color: rgb(87, 107, 148);visibility: visible;box-sizing: border-box !important;overflow-wrap: break-word !important;">蓝色字体</span></strong>，选择“设为星标”</span></section><section mp-original-font-size="14" mp-original-line-height="24.5" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;font-style: normal;font-variant-caps: normal;font-weight: normal;letter-spacing: 0.47600001096725464px;orphans: auto;text-indent: 0px;text-transform: none;white-space: normal;widows: auto;word-spacing: 0px;-webkit-text-size-adjust: auto;-webkit-text-stroke-width: 0px;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 12.25px;font-family: &quot;Helvetica Neue&quot;;-webkit-text-stroke-color: rgb(178, 178, 178);text-align: center;color: rgb(178, 178, 178);line-height: 21.4375px;visibility: visible;overflow-wrap: break-word !important;"><span style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;visibility: visible;line-height: 16.4131px;font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span mp-original-font-size="14" mp-original-line-height="24.5" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;background-color: rgb(255, 255, 255);visibility: visible;line-height: 21.4375px;">回复"</span><strong mp-original-font-size="14" mp-original-line-height="24.5" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;visibility: visible;font-size: 12.25px;line-height: 21.4375px;overflow-wrap: break-word !important;"><span mp-original-font-size="14" mp-original-line-height="24.5" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;background-color: rgb(255, 255, 255);color: rgb(255, 0, 0);visibility: visible;line-height: 21.4375px;box-sizing: border-box !important;overflow-wrap: break-word !important;">面试"</span></strong><span mp-original-font-size="14" mp-original-line-height="24.5" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;background-color: rgb(255, 255, 255);visibility: visible;line-height: 21.4375px;">获取更多惊喜</span></span></section><section mp-original-font-size="14" mp-original-line-height="16" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;font-style: normal;font-variant-caps: normal;font-weight: normal;letter-spacing: 0.47600001096725464px;orphans: auto;text-indent: 0px;text-transform: none;white-space: normal;widows: auto;word-spacing: 0px;-webkit-text-size-adjust: auto;-webkit-text-stroke-width: 0px;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 12.25px;line-height: 14px;font-family: &quot;Helvetica Neue&quot;;-webkit-text-stroke-color: rgb(178, 178, 178);text-align: center;color: rgb(178, 178, 178);visibility: visible;overflow-wrap: break-word !important;"><span style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;background-color: rgb(255, 255, 255);visibility: visible;line-height: 10.7188px;font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><img class="rich_pages wxw-img" data-ratio="0.0625" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/1_TMnLIpBq96wT1ibdccSSd3LVdSE3LQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/sq2uE6cicHYxoldXibjHyWbvjJfI6ibEm5Kw715uVJTBLdX1gkVpExwlFh22TMnLIpBq96wT1ibdccSSd3LVdSE3LQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1'" data-type="png" data-w="640" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;vertical-align: bottom;height: auto !important;font-size: 9.37890625px;line-height: 10.71875px;visibility: visible !important;overflow-wrap: break-word !important;width: 638px !important;"  /></span></section><section mp-original-font-size="17" mp-original-line-height="27" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;color: rgb(34, 34, 34);font-size: 14.875px;font-style: normal;font-variant-caps: normal;font-weight: normal;orphans: auto;text-align: justify;text-indent: 0px;text-transform: none;white-space: normal;widows: auto;word-spacing: 0px;-webkit-text-size-adjust: auto;-webkit-text-stroke-width: 0px;letter-spacing: 0.544px;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;background-color: rgb(255, 255, 255);line-height: 23.625px;visibility: visible;"><section powered-by="xiumi.us" mp-original-font-size="17" mp-original-line-height="27" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;line-height: 23.625px;visibility: visible;font-size: 14.875px;"><section mp-original-font-size="17" mp-original-line-height="27" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;line-height: 23.625px;visibility: visible;font-size: 14.875px;"><section powered-by="xiumi.us" mp-original-font-size="17" mp-original-line-height="27" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;line-height: 23.625px;visibility: visible;font-size: 14.875px;"><section data-role="outer" label="Powered by 135editor.com" mp-original-font-size="17" mp-original-line-height="27" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;line-height: 23.625px;visibility: visible;font-size: 14.875px;"><section data-tools="135编辑器" data-id="98469" mp-original-font-size="17" mp-original-line-height="27" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;line-height: 23.625px;visibility: visible;font-size: 14.875px;"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" mp-original-font-size="16" mp-original-line-height="25" style="margin: 0px;padding: 0px 10px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;font-size: 14px;color: black;line-height: 21.875px;letter-spacing: 0px;word-break: break-word;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;visibility: visible;"><blockquote data-tool="mdnice编辑器" mp-original-font-size="14.399999618530273" mp-original-line-height="23" style="margin: 20px 0px;padding: 10px 10px 10px 20px;outline: 0px;border-left-width: 3px;border-style: none none none solid;border-left-color: rgb(239, 112, 96);color: rgb(106, 115, 125);font-size: 12.59999966621399px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;line-height: 20.125px;overflow: auto;background-color: rgb(255, 249, 249);visibility: visible;"><p mp-original-font-size="16" mp-original-line-height="26" style="margin: 0px;padding: 8px 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;clear: both;min-height: 1em;font-size: 14px;color: black;line-height: 22.75px;visibility: visible;"><img class="rich_pages wxw-img" data-ratio="1" data-type="png" data-w="20" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/2_vBcv0y1XsD2G4eGzwpWDB5zJ7WsXTw.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/sq2uE6cicHYx7hRPkpj6kFISkZddB66TXddALsPHrNIMH29kxdMKMeBDdvBcv0y1XsD2G4eGzwpWDB5zJ7WsXTw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1'" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;vertical-align: text-bottom;height: auto !important;-webkit-text-stroke-color: rgb(178, 178, 178);color: rgb(178, 178, 178);font-family: &quot;Helvetica Neue&quot;;font-size: 8.75px;letter-spacing: 0.544px;display: inline-block;line-height: 16.250001430511475px;visibility: visible !important;width: 20px !important;"  /><span style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;visibility: visible;line-height: 13.3356px;font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong mp-original-font-size="15" mp-original-line-height="42" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;-webkit-text-stroke-color: rgb(178, 178, 178);font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;text-align: center;visibility: visible;line-height: 36.75px;font-size: 13.125px;"><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247512011&amp;idx=1&amp;sn=68aaa9c5c42e2087d56d170c442b30ba&amp;scene=21#wechat_redirect" textvalue="😄轻戳有惊喜：八股文教给我，‍你们专心刷题和面试" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2" wah-hotarea="click" mp-original-font-size="14" mp-original-line-height="22.75" style="margin: 0px;padding: 0px;outline: 0px;color: rgb(87, 107, 149);text-decoration: none;cursor: pointer;max-width: 100%;visibility: visible;line-height: 19.9062px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span mp-original-font-size="13.125" mp-original-line-height="16.493200302124023" style="margin: 0px;padding: 0px;outline: 0px;max-width: 100%;cursor: pointer;visibility: visible;line-height: 14.4316px;letter-spacing: 0.544px;color: rgb(255, 76, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;">全网最全大数据面试提升手册！</span></a></strong></span></p></blockquote></section></section></section></section></section></section></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px;color: black;padding: 0 10px;line-height: 1.6;word-spacing: 0px;letter-spacing: 0px;word-break: break-word;word-wrap: break-word;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &#39;PingFang SC&#39;, Cambria, Cochin, Georgia, Times, &#39;Times New Roman&#39;, serif;"><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;border-bottom: 2px solid rgb(239, 112, 96);font-size: 1.3em;"><span style="display: inline-block;font-weight: bold;background: rgb(239, 112, 96);color: #ffffff;padding: 3px 10px 1px;border-top-right-radius: 3px;border-top-left-radius: 3px;margin-right: 3px;">第一部分：Iceberg文件存储格式</span></h2><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">Apache Iceberg作为一款新兴的数据湖解决方案在实现上高度抽象，在存储上能够对接当前主流的HDFS，S3文件系统并且支持多种文件存储格式，例如Parquet、ORC、AVRO。相较于Hudi、Delta与Spark的强耦合，Iceberg可以与多种计算引擎对接，目前社区已经支持Spark读写Iceberg、Impala/Hive查询Iceberg。本文基于Apache Iceberg 0.10.0，介绍Iceberg文件的组织方式以及不同文件的存储格式。</p><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;font-size: 16px;">Iceberg Table Format</h5><figure data-tool="mdnice编辑器" style="margin: 0;margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.7364864864864865" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/3_mlOkO9IDJOzlMBtCE995NRzh7ASG5w.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MIAhHH1mPG6Tdsg33w3ia0LAARhBibSo47ib7IdXWNwy7zng7mlOkO9IDJOzlMBtCE995NRzh7ASG5w/640?wx_fmt=png'" data-type="png" data-w="888" style="display: block;margin: 0 auto;max-width: 100%;"  /></figure><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">从图中可以看到iceberg将数据进行分层管理，主要分为元数据管理层和数据存储层。元数据管理层又可以细分为三层：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: disc;" class="list-paddingleft-1"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">VersionMetadata</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">Snapshot</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">Manifest</section></li></ul><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">VersionMetadata存储当前版本的元数据信息（所有snapshot信息）；Snapshot表示当前操作的一个快照，每次commit都会生成一个快照，一个快照中包含多个Manifest，每个Manifest中记录了当前操作生成数据所对应的文件地址，也就是data files的地址。基于snapshot的管理方式，iceberg能够进行time travel（历史版本读取以及增量读取），并且提供了serializable isolation。</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">数据存储层支持不同的文件格式，目前支持Parquet、ORC、AVRO。</p><figure data-tool="mdnice编辑器" style="margin: 0;margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.28622540250447226" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/4_lxdKgoUdSic9zuXVw0ODcWY5n0VEug.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/UdK9ByfMT2MIAhHH1mPG6Tdsg33w3ia0LicTcLrGZDjLLlmS57CcPMOeTtLlxdKgoUdSic9zuXVw0ODcWY5n0VEug/640?wx_fmt=jpeg'" data-type="jpeg" data-w="1118" style="display: block;margin: 0 auto;max-width: 100%;"  /></figure><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">下面以HadoopTableOperation commit生成的数据为例介绍各层的数据格式。iceberg生成的数据目录结构如下所示：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">├──&nbsp;data<br  />│&nbsp;&nbsp;&nbsp;├──&nbsp;id=1<br  />│&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;├──&nbsp;00000-0-04ae60eb-657d-45cb-bb99-d1cb7fe0ad5a-00001.parquet<br  />│&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;└──&nbsp;00000-4-487b841b-13b4-4ae8-9238-f70674d5102e-00001.parquet<br  />│&nbsp;&nbsp;&nbsp;├──&nbsp;id=2<br  />│&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;├──&nbsp;00001-1-e85b018b-e43a-44d7-9904-09c80a9b9c24-00001.parquet<br  />│&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;└──&nbsp;00001-5-0e2be766-c921-4269-8e1e-c3cff4b98a5a-00001.parquet<br  />│&nbsp;&nbsp;&nbsp;├──&nbsp;id=3<br  />│&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;├──&nbsp;00002-2-097171c5-d810-4de9-aa07-58f3f8a3f52e-00001.parquet<br  />│&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;└──&nbsp;00002-6-9d738169-1dbe-4cc5-9a87-f79457a9ec0b-00001.parquet<br  />│&nbsp;&nbsp;&nbsp;└──&nbsp;id=4<br  />│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;├──&nbsp;00003-3-b0c91d66-9e4e-4b7a-bcd5-db3dc1b847f2-00001.parquet<br  />│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└──&nbsp;00003-7-68c45a24-21a2-41e8-90f1-ef4be42f3002-00001.parquet<br  />└──&nbsp;metadata<br  />&nbsp;&nbsp;&nbsp;&nbsp;├──&nbsp;1f8279fb-5b2d-464c-af12-d9d6fbe9b5ae-m0.avro<br  />&nbsp;&nbsp;&nbsp;&nbsp;├──&nbsp;1f8279fb-5b2d-464c-af12-d9d6fbe9b5ae-m1.avro<br  />&nbsp;&nbsp;&nbsp;&nbsp;├──&nbsp;f475511f-877e-4da5-90aa-efa5928a7759-m0.avro<br  />&nbsp;&nbsp;&nbsp;&nbsp;├──&nbsp;snap-2080639593951710914-1-1f8279fb-5b2d-464c-af12-d9d6fbe9b5ae.avro<br  />&nbsp;&nbsp;&nbsp;&nbsp;├──&nbsp;snap-5178718682852547007-1-f475511f-877e-4da5-90aa-efa5928a7759.avro<br  />&nbsp;&nbsp;&nbsp;&nbsp;├──&nbsp;v1.metadata.json<br  />&nbsp;&nbsp;&nbsp;&nbsp;├──&nbsp;v2.metadata.json<br  />&nbsp;&nbsp;&nbsp;&nbsp;├──&nbsp;v3.metadata.json<br  />&nbsp;&nbsp;&nbsp;&nbsp;└──&nbsp;version-hint.text<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">其中metadata目录存放元数据管理层的数据：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: disc;" class="list-paddingleft-1"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">version-hint.text：存储version.metadata.json的版本号，即下文的number</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">version[number].metadata.json</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">snap-[snapshotID]-[attemptID]-[commitUUID].avro(snapshot文件)</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">[commitUUID]-m-[manifestCount].avr- o(manifest文件)</section></li></ul><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">data目录组织形式类似于hive，都是以分区进行目录组织（上图中id为分区列），最终数据可以使用不同文件格式进行存储：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: disc;" class="list-paddingleft-1"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">[sparkPartitionID]-[sparkTaskID]-[UUID]-[fileCount].[parquet | avro | orc]</section></li></ul><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;font-size: 16px;">VersionMetadata</h5><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">//&nbsp;<br  />{<br  />&nbsp;&nbsp;//&nbsp;当前文件格式版本信息<br  />&nbsp;&nbsp;//&nbsp;目前为version&nbsp;1<br  />&nbsp;&nbsp;//&nbsp;支持row-level&nbsp;delete等功能的version&nbsp;2还在开发中<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"format-version"</span>&nbsp;:&nbsp;1,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"table-uuid"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"a9114f94-911e-4acf-94cc-6d000b321812"</span>,<br  />&nbsp;&nbsp;//&nbsp;hadoopTable&nbsp;location<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"location"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item"</span>,<br  />&nbsp;&nbsp;//&nbsp;最新snapshot的创建时间<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"last-updated-ms"</span>&nbsp;:&nbsp;1608810968725,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"last-column-id"</span>&nbsp;:&nbsp;6,<br  />&nbsp;&nbsp;//&nbsp;iceberg&nbsp;schema<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"schema"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"struct"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"fields"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;1,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,&nbsp;//&nbsp;类似probuf中的required<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;2,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"order_id"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;3,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"product_id"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;4,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"product_price"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"decimal(7,&nbsp;2)"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;5,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"product_quantity"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;6,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"product_name"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"string"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;]<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partition-spec"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"transform"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"identity"</span>,&nbsp;//&nbsp;transform类型<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"source-id"</span>&nbsp;:&nbsp;1,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"field-id"</span>&nbsp;:&nbsp;1000<br  />&nbsp;&nbsp;}&nbsp;],<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"default-spec-id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;//&nbsp;分区信息<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partition-specs"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"spec-id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"fields"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;transform类型：目前支持identity，year，bucket等<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"transform"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"identity"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;对应schema.fields中相应field的ID<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"source-id"</span>&nbsp;:&nbsp;1,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"field-id"</span>&nbsp;:&nbsp;1000<br  />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;]<br  />&nbsp;&nbsp;}&nbsp;],<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"default-sort-order-id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"sort-orders"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"order-id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"fields"</span>&nbsp;:&nbsp;[&nbsp;]<br  />&nbsp;&nbsp;}&nbsp;],<br  />&nbsp;&nbsp;//&nbsp;hive创建该表存储的一些hive&nbsp;property信息<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"properties"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"totalSize"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"rawDataSize"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"numRows"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"COLUMN_STATS_ACCURATE"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"{\"BASIC_STATS\":\"true\"}"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"numFiles"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span><br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;//&nbsp;当前snapshot&nbsp;id<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"current-snapshot-id"</span>&nbsp;:&nbsp;2080639593951710914,<br  />&nbsp;&nbsp;//&nbsp;snapshot信息<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshots"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshot-id"</span>&nbsp;:&nbsp;5178718682852547007,<br  />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;创建snapshot时间<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608809818168,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"summary"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;spark写入方式，目前支持overwrite以及append<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"operation"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"overwrite"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"spark.app.id"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"local-1608809790982"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"replace-partitions"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"true"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;本次snapshot添加的文件数量<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-data-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;本次snapshot添加的record数量<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-records"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;本次snapshot添加的文件大小<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-files-size"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"7217"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;本次snapshot修改的分区数量<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"changed-partition-count"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;本次snapshot中record总数&nbsp;=&nbsp;lastSnapshotTotalRecord&nbsp;-&nbsp;currentSnapshotDeleteRecord&nbsp;+&nbsp;currentSnapshotAddRecord<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-records"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-data-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-delete-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-position-deletes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-equality-deletes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest-list"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/snap-5178718682852547007-1-f475511f-877e-4da5-90aa-efa5928a7759.avro"</span><br  />&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshot-id"</span>&nbsp;:&nbsp;2080639593951710914,<br  />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;上次snapshotID<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"parent-snapshot-id"</span>&nbsp;:&nbsp;5178718682852547007,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608810968725,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"summary"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"operation"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"overwrite"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"spark.app.id"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"local-1608809790982"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"replace-partitions"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"true"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-data-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted-data-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-records"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted-records"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-files-size"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"7217"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"removed-files-size"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"7217"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"changed-partition-count"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-records"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-data-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-delete-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-position-deletes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-equality-deletes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},<br  />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;snapshot文件路径<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest-list"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/snap-2080639593951710914-1-1f8279fb-5b2d-464c-af12-d9d6fbe9b5ae.avro"</span><br  />&nbsp;&nbsp;}&nbsp;],<br  />&nbsp;&nbsp;//&nbsp;snapshot记录<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshot-log"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608809818168,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshot-id"</span>&nbsp;:&nbsp;5178718682852547007<br  />&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608810968725,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshot-id"</span>&nbsp;:&nbsp;2080639593951710914<br  />&nbsp;&nbsp;}&nbsp;],<br  />&nbsp;&nbsp;//&nbsp;metada记录<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"metadata-log"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608809758229,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"metadata-file"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/v1.metadata.json"</span><br  />&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608809818168,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"metadata-file"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/v2.metadata.json"</span><br  />&nbsp;&nbsp;}&nbsp;]<br  />}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">上例展示的是v3.metadata.json中的数据，该文件保存了iceberg table schema、partition、snapshot信息，partition中的transform信息使得iceberg能够根据字段进行hidden partition，而无需像hive一样显示的指定分区字段。由于VersionMetadata中记录了每次snapshot的id以及create_time，我们可以通过时间或snapshotId查询相应snapshot的数据，实现Time Travel。</p><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;font-size: 16px;">Snapshot</h5><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">//&nbsp;Snapshot:&nbsp;2080639593951710914<br  />//&nbsp;Location:&nbsp;hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/snap-2080639593951710914-1-1f8279fb-5b2d-464c-af12-d9d6fbe9b5ae.avro<br  /><br  />//&nbsp;manifest&nbsp;entry<br  />{<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest_path"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/1f8279fb-5b2d-464c-af12-d9d6fbe9b5ae-m1.avro"</span>,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest_length"</span>&nbsp;:&nbsp;5291,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partition_spec_id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;//&nbsp;该manifest&nbsp;entry所属的snapshot<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_snapshot_id"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;2080639593951710914<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;//&nbsp;该manifest中添加的文件数量<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;4<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;//&nbsp;创建该manifest时已经存在且<br  />&nbsp;&nbsp;//&nbsp;没有被这次创建操作删除的文件数量<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"existing_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;//&nbsp;创建manifest删除的文件<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;//&nbsp;该manifest中partition字段的范围<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partitions"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"array"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"contains_null"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"lower_bound"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"bytes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"\u0001\u0000\u0000\u0000\u0000\u0000\u0000\u0000"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"upper_bound"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"bytes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"\u0004\u0000\u0000\u0000\u0000\u0000\u0000\u0000"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;]<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;4<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"existing_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;}<br  />}<br  />//&nbsp;manifest&nbsp;entry<br  />{<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest_path"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/1f8279fb-5b2d-464c-af12-d9d6fbe9b5ae-m0.avro"</span>,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest_length"</span>&nbsp;:&nbsp;5289,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partition_spec_id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_snapshot_id"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;2080639593951710914<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"existing_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;4<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partitions"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"array"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"contains_null"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"lower_bound"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"bytes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"\u0001\u0000\u0000\u0000\u0000\u0000\u0000\u0000"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"upper_bound"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"bytes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"\u0004\u0000\u0000\u0000\u0000\u0000\u0000\u0000"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;]<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"existing_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;4<br  />&nbsp;&nbsp;}<br  />}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">一个snapshot中可以包含多个manifest entry，一个manifest entry表示一个manifest，其中重点需要关注的是每个manifest中的partitions字段，在根据filter进行过滤时可以首先通过该字段表示的分区范围对manifest进行过滤，避免无效的查询。</p><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;font-size: 16px;">Manifest</h5><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">//&nbsp;<br  />{<br  />&nbsp;&nbsp;//&nbsp;当前文件格式版本信息<br  />&nbsp;&nbsp;//&nbsp;目前为version&nbsp;1<br  />&nbsp;&nbsp;//&nbsp;支持row-level&nbsp;delete等功能的version&nbsp;2还在开发中<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"format-version"</span>&nbsp;:&nbsp;1,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"table-uuid"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"a9114f94-911e-4acf-94cc-6d000b321812"</span>,<br  />&nbsp;&nbsp;//&nbsp;hadoopTable&nbsp;location<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"location"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item"</span>,<br  />&nbsp;&nbsp;//&nbsp;最新snapshot的创建时间<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"last-updated-ms"</span>&nbsp;:&nbsp;1608810968725,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"last-column-id"</span>&nbsp;:&nbsp;6,<br  />&nbsp;&nbsp;//&nbsp;iceberg&nbsp;schema<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"schema"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"struct"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"fields"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;1,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,&nbsp;//&nbsp;类似probuf中的required<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;2,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"order_id"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;3,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"product_id"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;4,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"product_price"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"decimal(7,&nbsp;2)"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;5,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"product_quantity"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>&nbsp;:&nbsp;6,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"product_name"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"required"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"type"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"string"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;]<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partition-spec"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"transform"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"identity"</span>,&nbsp;//&nbsp;transform类型<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"source-id"</span>&nbsp;:&nbsp;1,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"field-id"</span>&nbsp;:&nbsp;1000<br  />&nbsp;&nbsp;}&nbsp;],<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"default-spec-id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;//&nbsp;分区信息<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partition-specs"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"spec-id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"fields"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"name"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;transform类型：目前支持identity，year，bucket等<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"transform"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"identity"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;对应schema.fields中相应field的ID<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"source-id"</span>&nbsp;:&nbsp;1,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"field-id"</span>&nbsp;:&nbsp;1000<br  />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;]<br  />&nbsp;&nbsp;}&nbsp;],<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"default-sort-order-id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"sort-orders"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"order-id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"fields"</span>&nbsp;:&nbsp;[&nbsp;]<br  />&nbsp;&nbsp;}&nbsp;],<br  />&nbsp;&nbsp;//&nbsp;hive创建该表存储的一些hive&nbsp;property信息<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"properties"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"totalSize"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"rawDataSize"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"numRows"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"COLUMN_STATS_ACCURATE"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"{\"BASIC_STATS\":\"true\"}"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"numFiles"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span><br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;//&nbsp;当前snapshot&nbsp;id<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"current-snapshot-id"</span>&nbsp;:&nbsp;2080639593951710914,<br  />&nbsp;&nbsp;//&nbsp;snapshot信息<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshots"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshot-id"</span>&nbsp;:&nbsp;5178718682852547007,<br  />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;创建snapshot时间<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608809818168,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"summary"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;spark写入方式，目前支持overwrite以及append<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"operation"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"overwrite"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"spark.app.id"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"local-1608809790982"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"replace-partitions"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"true"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;本次snapshot添加的文件数量<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-data-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;本次snapshot添加的record数量<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-records"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;本次snapshot添加的文件大小<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-files-size"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"7217"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;本次snapshot修改的分区数量<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"changed-partition-count"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;本次snapshot中record总数&nbsp;=&nbsp;lastSnapshotTotalRecord&nbsp;-&nbsp;currentSnapshotDeleteRecord&nbsp;+&nbsp;currentSnapshotAddRecord<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-records"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-data-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-delete-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-position-deletes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-equality-deletes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest-list"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/snap-5178718682852547007-1-f475511f-877e-4da5-90aa-efa5928a7759.avro"</span><br  />&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshot-id"</span>&nbsp;:&nbsp;2080639593951710914,<br  />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;上次snapshotID<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"parent-snapshot-id"</span>&nbsp;:&nbsp;5178718682852547007,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608810968725,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"summary"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"operation"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"overwrite"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"spark.app.id"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"local-1608809790982"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"replace-partitions"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"true"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-data-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted-data-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-records"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted-records"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added-files-size"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"7217"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"removed-files-size"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"7217"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"changed-partition-count"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-records"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-data-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"4"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-delete-files"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-position-deletes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"total-equality-deletes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"0"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;},<br  />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;snapshot文件路径<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest-list"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/snap-2080639593951710914-1-1f8279fb-5b2d-464c-af12-d9d6fbe9b5ae.avro"</span><br  />&nbsp;&nbsp;}&nbsp;],<br  />&nbsp;&nbsp;//&nbsp;snapshot记录<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshot-log"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608809818168,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshot-id"</span>&nbsp;:&nbsp;5178718682852547007<br  />&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608810968725,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"snapshot-id"</span>&nbsp;:&nbsp;2080639593951710914<br  />&nbsp;&nbsp;}&nbsp;],<br  />&nbsp;&nbsp;//&nbsp;metada记录<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"metadata-log"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608809758229,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"metadata-file"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/v1.metadata.json"</span><br  />&nbsp;&nbsp;},&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"timestamp-ms"</span>&nbsp;:&nbsp;1608809818168,<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"metadata-file"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/v2.metadata.json"</span><br  />&nbsp;&nbsp;}&nbsp;]<br  />}<br  /><br  />上例展示的是v3.metadata.json中的数据，该文件保存了iceberg&nbsp;table&nbsp;schema、partition、snapshot信息，partition中的transform信息使得iceberg能够根据字段进行hidden&nbsp;partition，而无需像hive一样显示的指定分区字段。由于VersionMetadata中记录了每次snapshot的id以及create_time，我们可以通过时间或snapshotId查询相应snapshot的数据，实现Time&nbsp;Travel。<br  /><br  />Snapshot<br  /><br  />//&nbsp;Snapshot:&nbsp;2080639593951710914<br  />//&nbsp;Location:&nbsp;hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/snap-2080639593951710914-1-1f8279fb-5b2d-464c-af12-d9d6fbe9b5ae.avro<br  /><br  />//&nbsp;manifest&nbsp;entry<br  />{<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest_path"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/1f8279fb-5b2d-464c-af12-d9d6fbe9b5ae-m1.avro"</span>,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest_length"</span>&nbsp;:&nbsp;5291,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partition_spec_id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;//&nbsp;该manifest&nbsp;entry所属的snapshot<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_snapshot_id"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;2080639593951710914<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;//&nbsp;该manifest中添加的文件数量<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;4<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;//&nbsp;创建该manifest时已经存在且<br  />&nbsp;&nbsp;//&nbsp;没有被这次创建操作删除的文件数量<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"existing_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;//&nbsp;创建manifest删除的文件<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;//&nbsp;该manifest中partition字段的范围<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partitions"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"array"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"contains_null"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"lower_bound"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"bytes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"\u0001\u0000\u0000\u0000\u0000\u0000\u0000\u0000"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"upper_bound"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"bytes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"\u0004\u0000\u0000\u0000\u0000\u0000\u0000\u0000"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;]<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;4<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"existing_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;}<br  />}<br  />//&nbsp;manifest&nbsp;entry<br  />{<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest_path"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item/metadata/1f8279fb-5b2d-464c-af12-d9d6fbe9b5ae-m0.avro"</span>,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"manifest_length"</span>&nbsp;:&nbsp;5289,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partition_spec_id"</span>&nbsp;:&nbsp;0,<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_snapshot_id"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;2080639593951710914<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"existing_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted_data_files_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"int"</span>&nbsp;:&nbsp;4<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"partitions"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"array"</span>&nbsp;:&nbsp;[&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"contains_null"</span>&nbsp;:&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>,<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"lower_bound"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"bytes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"\u0001\u0000\u0000\u0000\u0000\u0000\u0000\u0000"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"upper_bound"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"bytes"</span>&nbsp;:&nbsp;<span style="color: #98c379;line-height: 26px;">"\u0004\u0000\u0000\u0000\u0000\u0000\u0000\u0000"</span><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;]<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"added_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"existing_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;0<br  />&nbsp;&nbsp;},<br  />&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"deleted_rows_count"</span>&nbsp;:&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #98c379;line-height: 26px;">"long"</span>&nbsp;:&nbsp;4<br  />&nbsp;&nbsp;}<br  />}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">Manifest管理多个data文件，一条DataFileEntry对应一个data文件，DataFileEntry中记录了所属partition，value bounds等信息，value_counts和null_value_counts可以用于过滤null列，例：column a所对应的value_count为3，且对应的null_value_count也为3，此时如果select a，则可以根据value_count-null_value_count=0判断a全为null直接返回而无需再进行parquet文件的查询；除此之外，可以根据value bounds进行过滤，加速查询。</p><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;border-bottom: 2px solid rgb(239, 112, 96);font-size: 1.3em;"><span style="display: inline-block;font-weight: bold;background: rgb(239, 112, 96);color: #ffffff;padding: 3px 10px 1px;border-top-right-radius: 3px;border-top-left-radius: 3px;margin-right: 3px;">第二部分：Spark写Iceberg流程分析</span></h2><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;font-size: 16px;">spark写入示例</h5><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">import&nbsp;org.apache.iceberg.hadoop.HadoopTables<br  />import&nbsp;org.apache.hadoop.conf.Configuration<br  />import&nbsp;org.apache.iceberg.catalog.TableIdentifier<br  />import&nbsp;org.apache.iceberg.Schema<br  />import&nbsp;org.apache.iceberg.types._<br  />import&nbsp;org.apache.spark.sql.types._<br  />import&nbsp;org.apache.iceberg.PartitionSpec<br  />import&nbsp;org.apache.iceberg.spark.SparkSchemaUtil<br  />import&nbsp;org.apache.spark.sql._<br  />import&nbsp;spark.implicits._<br  /><br  />val&nbsp;order_item_schema&nbsp;=&nbsp;StructType(List(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StructField(<span style="color: #98c379;line-height: 26px;">"id"</span>,&nbsp;LongType,&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StructField(<span style="color: #98c379;line-height: 26px;">"order_id"</span>,&nbsp;LongType,&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StructField(<span style="color: #98c379;line-height: 26px;">"product_id"</span>,&nbsp;LongType,&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StructField(<span style="color: #98c379;line-height: 26px;">"product_price"</span>,&nbsp;DecimalType(7,2),&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StructField(<span style="color: #98c379;line-height: 26px;">"product_quantity"</span>,&nbsp;IntegerType,&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StructField(<span style="color: #98c379;line-height: 26px;">"product_name"</span>,&nbsp;StringType,&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>)<br  />&nbsp;&nbsp;&nbsp;&nbsp;))<br  /><br  />val&nbsp;order_item_action&nbsp;=&nbsp;Seq(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Row(1L,&nbsp;1L,&nbsp;1L,&nbsp;Decimal.apply(50.00,&nbsp;7,&nbsp;2),&nbsp;2,&nbsp;<span style="color: #98c379;line-height: 26px;">"table&nbsp;lamp"</span>),&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Row(2L,&nbsp;1L,&nbsp;2L,&nbsp;Decimal.apply(100.5,&nbsp;7,&nbsp;2),&nbsp;1,&nbsp;<span style="color: #98c379;line-height: 26px;">"skirt"</span>),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Row(3L,&nbsp;2L,&nbsp;1L,&nbsp;Decimal.apply(50.00,&nbsp;7,&nbsp;2),&nbsp;1,&nbsp;<span style="color: #98c379;line-height: 26px;">"table&nbsp;lamp"</span>),&nbsp;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Row(4L,&nbsp;3L,&nbsp;3L,&nbsp;Decimal.apply(0.99,&nbsp;7,&nbsp;2),&nbsp;1,&nbsp;<span style="color: #98c379;line-height: 26px;">"match"</span>)<br  />&nbsp;&nbsp;&nbsp;&nbsp;)<br  /><br  />val&nbsp;iceberg_schema&nbsp;=&nbsp;new&nbsp;Schema(<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Types.NestedField.optional(1,&nbsp;<span style="color: #98c379;line-height: 26px;">"id"</span>,&nbsp;Types.LongType.get()),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Types.NestedField.optional(2,&nbsp;<span style="color: #98c379;line-height: 26px;">"order_id"</span>,&nbsp;Types.LongType.get()),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Types.NestedField.optional(3,&nbsp;<span style="color: #98c379;line-height: 26px;">"product_id"</span>,&nbsp;Types.LongType.get()),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Types.NestedField.optional(4,&nbsp;<span style="color: #98c379;line-height: 26px;">"product_price"</span>,&nbsp;Types.DecimalType.of(7,&nbsp;2)),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Types.NestedField.optional(5,&nbsp;<span style="color: #98c379;line-height: 26px;">"product_quantity"</span>,&nbsp;Types.IntegerType.get()),<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Types.NestedField.optional(6,&nbsp;<span style="color: #98c379;line-height: 26px;">"product_name"</span>,&nbsp;Types.StringType.get())<br  />&nbsp;&nbsp;&nbsp;&nbsp;)<br  /><br  />val&nbsp;iceberg_partition&nbsp;=&nbsp;PartitionSpec.builderFor(iceberg_schema).identity(<span style="color: #98c379;line-height: 26px;">"id"</span>).build()&nbsp;&nbsp;<br  /><br  />val&nbsp;hadoopTable&nbsp;=&nbsp;new&nbsp;HadoopTables(sc.hadoopConfiguration);<br  />val&nbsp;location&nbsp;=&nbsp;<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item"</span>;<br  /><br  />hadoopTable.create(iceberg_schema,&nbsp;iceberg_partition,&nbsp;location)<br  /><br  />val&nbsp;df&nbsp;=&nbsp;spark.createDataFrame(sc.makeRDD(order_item_action),&nbsp;order_item_schema)<br  /><br  />df.write.format(<span style="color: #98c379;line-height: 26px;">"iceberg"</span>).mode(<span style="color: #98c379;line-height: 26px;">"overwrite"</span>).save(<span style="color: #98c379;line-height: 26px;">"hdfs://10.242.199.202:9000/hive/empty_order_item"</span>)<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">spark写入iceberg主要分为两步：</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: disc;" class="list-paddingleft-1"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">Executor写入数据</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">Driver commit生成元数据</section></li></ul><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;font-size: 16px;">Executor写入逻辑</h5><figure data-tool="mdnice编辑器" style="margin: 0;margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.7922297297297297" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/5_cFhQ8UTRR9LIChdzwUo3SnYU6hprkQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MIAhHH1mPG6Tdsg33w3ia0LicP8Mgk0303vd0blyOhUZN4KuicFhQ8UTRR9LIChdzwUo3SnYU6hprkQ/640?wx_fmt=png'" data-type="png" data-w="1184" style="display: block;margin: 0 auto;max-width: 100%;"  /></figure><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">由上图可以看到IcebergSource实现了spark ReadSupport、WriteSupport、StreamWriteSupport等接口，WriteFactory根据写入表的类型：(1) 分区表 (2) 非分区表，生成不同的writer，最后通过write方法写入数据。</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">我们以写入分区表为例简单介绍一下executor端iceberg写入数据的流程:</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: disc;" class="list-paddingleft-1"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">根据file format生成对应的FileAppender，FileAppender完成实际的写文件操作。目前支持3种文件格式的写入：Parquet、Avro以及Orc</section></li></ul><figure data-tool="mdnice编辑器" style="margin: 0;margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.5772357723577236" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/6_A6PGnf2IfuicJSib1jxZgAibTeYIGQ.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MIAhHH1mPG6Tdsg33w3ia0L6fic9GA5viatEXYAlvPly6S8jqXkPA6PGnf2IfuicJSib1jxZgAibTeYIGQ/640?wx_fmt=png'" data-type="png" data-w="984" style="display: block;margin: 0 auto;max-width: 100%;"  /></figure><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: disc;" class="list-paddingleft-1"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">iceberg分区数据不直接写入数据文件中，而是通过目录树结构来进行存储，分区目录结构与hive类型，都是以key1=value1/key2=value2的形式进行组织。在写入数据之前，partitionWriter首先根据partition transform函数得到对应的partition value，然后创建对应的分区目录</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">fileAppender通过调用不同的file format组件将数据写入到文件中。iceberg写入时可以通过设置write.target-file-size-bytes table property调整写入文件target大小，默认为LONG_MAX</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">当所有数据写入完成后，iceberg会收集写入的统计信息，例如record_count, lower_bound, upper_bound, value_count等用于driver端生成对应的manifest文件，最后executor端将这些信息传回driver端。</section></li></ul><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;font-size: 16px;">Driver commit逻辑</h5><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">iceberg snapshot中的统计信息实际是累计更新的结果，相较于上次commit，本次commit发生了哪些变化，例新增了多少条记录，删除了多少条记录，新增了多少文件，删除了多少文件等等。既然是累计更新，首先需要知道上次snapshot的信息，然后计算最后的结果。iceberg读取当前最新snapshot数据过程如下：</p><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: decimal;" class="list-paddingleft-1"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">读取version.hint中记录的最新metadata版本号versionNumber</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">读取version[versionNumber].metadata.json文件，根据metadata中记录的snpshots信息以及current snapshot id得到最新snapshot的location</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">最后根据获得的location读取对应的snapshot文件得到最新的snapshot数据</section></li></ol><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">overwrite实际上可以等价划分成两个步骤:</p><ul data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: disc;" class="list-paddingleft-1"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">delete</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">insert</section></li></ul><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">那么我们如何知道需要删除哪些数据呢？这里就要用到刚刚读取的current snapshot数据以及executor传回的信息，根据这些信息，我们可以计算得到哪些分区文件是需要通过覆盖删除的，实际上是将manifest中的对应DataFileEntry标记成删除写入到新的manifest文件中，没有被删除的DataFileEntry则标记成Existing写入到manifest文件中</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">在完成了delete操作之后，insert操作就相对比较简单，只要将GenericDataFile全部写入到新的manifest中即可</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">iceberg默认开启merge manifest功能，当manifest文件数量超过commit.manifest.min-count-to-merge时(默认100)，将多个small manifest文件合并成large manifest(large manifest文件大小由commit.manifest.target-size-bytes指定，默认为8M）</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">最后iceberg根据这些Added/Deleted/Existing DataFileEntry得到本次commit的差值统计信息，与前一次snapshot统计信息累加最终得到本次snapshot的统计信息(added_data_files_count, added_rows_count等）。生成snapshot的整个过程如下图所示：</p><figure data-tool="mdnice编辑器" style="margin: 0;margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.6915887850467289" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/7_sGDLoKVfbGtUsxGGxvhxce1xAQycrg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MIAhHH1mPG6Tdsg33w3ia0LX9TLNj23fmlsXRRUJbT2H1iaKsGDLoKVfbGtUsxGGxvhxce1xAQycrg/640?wx_fmt=png'" data-type="png" data-w="1284" style="display: block;margin: 0 auto;max-width: 100%;"  /></figure><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">在生成新的snapshot后，只剩最后一步那就是生成新版本的version.metadata.json文件，同时将版本号写入到version.hint中，至此完成了所有iceberg数据的写入。</p><h2 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;border-bottom: 2px solid rgb(239, 112, 96);font-size: 1.3em;"><span style="display: inline-block;font-weight: bold;background: rgb(239, 112, 96);color: #ffffff;padding: 3px 10px 1px;border-top-right-radius: 3px;border-top-left-radius: 3px;margin-right: 3px;">第三部分：Flink写Iceberg流程分析</span></h2><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;font-size: 16px;">开始实例</h5><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">flink支持DataStream和DataStream写入iceberg</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">StreamExecutionEnvironment&nbsp;env&nbsp;=&nbsp;...;<br  /><br  />DataStream&lt;RowData&gt;&nbsp;input&nbsp;=&nbsp;...&nbsp;;<br  />Configuration&nbsp;hadoopConf&nbsp;=&nbsp;new&nbsp;Configuration();<br  />TableLoader&nbsp;tableLoader&nbsp;=&nbsp;TableLoader.fromHadoopTable(<span style="color: #98c379;line-height: 26px;">"hdfs://nn:8020/warehouse/path"</span>,&nbsp;hadoopConf);<br  />FlinkSink.forRowData(input,&nbsp;FLINK_SCHEMA)<br  />&nbsp;&nbsp;&nbsp;&nbsp;.tableLoader(tableLoader)<br  />&nbsp;&nbsp;&nbsp;&nbsp;.writeParallelism(1)<br  />&nbsp;&nbsp;&nbsp;&nbsp;.build();<br  />env.execute(<span style="color: #98c379;line-height: 26px;">"Test&nbsp;Iceberg&nbsp;DataStream"</span>);<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">input为DataStream和DataStream形式的输入流，FLINK_SCHEMA为TableSchema；</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">首先看build()方法：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">public&nbsp;DataStreamSink&lt;RowData&gt;&nbsp;<span style="color: rgb(97, 174, 238);line-height: 26px;">build</span>()&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Preconditions.checkArgument(this.rowDataInput&nbsp;!=&nbsp;null,&nbsp;<span style="color: #98c379;line-height: 26px;">"Please&nbsp;use&nbsp;forRowData()&nbsp;to&nbsp;initialize&nbsp;the&nbsp;input&nbsp;DataStream."</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Preconditions.checkNotNull(this.tableLoader,&nbsp;<span style="color: #98c379;line-height: 26px;">"Table&nbsp;loader&nbsp;shouldn't&nbsp;be&nbsp;null"</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(this.table&nbsp;==&nbsp;null)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.tableLoader.open();<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TableLoader&nbsp;loader&nbsp;=&nbsp;this.tableLoader;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Throwable&nbsp;var2&nbsp;=&nbsp;null;<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.table&nbsp;=&nbsp;loader.loadTable();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(Throwable&nbsp;var12)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var2&nbsp;=&nbsp;var12;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;var12;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(loader&nbsp;!=&nbsp;null)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(var2&nbsp;!=&nbsp;null)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loader.close();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(Throwable&nbsp;var11)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var2.addSuppressed(var11);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loader.close();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(IOException&nbsp;var14)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;UncheckedIOException(<span style="color: #98c379;line-height: 26px;">"Failed&nbsp;to&nbsp;load&nbsp;iceberg&nbsp;table&nbsp;from&nbsp;table&nbsp;loader:&nbsp;"</span>&nbsp;+&nbsp;this.tableLoader,&nbsp;var14);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&lt;Integer&gt;&nbsp;equalityFieldIds&nbsp;=&nbsp;Lists.newArrayList();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(this.equalityFieldColumns&nbsp;!=&nbsp;null&nbsp;&amp;&amp;&nbsp;this.equalityFieldColumns.size()&nbsp;&gt;&nbsp;0)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iterator&nbsp;var16&nbsp;=&nbsp;this.equalityFieldColumns.iterator();<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">while</span>(var16.hasNext())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;column&nbsp;=&nbsp;(String)var16.next();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NestedField&nbsp;field&nbsp;=&nbsp;this.table.schema().findField(column);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Preconditions.checkNotNull(field,&nbsp;<span style="color: #98c379;line-height: 26px;">"Missing&nbsp;required&nbsp;equality&nbsp;field&nbsp;column&nbsp;'%s'&nbsp;in&nbsp;table&nbsp;schema&nbsp;%s"</span>,&nbsp;column,&nbsp;this.table.schema());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;equalityFieldIds.add(field.fieldId());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RowType&nbsp;flinkRowType&nbsp;=&nbsp;FlinkSink.toFlinkRowType(this.table.schema(),&nbsp;this.tableSchema);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.rowDataInput&nbsp;=&nbsp;this.distributeDataStream(this.rowDataInput,&nbsp;this.table.properties(),&nbsp;this.table.spec(),&nbsp;this.table.schema(),&nbsp;flinkRowType);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IcebergStreamWriter&lt;RowData&gt;&nbsp;streamWriter&nbsp;=&nbsp;FlinkSink.createStreamWriter(this.table,&nbsp;flinkRowType,&nbsp;equalityFieldIds);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IcebergFilesCommitter&nbsp;filesCommitter&nbsp;=&nbsp;new&nbsp;IcebergFilesCommitter(this.tableLoader,&nbsp;this.overwrite);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.writeParallelism&nbsp;=&nbsp;this.writeParallelism&nbsp;==&nbsp;null&nbsp;?&nbsp;this.rowDataInput.getParallelism()&nbsp;:&nbsp;this.writeParallelism;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DataStream&lt;Void&gt;&nbsp;returnStream&nbsp;=&nbsp;this.rowDataInput.transform(FlinkSink.ICEBERG_STREAM_WRITER_NAME,&nbsp;TypeInformation.of(WriteResult.class),&nbsp;streamWriter).setParallelism(this.writeParallelism).transform(FlinkSink.ICEBERG_FILES_COMMITTER_NAME,&nbsp;Types.VOID,&nbsp;filesCommitter).setParallelism(1).setMaxParallelism(1);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;returnStream.addSink(new&nbsp;DiscardingSink()).name(String.format(<span style="color: #98c379;line-height: 26px;">"IcebergSink&nbsp;%s"</span>,&nbsp;this.table.name())).setParallelism(1);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">此处创建写的iceberg核心算子IcebergStreamWriter和IcebergFilesCommitter</p><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;font-size: 16px;">IcebergStreamWriter</h5><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">IcebergStreamWriter&lt;RowData&gt;&nbsp;streamWriter&nbsp;=&nbsp;FlinkSink.createStreamWriter(this.table,&nbsp;flinkRowType,&nbsp;equalityFieldIds);<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">build()方法中，调用createStreamWriter()创建IcebergStreamWriter</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">static&nbsp;IcebergStreamWriter&lt;RowData&gt;&nbsp;createStreamWriter(Table&nbsp;table,&nbsp;RowType&nbsp;flinkRowType,&nbsp;List&lt;Integer&gt;&nbsp;equalityFieldIds)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map&lt;String,&nbsp;String&gt;&nbsp;props&nbsp;=&nbsp;table.properties();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;targetFileSize&nbsp;=&nbsp;getTargetFileSizeBytes(props);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileFormat&nbsp;fileFormat&nbsp;=&nbsp;getFileFormat(props);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TaskWriterFactory&lt;RowData&gt;&nbsp;taskWriterFactory&nbsp;=&nbsp;new&nbsp;RowDataTaskWriterFactory(table.schema(),&nbsp;flinkRowType,&nbsp;table.spec(),&nbsp;table.locationProvider(),&nbsp;table.io(),&nbsp;table.encryption(),&nbsp;targetFileSize,&nbsp;fileFormat,&nbsp;props,&nbsp;equalityFieldIds);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;new&nbsp;IcebergStreamWriter(table.name(),&nbsp;taskWriterFactory);<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">根据表信息构建TaskWriterFactory，并传入到IcebergStreamWriter</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">class&nbsp;IcebergStreamWriter&lt;T&gt;&nbsp;extends&nbsp;AbstractStreamOperator&lt;WriteResult&gt;&nbsp;implements&nbsp;OneInputStreamOperator&lt;T,&nbsp;WriteResult&gt;,&nbsp;BoundedOneInput&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;long&nbsp;serialVersionUID&nbsp;=&nbsp;1L;<br  />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;String&nbsp;fullTableName;<br  />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;final&nbsp;TaskWriterFactory&lt;T&gt;&nbsp;taskWriterFactory;<br  />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;transient&nbsp;TaskWriter&lt;T&gt;&nbsp;writer;<br  />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;transient&nbsp;int&nbsp;subTaskId;<br  />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;transient&nbsp;int&nbsp;attemptId;<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;IcebergStreamWriter(String&nbsp;fullTableName,&nbsp;TaskWriterFactory&lt;T&gt;&nbsp;taskWriterFactory)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.fullTableName&nbsp;=&nbsp;fullTableName;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.taskWriterFactory&nbsp;=&nbsp;taskWriterFactory;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.setChainingStrategy(ChainingStrategy.ALWAYS);<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;<span style="color: rgb(97, 174, 238);line-height: 26px;">open</span>()&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.subTaskId&nbsp;=&nbsp;this.getRuntimeContext().getIndexOfThisSubtask();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.attemptId&nbsp;=&nbsp;this.getRuntimeContext().getAttemptNumber();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.taskWriterFactory.initialize(this.subTaskId,&nbsp;this.attemptId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.writer&nbsp;=&nbsp;this.taskWriterFactory.create();<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;prepareSnapshotPreBarrier(long&nbsp;checkpointId)&nbsp;throws&nbsp;Exception&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.emit(this.writer.complete());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.writer&nbsp;=&nbsp;this.taskWriterFactory.create();<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;processElement(StreamRecord&lt;T&gt;&nbsp;element)&nbsp;throws&nbsp;Exception&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.writer.write(element.getValue());<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  />}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">在open中通过传入的taskWriterFactory构建TaskWriter</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">public&nbsp;TaskWriter&lt;RowData&gt;&nbsp;<span style="color: rgb(97, 174, 238);line-height: 26px;">create</span>()&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Preconditions.checkNotNull(this.outputFileFactory,&nbsp;<span style="color: #98c379;line-height: 26px;">"The&nbsp;outputFileFactory&nbsp;shouldn't&nbsp;be&nbsp;null&nbsp;if&nbsp;we&nbsp;have&nbsp;invoked&nbsp;the&nbsp;initialize()."</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(this.equalityFieldIds&nbsp;!=&nbsp;null&nbsp;&amp;&amp;&nbsp;!this.equalityFieldIds.isEmpty())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;(TaskWriter)(this.spec.isUnpartitioned()&nbsp;?&nbsp;new&nbsp;UnpartitionedDeltaWriter(this.spec,&nbsp;this.format,&nbsp;this.appenderFactory,&nbsp;this.outputFileFactory,&nbsp;this.io,&nbsp;this.targetFileSizeBytes,&nbsp;this.schema,&nbsp;this.flinkSchema,&nbsp;this.equalityFieldIds)&nbsp;:&nbsp;new&nbsp;PartitionedDeltaWriter(this.spec,&nbsp;this.format,&nbsp;this.appenderFactory,&nbsp;this.outputFileFactory,&nbsp;this.io,&nbsp;this.targetFileSizeBytes,&nbsp;this.schema,&nbsp;this.flinkSchema,&nbsp;this.equalityFieldIds));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;(TaskWriter)(this.spec.isUnpartitioned()&nbsp;?&nbsp;new&nbsp;UnpartitionedWriter(this.spec,&nbsp;this.format,&nbsp;this.appenderFactory,&nbsp;this.outputFileFactory,&nbsp;this.io,&nbsp;this.targetFileSizeBytes)&nbsp;:&nbsp;new&nbsp;RowDataTaskWriterFactory.RowDataPartitionedFanoutWriter(this.spec,&nbsp;this.format,&nbsp;this.appenderFactory,&nbsp;this.outputFileFactory,&nbsp;this.io,&nbsp;this.targetFileSizeBytes,&nbsp;this.schema,&nbsp;this.flinkSchema));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">此方法中根据是否指定字段，构造分区写(PartitionedDeltaWriter/RowDataPartitionedFanoutWriter)和非分区写实例(UnpartitionedDeltaWriter/UnpartitionedWriter)
四个类的调用关系：</p><blockquote data-tool="mdnice编辑器" style="border-top: none;border-right: none;border-bottom: none;display: block;font-size: 0.9em;overflow: auto;border-left: 3px solid rgb(239, 112, 96);color: rgb(106, 115, 125);padding: 10px 10px 10px 20px;margin-bottom: 20px;margin-top: 20px;background: rgb(255, 249, 249);"><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0px;color: black;line-height: 26px;">指定字段：</p></blockquote><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">UnpartitionedDeltaWriter -&gt; BaseEqualityDeltaWriter.write() -&gt; RollingFileWriter.write() -&gt; appender.add()
PartitionedDeltaWriter -&gt; BaseDeltaTaskWriter.write() -&gt; RollingFileWriter.write() -&gt; appender.add()</p><blockquote data-tool="mdnice编辑器" style="border-top: none;border-right: none;border-bottom: none;display: block;font-size: 0.9em;overflow: auto;border-left: 3px solid rgb(239, 112, 96);color: rgb(106, 115, 125);padding: 10px 10px 10px 20px;margin-bottom: 20px;margin-top: 20px;background: rgb(255, 249, 249);"><p style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0px;color: black;line-height: 26px;">未指定字段：</p></blockquote><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">UnpartitionedWriter -&gt; RollingFileWriter.write() -&gt; appender.add()</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">RowDataPartitionedFanoutWriter -&gt; BaseRollingWriter.write -&gt; RollingFileWriter.write() -&gt; appender.add()</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">底层调用的appender为创建TaskWriter传入的FlinkAppenderFactory创建的</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">在processElement()中调用write(element.getValue())方法，将数据写入，最后在checkpoint时提交。</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">提示：task执行三部曲：beforeInvoke() -&gt; runMailboxLoop() -&gt; afterInvoke()
beforeInvoke调用open()和initializeState()，runMailboxLoop调用processElement()处理数据</p><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;font-size: 16px;">IcebergFilesCommitter</h5><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">IcebergFilesCommitter&nbsp;filesCommitter&nbsp;=&nbsp;new&nbsp;IcebergFilesCommitter(this.tableLoader,&nbsp;this.overwrite);<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">build()方法中，传入tableLoader和overwrite直接创建IcebergFilesCommitter。</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">checkpoint初始化操作在IcebergFilesCommitter的initializeState()</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">public&nbsp;void&nbsp;initializeState(StateInitializationContext&nbsp;context)&nbsp;throws&nbsp;Exception&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super.initializeState(context);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.flinkJobId&nbsp;=&nbsp;this.getContainingTask().getEnvironment().getJobID().toString();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.tableLoader.open();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.table&nbsp;=&nbsp;this.tableLoader.loadTable();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;subTaskId&nbsp;=&nbsp;this.getRuntimeContext().getIndexOfThisSubtask();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;attemptId&nbsp;=&nbsp;this.getRuntimeContext().getAttemptNumber();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.manifestOutputFileFactory&nbsp;=&nbsp;FlinkManifestUtil.createOutputFileFactory(this.table,&nbsp;this.flinkJobId,&nbsp;subTaskId,&nbsp;(long)attemptId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.maxCommittedCheckpointId&nbsp;=&nbsp;-1L;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.checkpointsState&nbsp;=&nbsp;context.getOperatorStateStore().getListState(STATE_DESCRIPTOR);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.jobIdState&nbsp;=&nbsp;context.getOperatorStateStore().getListState(JOB_ID_DESCRIPTOR);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(context.isRestored())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;restoredFlinkJobId&nbsp;=&nbsp;(String)((Iterable)this.jobIdState.get()).iterator().next();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Preconditions.checkState(!Strings.isNullOrEmpty(restoredFlinkJobId),&nbsp;<span style="color: #98c379;line-height: 26px;">"Flink&nbsp;job&nbsp;id&nbsp;parsed&nbsp;from&nbsp;checkpoint&nbsp;snapshot&nbsp;shouldn't&nbsp;be&nbsp;null&nbsp;or&nbsp;empty"</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.maxCommittedCheckpointId&nbsp;=&nbsp;getMaxCommittedCheckpointId(this.table,&nbsp;restoredFlinkJobId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NavigableMap&lt;Long,&nbsp;byte[]&gt;&nbsp;uncommittedDataFiles&nbsp;=&nbsp;Maps.newTreeMap((SortedMap)((Iterable)this.checkpointsState.get()).iterator().next()).tailMap(this.maxCommittedCheckpointId,&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(!uncommittedDataFiles.isEmpty())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;maxUncommittedCheckpointId&nbsp;=&nbsp;(Long)uncommittedDataFiles.lastKey();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.commitUpToCheckpoint(uncommittedDataFiles,&nbsp;restoredFlinkJobId,&nbsp;maxUncommittedCheckpointId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">checkpoint提交流程在IcebergFilesCommitter的snapshotState中</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">public&nbsp;void&nbsp;snapshotState(StateSnapshotContext&nbsp;context)&nbsp;throws&nbsp;Exception&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super.snapshotState(context);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;checkpointId&nbsp;=&nbsp;context.getCheckpointId();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.info(<span style="color: #98c379;line-height: 26px;">"Start&nbsp;to&nbsp;flush&nbsp;snapshot&nbsp;state&nbsp;to&nbsp;state&nbsp;backend,&nbsp;table:&nbsp;{},&nbsp;checkpointId:&nbsp;{}"</span>,&nbsp;this.table,&nbsp;checkpointId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.dataFilesPerCheckpoint.put(checkpointId,&nbsp;this.writeToManifest(checkpointId));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.checkpointsState.clear();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.checkpointsState.add(this.dataFilesPerCheckpoint);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.jobIdState.clear();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.jobIdState.add(this.flinkJobId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.writeResultsOfCurrentCkpt.clear();<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">this.dataFilesPerCheckpoint.put(checkpointId, this.writeToManifest(checkpointId));
为更新当前的checkpointId和manifest元文件信息</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">dataFilesPerCheckpoint与调用关系如下：</p><figure data-tool="mdnice编辑器" style="margin: 0;margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.3619361936193619" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/8_MiaZPLNeUj2IKvon3BuI6uEdiahicA.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/UdK9ByfMT2MIAhHH1mPG6Tdsg33w3ia0Lx6lNicMlibC8zVJoQwZKh9NibNiczThMiaZPLNeUj2IKvon3BuI6uEdiahicA/640?wx_fmt=jpeg'" data-type="jpeg" data-w="1818" style="display: block;margin: 0 auto;max-width: 100%;"  /></figure><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">private&nbsp;byte[]&nbsp;writeToManifest(long&nbsp;checkpointId)&nbsp;throws&nbsp;IOException&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(this.writeResultsOfCurrentCkpt.isEmpty())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;EMPTY_MANIFEST_DATA;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteResult&nbsp;result&nbsp;=&nbsp;WriteResult.builder().addAll(this.writeResultsOfCurrentCkpt).build();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeltaManifests&nbsp;deltaManifests&nbsp;=&nbsp;FlinkManifestUtil.writeCompletedFiles(result,&nbsp;()&nbsp;-&gt;&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;this.manifestOutputFileFactory.create(checkpointId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;this.table.spec());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;SimpleVersionedSerialization.writeVersionAndSerialize(DeltaManifestsSerializer.INSTANCE,&nbsp;deltaManifests);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">writeResultsOfCurrentCkpt中包含了datafile文件、deletefile文件和referenced数据文件。然后，根据result创建deltaManifests ，并且返回序列化后的manifest信息。</p><figure data-tool="mdnice编辑器" style="margin: 0;margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.176759410801964" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/9_xAC5HFMQDCTwOiauibs27svrB7zf5A.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MIAhHH1mPG6Tdsg33w3ia0L0tOnD4kGib7KeZmibBhMibkjuZbbQxAC5HFMQDCTwOiauibs27svrB7zf5A/640?wx_fmt=png'" data-type="png" data-w="1833" style="display: block;margin: 0 auto;max-width: 100%;"  /></figure><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">deltaManifests 值如下：</p><figure data-tool="mdnice编辑器" style="margin: 0;margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.35075431034482757" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/10_NvT4Zy3PNHOnDfKSXS4ictkPotzOAg.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MIAhHH1mPG6Tdsg33w3ia0LVovrSpv89OiaEtJPXswfkwZiaaSNvT4Zy3PNHOnDfKSXS4ictkPotzOAg/640?wx_fmt=png'" data-type="png" data-w="1856" style="display: block;margin: 0 auto;max-width: 100%;"  /></figure><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">static&nbsp;DeltaManifests&nbsp;writeCompletedFiles(WriteResult&nbsp;result,&nbsp;Supplier&lt;OutputFile&gt;&nbsp;outputFileSupplier,&nbsp;PartitionSpec&nbsp;spec)&nbsp;throws&nbsp;IOException&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ManifestFile&nbsp;dataManifest&nbsp;=&nbsp;null;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ManifestFile&nbsp;deleteManifest&nbsp;=&nbsp;null;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(result.dataFiles()&nbsp;!=&nbsp;null&nbsp;&amp;&amp;&nbsp;result.dataFiles().length&nbsp;&gt;&nbsp;0)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataManifest&nbsp;=&nbsp;writeDataFiles((OutputFile)outputFileSupplier.get(),&nbsp;spec,&nbsp;Lists.newArrayList(result.dataFiles()));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(result.deleteFiles()&nbsp;!=&nbsp;null&nbsp;&amp;&amp;&nbsp;result.deleteFiles().length&nbsp;&gt;&nbsp;0)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputFile&nbsp;deleteManifestFile&nbsp;=&nbsp;(OutputFile)outputFileSupplier.get();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ManifestWriter&lt;DeleteFile&gt;&nbsp;deleteManifestWriter&nbsp;=&nbsp;ManifestFiles.writeDeleteManifest(2,&nbsp;spec,&nbsp;deleteManifestFile,&nbsp;DUMMY_SNAPSHOT_ID);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ManifestWriter&lt;DeleteFile&gt;&nbsp;writer&nbsp;=&nbsp;deleteManifestWriter;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Throwable&nbsp;var8&nbsp;=&nbsp;null;<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeleteFile[]&nbsp;var9&nbsp;=&nbsp;result.deleteFiles();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;var10&nbsp;=&nbsp;var9.length;<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">for</span>(int&nbsp;var11&nbsp;=&nbsp;0;&nbsp;var11&nbsp;&lt;&nbsp;var10;&nbsp;++var11)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeleteFile&nbsp;deleteFile&nbsp;=&nbsp;var9[var11];<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writer.add(deleteFile);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(Throwable&nbsp;var16)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var8&nbsp;=&nbsp;var16;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;var16;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(writer&nbsp;!=&nbsp;null)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #d19a66;line-height: 26px;">$closeResource</span>(var8,&nbsp;writer);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deleteManifest&nbsp;=&nbsp;deleteManifestWriter.toManifestFile();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;new&nbsp;DeltaManifests(dataManifest,&nbsp;deleteManifest,&nbsp;result.referencedDataFiles());<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">从上面写入过程可以看出，datafile和deletefile写入后，分别生成各自的Manifest文件，最后创建DeltaManifests返回。</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">最后通知checkpoint完成，提交checkpoint</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">public&nbsp;void&nbsp;notifyCheckpointComplete(long&nbsp;checkpointId)&nbsp;throws&nbsp;Exception&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super.notifyCheckpointComplete(checkpointId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(checkpointId&nbsp;&gt;&nbsp;this.maxCommittedCheckpointId)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.commitUpToCheckpoint(this.dataFilesPerCheckpoint,&nbsp;this.flinkJobId,&nbsp;checkpointId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.maxCommittedCheckpointId&nbsp;=&nbsp;checkpointId;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">private&nbsp;void&nbsp;commitUpToCheckpoint(NavigableMap&lt;Long,&nbsp;byte[]&gt;&nbsp;deltaManifestsMap,&nbsp;String&nbsp;newFlinkJobId,&nbsp;long&nbsp;checkpointId)&nbsp;throws&nbsp;IOException&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NavigableMap&lt;Long,&nbsp;byte[]&gt;&nbsp;pendingMap&nbsp;=&nbsp;deltaManifestsMap.headMap(checkpointId,&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&lt;ManifestFile&gt;&nbsp;manifests&nbsp;=&nbsp;Lists.newArrayList();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NavigableMap&lt;Long,&nbsp;WriteResult&gt;&nbsp;pendingResults&nbsp;=&nbsp;Maps.newTreeMap();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iterator&nbsp;var8&nbsp;=&nbsp;pendingMap.entrySet().iterator();<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">while</span>(var8.hasNext())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Entry&lt;Long,&nbsp;byte[]&gt;&nbsp;e&nbsp;=&nbsp;(Entry)var8.next();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(!Arrays.equals(EMPTY_MANIFEST_DATA,&nbsp;(byte[])e.getValue()))&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeltaManifests&nbsp;deltaManifests&nbsp;=&nbsp;(DeltaManifests)SimpleVersionedSerialization.readVersionAndDeSerialize(DeltaManifestsSerializer.INSTANCE,&nbsp;(byte[])e.getValue());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pendingResults.put((Long)e.getKey(),&nbsp;FlinkManifestUtil.readCompletedFiles(deltaManifests,&nbsp;this.table.io()));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;manifests.addAll(deltaManifests.manifests());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(this.replacePartitions)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.replacePartitions(pendingResults,&nbsp;newFlinkJobId,&nbsp;checkpointId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.commitDeltaTxn(pendingResults,&nbsp;newFlinkJobId,&nbsp;checkpointId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pendingMap.clear();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var8&nbsp;=&nbsp;manifests.iterator();<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">while</span>(var8.hasNext())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ManifestFile&nbsp;manifest&nbsp;=&nbsp;(ManifestFile)var8.next();<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.table.io().deleteFile(manifest.path());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;var12)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;details&nbsp;=&nbsp;MoreObjects.toStringHelper(this).add(<span style="color: #98c379;line-height: 26px;">"flinkJobId"</span>,&nbsp;newFlinkJobId).add(<span style="color: #98c379;line-height: 26px;">"checkpointId"</span>,&nbsp;checkpointId).add(<span style="color: #98c379;line-height: 26px;">"manifestPath"</span>,&nbsp;manifest.path()).toString();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warn(<span style="color: #98c379;line-height: 26px;">"The&nbsp;iceberg&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed,&nbsp;but&nbsp;we&nbsp;failed&nbsp;to&nbsp;clean&nbsp;the&nbsp;temporary&nbsp;flink&nbsp;manifests:&nbsp;{}"</span>,&nbsp;details,&nbsp;var12);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">这里会反序列化之前序列化的值，生成deltaManifests，添加到manifests列表中，manifests值：</p><figure data-tool="mdnice编辑器" style="margin: 0;margin-top: 10px;margin-bottom: 10px;display: flex;flex-direction: column;justify-content: center;align-items: center;"><img class="rich_pages wxw-img" data-ratio="0.4477033757609297" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/11_uY1rEFb7MQrE2ruSOkraroC7icDcmA.png" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_png/UdK9ByfMT2MIAhHH1mPG6Tdsg33w3ia0LNMg64I9kHwDJnIBicAmOBF1NquuY1rEFb7MQrE2ruSOkraroC7icDcmA/640?wx_fmt=png'" data-type="png" data-w="1807" style="display: block;margin: 0 auto;max-width: 100%;"  /></figure><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">然后根据replacePartitions（创建时传入的overwrite值，默认为false）值提交事务，默认情况下调用commitDeltaTxn()</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;void&nbsp;commitDeltaTxn(NavigableMap&lt;Long,&nbsp;WriteResult&gt;&nbsp;pendingResults,&nbsp;String&nbsp;newFlinkJobId,&nbsp;long&nbsp;checkpointId)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;deleteFilesNum&nbsp;=&nbsp;pendingResults.values().stream().mapToInt((r)&nbsp;-&gt;&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;r.deleteFiles().length;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}).sum();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Stream&nbsp;var10000;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(deleteFilesNum&nbsp;==&nbsp;0)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AppendFiles&nbsp;appendFiles&nbsp;=&nbsp;this.table.newAppend();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;numFiles&nbsp;=&nbsp;0;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iterator&nbsp;var8&nbsp;=&nbsp;pendingResults.values().iterator();<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">while</span>(var8.hasNext())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteResult&nbsp;result&nbsp;=&nbsp;(WriteResult)var8.next();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Preconditions.checkState(result.referencedDataFiles().length&nbsp;==&nbsp;0,&nbsp;<span style="color: #98c379;line-height: 26px;">"Should&nbsp;have&nbsp;no&nbsp;referenced&nbsp;data&nbsp;files."</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;numFiles&nbsp;+=&nbsp;result.dataFiles().length;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var10000&nbsp;=&nbsp;Arrays.stream(result.dataFiles());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Objects.requireNonNull(appendFiles);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var10000.forEach(appendFiles::appendFile);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.commitOperation(appendFiles,&nbsp;numFiles,&nbsp;0,&nbsp;<span style="color: #98c379;line-height: 26px;">"append"</span>,&nbsp;newFlinkJobId,&nbsp;checkpointId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iterator&nbsp;var12&nbsp;=&nbsp;pendingResults.entrySet().iterator();<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">while</span>(var12.hasNext())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Entry&lt;Long,&nbsp;WriteResult&gt;&nbsp;e&nbsp;=&nbsp;(Entry)var12.next();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteResult&nbsp;result&nbsp;=&nbsp;(WriteResult)e.getValue();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RowDelta&nbsp;rowDelta&nbsp;=&nbsp;this.table.newRowDelta().validateDataFilesExist(ImmutableList.copyOf(result.referencedDataFiles())).validateDeletedFiles();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;numDataFiles&nbsp;=&nbsp;result.dataFiles().length;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var10000&nbsp;=&nbsp;Arrays.stream(result.dataFiles());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Objects.requireNonNull(rowDelta);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var10000.forEach(rowDelta::addRows);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;numDeleteFiles&nbsp;=&nbsp;result.deleteFiles().length;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var10000&nbsp;=&nbsp;Arrays.stream(result.deleteFiles());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Objects.requireNonNull(rowDelta);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var10000.forEach(rowDelta::addDeletes);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.commitOperation(rowDelta,&nbsp;numDataFiles,&nbsp;numDeleteFiles,&nbsp;<span style="color: #98c379;line-height: 26px;">"rowDelta"</span>,&nbsp;newFlinkJobId,&nbsp;(Long)e.getKey());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">创建一个RowDelta的对象rowDelta或MergeAppend的appendFiles，rowDelta的实现类为BaseRowDelta继承自MergingSnapshotProducer作为一个新的snapshot提交；appendFiles的实现类MergeAppend，同样继承MergingSnapshotProducer。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">private&nbsp;void&nbsp;commitOperation(SnapshotUpdate&lt;?&gt;&nbsp;operation,&nbsp;int&nbsp;numDataFiles,&nbsp;int&nbsp;numDeleteFiles,&nbsp;String&nbsp;description,&nbsp;String&nbsp;newFlinkJobId,&nbsp;long&nbsp;checkpointId)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.info(<span style="color: #98c379;line-height: 26px;">"Committing&nbsp;{}&nbsp;with&nbsp;{}&nbsp;data&nbsp;files&nbsp;and&nbsp;{}&nbsp;delete&nbsp;files&nbsp;to&nbsp;table&nbsp;{}"</span>,&nbsp;new&nbsp;Object[]{description,&nbsp;numDataFiles,&nbsp;numDeleteFiles,&nbsp;this.table});<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;operation.set(<span style="color: #98c379;line-height: 26px;">"flink.max-committed-checkpoint-id"</span>,&nbsp;Long.toString(checkpointId));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;operation.set(<span style="color: #98c379;line-height: 26px;">"flink.job-id"</span>,&nbsp;newFlinkJobId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;start&nbsp;=&nbsp;System.currentTimeMillis();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;operation.commit();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;duration&nbsp;=&nbsp;System.currentTimeMillis()&nbsp;-&nbsp;start;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.info(<span style="color: #98c379;line-height: 26px;">"Committed&nbsp;in&nbsp;{}&nbsp;ms"</span>,&nbsp;duration);<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">operation.commit()会调用SnapshotProducer中的commit()方法</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">public&nbsp;void&nbsp;<span style="color: rgb(97, 174, 238);line-height: 26px;">commit</span>()&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AtomicLong&nbsp;newSnapshotId&nbsp;=&nbsp;new&nbsp;AtomicLong(-1L);<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tasks.foreach(new&nbsp;TableOperations[]{this.ops}).retry(this.base.propertyAsInt(<span style="color: #98c379;line-height: 26px;">"commit.retry.num-retries"</span>,&nbsp;4)).exponentialBackoff((long)this.base.propertyAsInt(<span style="color: #98c379;line-height: 26px;">"commit.retry.min-wait-ms"</span>,&nbsp;100),&nbsp;(long)this.base.propertyAsInt(<span style="color: #98c379;line-height: 26px;">"commit.retry.max-wait-ms"</span>,&nbsp;60000),&nbsp;(long)this.base.propertyAsInt(<span style="color: #98c379;line-height: 26px;">"commit.retry.total-timeout-ms"</span>,&nbsp;1800000),&nbsp;2.0D).onlyRetryOn(CommitFailedException.class).run((taskOps)&nbsp;-&gt;&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Snapshot&nbsp;newSnapshot&nbsp;=&nbsp;this.apply();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newSnapshotId.set(newSnapshot.snapshotId());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TableMetadata&nbsp;updated;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(this.stageOnly)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updated&nbsp;=&nbsp;this.base.addStagedSnapshot(newSnapshot);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updated&nbsp;=&nbsp;this.base.replaceCurrentSnapshot(newSnapshot);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(updated&nbsp;!=&nbsp;this.base)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;taskOps.commit(this.base,&nbsp;updated.withUUID());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(RuntimeException&nbsp;var5)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exceptions.suppressAndThrow(var5,&nbsp;this::cleanAll);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.info(<span style="color: #98c379;line-height: 26px;">"Committed&nbsp;snapshot&nbsp;{}&nbsp;({})"</span>,&nbsp;newSnapshotId.get(),&nbsp;this.getClass().getSimpleName());<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Snapshot&nbsp;saved&nbsp;=&nbsp;this.ops.refresh().snapshot(newSnapshotId.get());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(saved&nbsp;!=&nbsp;null)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.cleanUncommitted(Sets.newHashSet(saved.allManifests()));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iterator&nbsp;var3&nbsp;=&nbsp;this.manifestLists.iterator();<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">while</span>(var3.hasNext())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;manifestList&nbsp;=&nbsp;(String)var3.next();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(!saved.manifestListLocation().equals(manifestList))&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.deleteFile(manifestList);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warn(<span style="color: #98c379;line-height: 26px;">"Failed&nbsp;to&nbsp;load&nbsp;committed&nbsp;snapshot,&nbsp;skipping&nbsp;manifest&nbsp;clean-up"</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(RuntimeException&nbsp;var6)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warn(<span style="color: #98c379;line-height: 26px;">"Failed&nbsp;to&nbsp;load&nbsp;committed&nbsp;table&nbsp;metadata,&nbsp;skipping&nbsp;manifest&nbsp;clean-up"</span>,&nbsp;var6);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.notifyListeners();<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">SnapshotProducer.apply() 方法执行写入manifestFiles数据，返回快照数据；</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">public&nbsp;Snapshot&nbsp;<span style="color: rgb(97, 174, 238);line-height: 26px;">apply</span>()&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.base&nbsp;=&nbsp;this.refresh();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Long&nbsp;parentSnapshotId&nbsp;=&nbsp;this.base.currentSnapshot()&nbsp;!=&nbsp;null&nbsp;?&nbsp;this.base.currentSnapshot().snapshotId()&nbsp;:&nbsp;null;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;sequenceNumber&nbsp;=&nbsp;this.base.nextSequenceNumber();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.validate(this.base);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&lt;ManifestFile&gt;&nbsp;manifests&nbsp;=&nbsp;this.apply(this.base);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(this.base.formatVersion()&nbsp;&lt;=&nbsp;1&nbsp;&amp;&amp;&nbsp;!this.base.propertyAsBoolean(<span style="color: #98c379;line-height: 26px;">"write.manifest-lists.enabled"</span>,&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>))&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;new&nbsp;BaseSnapshot(this.ops.io(),&nbsp;this.snapshotId(),&nbsp;parentSnapshotId,&nbsp;System.currentTimeMillis(),&nbsp;this.operation(),&nbsp;this.summary(this.base),&nbsp;manifests);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputFile&nbsp;manifestList&nbsp;=&nbsp;this.manifestListPath();<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ManifestListWriter&nbsp;writer&nbsp;=&nbsp;ManifestLists.write(this.ops.current().formatVersion(),&nbsp;manifestList,&nbsp;this.snapshotId(),&nbsp;parentSnapshotId,&nbsp;sequenceNumber);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Throwable&nbsp;var7&nbsp;=&nbsp;null;<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.manifestLists.add(manifestList.location());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ManifestFile[]&nbsp;manifestFiles&nbsp;=&nbsp;new&nbsp;ManifestFile[manifests.size()];<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Tasks.range(manifestFiles.length).stopOnFailure().throwFailureWhenFinished().executeWith(ThreadPools.getWorkerPool()).run((index)&nbsp;-&gt;&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;manifestFiles[index]&nbsp;=&nbsp;(ManifestFile)this.manifestsWithMetadata.get((ManifestFile)manifests.get(index));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writer.addAll(Arrays.asList(manifestFiles));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(Throwable&nbsp;var13)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var7&nbsp;=&nbsp;var13;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;var13;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(writer&nbsp;!=&nbsp;null)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #d19a66;line-height: 26px;">$closeResource</span>(var7,&nbsp;writer);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(IOException&nbsp;var15)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;RuntimeIOException(var15,&nbsp;<span style="color: #98c379;line-height: 26px;">"Failed&nbsp;to&nbsp;write&nbsp;manifest&nbsp;list&nbsp;file"</span>,&nbsp;new&nbsp;Object[0]);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;new&nbsp;BaseSnapshot(this.ops.io(),&nbsp;sequenceNumber,&nbsp;this.snapshotId(),&nbsp;parentSnapshotId,&nbsp;System.currentTimeMillis(),&nbsp;this.operation(),&nbsp;this.summary(this.base),&nbsp;manifestList.location());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">然后生成表的元数据updated</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">public&nbsp;TableMetadata&nbsp;replaceCurrentSnapshot(Snapshot&nbsp;snapshot)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(this.snapshotsById.containsKey(snapshot.snapshotId()))&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;this.setCurrentSnapshotTo(snapshot);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidationException.check(this.formatVersion&nbsp;==&nbsp;1&nbsp;||&nbsp;snapshot.sequenceNumber()&nbsp;&gt;&nbsp;this.lastSequenceNumber,&nbsp;<span style="color: #98c379;line-height: 26px;">"Cannot&nbsp;add&nbsp;snapshot&nbsp;with&nbsp;sequence&nbsp;number&nbsp;%s&nbsp;older&nbsp;than&nbsp;last&nbsp;sequence&nbsp;number&nbsp;%s"</span>,&nbsp;new&nbsp;Object[]{snapshot.sequenceNumber(),&nbsp;this.lastSequenceNumber});<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&lt;Snapshot&gt;&nbsp;newSnapshots&nbsp;=&nbsp;ImmutableList.builder().addAll(this.snapshots).add(snapshot).build();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&lt;HistoryEntry&gt;&nbsp;newSnapshotLog&nbsp;=&nbsp;ImmutableList.builder().addAll(this.snapshotLog).add(new&nbsp;TableMetadata.SnapshotLogEntry(snapshot.timestampMillis(),&nbsp;snapshot.snapshotId())).build();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #e6c07b;line-height: 26px;">return</span>&nbsp;new&nbsp;TableMetadata((InputFile)null,&nbsp;this.formatVersion,&nbsp;this.uuid,&nbsp;this.location,&nbsp;snapshot.sequenceNumber(),&nbsp;snapshot.timestampMillis(),&nbsp;this.lastColumnId,&nbsp;this.schema,&nbsp;this.defaultSpecId,&nbsp;this.specs,&nbsp;this.defaultSortOrderId,&nbsp;this.sortOrders,&nbsp;this.properties,&nbsp;snapshot.snapshotId(),&nbsp;newSnapshots,&nbsp;newSnapshotLog,&nbsp;this.addPreviousFile(this.file,&nbsp;this.lastUpdatedMillis));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">调用BaseMetastoreTableOperations算子的commit()方法</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">public&nbsp;void&nbsp;commit(TableMetadata&nbsp;base,&nbsp;TableMetadata&nbsp;metadata)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(base&nbsp;!=&nbsp;this.current())&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;CommitFailedException(<span style="color: #98c379;line-height: 26px;">"Cannot&nbsp;commit:&nbsp;stale&nbsp;table&nbsp;metadata"</span>,&nbsp;new&nbsp;Object[0]);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(base&nbsp;==&nbsp;metadata)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.info(<span style="color: #98c379;line-height: 26px;">"Nothing&nbsp;to&nbsp;commit."</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;start&nbsp;=&nbsp;System.currentTimeMillis();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.doCommit(base,&nbsp;metadata);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.deleteRemovedMetadataFiles(base,&nbsp;metadata);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.requestRefresh();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.info(<span style="color: #98c379;line-height: 26px;">"Successfully&nbsp;committed&nbsp;to&nbsp;table&nbsp;{}&nbsp;in&nbsp;{}&nbsp;ms"</span>,&nbsp;this.tableName(),&nbsp;System.currentTimeMillis()&nbsp;-&nbsp;start);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">最后调用HiveTableOperations的doCommit()，执行提交操作。</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">protected&nbsp;void&nbsp;doCommit(TableMetadata&nbsp;base,&nbsp;TableMetadata&nbsp;metadata)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;newMetadataLocation&nbsp;=&nbsp;this.writeNewMetadata(metadata,&nbsp;this.currentVersion()&nbsp;+&nbsp;1);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;hiveEngineEnabled&nbsp;=&nbsp;hiveEngineEnabled(metadata,&nbsp;this.conf);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;threw&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;updateHiveTable&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional&nbsp;lockId&nbsp;=&nbsp;Optional.empty();<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lockId&nbsp;=&nbsp;Optional.of(this.acquireLock());<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Table&nbsp;tbl&nbsp;=&nbsp;this.loadHmsTable();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(tbl&nbsp;!=&nbsp;null)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(base&nbsp;==&nbsp;null&nbsp;&amp;&amp;&nbsp;tbl.getParameters().get(<span style="color: #98c379;line-height: 26px;">"metadata_location"</span>)&nbsp;!=&nbsp;null)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AlreadyExistsException(<span style="color: #98c379;line-height: 26px;">"Table&nbsp;already&nbsp;exists:&nbsp;%s.%s"</span>,&nbsp;new&nbsp;Object[]{this.database,&nbsp;this.tableName});<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updateHiveTable&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">true</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(<span style="color: #98c379;line-height: 26px;">"Committing&nbsp;existing&nbsp;table:&nbsp;{}"</span>,&nbsp;this.fullName);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span style="color: #c678dd;line-height: 26px;">else</span>&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tbl&nbsp;=&nbsp;this.newHmsTable();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(<span style="color: #98c379;line-height: 26px;">"Committing&nbsp;new&nbsp;table:&nbsp;{}"</span>,&nbsp;this.fullName);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tbl.setSd(this.storageDescriptor(metadata,&nbsp;hiveEngineEnabled));<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;metadataLocation&nbsp;=&nbsp;(String)tbl.getParameters().get(<span style="color: #98c379;line-height: 26px;">"metadata_location"</span>);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;baseMetadataLocation&nbsp;=&nbsp;base&nbsp;!=&nbsp;null&nbsp;?&nbsp;base.metadataFileLocation()&nbsp;:&nbsp;null;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(!Objects.equals(baseMetadataLocation,&nbsp;metadataLocation))&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;CommitFailedException(<span style="color: #98c379;line-height: 26px;">"Base&nbsp;metadata&nbsp;location&nbsp;'%s'&nbsp;is&nbsp;not&nbsp;same&nbsp;as&nbsp;the&nbsp;current&nbsp;table&nbsp;metadata&nbsp;location&nbsp;'%s'&nbsp;for&nbsp;%s.%s"</span>,&nbsp;new&nbsp;Object[]{baseMetadataLocation,&nbsp;metadataLocation,&nbsp;this.database,&nbsp;this.tableName});<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.setParameters(newMetadataLocation,&nbsp;tbl,&nbsp;hiveEngineEnabled);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.persistTable(tbl,&nbsp;updateHiveTable);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threw&nbsp;=&nbsp;<span style="color: #56b6c2;line-height: 26px;">false</span>;<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(org.apache.hadoop.hive.metastore.api.AlreadyExistsException&nbsp;var16)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;AlreadyExistsException(<span style="color: #98c379;line-height: 26px;">"Table&nbsp;already&nbsp;exists:&nbsp;%s.%s"</span>,&nbsp;new&nbsp;Object[]{this.database,&nbsp;this.tableName});<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(UnknownHostException&nbsp;|&nbsp;TException&nbsp;var17)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(var17.getMessage()&nbsp;!=&nbsp;null&nbsp;&amp;&amp;&nbsp;var17.getMessage().contains(<span style="color: #98c379;line-height: 26px;">"Table/View&nbsp;'HIVE_LOCKS'&nbsp;does&nbsp;not&nbsp;exist"</span>))&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;RuntimeException(<span style="color: #98c379;line-height: 26px;">"Failed&nbsp;to&nbsp;acquire&nbsp;locks&nbsp;from&nbsp;metastore&nbsp;because&nbsp;'HIVE_LOCKS'&nbsp;doesn't&nbsp;exist,&nbsp;this&nbsp;probably&nbsp;happened&nbsp;when&nbsp;using&nbsp;embedded&nbsp;metastore&nbsp;or&nbsp;doesn't&nbsp;create&nbsp;a&nbsp;transactional&nbsp;meta&nbsp;table.&nbsp;To&nbsp;fix&nbsp;this,&nbsp;use&nbsp;an&nbsp;alternative&nbsp;metastore"</span>,&nbsp;var17);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;RuntimeException(String.format(<span style="color: #98c379;line-height: 26px;">"Metastore&nbsp;operation&nbsp;failed&nbsp;for&nbsp;%s.%s"</span>,&nbsp;this.database,&nbsp;this.tableName),&nbsp;var17);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(InterruptedException&nbsp;var18)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread.currentThread().interrupt();<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;RuntimeException(<span style="color: #98c379;line-height: 26px;">"Interrupted&nbsp;during&nbsp;commit"</span>,&nbsp;var18);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;finally&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.cleanupMetadataAndUnlock(threw,&nbsp;newMetadataLocation,&nbsp;lockId);<br  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br  /></code></pre><h5 data-tool="mdnice编辑器" style="margin-top: 30px;margin-bottom: 15px;padding: 0px;font-weight: bold;color: black;font-size: 16px;">附：flink task执行流程</h5><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">task的生命周期：</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">StreamTask是所有stream task的基本类。一个task 运行一个或者多个StreamOperator（如果成chain）。成chain的算子在同一个线程内同步运行。</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">执行过程：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">@Override<br  />&nbsp;public&nbsp;final&nbsp;void&nbsp;invoke()&nbsp;throws&nbsp;Exception&nbsp;{<br  />&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;beforeInvoke();<br  /><br  />&nbsp;&nbsp;&nbsp;//&nbsp;final&nbsp;check&nbsp;to&nbsp;<span style="color: #e6c07b;line-height: 26px;">exit</span>&nbsp;early&nbsp;before&nbsp;starting&nbsp;to&nbsp;run<br  />&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(canceled)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;CancelTaskException();<br  />&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;//&nbsp;<span style="color: #e6c07b;line-height: 26px;">let</span>&nbsp;the&nbsp;task&nbsp;<span style="color: #c678dd;line-height: 26px;">do</span>&nbsp;its&nbsp;work<br  />&nbsp;&nbsp;&nbsp;runMailboxLoop();<br  /><br  />&nbsp;&nbsp;&nbsp;//&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;this&nbsp;left&nbsp;the&nbsp;run()&nbsp;method&nbsp;cleanly&nbsp;despite&nbsp;the&nbsp;fact&nbsp;that&nbsp;this&nbsp;was&nbsp;canceled,<br  />&nbsp;&nbsp;&nbsp;//&nbsp;make&nbsp;sure&nbsp;the&nbsp;<span style="color: #98c379;line-height: 26px;">"clean&nbsp;shutdown"</span>&nbsp;is&nbsp;not&nbsp;attempted<br  />&nbsp;&nbsp;&nbsp;<span style="color: #c678dd;line-height: 26px;">if</span>&nbsp;(canceled)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;CancelTaskException();<br  />&nbsp;&nbsp;&nbsp;}<br  /><br  />&nbsp;&nbsp;&nbsp;afterInvoke();<br  />&nbsp;&nbsp;}<br  />&nbsp;&nbsp;catch&nbsp;(Exception&nbsp;invokeException)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;try&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;cleanUpInvoke();<br  />&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;catch&nbsp;(Throwable&nbsp;cleanUpException)&nbsp;{<br  />&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;(Exception)&nbsp;ExceptionUtils.firstOrSuppressed(cleanUpException,&nbsp;invokeException);<br  />&nbsp;&nbsp;&nbsp;}<br  />&nbsp;&nbsp;&nbsp;throw&nbsp;invokeException;<br  />&nbsp;&nbsp;}<br  />&nbsp;&nbsp;cleanUpInvoke();<br  />&nbsp;}<br  /></code></pre><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">在beforeInvoke中会做一些初始化工作，包括提取出所有的operator等。
在runMailboxLoop中调用task运行
在afterInvoke中结束</p><p data-tool="mdnice编辑器" style="font-size: 16px;padding-top: 8px;padding-bottom: 8px;margin: 0;line-height: 26px;color: black;">调用关系：</p><pre data-tool="mdnice编辑器" style="margin-top: 10px;margin-bottom: 10px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><code style="overflow-x: auto;padding: 16px;color: #abb2bf;display: -webkit-box;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;font-size: 12px;-webkit-overflow-scrolling: touch;padding-top: 15px;background: #282c34;border-radius: 5px;">--&nbsp;invoke()<br  />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<br  />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----&gt;&nbsp;Create&nbsp;basic&nbsp;utils&nbsp;(config,&nbsp;etc)&nbsp;and&nbsp;load&nbsp;the&nbsp;chain&nbsp;of&nbsp;operators<br  />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----&gt;&nbsp;operators.setup()<br  />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----&gt;&nbsp;task&nbsp;specific&nbsp;init()<br  />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----&gt;&nbsp;initialize-operator-states()<br  />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----&gt;&nbsp;open-operators()<br  />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----&gt;&nbsp;run()<br  />*&nbsp;--------------&gt;&nbsp;mailboxProcessor.runMailboxLoop();<br  />*&nbsp;--------------&gt;&nbsp;StreamTask.processInput()<br  />*&nbsp;--------------&gt;&nbsp;StreamTask.inputProcessor.processInput()<br  />*&nbsp;--------------&gt;&nbsp;间接调用&nbsp;operator的processElement()和processWatermark()方法<br  />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----&gt;&nbsp;close-operators()<br  />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----&gt;&nbsp;dispose-operators()<br  />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----&gt;&nbsp;common&nbsp;cleanup<br  />*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+----&gt;&nbsp;task&nbsp;specific&nbsp;cleanup()<br  /></code></pre><ol data-tool="mdnice编辑器" style="margin-top: 8px;margin-bottom: 8px;padding-left: 25px;color: black;list-style-type: decimal;" class="list-paddingleft-1"><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">创建状态存储后端，为 OperatorChain 中的所有算子提供状态</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">加载 OperatorChain 中的所有算子</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">所有的 operator 调用 setup</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">task 相关的初始化操作</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">所有 operator 调用 initializeState 初始化状态</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">所有的 operator 调用 open</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">run 方法循环处理数据</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">所有 operator 调用 close</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">所有 operator 调用 dispose</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">通用的 cleanup 操作</section></li><li><section style="margin-top: 5px;margin-bottom: 5px;line-height: 26px;text-align: left;color: rgb(1,1,1);font-weight: 500;">task 相关的 cleanup 操作</section></li></ol></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;max-width: 100%;white-space: normal;text-align: left;font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, &quot;PingFang SC&quot;, Cambria, Cochin, Georgia, Times, &quot;Times New Roman&quot;, serif;line-height: 1.6;letter-spacing: 0.034em;color: rgb(63, 63, 63);font-size: 16px;overflow-wrap: break-word !important;box-sizing: border-box !important;margin-bottom: 0px;"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="padding-right: 10px;padding-left: 10px;max-width: 100%;line-height: 1.6;letter-spacing: 0.034em;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="margin: 5px 0px;max-width: 100%;line-height: 26px;color: rgb(1, 1, 1);text-align: left;overflow-wrap: break-word !important;box-sizing: border-box !important;"><span style="letter-spacing: 0.544px;color: rgb(74, 74, 74);max-width: 100%;font-size: 15px;background-color: rgb(255, 255, 255);overflow-wrap: break-word !important;box-sizing: border-box !important;">如果这个文章对你有帮助，不要忘记&nbsp;</span><span style="letter-spacing: 0.544px;max-width: 100%;outline: 0px;font-size: 15px;background-color: rgb(255, 255, 255);color: rgb(255, 104, 39);overflow-wrap: break-word !important;box-sizing: border-box !important;"><strong style="max-width: 100%;outline: 0px;line-height: 1.75em;overflow-wrap: break-word !important;box-sizing: border-box !important;">「在看」</strong>&nbsp;<strong style="max-width: 100%;outline: 0px;line-height: 1.75em;overflow-wrap: break-word !important;box-sizing: border-box !important;">「点赞」</strong>&nbsp;<strong style="max-width: 100%;outline: 0px;line-height: 1.75em;overflow-wrap: break-word !important;box-sizing: border-box !important;">「收藏」</strong></span><span style="letter-spacing: 0.544px;color: rgb(74, 74, 74);max-width: 100%;font-size: 15px;background-color: rgb(255, 255, 255);overflow-wrap: break-word !important;box-sizing: border-box !important;">&nbsp;三连啊喂！</span></section><p style="text-align: center;margin-bottom: 0em;"><img class="rich_pages wxw-img" data-galleryid="" data-ratio="1.4586206896551723" data-s="300,640" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/12_Meiaf8u6goR03VhhyJkpXN9iaibnIg.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/UdK9ByfMT2NCHC0dw9dMYMR2DBvGh04aE6bIbNHCDKIOQeDpQ2aIGYWlTogMeiaf8u6goR03VhhyJkpXN9iaibnIg/640?wx_fmt=jpeg'" data-type="png" data-w="580" style="width: 260px;height: 379px;"  /><span style="background-color: rgb(255, 255, 255);color: rgb(136, 136, 136);font-family: &quot;Helvetica Neue&quot;;font-size: 13px;letter-spacing: 1px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;"></span></p></section></section><section style="max-width: 100%;white-space: normal;margin-bottom: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-tools="135编辑器" data-id="98469" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section hm_fix="349:393" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><img class="rich_pages wxw-img" data-ratio="0.10979228486646884" src="图片/大数据技术与架构_2022-07-06_Apache Iceberg核心原理分析文件存储及数据写入流程/13_zrkyKUN5kNeUFicVC3bMP1GEqKz1OQ.jpg" onerror="this.src='https://mmbiz.qpic.cn/mmbiz_jpg/BSBqCXrZtzAicMToibKuIysLrB62M5A5YaLhZg6z86tI7ZeEZqTLLYyNrmlzrkyKUN5kNeUFicVC3bMP1GEqKz1OQ/640?wx_fmt=jpeg'" data-type="jpeg" data-w="1011" style="height: 42px;color: rgb(136, 136, 136);font-family: &quot;Helvetica Neue&quot;;font-size: 13px;letter-spacing: 1px;-webkit-text-stroke-color: rgb(136, 136, 136);box-sizing: border-box;width: 384px;overflow-wrap: break-word !important;"  /></section><section style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-tools="135编辑器" data-id="98469" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section hm_fix="349:393" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247510040&amp;idx=1&amp;sn=aa335f25965975731173916f012d56f4&amp;chksm=fd3eee8dca49679b82f632048fb64d21fac01497d1a0fe33917edb01e194caf0f9a1930a55ce&amp;scene=21#wechat_redirect" textvalue="2022年全网首发|大数据专家级技能模型与学习指南(胜天半子篇)" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;letter-spacing: 0.544px;overflow-wrap: break-word !important;box-sizing: border-box !important;">2022年全网首发|大数据专家级技能模型与学习指南(胜天半子篇)</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247508317&amp;idx=1&amp;sn=0bcb7fb6997b42306994b890eaa0d47f&amp;chksm=fd3ee7c8ca496ede347a2971002c6ea68dcfd70abeeb90b43c8b02a2a60ebc7cec3a87ef7d52&amp;scene=21#wechat_redirect" textvalue="互联网最坏的时代可能真的来了" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">互联网最坏的时代可能真的来了</a><br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247507860&amp;idx=1&amp;sn=807ac5003762f29c127bc4071dcebe33&amp;chksm=fd3e9901ca4910178cfc816043ea86c29f881f70cd943d252de9ae2e21cb7e8ba80bff162e1b&amp;scene=21#wechat_redirect" textvalue="我在B站读大学，大数据专业" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">我在B站读大学，大数据专业</a><br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247499604&amp;idx=1&amp;sn=d938dfb30d221774704982d2938b30c1&amp;chksm=fd3eb9c1ca4930d76a391241333de461ca22d2aa27472eab3cffab1564872ae37f1b48fe2d3c&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">我们在学习Flink的时候，到底在学习什么？</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504856&amp;idx=2&amp;sn=6f62e2a0c756ce56773eed253d2f41ee&amp;chksm=fd3e954dca491c5b732b7e2aa46db32efbc3f690e528522098659bb3c6e78e1582ab4529b5dc&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;letter-spacing: 0.544px;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">193篇文章暴揍Flink，这个合集你需要关注一下</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504742&amp;idx=1&amp;sn=8765c198d8ad66219a7bcabb221e4a23&amp;chksm=fd3e95f3ca491ce52d0724b9e4154a47af0f5ea349e1e184c8fbc65aa17c0000242aa9b58429&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;letter-spacing: 0.544px;overflow-wrap: break-word !important;box-sizing: border-box !important;">Flink生产环境TOP难题与优化，阿里巴巴藏经阁YYDS</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504813&amp;idx=1&amp;sn=f5cd6ae2aa2b1e30f87a5ae55971c514&amp;chksm=fd3e9538ca491c2eb191677d070f2c7e4f1098eece00e256d6205b8a5d21b21c1e74f875f16f&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;letter-spacing: 0.544px;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">Flink CDC我吃定了耶稣也留不住他！| Flink CDC线上问题小盘点</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI0NjU2NDkzMQ==&amp;mid=2247492567&amp;idx=1&amp;sn=1f693e549f76622725b936041ff8896e&amp;chksm=e9bff2fbdec87bedecbdeed4547d7d612c72fc8d4918614a26a4e31666cf0128fd57b537f347&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">我们在学习Spark的时候，到底在学习什么？</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504834&amp;idx=1&amp;sn=46ca1a3924b8fdb89ac1c2acb0319d6c&amp;chksm=fd3e9557ca491c41d837b917639ea62007ea16d3c2cc6c0c02d1f8a8c6e44318f5183b787c46&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;letter-spacing: 0.544px;overflow-wrap: break-word !important;box-sizing: border-box !important;">在所有Spark模块中，我愿称SparkSQL为最强！</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247502750&amp;idx=1&amp;sn=bd9a9173d060dc4e4ebd49c8efc6acfe&amp;chksm=fd3e8d0bca49041dea84da93910e5efdc4935e520525c09887c986691377aeb48e5cf7fb5667&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">硬刚Hive | 4万字基础调优面试小总结</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504382&amp;idx=2&amp;sn=550b78802acfe727e0e77cd9195f8784&amp;chksm=fd3e976bca491e7db2b8b2446d231736df01bbf13653804d680ac4390597ec17fa466ad4ae83&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">数据治理方法论和实践小百科全书</a><br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247503741&amp;idx=1&amp;sn=e5039be93123f2e337013756a818bfc3&amp;chksm=fd3e89e8ca4900fe603b63c5722a6fb8a32bd63d6ba23e0028851948a71b877eb1f742d95087&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">标签体系下的用户画像建设小指南</a><br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247503675&amp;idx=1&amp;sn=3ee6af64d0126c78b48cad219308f81e&amp;chksm=fd3e89aeca4900b8b8954e9569ee3c0877881fac8c792bfafc22e7e9d3e8524da8eb860d33d8&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;">4万字长文 | ClickHouse基础&amp;实践&amp;调优全视角解析</a><br style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"  /></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI0NjU2NDkzMQ==&amp;mid=2247492567&amp;idx=2&amp;sn=57ecc77718f1b6f2f262d62e8318dcc9&amp;chksm=e9bff2fbdec87bedb1986765bfae7dbabb9aece45b0b2af147bbad1ac5d79ebc934c64df40ea&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">【面试&amp;个人成长】2021年过半，社招和校招的经验之谈</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504478&amp;idx=1&amp;sn=14efef3868ba42bd044f9618745a7fdc&amp;chksm=fd3e94cbca491dddb961b7b8b93105b2869c5bcf4c03f9f0dc83ad62be0dce4c124b52ed0ba3&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">大数据方向另一个十年开启 |《硬刚系列》第一版完结</a></section><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);background-color: rgb(255, 255, 255);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504410&amp;idx=1&amp;sn=7e81ab5a324395eb0f12397c40247ca1&amp;chksm=fd3e948fca491d9946456acbd93b2d651ae4d7a7d0127a211981e08f50f377e60d1b7c0d7b3a&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">我写过的关于成长/面试/职场进阶的文章</a></section><section style="max-width: 100%;font-family: -apple-system, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section powered-by="xiumi.us" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section data-tools="135编辑器" data-id="98469" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section hm_fix="349:393" style="max-width: 100%;overflow-wrap: break-word !important;box-sizing: border-box !important;"><section style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;font-stretch: normal;font-size: 13px;font-family: &quot;Helvetica Neue&quot;;letter-spacing: 0.544px;-webkit-text-stroke-color: rgb(136, 136, 136);text-align: left;color: rgb(136, 136, 136);line-height: 3em;margin-left: 0px;margin-right: 0px;overflow-wrap: break-word !important;box-sizing: border-box !important;"><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU3MzgwNTU2Mg==&amp;mid=2247504783&amp;idx=1&amp;sn=72aed147a459368ed934a007a2df3bc9&amp;chksm=fd3e951aca491c0cade212390011eca7d8a68951fee6aa2844b8f4d14bcbd5b3ed26305d69dc&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1" style="max-width: 100%;-webkit-tap-highlight-color: rgba(0, 0, 0, 0);cursor: pointer;overflow-wrap: break-word !important;box-sizing: border-box !important;">当我们在学习Hive的时候在学习什么？「硬刚Hive续集」</a></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></section></content>
</div>
</body>
</html>